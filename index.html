<!DOCTYPE html>
<html lang="de">
<head>
<script>if(location.hostname==='bea-lab.io')location.replace('https://www.bea-lab.io'+location.pathname+location.search+location.hash);</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BEATRIX – The Strategic Intelligence Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0a1628; --navy-light: #111d35; --navy-mid: #162244; --navy-card: #1a2847; --navy-hover: #1f3055;
            --border: #253556; --border-light: #2d4070;
            --accent: #5b8af5; --accent-light: #7ba3ff; --accent-glow: rgba(91,138,245,0.12); --accent-glow-strong: rgba(91,138,245,0.25);
            --text: #e4e9f2; --text-secondary: #8899b8; --text-muted: #586a8e; --white: #ffffff;
            --success: #34d399; --success-bg: rgba(52,211,153,0.1); --warning: #fbbf24;
            --error: #f87171; --error-bg: rgba(248,113,113,0.08);
            --radius: 14px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Plus Jakarta Sans',-apple-system,sans-serif; background:var(--navy); color:var(--text); min-height:100vh; overflow-x:hidden; -webkit-font-smoothing:antialiased; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(91,138,245,0.06),transparent),radial-gradient(ellipse 60% 50% at 80% 100%,rgba(91,138,245,0.04),transparent); pointer-events:none; z-index:0; }

        /* ── Login/Register Overlay ──────────────────────── */
        .auth-overlay { position:fixed; inset:0; z-index:10000; background:var(--navy); display:flex; align-items:center; justify-content:center; transition:opacity 0.5s ease, visibility 0.5s ease; }
        .auth-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }
        .auth-card { width:100%; max-width:420px; padding:48px 40px; text-align:center; }
        .auth-logo { width:80px; height:80px; border-radius:20px; margin:0 auto 28px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.2); }
        .auth-title { font-size:28px; font-weight:800; color:var(--white); margin-bottom:6px; letter-spacing:-0.3px; }
        .auth-title span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .auth-subtitle { font-size:14px; color:var(--text-secondary); margin-bottom:32px; line-height:1.6; }
        .auth-form { display:flex; flex-direction:column; gap:14px; }
        .auth-input-wrapper { position:relative; }
        .auth-input-wrapper svg { position:absolute; left:16px; top:50%; transform:translateY(-50%); width:18px; height:18px; stroke:var(--text-muted); transition:var(--transition); pointer-events:none; }
        .auth-input { width:100%; padding:14px 16px 14px 46px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:15px; outline:none; transition:var(--transition); }
        .auth-input::placeholder { color:var(--text-muted); }
        .auth-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); background:var(--navy-card); }
        .auth-btn { width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:var(--radius); font-size:15px; font-weight:700; font-family:inherit; cursor:pointer; transition:var(--transition); box-shadow:0 4px 20px rgba(91,138,245,0.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 6px 28px rgba(91,138,245,0.4); }
        .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .auth-error { font-size:13px; color:var(--error); padding:10px 14px; background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); border-radius:var(--radius-sm); display:none; animation:shake 0.4s ease; text-align:left; }
        .auth-error.visible { display:block; }
        .auth-success { font-size:13px; color:var(--success); padding:10px 14px; background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); border-radius:var(--radius-sm); display:none; text-align:left; }
        .auth-success.visible { display:block; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} }
        .auth-switch { margin-top:24px; font-size:13px; color:var(--text-muted); }
        .auth-switch a { color:var(--accent); text-decoration:none; font-weight:600; cursor:pointer; }
        .auth-switch a:hover { color:var(--accent-light); text-decoration:underline; }
        .auth-footer { margin-top:28px; font-size:11px; color:var(--text-muted); }
        .auth-footer a { color:var(--accent); text-decoration:none; }
        .auth-panel { display:none; }
        .auth-panel.active { display:block; }
        .auth-divider { display:flex; align-items:center; gap:12px; margin:4px 0; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
        .auth-divider::before, .auth-divider::after { content:''; flex:1; height:1px; background:var(--border); }

        /* ── Nav ─────────────────────────────────────────── */
        .nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:0 40px; height:64px; background:rgba(10,22,40,0.9); backdrop-filter:blur(24px); border-bottom:1px solid var(--border); }
        .nav-brand { display:flex; align-items:center; gap:14px; text-decoration:none; }
        .nav-logo-img { height:34px; width:auto; border-radius:6px; }
        .nav-title { font-size:16px; font-weight:700; color:var(--white); letter-spacing:1.5px; text-transform:uppercase; }
        .nav-links { display:flex; align-items:center; gap:4px; }
        .nav-link { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); }
        .nav-link:hover, .nav-link.active { color:var(--white); background:var(--navy-mid); }
        /* ── Nav Dropdowns ── */
        .nav-dropdown { position:relative; }
        .nav-dropdown-trigger { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); border-radius:var(--radius-sm); transition:var(--transition); cursor:pointer; display:flex; align-items:center; gap:6px; background:none; border:none; font-family:inherit; }
        .nav-dropdown-trigger:hover, .nav-dropdown-trigger.active { color:var(--white); background:var(--navy-mid); }
        .nav-dropdown-trigger svg { width:10px; height:10px; opacity:0.5; transition:transform 0.2s; }
        .nav-dropdown.open .nav-dropdown-trigger svg { transform:rotate(180deg); }
        .nav-dropdown-menu { display:none; position:absolute; top:calc(100% + 6px); left:0; min-width:260px; background:var(--navy-mid); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 12px 32px rgba(0,0,0,0.4); padding:6px; z-index:200; }
        .nav-dropdown.open .nav-dropdown-menu { display:block; }
        .nav-dropdown-item { display:flex; align-items:center; gap:10px; padding:10px 14px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); cursor:pointer; white-space:nowrap; }
        .nav-dropdown-item:hover { color:var(--white); background:rgba(255,255,255,0.06); }
        .nav-dropdown-item.active { color:var(--white); background:rgba(255,255,255,0.08); }
        .nav-dropdown-item svg { width:15px; height:15px; opacity:0.5; flex-shrink:0; }
        .nav-dropdown-item:hover svg { opacity:0.8; }
        .nav-dropdown-divider { height:1px; background:var(--border); margin:4px 6px; }
        .nav-dropdown-header { padding:6px 14px 4px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(255,255,255,0.25); pointer-events:none; }
        .nav-right { display:flex; align-items:center; gap:12px; }
        .nav-status { display:flex; align-items:center; gap:7px; font-size:12px; font-weight:500; color:var(--success); padding:5px 12px; background:var(--success-bg); border-radius:20px; }
        .nav-status .dot { width:6px; height:6px; border-radius:50%; background:var(--success); animation:pulse 2s infinite; }
        .nav-user { font-size:12px; color:var(--text-secondary); padding:5px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:20px; }
        .nav-logout { padding:5px 12px; font-size:12px; font-weight:500; color:var(--text-muted); background:var(--navy-light); border:1px solid var(--border); border-radius:20px; cursor:pointer; transition:var(--transition); font-family:inherit; display:flex; align-items:center; gap:5px; }
        .nav-logout:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* ── Hero ────────────────────────────────────────── */
        .hero { position:relative; z-index:1; text-align:center; padding:80px 24px 60px; border-bottom:1px solid var(--border); }
        .hero-logo { width:120px; height:120px; border-radius:24px; margin:0 auto 32px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.15); }
        .hero h1 { font-size:42px; font-weight:800; letter-spacing:-0.5px; color:var(--white); margin-bottom:12px; }
        .hero h1 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .hero .subtitle { font-size:17px; color:var(--text-secondary); max-width:520px; margin:0 auto 36px; line-height:1.7; }
        .hero-stats { display:flex; justify-content:center; gap:40px; }
        .hero-stat { text-align:center; }
        .hero-stat .num { font-size:28px; font-weight:800; color:var(--white); }
        .hero-stat .label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }

        /* ── Sections ───────────────────────────────────── */
        .section { display:none; position:relative; z-index:1; }
        .section.active { display:block; }
        .container { max-width:960px; margin:0 auto; padding:40px 24px 80px; }
        .section-header { margin-bottom:32px; }
        .section-header h2 { font-size:24px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .section-header p { font-size:14px; color:var(--text-secondary); line-height:1.6; }
        .db-selector { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:28px; }
        .db-option { padding:16px 18px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); }
        .db-option:hover { background:var(--navy-card); border-color:var(--border-light); }
        .db-option.selected { background:var(--navy-card); border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .db-option-title { font-size:14px; font-weight:600; color:var(--white); margin-bottom:3px; display:flex; align-items:center; gap:8px; }
        .db-dot { width:8px; height:8px; border-radius:50%; }
        .db-option-desc { font-size:12px; color:var(--text-muted); }
        .tabs { display:flex; gap:4px; margin-bottom:28px; background:var(--navy-light); padding:4px; border-radius:var(--radius); border:1px solid var(--border); width:fit-content; }
        .tab { padding:10px 22px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:var(--transition); border:none; background:none; font-family:inherit; }
        .tab:hover { color:var(--text); }
        .tab.active { background:var(--navy-card); color:var(--white); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:52px 40px; text-align:center; cursor:pointer; transition:var(--transition); background:var(--navy-light); position:relative; overflow:hidden; }
        .upload-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,var(--accent-glow),transparent 70%); opacity:0; transition:var(--transition); }
        .upload-zone:hover,.upload-zone.dragover { border-color:var(--accent); background:var(--navy-card); }
        .upload-zone:hover::before,.upload-zone.dragover::before { opacity:1; }
        .upload-icon { position:relative; z-index:1; margin-bottom:16px; }
        .upload-icon svg { width:36px; height:36px; stroke:var(--accent); }
        .upload-zone h3 { position:relative; z-index:1; font-size:16px; font-weight:600; margin-bottom:6px; color:var(--white); }
        .upload-zone h3 span { color:var(--accent-light); text-decoration:underline; text-underline-offset:2px; }
        .upload-zone p { position:relative; z-index:1; font-size:13px; color:var(--text-muted); margin-bottom:12px; }
        .upload-formats { position:relative; z-index:1; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
        .format-badge { padding:3px 9px; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; background:var(--navy-card); border:1px solid var(--border); border-radius:5px; color:var(--text-secondary); }
        .file-section,.text-section { display:none; }
        .file-section.active,.text-section.active { display:block; }
        .input-group { margin-bottom:16px; }
        .input-group label { display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
        .input-field,.textarea-field { width:100%; padding:10px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:var(--transition); }
        .input-field:focus,.textarea-field:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .textarea-field { min-height:200px; resize:vertical; line-height:1.7; }
        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .tag-container { display:flex; flex-wrap:wrap; gap:6px; padding:8px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:40px; align-items:center; cursor:text; transition:var(--transition); }
        .tag-container:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .tag { display:flex; align-items:center; gap:4px; padding:3px 8px 3px 10px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.3); border-radius:6px; font-size:12px; font-weight:500; color:var(--accent-light); }
        .tag button { background:none; border:none; color:var(--accent-light); cursor:pointer; font-size:14px; padding:0 2px; opacity:0.6; }
        .tag button:hover { opacity:1; }
        .tag-input { border:none; outline:none; background:none; color:var(--text); font-family:inherit; font-size:13px; flex:1; min-width:80px; }
        .file-list { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
        .file-item { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); animation:slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
        .file-type-icon { width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; text-transform:uppercase; flex-shrink:0; }
        .file-type-icon.pdf { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.2); }
        .file-type-icon.txt { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-type-icon.md { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.2); }
        .file-type-icon.doc { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-info { flex:1; min-width:0; }
        .file-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .file-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .progress-bar { height:3px; background:var(--navy); border-radius:2px; overflow:hidden; max-width:180px; }
        .progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s; }
        .file-status { font-size:11px; font-weight:600; padding:3px 9px; border-radius:5px; white-space:nowrap; }
        .file-status.pending { color:var(--text-muted); background:var(--navy-light); }
        .file-status.uploading { color:var(--accent-light); background:var(--accent-glow); }
        .file-status.success { color:var(--success); background:var(--success-bg); }
        .file-status.error { color:var(--error); background:var(--error-bg); }
        .file-remove { background:none; border:none; color:var(--text-muted); cursor:pointer; padding:4px; transition:var(--transition); border-radius:4px; }
        .file-remove:hover { color:var(--error); background:var(--error-bg); }
        .actions { margin-top:28px; display:flex; align-items:center; justify-content:space-between; }
        .btn { padding:11px 24px; border-radius:var(--radius-sm); font-size:13px; font-weight:600; font-family:inherit; cursor:pointer; transition:var(--transition); border:none; display:flex; align-items:center; gap:8px; }
        .btn-primary { background:var(--accent); color:white; box-shadow:0 2px 12px rgba(91,138,245,0.3); }
        .btn-primary:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 4px 20px rgba(91,138,245,0.4); }
        .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-secondary { background:var(--navy-card); color:var(--text-secondary); border:1px solid var(--border); }
        .btn-secondary:hover { background:var(--navy-hover); color:var(--text); }
        .upload-count { font-size:13px; color:var(--text-muted); }
        .doc-table { width:100%; border-collapse:collapse; }
        .doc-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .doc-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .doc-table tr:hover td { background:var(--navy-light); }
        .doc-table .doc-name { color:var(--white); font-weight:500; }
        .status-badge { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:600; }
        .status-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--success); }
        .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
        .empty-state svg { width:48px; height:48px; stroke:var(--border-light); margin-bottom:16px; }
        .empty-state h3 { font-size:16px; color:var(--text-secondary); margin-bottom:6px; }
        .toast-container { position:fixed; bottom:24px; right:24px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
        .toast { padding:12px 18px; border-radius:var(--radius-sm); font-size:13px; font-weight:500; display:flex; align-items:center; gap:8px; animation:toastIn 0.3s ease; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid var(--border); background:var(--navy-card); }
        .toast.success { border-left:3px solid var(--success); } .toast.error { border-left:3px solid var(--error); } .toast.info { border-left:3px solid var(--accent); }
        @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
        .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
        @keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
        .mb-default-badge { display:inline-block;font-size:10px;font-weight:600;color:var(--accent);background:rgba(139,170,255,0.1);border:1px solid rgba(139,170,255,0.2);padding:2px 8px;border-radius:10px;margin-top:6px;letter-spacing:0.3px;text-transform:uppercase; }
        .footer { position:relative; z-index:1; text-align:center; padding:32px 24px; border-top:1px solid var(--border); font-size:12px; color:var(--text-muted); }
        .footer a { color:var(--accent); text-decoration:none; }

        /* ── Admin Dashboard ───────────────────────────────── */
        .admin-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:32px; }
        .admin-card { padding:24px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); }
        .admin-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:8px; }
        .admin-card-value { font-size:28px; font-weight:800; color:var(--white); }
        .admin-card-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }
        .admin-section-title { font-size:16px; font-weight:700; color:var(--white); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
        .admin-section-title .badge { font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; background:var(--accent-glow); color:var(--accent-light); border:1px solid rgba(91,138,245,0.2); }
        .user-table { width:100%; border-collapse:collapse; margin-bottom:32px; }
        .user-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .user-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .user-table tr:hover td { background:var(--navy-light); }
        .user-email { color:var(--white); font-weight:500; }
        .user-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 8px; border-radius:4px; text-transform:uppercase; letter-spacing:0.3px; }
        .user-badge.admin { background:rgba(251,191,36,0.12); color:var(--warning); border:1px solid rgba(251,191,36,0.2); }
        .user-badge.user { background:var(--navy-light); color:var(--text-muted); border:1px solid var(--border); }
        .user-badge.active { background:var(--success-bg); color:var(--success); border:1px solid rgba(52,211,153,0.2); }
        .user-badge.inactive { background:var(--error-bg); color:var(--error); border:1px solid rgba(248,113,113,0.2); }
        .btn-toggle { padding:5px 12px; font-size:11px; font-weight:600; font-family:inherit; cursor:pointer; border-radius:6px; transition:var(--transition); border:1px solid var(--border); background:var(--navy-light); color:var(--text-secondary); }
        .btn-toggle:hover { background:var(--navy-hover); color:var(--white); border-color:var(--border-light); }
        .btn-toggle.deactivate:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        .btn-toggle.activate:hover { color:var(--success); border-color:rgba(52,211,153,0.3); background:var(--success-bg); }
        .settings-row { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:10px; }
        .settings-label { font-size:13px; color:var(--text); font-weight:500; }
        .settings-value { font-size:13px; color:var(--accent-light); font-weight:600; font-family:'JetBrains Mono',monospace; }
        .nav-link.admin-link { color:var(--warning); }
        .comp-cat-tab { display:inline-flex;align-items:center;gap:6px;padding:7px 14px;font-size:12px;font-weight:500;color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.15s; }
        .comp-cat-tab:hover { color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.05); }
        .comp-cat-tab.active { color:white;background:rgba(42,127,142,0.15);border-color:rgba(42,127,142,0.3); }
        .comp-cat-count { font-size:10px;padding:1px 6px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3); }
        .comp-cat-tab.active .comp-cat-count { background:rgba(42,127,142,0.2);color:rgba(255,255,255,0.6); }
        .comp-card:hover { transform:translateY(-2px);border-color:rgba(42,127,142,0.3) !important;background:rgba(255,255,255,0.03) !important; }
        .comp-card.active { border-color:rgba(42,127,142,0.5) !important;background:rgba(42,127,142,0.08) !important;box-shadow:0 0 20px rgba(42,127,142,0.1); }
        .prj-mode-card:hover { transform:translateY(-2px);border-color:rgba(42,127,142,0.3) !important; }
        .prj-mode-card.active { border-color:rgba(42,127,142,0.5) !important;background:rgba(42,127,142,0.08) !important;box-shadow:0 0 20px rgba(42,127,142,0.1); }
        .prj-tab { padding:8px 14px;font-size:12px;color:rgba(255,255,255,0.4);cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all 0.15s;flex-shrink:0; }
        .prj-tab:hover { color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.02);border-radius:6px 6px 0 0; }
        .prj-tab.active { color:var(--accent-light);border-bottom-color:var(--accent);font-weight:600; }
        .prj-tab-content { display:none; }
        .prj-tab-content.active { display:block; }
        .prj-main-tab-content { display:none; }
        .prj-main-tab-content.active { display:block; }
        .prj-inhalt-card:hover { border-color:rgba(42,127,142,0.4) !important; background:rgba(42,127,142,0.04) !important; }
        .nav-link.admin-link:hover,.nav-link.admin-link.active { color:var(--warning); background:rgba(251,191,36,0.08); }

        /* ── Password Modal ──────────────────────────────── */
        .modal-overlay { position:fixed; inset:0; z-index:9999; background:rgba(10,22,40,0.85); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:all 0.3s ease; }
        .modal-overlay.visible { opacity:1; visibility:visible; }
        .modal { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:36px; width:100%; max-width:400px; }
        .modal h3 { font-size:18px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .modal-input { width:100%; padding:12px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .modal-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
        .modal-msg { font-size:13px; padding:10px 14px; border-radius:var(--radius-sm); margin-bottom:12px; display:none; }
        .modal-msg.error { display:block; color:var(--error); background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); }
        .modal-msg.success { display:block; color:var(--success); background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); }
        .nav-user { cursor:pointer; transition:var(--transition); }
        .nav-user:hover { border-color:var(--accent); color:var(--text); }
        /* ── Profile ──────────────────────── */
        .profile-grid { display:grid; grid-template-columns:280px 1fr; gap:32px; }
        .profile-card { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; text-align:center; }
        .profile-avatar-wrap { position:relative; width:120px; height:120px; margin:0 auto 20px; }
        .profile-avatar { width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid var(--border); background:var(--navy-mid); display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--accent); overflow:hidden; }
        .profile-avatar img { width:100%; height:100%; object-fit:cover; }
        .profile-avatar-edit { position:absolute; bottom:4px; right:4px; width:32px; height:32px; border-radius:50%; background:var(--accent); border:2px solid var(--navy-card); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:var(--transition); }
        .profile-avatar-edit:hover { transform:scale(1.1); }
        .profile-avatar-edit svg { width:14px; height:14px; stroke:white; }
        .profile-name { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .profile-position { font-size:13px; color:var(--text-secondary); margin-bottom:16px; }
        .profile-meta { display:flex; flex-direction:column; gap:8px; text-align:left; padding-top:16px; border-top:1px solid var(--border); }
        .profile-meta-item { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--text-secondary); }
        .profile-meta-item svg { width:16px; height:16px; stroke:var(--text-muted); flex-shrink:0; }
        .profile-form { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; }
        .profile-form h3 { font-size:16px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .profile-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
        .profile-field { display:flex; flex-direction:column; gap:6px; }
        .profile-field.full { grid-column:1/-1; }
        .profile-field label { font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px; }
        .profile-field input, .profile-field textarea { background:var(--navy-mid); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 14px; color:var(--text); font-family:inherit; font-size:14px; transition:var(--transition); }
        .profile-field input:focus, .profile-field textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .profile-field textarea { resize:vertical; min-height:80px; }
        .profile-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .profile-tag { padding:4px 12px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); border-radius:20px; font-size:12px; color:var(--accent-light); display:flex; align-items:center; gap:4px; }
        .profile-tag .remove { cursor:pointer; opacity:0.6; } .profile-tag .remove:hover { opacity:1; }
        .profile-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; padding-top:20px; border-top:1px solid var(--border); }
        .linkedin-btn { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:#0a66c2; color:white; border:none; border-radius:var(--radius-sm); font-family:inherit; font-size:13px; font-weight:600; cursor:pointer; transition:var(--transition); }
        .linkedin-btn:hover { background:#004182; }
        .linkedin-btn.connected { background:var(--navy-mid); border:1px solid var(--border); color:var(--text-secondary); }
        .linkedin-section { margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }
        /* ── Chat ──────────────────────── */
        .chat-container { max-width:900px; margin:0 auto; display:flex; flex-direction:column; height:calc(100vh - 72px); padding:0 20px; }
        .chat-header { padding:24px 0 16px; text-align:center; flex-shrink:0; }
        .chat-header h2 { font-size:22px; font-weight:800; color:var(--white); margin-bottom:4px; }
        .chat-header h2 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .chat-header p { font-size:13px; color:var(--text-secondary); }
        .chat-messages { flex:1; overflow-y:auto; padding:8px 0 16px; display:flex; flex-direction:column; gap:16px; scroll-behavior:smooth; }
        .chat-messages::-webkit-scrollbar { width:6px; } .chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
        .chat-msg { display:flex; gap:12px; max-width:85%; animation:msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        .chat-msg.user { align-self:flex-end; flex-direction:row-reverse; }
        .chat-msg-avatar { width:32px; height:32px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
        .chat-msg.user .chat-msg-avatar { background:var(--accent-glow); color:var(--accent); border:1px solid rgba(91,138,245,0.3); }
        .chat-msg.assistant .chat-msg-avatar { background:linear-gradient(135deg,#1a2a47,#162244); color:var(--accent-light); border:1px solid var(--border); }
        .chat-msg-body { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:14px 18px; font-size:14px; line-height:1.7; color:var(--text); }
        .chat-msg.user .chat-msg-body { background:var(--accent-glow-strong); border-color:rgba(91,138,245,0.25); }
        .chat-msg-body p { margin-bottom:8px; } .chat-msg-body p:last-child { margin-bottom:0; }
        .chat-msg-body code { background:var(--navy-mid); padding:1px 6px; border-radius:4px; font-family:'JetBrains Mono',monospace; font-size:13px; }
        .chat-msg-body strong { color:var(--white); font-weight:600; }
        .chat-msg-body ul, .chat-msg-body ol { margin:8px 0; padding-left:20px; } .chat-msg-body li { margin:4px 0; }
        .chat-sources { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; padding-top:8px; border-top:1px solid var(--border); }
        .chat-source-tag { font-size:11px; padding:3px 10px; background:var(--navy-mid); border:1px solid var(--border); border-radius:12px; color:var(--text-secondary); }
        .chat-input-area { flex-shrink:0; padding:16px 0 24px; }
        .chat-input-wrap { display:flex; gap:10px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:8px 8px 8px 18px; transition:var(--transition); }
        .chat-input-wrap:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .chat-input { flex:1; background:none; border:none; color:var(--text); font-family:inherit; font-size:15px; outline:none; resize:none; max-height:120px; line-height:1.5; }
        .chat-input::placeholder { color:var(--text-muted); }
        .chat-send-btn { width:42px; height:42px; border-radius:12px; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--transition); flex-shrink:0; }
        .chat-send-btn:hover { background:var(--accent-light); transform:scale(1.05); }
        .chat-send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
        .chat-send-btn svg { width:18px; height:18px; stroke:white; }
        .chat-typing { display:flex; gap:4px; padding:8px 0; }
        .chat-typing span { width:8px; height:8px; border-radius:50%; background:var(--text-muted); animation:typing 1.4s ease-in-out infinite; }
        .chat-typing span:nth-child(2) { animation-delay:0.2s; } .chat-typing span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,60%,100% { transform:translateY(0); opacity:0.4; } 30% { transform:translateY(-6px); opacity:1; } }
        .chat-welcome { text-align:center; padding:60px 20px; }
        .chat-welcome-icon { width:80px; height:80px; border-radius:50%; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); display:flex; align-items:center; justify-content:center; margin:0 auto 24px; }
        .chat-welcome-icon img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
        .chat-welcome h3 { font-size:20px; font-weight:700; color:var(--white); margin-bottom:8px; }
        .chat-welcome p { font-size:14px; color:var(--text-secondary); max-width:500px; margin:0 auto 28px; line-height:1.6; }
        .chat-suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
        .chat-suggestion { padding:8px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:20px; font-size:13px; color:var(--text-secondary); cursor:pointer; transition:var(--transition); font-family:inherit; }
        .chat-suggestion:hover { border-color:var(--accent); color:var(--accent-light); background:var(--accent-glow); }

        /* ═══════ MODEL BUILDING ═══════ */
        .mb-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:32px; flex-wrap:wrap; gap:16px; }
        .mb-header h2 { font-size:24px; font-weight:700; color:var(--white); margin:0; }
        .mb-header p { font-size:14px; color:var(--text-secondary); margin:4px 0 0; }
        .mb-progress { display:flex; gap:4px; padding:16px 0; margin-bottom:28px; overflow-x:auto; }
        .mb-step-dot { display:flex; flex-direction:column; align-items:center; gap:6px; min-width:70px; cursor:pointer; }
        .mb-step-num { width:34px; height:34px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; border:2px solid var(--border); color:var(--text-muted); background:var(--navy-light); transition:var(--transition); }
        .mb-step-dot.active .mb-step-num { border-color:var(--accent); color:var(--white); background:var(--accent); box-shadow:0 0 16px var(--accent-glow); }
        .mb-step-dot.completed .mb-step-num { border-color:var(--success); color:var(--white); background:var(--success); }
        .mb-step-dot.completed .mb-step-num::after { content:'✓'; }
        .mb-step-label { font-size:10px; color:var(--text-muted); text-align:center; white-space:nowrap; transition:var(--transition); }
        .mb-step-dot.active .mb-step-label { color:var(--accent-light); font-weight:600; }
        .mb-step-dot.completed .mb-step-label { color:var(--success); }
        .mb-step-line { flex:1; height:2px; background:var(--border); align-self:center; margin:0 -8px; margin-bottom:22px; }
        .mb-step-line.completed { background:var(--success); }

        .mb-panel { display:none; animation:fadeIn 0.3s ease; }
        .mb-panel.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

        .mb-step-title { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-step-desc { font-size:14px; color:var(--text-secondary); margin-bottom:24px; line-height:1.6; }

        .mb-choices { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:24px; }
        .mb-choice { padding:20px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); position:relative; }
        .mb-choice:hover { border-color:var(--border-light); background:var(--navy-card); transform:translateY(-2px); }
        .mb-choice.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-choice-num { position:absolute; top:12px; right:14px; width:24px; height:24px; border-radius:50%; background:var(--navy-mid); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--text-muted); }
        .mb-choice.selected .mb-choice-num { background:var(--accent); border-color:var(--accent); color:var(--white); }
        .mb-choice-icon { font-size:24px; margin-bottom:10px; }
        .mb-choice-title { font-size:15px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .mb-choice-desc { font-size:12px; color:var(--text-secondary); line-height:1.5; }
        .mb-choice-meta { font-size:11px; color:var(--text-muted); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
        .mb-choice.custom-choice { border-style:dashed; }

        .mb-actions { display:flex; gap:12px; margin-top:24px; }
        .mb-btn { padding:12px 28px; border-radius:var(--radius); font-size:14px; font-weight:600; cursor:pointer; transition:var(--transition); border:none; font-family:inherit; }
        .mb-btn-primary { background:var(--accent); color:var(--white); }
        .mb-btn-primary:hover { background:var(--accent-light); box-shadow:0 4px 16px rgba(91,138,245,0.3); }
        .mb-btn-primary:disabled { opacity:0.4; cursor:not-allowed; }
        .mb-btn-secondary { background:var(--navy-light); color:var(--text-secondary); border:1px solid var(--border); }
        .mb-btn-secondary:hover { color:var(--white); border-color:var(--border-light); }
        .mb-btn-back { background:none; color:var(--text-muted); border:1px solid var(--border); }

        .mb-input { width:100%; padding:12px 16px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .mb-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-textarea { min-height:80px; resize:vertical; }
        .mb-label { font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; display:block; }

        .mb-info-box { padding:16px 20px; background:rgba(91,138,245,0.06); border:1px solid rgba(91,138,245,0.15); border-radius:var(--radius); margin-bottom:20px; }
        .mb-info-box p { font-size:13px; color:var(--text-secondary); line-height:1.6; margin:0; }
        .mb-info-box strong { color:var(--accent-light); }
        .mb-inline-progress { margin-top:20px;padding:20px;background:rgba(139,170,255,0.04);border:1px solid rgba(139,170,255,0.1);border-radius:var(--radius); }
        .mb-prog-header { display:flex;align-items:center;gap:12px;margin-bottom:14px; }
        .mb-prog-spinner { width:18px;height:18px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0; }
        .mb-prog-bar-bg { height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;margin-bottom:8px; }
        .mb-prog-bar { height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#818cf8);border-radius:3px;transition:width 0.6s ease; }
        .mb-prog-meta { display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:12px; }
        .mb-prog-stages { display:flex;flex-direction:column;gap:4px; }
        .mb-prog-stage { display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,0.35);transition:all 0.3s; }
        .mb-prog-stage.active { color:rgba(255,255,255,0.9); }
        .mb-prog-stage.done { color:rgba(34,197,94,0.8); }
        .mb-prog-dot { width:16px;height:16px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0; }
        .mb-prog-stage.active .mb-prog-dot { border-color:var(--accent);background:rgba(139,170,255,0.15); }
        .mb-prog-stage.done .mb-prog-dot { border-color:#22c55e;background:rgba(34,197,94,0.15); }

        .mb-registry { display:grid; gap:12px; margin-top:20px; }
        .mb-model-card { padding:16px 20px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); display:flex; align-items:center; gap:16px; transition:var(--transition); cursor:pointer; }
        .mb-model-card:hover { border-color:var(--border-light); background:var(--navy-card); }
        .mb-model-id { font-size:11px; font-weight:700; color:var(--accent); background:var(--accent-glow); padding:4px 10px; border-radius:12px; white-space:nowrap; }
        .mb-model-info { flex:1; }
        .mb-model-name { font-size:14px; font-weight:600; color:var(--white); }
        .mb-model-meta { font-size:12px; color:var(--text-muted); margin-top:2px; }
        .mb-model-version { font-size:11px; color:var(--text-muted); background:var(--navy-mid); padding:3px 8px; border-radius:8px; }

        .mb-summary { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:20px; }
        .mb-summary-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
        .mb-summary-row:last-child { border-bottom:none; }
        .mb-summary-label { color:var(--text-muted); }
        .mb-summary-value { color:var(--white); font-weight:600; }

        .mb-mode-cards { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
        .mb-mode-card { padding:20px 16px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; text-align:center; transition:var(--transition); }
        .mb-mode-card:hover { border-color:var(--border-light); transform:translateY(-2px); }
        .mb-mode-card.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); }
        .mb-mode-icon { font-size:28px; margin-bottom:10px; }
        .mb-mode-name { font-size:14px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-mode-time { font-size:11px; color:var(--accent-light); margin-bottom:6px; }
        .mb-mode-desc { font-size:11px; color:var(--text-muted); line-height:1.4; }

        .nav-hamburger { display:none; width:36px; height:36px; align-items:center; justify-content:center; background:none; border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-secondary); transition:var(--transition); }
        .nav-hamburger:hover { border-color:var(--border-light); color:var(--white); }
        .nav-hamburger svg { width:18px; height:18px; }
        @media (max-width:768px) { .mb-choices { grid-template-columns:1fr; } .mb-mode-cards { grid-template-columns:1fr 1fr; } #brfTypeCards { grid-template-columns:1fr 1fr !important; } #brfStep2Content .mb-choice { padding:8px 10px !important; } #caConfirmContent > div:first-child { grid-template-columns:1fr !important; } }
        @media (max-width:768px) { .profile-grid { grid-template-columns:1fr; } .profile-row { grid-template-columns:1fr; } }
        @media (max-width:640px) {
            .nav { padding:0 10px; flex-wrap:wrap; height:auto; min-height:48px; }
            .nav-brand { gap:8px; }
            .nav-brand .nav-title { font-size:15px; }
            .nav-brand .nav-logo-img { width:28px; height:28px; }
            .nav-links { display:none; width:100%; order:3; flex-direction:column; padding:8px 0 12px; border-top:1px solid var(--border); }
            .nav-links.mobile-open { display:flex; }
            .nav-links .nav-link { padding:12px 16px; font-size:14px; border-radius:8px; }
            .nav-links .nav-dropdown { width:100%; }
            .nav-links .nav-dropdown-trigger { width:100%; padding:12px 16px; font-size:14px; justify-content:flex-start; }
            .nav-links .nav-dropdown-menu { position:static; background:rgba(15,30,55,0.6); border:none; box-shadow:none; margin:0; padding:0 0 0 20px; border-radius:0; }
            .nav-links .nav-dropdown-item { padding:10px 16px; font-size:13px; }
            .nav-links .nav-dropdown.open .nav-dropdown-menu { display:flex; flex-direction:column; }
            .nav-right { order:2; gap:4px; margin-left:auto; }
            .nav-right .nav-status { display:none; }
            .nav-right .nav-logout { display:none; }
            .nav-right #appVersion { display:none; }
            .nav-right .nav-user { font-size:11px; padding:4px 10px; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
            .nav-right .admin-link { padding:4px; }
            .nav-right .admin-link svg { width:13px; height:13px; }
            .nav-hamburger { display:flex; order:1; margin-left:auto; margin-right:4px; width:32px; height:32px; }
            .hero { padding:48px 16px 40px; } .hero h1 { font-size:28px; }
            .hero-stats { gap:20px; } .container { padding:24px 16px 60px; } .db-selector { grid-template-columns:1fr; }
            .input-row { grid-template-columns:1fr; } .upload-zone { padding:36px 20px; } .actions { flex-direction:column; gap:12px; }
            .auth-card { padding:36px 24px; } .auth-title { font-size:24px; }
            #caPsiCards { grid-template-columns:repeat(2,1fr) !important; }
            .mb-mode-cards { grid-template-columns:1fr !important; }
            .mb-choices { grid-template-columns:1fr !important; }
        }
    </style>
</head>
<body>

    <!-- ═══════ AUTH OVERLAY ═══════ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <img src="/logo.jpeg" alt="BEATRIX" class="auth-logo">
            <h1 class="auth-title">BEATRIX <span>Lab</span></h1>
            <p class="auth-subtitle">Strategic Intelligence Suite</p>

            <!-- LOGIN PANEL -->
            <div class="auth-panel active" id="loginPanel">
                <div class="auth-form">
                    <div class="auth-error" id="loginError"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="loginEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="loginPassword" placeholder="Passwort" autocomplete="current-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="loginBtn" onclick="doLogin()">Anmelden</button>
                    <div style="text-align:center;margin-top:10px"><a onclick="showAuthPanel('forgot')" style="font-size:13px;color:var(--accent);cursor:pointer">Passwort vergessen?</a></div>
                </div>
                <div class="auth-switch">Noch kein Konto? <a onclick="showAuthPanel('register')">Jetzt registrieren</a></div>
            </div>

            <!-- REGISTER PANEL -->
            <div class="auth-panel" id="registerPanel">
                <div class="auth-form">
                    <div class="auth-error" id="registerError"></div>
                    <div class="auth-success" id="registerSuccess"></div>
                    <div class="auth-input-wrapper">
                        <input type="text" class="auth-input" id="regName" placeholder="Name (optional)" autocomplete="name">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="regEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="regPassword" placeholder="Passwort (mind. 6 Zeichen)" autocomplete="new-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="registerBtn" onclick="doRegister()">Registrieren</button>
                    <div id="resendArea" style="display:none;margin-top:12px;text-align:center;font-size:13px;color:var(--text-muted)">
                        Keine E-Mail erhalten? <a onclick="resendVerification()" style="color:var(--accent);cursor:pointer;font-weight:600">Erneut senden</a>
                    </div>
                </div>
                <div class="auth-switch">Bereits registriert? <a onclick="showAuthPanel('login')">Anmelden</a></div>
            </div>

            <!-- FORGOT PASSWORD PANEL -->
            <div class="auth-panel" id="forgotPanel">
                <div class="auth-form">
                    <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px;text-align:center">Gib deine E-Mail-Adresse ein und wir senden dir einen Link zum Zurücksetzen deines Passworts.</p>
                    <div class="auth-error" id="forgotError"></div>
                    <div class="auth-success" id="forgotSuccess" style="display:none;padding:12px;background:var(--success-bg);border:1px solid rgba(52,211,153,0.15);border-radius:var(--radius-sm);color:var(--success);font-size:13px;margin-bottom:12px"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="forgotEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <button class="auth-btn" id="forgotBtn" onclick="doForgotPassword()">Reset-Link senden</button>
                </div>
                <div class="auth-switch">Zurück zur <a onclick="showAuthPanel('login')">Anmeldung</a></div>
            </div>

            <div class="auth-footer"><a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</div>
        </div>
    </div>

    <!-- ═══════ MAIN APP ═══════ -->
    <nav class="nav">
        <a href="#" class="nav-brand" onclick="showSection('hero')"><img src="/logo.jpeg" alt="BEATRIX" class="nav-logo-img"><span class="nav-title">BEATRIX</span></a>
        <button class="nav-hamburger" id="navHamburger" onclick="toggleMobileNav()" aria-label="Menu">
            <svg id="hamburgerIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-section="chat" onclick="showSection('chat',this)">💬 Fragen</a>
            <a href="#" class="nav-link" id="navTopProjects" data-section="myprojects" onclick="showSection('myprojects',this)" style="display:none">📋 Projekte</a>
            <div class="nav-dropdown" id="navDropBehavioral">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropBehavioral')">
                    🧠 Behavioral Design <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <div class="nav-dropdown-header">Einstieg</div>
                    <a class="nav-dropdown-item" data-section="briefing" onclick="navDropClick('briefing',this)">
                        📋 Briefing
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Verstehen</div>
                    <a class="nav-dropdown-item" id="navDropContext" data-section="context" onclick="navDropClick('context',this)">
                        🔬 Kontext-Analyse
                    </a>
                    <a class="nav-dropdown-item" data-section="segments" onclick="navDropClick('segments',this)">
                        👥 Segment-Analyse
                    </a>
                    <a class="nav-dropdown-item" data-section="journey" onclick="navDropClick('journey',this)">
                        🗺️ Behavioral Journey
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Gestalten</div>
                    <a class="nav-dropdown-item" data-section="nutzen" onclick="navDropClick('nutzen',this)">
                        💎 Nutzen & Anreize
                    </a>
                    <a class="nav-dropdown-item" data-section="architektur" onclick="navDropClick('architektur',this)">
                        ⚖️ Entscheidungsarchitektur
                    </a>
                    <a class="nav-dropdown-item" data-section="model" onclick="navDropClick('model',this)">
                        🏗️ Modell-Building
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Messen</div>
                    <a class="nav-dropdown-item" data-section="audit" onclick="navDropClick('audit',this)">
                        📊 Behavioral Audit
                    </a>
                    <a class="nav-dropdown-item" data-section="wirkung" onclick="navDropClick('wirkung',this)">
                        📈 Wirkungsmessung
                    </a>
                    <div class="nav-dropdown-divider"></div>
                    <div class="nav-dropdown-header">Prüfen</div>
                    <a class="nav-dropdown-item" data-section="evidenz" onclick="navDropClick('evidenz',this)">
                        🧪 Evidenz-Check
                    </a>
                </div>
            </div>
            <div class="nav-dropdown" id="navDropWissen">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropWissen')">
                    📚 Wissen <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <a class="nav-dropdown-item" data-section="upload" onclick="navDropClick('upload',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Upload
                    </a>
                    <a class="nav-dropdown-item" data-section="documents" onclick="navDropClick('documents',this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Dokumente
                    </a>
                </div>
            </div>
            <div class="nav-dropdown" id="navDropBusiness" style="display:none">
                <button class="nav-dropdown-trigger" onclick="toggleDropdown('navDropBusiness')">
                    📊 Business <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="nav-dropdown-menu">
                    <a class="nav-dropdown-item" id="navDropMyProjects" data-section="myprojects" onclick="navDropClick('myprojects',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        Kundenprojekte
                    </a>
                    <a class="nav-dropdown-item" id="navDropLeads" data-section="leads" onclick="navDropClick('leads',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        CRM
                    </a>
                    <a class="nav-dropdown-item" id="navDropCompanies" data-section="companies" onclick="navDropClick('companies',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
                        Firmen
                    </a>
                    <a class="nav-dropdown-item" id="navDropProjects" data-section="projects" onclick="navDropClick('projects',this)" style="display:none">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        Alle Projekte
                    </a>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <div class="nav-status"><span class="dot"></span> Online</div>
            <span style="font-size:10px;color:rgba(255,255,255,0.15);margin-left:4px" id="appVersion">v3.17</span>
            <a href="#" class="nav-link admin-link" data-section="admin" id="navAdmin" onclick="showSection('admin',this)" style="display:none" title="Admin">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </a>
            <span class="nav-user" id="navUser" onclick="showSection('profile')" title="Profil"></span>
            <button class="nav-logout" onclick="doLogout()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Abmelden
            </button>
        </div>
    </nav>

    <section class="hero" id="hero-section" style="display:none">
        <img src="/logo.jpeg" alt="BEATRIX Logo" class="hero-logo">
        <h1>BEATRIX <span>Intelligence Suite</span></h1>
        <p class="subtitle">Knowledge Base für Behavioral Economics. Lade Dokumente, Axiome und Research Papers in die BEATRIX-Datenbank.</p>
        <div class="hero-stats">
            <div class="hero-stat"><div class="num" id="statDocs">–</div><div class="label">Dokumente</div></div>
            <div class="hero-stat"><div class="num" id="statKB">–</div><div class="label">Knowledge Base</div></div>
            <div class="hero-stat"><div class="num" id="statAxioms">–</div><div class="label">BCM Axiome</div></div>
        </div>
    </section>

    <!-- ═══════ CHAT SECTION ═══════ -->
    <section class="section active" id="chat-section">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Frag <span>BEATRIX</span></h2>
                <p>Deine Fragen zu Behavioral Economics, BCM und der Knowledge Base</p>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome" id="chatWelcome">
                    <div class="chat-welcome-icon"><img src="/logo.jpeg" alt="BEATRIX"></div>
                    <h3>Hallo! Ich bin BEATRIX.</h3>
                    <p>Stelle mir eine Frage zu Behavioral Economics, zum Behavioral Competence Model oder zu Dokumenten in der Knowledge Base.</p>
                    <div class="chat-suggestions">
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Was ist das BCM?</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Erkläre Complementarity</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(52,211,153,0.2);color:rgba(52,211,153,0.6)">📋 Neues Projekt eröffnen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(251,191,36,0.2);color:rgba(251,191,36,0.6)">🎯 Neuen Lead erfassen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(139,170,255,0.2);color:rgba(139,170,255,0.6)">🔬 BCM-Modell bauen</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)" style="border-color:rgba(232,163,61,0.2);color:rgba(232,163,61,0.6)">🧠 Ausgangslage erfassen</button>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div id="prjChatIndicator" style="display:none;padding:6px 14px;margin-bottom:6px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:8px;font-size:11px;color:rgba(42,127,142,0.7)">
                    💡 <strong>BEATRIX Command Mode</strong> – Projekte, Leads, Modelle, Kontext per Sprache.
                    <span onclick="toggleBxCmd()" style="cursor:pointer;margin-left:8px;color:rgba(255,255,255,0.3)">✕</span>
                </div>
                <div class="chat-input-wrap" style="display:flex;align-items:flex-end;gap:6px">
                    <button id="prjChatToggle" onclick="toggleBxCmd()" style="padding:8px 10px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:14px;cursor:pointer;flex-shrink:0;transition:all 0.15s;line-height:1" title="BEATRIX Command Mode">💡</button>
                    <div style="flex:1;position:relative">
                        <textarea class="chat-input" id="chatInput" placeholder="Stelle eine Frage an BEATRIX..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}" oninput="autoResize(this)"></textarea>
                    </div>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()" title="Senden">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="upload-section">
        <div class="container">
            <div class="section-header"><h2>Dokument hochladen</h2><p>PDFs, Texte und Axiom-Definitionen in die BEATRIX Knowledge Base einfügen.</p></div>
            <div class="db-selector">
                <div class="db-option selected" data-db="knowledge_base" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--accent)"></span> Knowledge Base</div><div class="db-option-desc">Dokumente & Literatur</div></div>
                <div class="db-option" data-db="bcm_axioms" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--success)"></span> BCM Axiome</div><div class="db-option-desc">Axiom-Definitionen</div></div>
                <div class="db-option" data-db="research" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--warning)"></span> Research Papers</div><div class="db-option-desc">Akademische Publikationen</div></div>
            </div>
            <div class="tabs"><button class="tab active" onclick="switchTab('file',this)">Datei-Upload</button><button class="tab" onclick="switchTab('text',this)">Text eingeben</button></div>
            <div class="file-section active" id="file-section">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    <h3>Dateien hierher ziehen oder <span>durchsuchen</span></h3>
                    <p>Maximal 50 MB pro Datei</p>
                    <div class="upload-formats"><span class="format-badge">PDF</span><span class="format-badge">TXT</span><span class="format-badge">MD</span><span class="format-badge">DOCX</span><span class="format-badge">CSV</span><span class="format-badge">JSON</span></div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md,.docx,.csv,.json" style="display:none">
                <div class="file-list" id="fileList"></div>
            </div>
            <div class="text-section" id="text-section">
                <div class="input-group"><label>Titel</label><input type="text" class="input-field" id="textTitle" placeholder="z.B. Axiom INU-3200 Definition"></div>
                <div class="input-row">
                    <div class="input-group"><label>Kategorie</label><select class="input-field" id="textCategory"><option value="general">Allgemein</option><option value="axiom">Axiom</option><option value="paper">Paper</option><option value="note">Notiz</option></select></div>
                    <div class="input-group"><label>Sprache</label><select class="input-field" id="textLang"><option value="de">Deutsch</option><option value="en">English</option></select></div>
                </div>
                <div class="input-group"><label>Tags</label><div class="tag-container" onclick="this.querySelector('.tag-input').focus()"><input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter"></div></div>
                <div class="input-group"><label>Inhalt</label><textarea class="textarea-field" id="textContent" placeholder="Text oder Axiom-Definition hier einfügen..."></textarea></div>
            </div>
            <div class="actions">
                <span class="upload-count" id="uploadCount"></span>
                <div style="display:flex;gap:10px;align-items:center">
                    <button class="btn btn-secondary" onclick="clearAll()">Zurücksetzen</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitUpload()">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        In Datenbank laden
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="documents-section">
        <div class="container"><div class="section-header"><h2>Dokumente</h2><p>Übersicht aller indexierten Dokumente in der BEATRIX Knowledge Base.</p></div><div id="docTableWrapper"></div></div>
    </section>

    <!-- ═══════ MODEL BUILDING SECTION ═══════ -->
    <section class="section" id="model-section">
        <div class="container">
            <div class="mb-header">
                <div>
                    <h2>Modell-Building</h2>
                    <p>Evidenzbasierte Verhaltensmodelle mit dem EEE Workflow designen</p>
                </div>
                <button class="mb-btn mb-btn-secondary" onclick="mbShowRegistry()" id="mbRegistryBtn">📋 Modell-Registry (21)</button>
            </div>

            <!-- PROGRESS BAR -->
            <div class="mb-progress" id="mbProgress" style="display:none">
                <div class="mb-step-dot active" data-step="0"><div class="mb-step-num">0</div><div class="mb-step-label">Init</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="1"><div class="mb-step-num">1</div><div class="mb-step-label">Entry Point</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="2"><div class="mb-step-num">2</div><div class="mb-step-label">Scope</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="3"><div class="mb-step-num">3</div><div class="mb-step-label">Kontext Ψ</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="4"><div class="mb-step-num">4</div><div class="mb-step-label">Modell</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="5"><div class="mb-step-num">5</div><div class="mb-step-label">Parameter</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="6"><div class="mb-step-num">6</div><div class="mb-step-label">Ergebnis</div></div>
            </div>

            <!-- ═══ START: Mode Selection ═══ -->
            <div class="mb-panel active" id="mbStart">
                <div class="mb-step-title">Neues Verhaltensmodell designen</div>
                <div class="mb-step-desc">Der EEE Workflow (Appendix EEE: METHOD-DESIGN) führt dich Schritt für Schritt zum evidenzbasierten Modell. Wähle deinen Modus:</div>

                <div class="mb-mode-cards">
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'schnell')">
                        <div class="mb-mode-icon">⚡</div>
                        <div class="mb-mode-name">Schnell</div>
                        <div class="mb-mode-time">~10 Minuten</div>
                        <div class="mb-mode-desc">3 Fragen → komplettes 10C Modell via GGG Defaults</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'gefuehrt')">
                        <div class="mb-mode-icon">🎯</div>
                        <div class="mb-mode-name">Geführt</div>
                        <div class="mb-mode-time">~45 Minuten</div>
                        <div class="mb-mode-desc">Alle Steps mit Erklärungen & 3+1 Optionen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'template')">
                        <div class="mb-mode-icon">📦</div>
                        <div class="mb-mode-name">Template</div>
                        <div class="mb-mode-time">~20 Minuten</div>
                        <div class="mb-mode-desc">Seed-Modell aus Registry anpassen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'custom')">
                        <div class="mb-mode-icon">🔧</div>
                        <div class="mb-mode-name">Custom</div>
                        <div class="mb-mode-time">Variabel</div>
                        <div class="mb-mode-desc">Freie Gestaltung, maximale Kontrolle</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-primary" id="mbStartBtn" disabled onclick="mbStartWorkflow()">Workflow starten →</button>
                </div>
            </div>

            <!-- ═══ STEP 0: Session Init ═══ -->
            <div class="mb-panel" id="mbStep0">
                <!-- VIEW A: Choices -->
                <div id="mbStep0ViewA">
                    <div class="mb-step-title">Wähle deine Problemstellung</div>
                    <div class="mb-step-desc">BEATRIX leitet daraus Domain, Scope und Lieferobjekte ab.</div>

                    <div id="mbStep0Choices" style="display:flex;flex-direction:column;gap:10px;margin:20px 0">
                        <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                            <div style="font-size:24px;margin-bottom:8px">⏳</div>
                            Lade personalisierte Vorschläge...
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:8px">
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbShowCustomInput()">
                            <div class="mb-choice-icon" style="font-size:16px">✏️</div>
                            <div class="mb-choice-title">Eigene Problemstellung</div>
                        </div>
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbLetBeatrixDefine()">
                            <div class="mb-choice-icon" style="font-size:16px">🤖</div>
                            <div class="mb-choice-title">BEATRIX definiert</div>
                        </div>
                    </div>

                    <div id="mbCustomInput" style="display:none;margin-top:16px">
                        <textarea class="mb-input mb-textarea" id="mbQuestion" placeholder="Beschreibe das Verhalten, die Entscheidung oder das Phänomen, das du modellieren möchtest..." style="min-height:80px"></textarea>
                        <div style="margin-top:10px">
                            <button class="mb-btn mb-btn-primary" onclick="mbProcessStep0()">Analysieren →</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW B: Analysis (hidden initially) -->
                <div id="mbStep0ViewB" style="display:none">
                    <div class="mb-step-title">Session-Analyse</div>
                    <div id="mbStep0SelectedQ" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;line-height:1.6"></div>

                    <div id="mbProgress0" class="mb-inline-progress" style="display:none"></div>

                    <div id="mbStep0Result" style="display:none">
                        <div class="mb-summary" id="mbSessionSummary"></div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep0Back()">↻ Andere Frage</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep0Btn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 1: Entry Point ═══ -->
            <div class="mb-panel" id="mbStep1">
                <div id="mbStep1ViewA">
                    <div class="mb-step-title">Entry Point wählen</div>
                    <div class="mb-step-desc">Starte mit Theorie oder Praxis?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'theory')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📚</div>
                            <div class="mb-choice-title">Theory-Driven</div>
                            <div class="mb-choice-desc">Start mit existierenden CORE Appendices (AAA-AW). Passt, wenn du ein EBF-Konzept anwenden möchtest.</div>
                            <div class="mb-choice-meta">→ Begin with EBF concept</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'practice')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎯</div>
                            <div class="mb-choice-title">Practice-Driven</div>
                            <div class="mb-choice-desc">Start mit konkretem Problem oder Situation. Passt, wenn du ein reales Verhalten modellieren musst.</div>
                            <div class="mb-choice-meta">→ Begin with Gestaltungsanlass</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'hybrid')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Hybrid</div>
                            <div class="mb-choice-desc">Abwechselnde Theorie-Praxis-Zyklen. Passt, wenn Iteration erforderlich ist.</div>
                            <div class="mb-choice-meta">→ Theory ↔ Practice Iteration</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Freie Wahl — du definierst den Entry Point selbst.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep1Btn" onclick="mbConfirmAndAdvance(1,2)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 2: Scope ═══ -->
            <div class="mb-panel" id="mbStep2">
                <div id="mbStep2ViewA">
                    <div class="mb-step-title">Scope wählen</div>
                    <div class="mb-step-desc">Welchen Verhaltenstyp modellierst du?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'decision')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">⚖️</div>
                            <div class="mb-choice-title">Decision</div>
                            <div class="mb-choice-desc">Einmalentscheidung: Rentenmodell wählen, Impfung, Jobwechsel, Kaufentscheid.</div>
                            <div class="mb-choice-meta">Mathematik: Logistic / Binary Choice</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'continuous')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">📈</div>
                            <div class="mb-choice-title">Continuous</div>
                            <div class="mb-choice-desc">Wiederholtes Verhalten: Sparbetrag, Energieverbrauch, Trainingsfrequenz.</div>
                            <div class="mb-choice-meta">Mathematik: Linear / CES Functional Form</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'process')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Process</div>
                            <div class="mb-choice-desc">Veränderung über Zeit: Habit-Bildung, Learning, Adoption Journey.</div>
                            <div class="mb-choice-meta">Mathematik: Dynamic / BCJ Models</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Spezifisch definieren — kombiniere oder erweitere die Typen.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(1)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep2Btn" onclick="mbConfirmAndAdvance(2,3)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 3: Context Ψ ═══ -->
            <div class="mb-panel" id="mbStep3">
                <div id="mbStep3ViewA">
                    <div class="mb-step-title">Kontext-Spezifikation (Ψ)</div>
                    <div class="mb-step-desc">Welche Kontextdimensionen sind relevant?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'ggg-default')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📊</div>
                            <div class="mb-choice-title">GGG Defaults</div>
                            <div class="mb-choice-desc">Vorkonfigurierte Ψ-Werte nach Domain & Level aus Tabelle GGG-1 (trust, digital_adoption, autonomy, risk_aversion).</div>
                            <div class="mb-choice-meta">Empfohlen für Schnell-Modus</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'custom-psi')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎛️</div>
                            <div class="mb-choice-title">Custom Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Du definierst explizit welche Ψ-Faktoren relevant sind (z.B. Saisonalität, Peer Effects, Availability).</div>
                            <div class="mb-choice-meta">Für spezifische Kontexte</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'full-8psi')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔬</div>
                            <div class="mb-choice-title">Alle 8 Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Vollständige Analyse aller 8 Kontextdimensionen.</div>
                            <div class="mb-choice-meta">Maximale Tiefe</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep3Btn" onclick="mbProcessStep3()">BEATRIX analysieren lassen →</button>
                    </div>
                </div>

                <!-- ViewB: Processing -->
                <div id="mbStep3ViewB" style="display:none">
                    <div class="mb-step-title">Ψ-Kontext wird analysiert</div>
                    <div id="mbStep3Selection" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0"></div>
                    <div id="mbProgress3" class="mb-inline-progress" style="display:none"></div>
                    <div id="mbStep3Result" style="margin-top:16px"></div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep3Back()">↻ Andere Wahl</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep3NextBtn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- ═══ STEP 4: Model ═══ -->
            <div class="mb-panel" id="mbStep4">
                <div class="mb-step-title">Schritt 4: Modell-Spezifikation</div>
                <div class="mb-step-desc">BEATRIX durchsucht die Modell-Registry und baut das 10C-Mapping.</div>
                <div id="mbModelResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">📊</div>
                        Klicke «Modell erstellen» um die Analyse zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(3)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep4Btn" onclick="mbRunStep4()">Modell erstellen →</button>
                </div>
            </div>

            <!-- ═══ STEP 5: Parameters ═══ -->
            <div class="mb-panel" id="mbStep5">
                <div class="mb-step-title">Schritt 5: Parameter-Schätzung</div>
                <div class="mb-step-desc">LLMMC Prior generieren und Bayesian Updating mit BCM2 & Papers.</div>
                <div id="mbParamResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">🔬</div>
                        Klicke «Parameter schätzen» um die Berechnung zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(4)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep5Btn" onclick="mbRunStep5()">Parameter schätzen →</button>
                </div>
            </div>

            <!-- ═══ STEP 6: Result ═══ -->
            <div class="mb-panel" id="mbStep6">
                <div class="mb-step-title">Schritt 6: Ergebnis & Report</div>
                <div class="mb-step-desc">Wähle die Report-Tiefe. BEATRIX streamt den Bericht live.</div>

                <!-- Depth Choice -->
                <div id="mbDepthChoice" style="display:flex;gap:12px;margin:20px 0">
                    <div onclick="mbSelectDepth('standard', this)" id="mbDepthStd" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">📋 Standard</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Kompakter Report mit Key Facts, 10C Mapping, BCM Parametern und Handlungsempfehlungen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~15 Sek. · 1–2 Seiten</div>
                    </div>
                    <div onclick="mbSelectDepth('deep', this)" id="mbDepthDeep" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">🔬 Standard++</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Vertiefte Analyse mit Ψ-Kontext-Matrix, Sensitivitätsanalyse, Interventions-Roadmap und Detail-Tabellen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~30 Sek. · 4–6 Seiten</div>
                    </div>
                </div>

                <!-- Progress Container -->
                <div id="mbComputeProgress" style="margin:24px 0;display:none">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div id="mbComputeSpinner" style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                        <div>
                            <div id="mbComputeStage" style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)">Verbinde mit BEATRIX...</div>
                            <div id="mbComputeDetail" style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px"></div>
                        </div>
                    </div>
                    <div id="mbComputeStages"></div>
                    <div id="mbComputeTime" style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px"></div>
                    <div id="mbProgressBar" style="display:none"></div>
                    <div id="mbComputePercent" style="display:none"></div>
                </div>

                <!-- Result (streamed) -->
                <div id="mbResultContent" style="display:none"></div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(5)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbComputeBtn" onclick="mbComputeResult()" disabled style="opacity:0.4">Report generieren →</button>
                    <button class="mb-btn mb-btn-primary" id="mbExportBtn" onclick="mbExportModel()" style="display:none">📄 Exportieren</button>
                    <button class="mb-btn mb-btn-secondary" onclick="mbGoToStart()" style="display:none" id="mbNewModelBtn">Neues Modell</button>
                </div>
            </div>

            <!-- ═══ REGISTRY VIEW ═══ -->
            <div class="mb-panel" id="mbRegistry">
                <div class="mb-step-title">Modell-Registry</div>
                <div class="mb-step-desc">21 evidenzbasierte Modelle im EBF Framework.</div>
                <div class="mb-registry" id="mbRegistryList"></div>
                <div class="mb-actions" style="margin-top:20px">
                    <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück zum Workflow</button>
                </div>
            </div>

        </div>
    </section>

    <!-- ═══════ AUSGANGSLAGE / KONTEXT SECTION ═══════ -->
    <section class="section" id="context-section">
        <div class="container">
            <div class="mb-header">
                <div>
                    <h2>Kontext-Analyse</h2>
                    <p>8 Ψ-Dimensionen × 5-Ebenen-Hierarchie — weil ohne Kontext jede Antwort falsch ist</p>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="mb-btn mb-btn-secondary" onclick="caShowHistory()" id="caHistoryBtn">📋 Bisherige Analysen</button>
                </div>
            </div>

            <!-- PROGRESS BAR -->
            <div class="mb-progress" id="caProgress" style="display:none">
                <div class="mb-step-dot active" data-castep="0"><div class="mb-step-num">1</div><div class="mb-step-label">Thema</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="1"><div class="mb-step-num">2</div><div class="mb-step-label">Kontext</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="2"><div class="mb-step-num">3</div><div class="mb-step-label">Situation</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="3"><div class="mb-step-num">4</div><div class="mb-step-label">Analyse</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-castep="4"><div class="mb-step-num">5</div><div class="mb-step-label">Ergebnis</div></div>
            </div>

            <!-- ═══ START: Mode Selection ═══ -->
            <div class="mb-panel active" id="caStart">
                <div class="mb-step-title">Neue Kontextanalyse starten</div>
                <div class="mb-step-desc">Die Kontextanalyse identifiziert alle relevanten Einflussfaktoren auf Verhalten und Entscheidungen. Jeder Kontext — Land, Branche, Organisation, Situation — verändert, wie Menschen sich verhalten.</div>

                <div class="mb-mode-cards">
                    <div class="mb-mode-card" onclick="caSelectMode(this,'schnell')">
                        <div class="mb-mode-icon">⚡</div>
                        <div class="mb-mode-name">Schnell</div>
                        <div class="mb-mode-time">~5 Minuten</div>
                        <div class="mb-mode-desc">Frage eingeben → BEATRIX analysiert alle 5 Ebenen automatisch</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'gefuehrt')">
                        <div class="mb-mode-icon">🎯</div>
                        <div class="mb-mode-name">Geführt</div>
                        <div class="mb-mode-time">~15 Minuten</div>
                        <div class="mb-mode-desc">Schritt für Schritt: Land → Branche → Situation, mit Auswahlhilfen</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'projekt')">
                        <div class="mb-mode-icon">📊</div>
                        <div class="mb-mode-name">Projekt</div>
                        <div class="mb-mode-time">~10 Minuten</div>
                        <div class="mb-mode-desc">Für einen bestehenden Kunden/Projekt aus der Datenbank</div>
                    </div>
                    <div class="mb-mode-card" onclick="caSelectMode(this,'vergleich')">
                        <div class="mb-mode-icon">🔄</div>
                        <div class="mb-mode-name">Vergleich</div>
                        <div class="mb-mode-time">~20 Minuten</div>
                        <div class="mb-mode-desc">Zwei Kontexte vergleichen — wie ändern sich Parameter von A → B?</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-primary" id="caStartBtn" disabled onclick="caStartWorkflow()">Analyse starten →</button>
                </div>
            </div>

            <!-- ═══ STEP 0: Thema/Frage ═══ -->
            <div class="mb-panel" id="caStep0">
                <div class="mb-step-title">Was willst du analysieren?</div>
                <div class="mb-step-desc">Beschreibe das Verhalten, die Entscheidung oder die Fragestellung. BEATRIX identifiziert daraus die relevanten Ψ-Dimensionen.</div>

                <div id="caStep0Suggestions" style="display:flex;flex-direction:column;gap:10px;margin:20px 0">
                    <div style="text-align:center;padding:30px;color:rgba(255,255,255,0.5)">
                        <div style="font-size:24px;margin-bottom:8px">⏳</div>
                        Lade kontextbasierte Vorschläge...
                    </div>
                </div>

                <div style="display:flex;gap:10px;margin-top:8px">
                    <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="caShowCustomInput()">
                        <div class="mb-choice-icon" style="font-size:16px">✏️</div>
                        <div class="mb-choice-title">Eigene Frage eingeben</div>
                    </div>
                </div>

                <div id="caCustomInput" style="display:none;margin-top:16px">
                    <textarea class="mb-input mb-textarea" id="caQuestion" placeholder="z.B. 'Warum wechseln Schweizer Bankkunden so selten ihren Anbieter?' oder 'Wie kann die BFE Hausbesitzer zu Heizungssanierung motivieren?'" style="min-height:80px"></textarea>
                    <div style="margin-top:10px">
                        <button class="mb-btn mb-btn-primary" onclick="caProcessStep0()">Analysieren →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ SMART STEP 1: KONTEXT BESTÄTIGEN ═══ -->
            <div class="mb-panel" id="caStepConfirm">
                <div class="mb-step-title" id="caConfirmTitle">Kontext wird erkannt...</div>
                <div class="mb-step-desc" id="caConfirmDesc">BEATRIX analysiert deine Frage...</div>

                <div id="caConfirmLoading" style="padding:30px;text-align:center">
                    <div class="spinner" style="margin:0 auto 12px"></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.5)">Frage wird analysiert...</div>
                </div>

                <div id="caConfirmContent" style="display:none">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                        <!-- Land -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfLand">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🌍 Land</span>
                                <span onclick="caConfirmEdit('land')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfLandValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfLandEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfLandSelect" onchange="caConfirmPick('land')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="ch">🇨🇭 Schweiz</option>
                                    <option value="at">🇦🇹 Österreich</option>
                                    <option value="de">🇩🇪 Deutschland</option>
                                    <option value="custom_macro">🌍 Anderes Land</option>
                                </select>
                                <input class="mb-input" id="caConfLandCustom" placeholder="Land beschreiben..." style="display:none;width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Branche -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfBranche">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🏢 Branche</span>
                                <span onclick="caConfirmEdit('branche')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfBrancheValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfBrancheEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfBrancheSelect" onchange="caConfirmPick('branche')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="finance">🏦 Finanzdienstleistung</option>
                                    <option value="health">🏥 Gesundheit</option>
                                    <option value="public">🏛️ Öffentlicher Sektor</option>
                                    <option value="energy">⚡ Energie</option>
                                    <option value="retail">🛍️ Retail / Handel</option>
                                    <option value="tech">💻 Technologie</option>
                                    <option value="education">🎓 Bildung</option>
                                    <option value="custom_meso">🏢 Andere Branche</option>
                                </select>
                                <input class="mb-input" id="caConfBrancheCustom" placeholder="Branche beschreiben..." style="display:none;width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Organisation -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfOrg">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">🏢 Organisation</span>
                                <span onclick="caConfirmEdit('org')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfOrgValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfOrgEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfOrgSelect" onchange="caConfirmPick('org')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="company">🏢 Unternehmen</option>
                                    <option value="public">🏛️ Behörde / Öffentlich</option>
                                    <option value="healthcare">🏥 Gesundheitseinrichtung</option>
                                    <option value="general">👤 Allgemein</option>
                                </select>
                                <input class="mb-input" id="caConfOrgCustom" placeholder="Konkretes Unternehmen (optional)..." style="width:100%;box-sizing:border-box;margin-top:6px;font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            </div>
                        </div>

                        <!-- Perspektive -->
                        <div style="padding:14px 16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)" id="caConfPersp">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;text-transform:uppercase;color:var(--text-muted);font-weight:600;letter-spacing:0.5px">👁️ Perspektive</span>
                                <span onclick="caConfirmEdit('persp')" style="font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline">ändern</span>
                            </div>
                            <div id="caConfPerspValue" style="font-size:15px;font-weight:600;color:var(--white)">–</div>
                            <div id="caConfPerspEdit" style="display:none;margin-top:8px">
                                <select class="mb-input" id="caConfPerspSelect" onchange="caConfirmPick('persp')" style="width:100%;box-sizing:border-box;font-size:13px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--accent)">
                                    <option value="kunden">🛒 Kunden</option>
                                    <option value="mitarbeitende">👔 Mitarbeitende</option>
                                    <option value="management">📊 Management</option>
                                    <option value="alle">🔄 Alle Perspektiven (Strategie)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" onclick="caConfirmDone()" id="caConfirmBtn">✅ Stimmt — weiter zur Situation →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ SMART STEP 2: SITUATION (Scenario-based) ═══ -->
            <div class="mb-panel" id="caStepScenarios">
                <div class="mb-step-title">In welcher Situation?</div>
                <div class="mb-step-desc" id="caScenarioDesc">Wähle ein typisches Szenario oder beschreibe die Situation selbst.</div>

                <div id="caScenarioLoading" style="padding:30px;text-align:center">
                    <div class="spinner" style="margin:0 auto 12px"></div>
                    <div style="font-size:13px;color:rgba(255,255,255,0.5)">Typische Szenarien werden generiert...</div>
                </div>

                <div id="caScenarioCards" style="display:none">
                    <div class="mb-choices" id="caScenarioChoices">
                        <!-- Filled by JS -->
                    </div>

                    <!-- Custom scenario (collapsed by default) -->
                    <div id="caCustomScenario" style="display:none;margin-top:16px;padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:12px">🎨 Eigenes Szenario definieren</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
                            <select class="mb-input" id="caMicroWhere" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">📍 Ort...</option>
                                <option value="home">🏠 Zuhause</option>
                                <option value="workplace">🏢 Arbeitsplatz</option>
                                <option value="store">🛒 Geschäft</option>
                                <option value="online">💻 Online / App</option>
                                <option value="public">🚶 Unterwegs</option>
                                <option value="healthcare">🏥 Arztpraxis / Behörde</option>
                            </select>
                            <select class="mb-input" id="caMicroSocial" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">👥 Wer dabei...</option>
                                <option value="solo">🙋 Allein</option>
                                <option value="dyadic">🤝 Zu zweit</option>
                                <option value="small_group">👨‍👩‍👧 Kleine Gruppe</option>
                                <option value="large_group">🏛️ Grosse Gruppe</option>
                                <option value="anonymous">🌐 Anonym</option>
                            </select>
                            <select class="mb-input" id="caMicroTime" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">⏰ Zeitrahmen...</option>
                                <option value="urgent">⚡ Sofort</option>
                                <option value="moderate">📅 Tage/Wochen</option>
                                <option value="relaxed">🌿 Viel Zeit</option>
                                <option value="recurring">🔄 Wiederkehrend</option>
                            </select>
                            <select class="mb-input" id="caMicroCognitive" style="font-size:12px;padding:6px 10px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                                <option value="">🧠 Zustand...</option>
                                <option value="analytical">🔬 Aufmerksam</option>
                                <option value="intuitive">💨 Autopilot</option>
                                <option value="stressed">😰 Gestresst</option>
                                <option value="fatigued">😴 Erschöpft</option>
                                <option value="motivated">🔥 Motiviert</option>
                            </select>
                        </div>
                        <textarea class="mb-input mb-textarea" id="caMicroNotes" placeholder="Besondere Umstände..." style="min-height:50px;width:100%;box-sizing:border-box;font-size:12px"></textarea>
                    </div>

                    <div class="mb-actions" style="margin-top:16px">
                        <button class="mb-btn mb-btn-back" onclick="caBack(1)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" id="caScenarioBtn" disabled onclick="caAnalyzeFromScenario()">🔍 Kontextprofil erstellen →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ OLD STEPS (hidden, used for edit fallback) ═══ -->
            <!-- ═══ STEP 1: MACRO ═══ -->
            <div class="mb-panel" id="caStep1">
                <div id="caStep1ViewA">
                    <div class="mb-step-title">Land & Rahmenbedingungen</div>
                    <div class="mb-step-desc">In welchem Land und regulatorischen Umfeld findet die Entscheidung statt?</div>
                    <div class="mb-choices" id="caStep1Choices">
                        <div class="mb-choice" onclick="caSelect(this,'ch')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">🇨🇭</div>
                            <div class="mb-choice-title">Schweiz</div>
                            <div class="mb-choice-desc">Direkte Demokratie, hohe Eigenverantwortung, Konsenskultur, wohlhabend.</div>
                            <div class="mb-choice-meta">DACH-CH</div>
                        </div>
                        <div class="mb-choice" onclick="caSelect(this,'at')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🇦🇹</div>
                            <div class="mb-choice-title">Österreich</div>
                            <div class="mb-choice-desc">Sozialpartnerschaft, EU-Recht, Gemeinschaftskultur, starke Traditionen.</div>
                            <div class="mb-choice-meta">DACH-AT</div>
                        </div>
                        <div class="mb-choice" onclick="caSelect(this,'de')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🇩🇪</div>
                            <div class="mb-choice-title">Deutschland</div>
                            <div class="mb-choice-desc">Föderalismus, EU-Recht, Sicherheitskultur, grösste EU-Volkswirtschaft.</div>
                            <div class="mb-choice-meta">DACH-DE</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="caSelect(this,'custom_macro')">
                            <div class="mb-choice-num">✎</div>
                            <div class="mb-choice-icon">🌍</div>
                            <div class="mb-choice-title">Anderes Land</div>
                            <div class="mb-choice-desc">Land, Regeln und kulturellen Rahmen frei beschreiben.</div>
                            <div class="mb-choice-meta">→ Freitext</div>
                        </div>
                    </div>
                    <div id="caCustomMacro" style="display:none;margin-bottom:16px">
                        <input class="mb-input" id="caMacroCustom" placeholder="Land/Region und institutioneller Rahmen beschreiben..." style="width:100%;box-sizing:border-box">
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" id="caStep1Btn" disabled onclick="caNextStep(1)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 2: MESO ═══ -->
            <div class="mb-panel" id="caStep2">
                <div class="mb-step-title">Branche & Umfeld</div>
                <div class="mb-step-desc">In welcher Branche und welchem organisatorischen Umfeld bewegt sich die Person?</div>
                <div class="mb-choices" id="caStep2Choices">
                    <div class="mb-choice" onclick="caSelect(this,'finance')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🏦</div>
                        <div class="mb-choice-title">Finanzdienstleistung</div>
                        <div class="mb-choice-desc">Reguliert, hohes Vertrauen erforderlich, lange Entscheidungszyklen.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelect(this,'health')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">🏥</div>
                        <div class="mb-choice-title">Gesundheit</div>
                        <div class="mb-choice-desc">Asymmetrische Information, hohe Emotionalität, Expert-Laie-Dynamik.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelect(this,'public')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">🏛️</div>
                        <div class="mb-choice-title">Öffentlicher Sektor</div>
                        <div class="mb-choice-desc">Politische Rahmenbedingungen, Bürger als Zielgruppe, Gemeinwohl.</div>
                    </div>
                    <div class="mb-choice custom-choice" onclick="caSelect(this,'custom_meso')">
                        <div class="mb-choice-num">✎</div>
                        <div class="mb-choice-icon">🏢</div>
                        <div class="mb-choice-title">Andere Branche</div>
                        <div class="mb-choice-desc">Industrie, Energie, Bildung, Technologie, Retail...</div>
                    </div>
                </div>
                <div id="caCustomMeso" style="display:none;margin-bottom:16px">
                    <input class="mb-input" id="caMesoCustom" placeholder="Branche, Unternehmensgrösse und Marktumfeld beschreiben..." style="width:100%;box-sizing:border-box">
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBack(1)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caStep2Btn" disabled onclick="caGoToOrg()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 3: ORGANISATION ═══ -->
            <div class="mb-panel" id="caStepOrg">
                <div class="mb-step-title">Für welche Organisation?</div>
                <div class="mb-step-desc">Wähle ein bestehendes Unternehmen aus dem CRM oder lege ein neues an.</div>

                <div class="mb-choices" id="caOrgTypeChoices">
                    <div class="mb-choice" onclick="caSelectOrgType(this,'company')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🏢</div>
                        <div class="mb-choice-title">Unternehmen</div>
                        <div class="mb-choice-desc">Privatwirtschaftliches Unternehmen — Bank, Versicherung, Industrie, etc.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'public')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">🏛️</div>
                        <div class="mb-choice-title">Behörde / Öffentliche Institution</div>
                        <div class="mb-choice-desc">Verwaltung, Regulierungsbehörde, staatliche Organisation.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'healthcare')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">🏥</div>
                        <div class="mb-choice-title">Gesundheitseinrichtung</div>
                        <div class="mb-choice-desc">Spital, Krankenkasse, Pflegeeinrichtung, Praxis.</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectOrgType(this,'general')">
                        <div class="mb-choice-num">4</div>
                        <div class="mb-choice-icon">👤</div>
                        <div class="mb-choice-title">Allgemein / kein spezifisches Unternehmen</div>
                        <div class="mb-choice-desc">Grundlagenanalyse für einen Markt oder eine Zielgruppe, ohne konkreten Kunden.</div>
                    </div>
                </div>

                <!-- CRM Search (appears when company/public/healthcare selected) -->
                <div id="caOrgSearch" style="display:none;margin-top:16px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:10px">🔍 Bestehender Kunde aus CRM</div>
                        <input class="mb-input" id="caOrgSearchInput" placeholder="Name eingeben zum Suchen..." oninput="caSearchOrg()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border);margin-bottom:10px">
                        <div id="caOrgResults" style="max-height:200px;overflow-y:auto"></div>
                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                            <button class="mb-btn mb-btn-secondary" onclick="caNewOrg()" style="font-size:12px;padding:6px 14px">➕ Neue Organisation anlegen</button>
                        </div>
                    </div>
                </div>

                <!-- New Org Form (appears on click) -->
                <div id="caNewOrgForm" style="display:none;margin-top:16px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:10px">➕ Neue Organisation</div>
                        <input class="mb-input" id="caNewOrgName" placeholder="Name der Organisation" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border);margin-bottom:8px">
                        <input class="mb-input" id="caNewOrgDesc" placeholder="Kurzbeschreibung (optional)" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                    </div>
                </div>

                <div class="mb-actions" style="margin-top:16px">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStep2',2)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caOrgBtn" disabled onclick="caGoToPersp()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 4: PERSPEKTIVE ═══ -->
            <div class="mb-panel" id="caStepPersp">
                <div class="mb-step-title">Wessen Verhalten analysieren wir?</div>
                <div class="mb-step-desc" id="caPerspDesc">Aus welcher Perspektive soll der Kontext verstanden werden?</div>

                <div class="mb-choices" id="caPerspChoices">
                    <div class="mb-choice" onclick="caSelectPersp(this,'kunden')">
                        <div class="mb-choice-num">1</div>
                        <div class="mb-choice-icon">🛒</div>
                        <div class="mb-choice-title">Kunden</div>
                        <div class="mb-choice-desc">Wie erleben die Kunden die Entscheidungssituation? Was treibt ihr Verhalten?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'mitarbeitende')">
                        <div class="mb-choice-num">2</div>
                        <div class="mb-choice-icon">👔</div>
                        <div class="mb-choice-title">Mitarbeitende</div>
                        <div class="mb-choice-desc">Wie verhalten sich Berater, Sachbearbeiter, Pflegende im Arbeitsalltag?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'management')">
                        <div class="mb-choice-num">3</div>
                        <div class="mb-choice-icon">📊</div>
                        <div class="mb-choice-title">Management / Entscheider</div>
                        <div class="mb-choice-desc">Wie trifft die Geschäftsleitung strategische Entscheidungen?</div>
                    </div>
                    <div class="mb-choice" onclick="caSelectPersp(this,'alle')">
                        <div class="mb-choice-num">4</div>
                        <div class="mb-choice-icon">🔄</div>
                        <div class="mb-choice-title">Alle Perspektiven (Strategie)</div>
                        <div class="mb-choice-desc">Ganzheitliche Analyse über alle Stakeholder — ideal für strategische Projekte.</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStepOrg',3)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caPerspBtn" disabled onclick="caGoToSituation()">Weiter →</button>
                </div>
            </div>

            <!-- ═══ STEP 5: SITUATION (was STEP 3: MICRO) ═══ -->
            <div class="mb-panel" id="caStep3">
                <div class="mb-step-title">Die konkrete Situation</div>
                <div class="mb-step-desc">In welcher Situation befindet sich die Person, wenn sie die Entscheidung trifft?</div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">📍 Wo passiert es?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Der physische oder digitale Ort der Entscheidung</div>
                        <select class="mb-input" id="caMicroWhere" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Ort wählen...</option>
                            <option value="home">🏠 Zuhause — entspannte Umgebung</option>
                            <option value="workplace">🏢 Am Arbeitsplatz — professionelles Umfeld</option>
                            <option value="store">🛒 Im Geschäft — beim Einkaufen</option>
                            <option value="online">💻 Online / App — am Bildschirm</option>
                            <option value="public">🚶 Unterwegs / öffentlicher Raum</option>
                            <option value="healthcare">🏥 Arztpraxis / Behörde — formelles Setting</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">👥 Wer ist dabei?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Sozialer Druck beeinflusst Entscheidungen massiv</div>
                        <select class="mb-input" id="caMicroSocial" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Situation wählen...</option>
                            <option value="solo">🙋 Allein — niemand schaut zu</option>
                            <option value="dyadic">🤝 Zu zweit — Berater, Partner, Kollege</option>
                            <option value="small_group">👨‍👩‍👧 Kleine Gruppe — Team, Familie, Freunde</option>
                            <option value="large_group">🏛️ Grosse Gruppe — Organisation, Gremium</option>
                            <option value="anonymous">🌐 Anonym — Online-Community, Masse</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">⏰ Wie viel Zeit bleibt?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Zeitdruck verändert wie Menschen entscheiden</div>
                        <select class="mb-input" id="caMicroTime" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Zeitrahmen wählen...</option>
                            <option value="urgent">⚡ Sofort — muss jetzt entschieden werden</option>
                            <option value="moderate">📅 Tage bis Wochen — etwas Bedenkzeit</option>
                            <option value="relaxed">🌿 Viel Zeit — Monate, kein Druck</option>
                            <option value="recurring">🔄 Wiederkehrend — Routine-Entscheidung</option>
                        </select>
                    </div>
                    <div style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:4px">🧠 In welchem Zustand?</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Der mentale Zustand bestimmt die Entscheidungsqualität</div>
                        <select class="mb-input" id="caMicroCognitive" onchange="caUpdateMicroBtn()" style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                            <option value="">Zustand wählen...</option>
                            <option value="analytical">🔬 Aufmerksam — denkt gründlich nach</option>
                            <option value="intuitive">💨 Auf Autopilot — entscheidet aus dem Bauch</option>
                            <option value="stressed">😰 Gestresst — viel um die Ohren</option>
                            <option value="fatigued">😴 Erschöpft — am Ende eines langen Tages</option>
                            <option value="motivated">🔥 Motiviert — will aktiv etwas verändern</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom:16px">
                    <textarea class="mb-input mb-textarea" id="caMicroNotes" placeholder="Optional: Gibt es besondere Umstände? Z.B. 'Kurz vor Pensionierung', 'Gerade Kinder bekommen', 'Neuer Job'..." style="min-height:60px;width:100%;box-sizing:border-box;font-size:13px"></textarea>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="caBackToStep('caStepPersp',4)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="caStep3Btn" disabled onclick="caAnalyze()">🔍 Kontextprofil erstellen →</button>
                </div>
            </div>

            <!-- ═══ STEP 4: Ψ-Profil ═══ -->
            <div class="mb-panel" id="caStep4">
                <div class="mb-step-title">Kontextprofil wird erstellt...</div>
                <div class="mb-step-desc">BEATRIX analysiert die 8 Ψ-Dimensionen basierend auf deinen Angaben und der BCM2-Kontextdatenbank.</div>

                <div id="caAnalysisProgress" style="padding:40px;text-align:center">
                    <div class="spinner" style="margin:0 auto 16px"></div>
                    <div style="font-size:14px;color:rgba(255,255,255,0.6)" id="caAnalysisStatus">Kontextdatenbank wird geladen...</div>
                </div>

                <div id="caAnalysisResult" style="display:none">
                    <!-- Context Breadcrumb -->
                    <div id="caResultBreadcrumb" style="display:none;flex-wrap:wrap;gap:6px;margin-bottom:16px"></div>

                    <!-- Allgemeine Perspektive: Big Picture -->
                    <div id="caPerspectiveBox" style="padding:20px 24px;background:linear-gradient(135deg,rgba(27,54,93,0.4),rgba(27,54,93,0.15));border:1px solid rgba(139,170,255,0.2);border-radius:var(--radius);margin-bottom:20px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                            <span style="font-size:20px">🔭</span>
                            <div style="font-size:15px;font-weight:700;color:var(--white)">Allgemeine Perspektive</div>
                        </div>
                        <div id="caPerspectiveText" style="font-size:14px;color:rgba(255,255,255,0.88);line-height:1.85"></div>
                    </div>

                    <!-- Ψ Dimension Cards -->
                    <div id="caPsiCards" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px"></div>

                    <!-- Context Story: Plain Language Translation -->
                    <div id="caStoryBox" style="padding:20px;background:linear-gradient(135deg,rgba(42,127,142,0.08),rgba(232,163,61,0.05));border:1px solid rgba(42,127,142,0.25);border-radius:var(--radius);margin-bottom:16px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px">
                            <span style="font-size:20px">🌍</span>
                            <div style="font-size:15px;font-weight:700;color:var(--white)">Was bedeutet das konkret?</div>
                        </div>
                        <div id="caStoryText" style="font-size:14px;color:rgba(255,255,255,0.85);line-height:1.8;margin-bottom:16px"></div>
                        <div id="caStoryDims" style="display:flex;flex-direction:column;gap:8px"></div>
                    </div>

                    <!-- Parameter Implications -->
                    <div id="caParamBox" style="padding:16px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px">
                        <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:10px">📐 Parameter-Implikationen</div>
                        <div id="caParams" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.7"></div>
                    </div>

                    <!-- AI Analysis -->
                    <div id="caInsightBox" style="padding:16px;background:rgba(139,170,255,0.05);border:1px solid rgba(139,170,255,0.15);border-radius:var(--radius);margin-bottom:16px">
                        <div style="font-size:14px;font-weight:600;color:var(--accent-light);margin-bottom:10px">💡 Kontext-Synthese</div>
                        <div id="caInsight" style="font-size:13px;color:rgba(255,255,255,0.75);line-height:1.7"></div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="caBack(3)">← Zurück</button>
                        <button class="mb-btn mb-btn-secondary" id="caSaveBtn" onclick="caSaveAndUse()">💾 Speichern</button>
                        <button class="mb-btn mb-btn-secondary" id="caDeepenBtn" onclick="caDeepen()" style="display:none;background:rgba(255,170,0,0.15);border-color:rgba(255,170,0,0.4);color:#ffaa00">🔍 Kontext vertiefen</button>
                        <button class="mb-btn mb-btn-primary" onclick="caUseInChat()">💬 Im Chat verwenden →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ HISTORY: Bisherige Analysen ═══ -->
            <div class="mb-panel" id="caHistory">
                <div class="mb-step-title">Bisherige Kontextanalysen</div>
                <div class="mb-step-desc">Gespeicherte Kontextprofile aus früheren Analysen.</div>
                <div id="caHistoryList" style="display:flex;flex-direction:column;gap:10px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Wird geladen...</div>
                </div>
                <div class="mb-actions" style="margin-top:16px">
                    <button class="mb-btn mb-btn-back" onclick="caGoToStart()">← Neue Analyse</button>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ BRIEFING SECTION ═══════ -->
    <section class="section" id="briefing-section">
        <div class="container">
            <div class="section-header">
                <h2>Briefing</h2>
                <p>Starte mit dem, was du hast — BEATRIX holt dich ab und leitet dich weiter.</p>
            </div>
            <div style="max-width:800px;margin:0 auto">

                <!-- STEP 1: Entry Type Selection -->
                <div id="brfStep1">
                    <div style="font-size:16px;font-weight:600;color:var(--white);margin-bottom:6px;text-align:center">Womit startest du?</div>
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:24px;text-align:center">Wähle deinen Ausgangspunkt — BEATRIX führt dich von dort aus weiter.</div>

                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px" id="brfTypeCards">
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('frage')">
                            <div style="font-size:32px;margin-bottom:10px">🔍</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Frage</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Warum tun oder lassen Menschen etwas? Ein Verhalten, das ich verstehen will.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('kunde')">
                            <div style="font-size:32px;margin-bottom:10px">🏢</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Ein Kunde</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Eine Organisation kommt mit einem Anliegen. Ich kenne den Kunden.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('ziel')">
                            <div style="font-size:32px;margin-bottom:10px">🎯</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Ein Ziel</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">So soll es in Zukunft aussehen. Ein Soll-Zustand oder eine Ambition.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('loesung')">
                            <div style="font-size:32px;margin-bottom:10px">🛠️</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Lösung</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Wir haben ein Produkt, eine Massnahme oder eine Intervention — wird sie wirken?</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('daten')">
                            <div style="font-size:32px;margin-bottom:10px">📊</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Beobachtung</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Die Zahlen zeigen etwas Unerwartetes. Ein Gap, ein Trend, eine Anomalie.</div>
                        </div>
                        <div class="mb-choice" style="padding:20px 16px;text-align:center;cursor:pointer" onclick="brfSelectType('sorge')">
                            <div style="font-size:32px;margin-bottom:10px">🚫</div>
                            <div style="font-size:14px;font-weight:600;color:var(--white);margin-bottom:6px">Eine Sorge</div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Das darf auf keinen Fall passieren. Ein Risiko, das ich vermeiden will.</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: Type-specific detail -->
                <div id="brfStep2" style="display:none">
                    <button class="mb-btn mb-btn-back" onclick="brfBack()" style="margin-bottom:16px">← Zurück</button>
                    <div id="brfStep2Header" style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                        <span id="brfStep2Icon" style="font-size:32px"></span>
                        <div>
                            <div id="brfStep2Title" style="font-size:16px;font-weight:700;color:var(--white)"></div>
                            <div id="brfStep2Subtitle" style="font-size:13px;color:var(--text-muted)"></div>
                        </div>
                    </div>

                    <!-- Dynamic content per type -->
                    <div id="brfStep2Content"></div>

                    <!-- Common: describe more -->
                    <div style="margin-top:20px;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                        <div style="font-size:13px;font-weight:600;color:var(--white);margin-bottom:8px" id="brfDetailLabel">Beschreibe es genauer</div>
                        <textarea class="mb-input mb-textarea" id="brfDetailInput" style="min-height:80px;width:100%;box-sizing:border-box;font-size:14px;line-height:1.6"></textarea>
                        <div style="margin-top:12px">
                            <button class="mb-btn mb-btn-primary" onclick="brfAnalyze()" id="brfAnalyzeBtn">🧠 BEATRIX, analysiere das →</button>
                        </div>
                    </div>
                </div>

                <!-- STEP 3: AI Result + Routing -->
                <div id="brfStep3" style="display:none">
                    <button class="mb-btn mb-btn-back" onclick="brfBackTo2()" style="margin-bottom:16px">← Zurück</button>
                    <div id="briefingResult"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══════ SEGMENTS SECTION ═══════ -->
    <section class="section" id="segments-section">
        <div class="container">
            <div class="section-header">
                <h2>Segment-Analyse</h2>
                <p>Wer ist die Zielgruppe? Verhaltensbasierte Segmentierung jenseits von Demografie.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">👥</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Segment-Analyse</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Verhaltensbasierte Segmente identifizieren: Nicht wer Menschen <em>sind</em>, sondern wie sie <em>entscheiden</em>. Basierend auf Ψ-Profilen, nicht Demografie.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ JOURNEY SECTION ═══════ -->
    <section class="section" id="journey-section">
        <div class="container">
            <div class="section-header">
                <h2>Behavioral Journey</h2>
                <p>Wo stehen die Menschen im Veränderungsprozess? Von Awareness über Readiness zu Action.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">🗺️</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Behavioral Change Journey</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Die Reise vom Nicht-Wissen zum Handeln: Awareness → Consideration → Readiness → Action → Habit. Für jede Stufe andere Interventionen.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ NUTZEN SECTION ═══════ -->
    <section class="section" id="nutzen-section">
        <div class="container">
            <div class="section-header">
                <h2>Nutzen & Anreize</h2>
                <p>Was treibt die Entscheidung? Wahrgenommener Nutzen, Kosten und Barrieren.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">💎</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Nutzen- & Anreizanalyse</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Was gewinnen Menschen durch eine Veränderung? Was verlieren sie? Welche Barrieren stehen im Weg — real und wahrgenommen?</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ ARCHITEKTUR SECTION ═══════ -->
    <section class="section" id="architektur-section">
        <div class="container">
            <div class="section-header">
                <h2>Entscheidungsarchitektur</h2>
                <p>Wie wird die Entscheidung präsentiert? Touchpoints, Defaults, Framing, Choice Architecture.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">⚖️</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Entscheidungsarchitektur</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Defaults, Framing, Sequencing, Social Proof — die konkreten Hebel, mit denen Entscheidungen gestaltet werden. Wo, wann und wie die Intervention ansetzt.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ AUDIT SECTION ═══════ -->
    <section class="section" id="audit-section">
        <div class="container">
            <div class="section-header">
                <h2>Behavioral Audit</h2>
                <p>Ist-Zustand erheben: Was passiert heute? Baseline für Verhaltensveränderung.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">📊</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Behavioral Audit</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Systematische Bestandsaufnahme: Welches Verhalten zeigt die Zielgruppe heute? KPIs, Conversion Rates, Drop-offs — die Baseline vor jeder Intervention.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ WIRKUNG SECTION ═══════ -->
    <section class="section" id="wirkung-section">
        <div class="container">
            <div class="section-header">
                <h2>Wirkungsmessung</h2>
                <p>Hat die Intervention gewirkt? Vorher/Nachher, Effect Sizes, RCT-Ergebnisse.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">📈</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Wirkungsmessung</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">Soll vs. Ist: Was hat die Intervention bewirkt? Effect Size berechnen, statistische Signifikanz prüfen, ROI der Verhaltensänderung dokumentieren.</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q3 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ EVIDENZ SECTION ═══════ -->
    <section class="section" id="evidenz-section">
        <div class="container">
            <div class="section-header">
                <h2>Evidenz-Check</h2>
                <p>Was sagt die Forschung? Theorien, Studien und empirische Evidenz prüfen.</p>
            </div>
            <div style="text-align:center;padding:60px 20px">
                <div style="font-size:48px;margin-bottom:16px">🧪</div>
                <div style="font-size:18px;font-weight:600;color:var(--white);margin-bottom:8px">Evidenz-Check</div>
                <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto;line-height:1.6">186 Theorien, 200+ Mechanismen, 94 Parameter in der BEATRIX-Wissensdatenbank. Welche Evidenz stützt unseren Ansatz? Wo sind die Grenzen?</div>
                <div style="margin-top:20px;padding:12px 20px;background:rgba(91,138,245,0.08);border:1px solid rgba(91,138,245,0.2);border-radius:var(--radius);display:inline-block;font-size:13px;color:var(--accent-light)">🚧 In Entwicklung — Q2 2026</div>
            </div>
        </div>
    </section>

    <!-- ═══════ LEADS SECTION ═══════ -->
    <section class="section" id="leads-section">
        <div class="container">
            <div class="section-header">
                <h2>CRM</h2>
                <p>Pipeline, Kontakte und Lead-Management. <span id="crmDateInfo" style="color:rgba(255,255,255,0.3)"></span></p>
            </div>

            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px" id="crmKpis">
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Aktive Leads</div>
                    <div id="crmKpiActive" style="font-size:24px;font-weight:700;color:white;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Pipeline (gew.)</div>
                    <div id="crmKpiPipeline" style="font-size:24px;font-weight:700;color:var(--accent-light);margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Won</div>
                    <div id="crmKpiWon" style="font-size:24px;font-weight:700;color:#34d399;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Conversion</div>
                    <div id="crmKpiConv" style="font-size:24px;font-weight:700;color:#fbbf24;margin:4px 0">–</div>
                </div>
                <div onclick="crmShowCompanies()" style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Firmen ↗</div>
                    <div id="crmKpiCompanies" style="font-size:24px;font-weight:700;color:rgba(255,255,255,0.6);margin:4px 0">–</div>
                </div>
            </div>

            <!-- View Toggle + Actions -->
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden">
                    <button class="fb-tool active" id="crmViewKanban" onclick="crmSetView('kanban')" style="border:none;border-radius:0;font-size:12px">▣ Kanban</button>
                    <button class="fb-tool" id="crmViewTable" onclick="crmSetView('table')" style="border:none;border-radius:0;font-size:12px">☰ Tabelle</button>
                </div>
                <div style="flex:1"></div>
                <button class="mb-btn mb-btn-primary" onclick="crmShowDealForm()" style="font-size:12px;padding:6px 14px">+ Neuer Lead</button>
                <button class="mb-btn mb-btn-back" onclick="crmSyncGithub()" style="font-size:12px;padding:6px 14px" id="crmSyncBtn">🔄 Synchronisieren</button>
            </div>

            <!-- Sync Hint -->
            <div id="crmSyncHint" style="display:none;padding:20px;background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.15);border-radius:12px;margin-bottom:16px;text-align:center;cursor:pointer" onclick="crmSyncGithub()">
                <div style="font-size:14px;color:white;margin-bottom:6px">🔄 60 Leads verfügbar</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:12px">Klicke hier um die Lead-Datenbank zu synchronisieren.</div>
                <button class="mb-btn mb-btn-primary" onclick="event.stopPropagation();crmSyncGithub()" style="font-size:13px;padding:10px 28px;cursor:pointer">Jetzt synchronisieren</button>
            </div>

            <!-- New Deal Form (hidden) -->
            <div id="crmDealForm" style="display:none;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
                <div style="font-size:14px;font-weight:600;color:white;margin-bottom:12px" id="crmDealFormTitle">Neuer Lead</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <input class="mb-input" id="crmDealTitle" placeholder="Lead-Titel / Projekt" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealCompany" placeholder="Firma" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealContact" placeholder="Kontaktperson" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealEmail" placeholder="E-Mail" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealValue" placeholder="Wert (CHF)" type="number" style="font-size:13px;padding:8px 12px">
                    <select class="mb-input" id="crmDealStage" style="font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                        <option value="prospect">Prospect</option>
                        <option value="qualified">Qualified</option>
                        <option value="proposal">Proposal</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Won</option>
                        <option value="active">Active</option>
                    </select>
                    <input class="mb-input" id="crmDealSource" placeholder="Quelle" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealNextAction" placeholder="Nächste Aktion" style="font-size:13px;padding:8px 12px">
                </div>
                <textarea class="mb-input" id="crmDealNotes" placeholder="Notizen..." style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:50px;width:100%;box-sizing:border-box"></textarea>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="mb-btn mb-btn-primary" onclick="crmSaveDeal()" style="font-size:12px;padding:6px 14px">Speichern</button>
                    <button class="mb-btn mb-btn-back" onclick="document.getElementById('crmDealForm').style.display='none'" style="font-size:12px;padding:6px 14px">Abbrechen</button>
                </div>
            </div>

            <!-- Kanban Board -->
            <!-- Company Filter Banner -->
            <div id="crmFilterBanner" style="display:none;align-items:center;gap:10px;padding:10px 16px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:10px;margin-bottom:12px">
                <span style="font-size:12px;color:#2A7F8E">🏢 Gefiltert nach Firma</span>
                <span style="flex:1"></span>
                <button onclick="crmClearFilter()" style="font-size:11px;padding:4px 12px;background:rgba(42,127,142,0.15);color:#2A7F8E;border:1px solid rgba(42,127,142,0.3);border-radius:8px;cursor:pointer">✕ Filter aufheben</button>
            </div>

            <div id="crmKanban" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:12px;min-height:300px">
                <!-- Columns injected by JS -->
            </div>

            <!-- Table View (hidden) -->
            <div id="crmTable" style="display:none;overflow-x:auto">
                <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Laden...</div>
            </div>
        </div>
    </section>

    <!-- Deal Detail Drawer -->
    <div id="crmDrawer" style="display:none;position:fixed;top:0;right:0;bottom:0;width:min(440px,90vw);z-index:9000;background:var(--navy-card);border-left:1px solid var(--border);box-shadow:-8px 0 30px rgba(0,0,0,0.4);overflow-y:auto;transition:transform 0.25s ease">
        <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
            <div style="flex:1">
                <div style="font-size:16px;font-weight:700;color:white" id="crmDrawerTitle">Lead</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4)" id="crmDrawerCompany">Firma</div>
            </div>
            <button onclick="crmCloseDrawer()" style="border:none;background:none;color:rgba(255,255,255,0.4);font-size:18px;cursor:pointer;padding:4px">✕</button>
        </div>
        <div id="crmDrawerContent" style="padding:16px"></div>
    </div>

    <!-- Companies Section (full page) -->
    <section class="section" id="companies-section">
        <div class="container">
            <!-- List View -->
            <div id="companiesListView">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap">
                    <div style="flex:1">
                        <h2 style="margin:0;font-size:22px;color:white">🏢 Firmen</h2>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="crmCompaniesCount"></div>
                    </div>
                    <input id="crmCompaniesSearch" type="text" placeholder="Suchen…" oninput="crmFilterCompanies()" style="font-size:13px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;color:white;width:min(240px,40vw);outline:none">
                </div>
                <!-- Category Cards -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="companyCategoryCards">
                    <div class="comp-card" data-cat="active" onclick="companySetCategory('active',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🟢</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountActive">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Aktive Projekte</div>
                    </div>
                    <div class="comp-card" data-cat="leads" onclick="companySetCategory('leads',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🟡</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountLeads">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Leads</div>
                    </div>
                    <div class="comp-card" data-cat="past" onclick="companySetCategory('past',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">🔵</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountPast">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Frühere Projekte</div>
                    </div>
                    <div class="comp-card" data-cat="new" onclick="companySetCategory('new',this)" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:28px;margin-bottom:6px">⚪</div>
                        <div style="font-size:22px;font-weight:700;color:white" id="catCountNew">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">Noch nie gearbeitet</div>
                    </div>
                </div>
                <div id="companyFilterBanner" style="display:none;margin-bottom:12px;padding:8px 16px;background:rgba(42,127,142,0.06);border:1px solid rgba(42,127,142,0.15);border-radius:8px;align-items:center;gap:8px">
                    <span style="font-size:12px;color:rgba(255,255,255,0.5)" id="companyFilterLabel"></span>
                    <span onclick="companySetCategory('all')" style="font-size:11px;color:var(--accent);cursor:pointer;margin-left:auto">✕ Alle zeigen</span>
                </div>
                <div id="crmCompaniesList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
            </div>

            <!-- Profile View (hidden by default) -->
            <div id="companiesProfileView" style="display:none">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap">
                    <button onclick="companyBackToList()" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Alle Firmen</button>
                    <h2 style="margin:0;font-size:22px;color:white" id="companyProfileName"></h2>
                    <span style="font-size:12px;color:rgba(255,255,255,0.3)" id="companyProfileCode"></span>
                    <span id="companyProfileCatBadge"></span>
                </div>
                <div id="companyProfileContent"></div>
            </div>
        </div>
    </section>

    <!-- Projects Section -->
    <!-- ═══════ MY PROJECTS (Kundenprojekte) ═══════ -->
    <section class="section" id="myprojects-section">
        <div class="container">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                <div style="flex:1">
                    <h2 style="margin:0;font-size:22px;color:white">📋 Projekte</h2>
                    <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="myPrjSubtitle"></div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                    <div id="myPrjToggle" style="display:flex;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;overflow:hidden">
                        <button onclick="myPrjSetScope('mine')" id="myPrjToggleMine" style="padding:6px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.15s;background:var(--accent);color:white">Meine</button>
                        <button onclick="myPrjSetScope('all')" id="myPrjToggleAll" style="padding:6px 14px;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all 0.15s;background:transparent;color:rgba(255,255,255,0.4);display:none">Alle</button>
                    </div>
                    <select id="myPrjFilter" onchange="myPrjRender()" style="padding:6px 12px;background:var(--navy-card);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.7);font-size:12px;cursor:pointer">
                        <option value="all">Alle Status</option>
                        <option value="active">Aktiv</option>
                        <option value="planning">In Planung</option>
                        <option value="completed">Abgeschlossen</option>
                    </select>
                    <button onclick="prjStartWizard();showSection('projects')" style="padding:8px 18px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">+ Neues Projekt</button>
                </div>
            </div>
            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px" id="myPrjKpis">
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#34d399" id="myPrjActive">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Aktiv</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:#fbbf24" id="myPrjPlanning">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">In Planung</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:rgba(139,170,255,0.6)" id="myPrjDone">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Abgeschlossen</div>
                </div>
                <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                    <div style="font-size:22px;font-weight:700;color:white" id="myPrjTotal">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4)">Meine Total</div>
                </div>
            </div>
            <div id="myPrjList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
        </div>
    </section>

    <section class="section" id="projects-section">
        <div class="container">
            <!-- Projects List View -->
            <div id="prjListView">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                    <div style="flex:1">
                        <h2 style="margin:0;font-size:22px;color:white">📋 Projekte</h2>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="prjCount"></div>
                    </div>
                    <button onclick="prjStartWizard()" style="padding:8px 18px;background:linear-gradient(135deg,var(--accent),#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s">+ Neues Projekt</button>
                </div>
                <!-- KPI Cards -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:#34d399" id="prjCountActive">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Aktiv</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:#fbbf24" id="prjCountPlanning">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">In Planung</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:rgba(139,170,255,0.6)" id="prjCountCompleted">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Abgeschlossen</div>
                    </div>
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center">
                        <div style="font-size:22px;font-weight:700;color:white" id="prjCountTotal">0</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4)">Total</div>
                    </div>
                </div>
                <div id="prjList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
            </div>

            <!-- Wizard View -->
            <div id="prjWizardView" style="display:none">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                    <button onclick="prjCancelWizard()" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Abbrechen</button>
                    <h2 style="margin:0;font-size:20px;color:white">Neues Projekt eröffnen</h2>
                </div>

                <!-- Mode Selector -->
                <div id="prjModeSelector" style="display:flex;gap:12px;margin-bottom:24px">
                    <div class="prj-mode-card active" data-mode="schnell" onclick="prjSetMode('schnell')" style="flex:1;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:24px;margin-bottom:8px">⚡</div>
                        <div style="font-size:14px;font-weight:600;color:white">Schnell</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px">Firma wählen, Rest auto-fill<br>~30 Sekunden</div>
                    </div>
                    <div class="prj-mode-card" data-mode="gefuehrt" onclick="prjSetMode('gefuehrt')" style="flex:1;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.15s;text-align:center">
                        <div style="font-size:24px;margin-bottom:8px">🧭</div>
                        <div style="font-size:14px;font-weight:600;color:white">Geführt</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:4px">5 Schritte, vollständig<br>~5 Minuten</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="prjProgress" style="display:none;margin-bottom:24px">
                    <div style="display:flex;gap:4px" id="prjProgressSteps"></div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:6px" id="prjProgressLabel"></div>
                </div>

                <!-- Step 1: Firma & Lead -->
                <div class="prj-step" id="prjStep1" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">1 · Firma & Lead wählen</div>
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Firma *</label>
                            <select id="prjFirma" onchange="prjOnFirmaChange()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                <option value="">Firma auswählen…</option>
                            </select>
                        </div>
                        <div id="prjFirmaInfo" style="display:none;padding:12px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:16px;font-size:12px;color:rgba(255,255,255,0.5)"></div>
                        <div style="margin-bottom:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Lead verknüpfen (optional)</label>
                            <select id="prjLead" onchange="prjOnLeadChange()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                <option value="">Kein Lead / Neues Projekt</option>
                            </select>
                        </div>
                        <div id="prjLeadInfo" style="display:none;padding:12px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.1);border-radius:8px;font-size:12px;color:rgba(255,255,255,0.5)"></div>
                        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px">
                            <button onclick="prjGoStep(2)" id="prjStep1Next" disabled style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;opacity:0.5">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Projektdefinition -->
                <div class="prj-step" id="prjStep2" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">2 · Projektdefinition</div>
                        <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Projektname *</label>
                                <input id="prjName" type="text" placeholder="z.B. Off-Site Kader 2026" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Typ *</label>
                                <select id="prjType" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="beratung">Beratung</option>
                                    <option value="workshop">Workshop / Off-Site</option>
                                    <option value="studie">Studie / Research</option>
                                    <option value="intervention">Intervention</option>
                                    <option value="keynote">Keynote / Vortrag</option>
                                    <option value="training">Training / Schulung</option>
                                    <option value="retainer">Retainer / laufend</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:8px">Projektkategorie *</label>
                            <div style="display:flex;gap:8px" id="prjCategoryCards">
                                <div onclick="prjSelectCategory(this,'mandat')" data-cat="mandat" style="flex:1;padding:14px;background:rgba(52,211,153,0.06);border:2px solid rgba(52,211,153,0.3);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card active">
                                    <div style="font-size:22px">💼</div>
                                    <div style="font-size:12px;font-weight:600;color:#34d399;margin-top:4px">Mandat</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Bezahltes Projekt</div>
                                </div>
                                <div onclick="prjSelectCategory(this,'lead')" data-cat="lead" style="flex:1;padding:14px;background:rgba(255,255,255,0.02);border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card">
                                    <div style="font-size:22px">🎯</div>
                                    <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);margin-top:4px">Lead</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Akquise / Offerte</div>
                                </div>
                                <div onclick="prjSelectCategory(this,'probono')" data-cat="probono" style="flex:1;padding:14px;background:rgba(255,255,255,0.02);border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s" class="prj-cat-card">
                                    <div style="font-size:22px">🤝</div>
                                    <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);margin-top:4px">Pro Bono</div>
                                    <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:2px">Unentgeltlich</div>
                                </div>
                            </div>
                            <input type="hidden" id="prjCategory" value="mandat">
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Beschreibung / Ziele</label>
                            <textarea id="prjDesc" rows="3" placeholder="Was soll erreicht werden?" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;resize:vertical;box-sizing:border-box"></textarea>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(1)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(3)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Timeline & Budget -->
                <div class="prj-step" id="prjStep3" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">3 · Timeline & Budget</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Startdatum</label>
                                <input id="prjStart" type="date" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Enddatum</label>
                                <input id="prjEnd" type="date" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Budget (CHF)</label>
                                <input id="prjBudget" type="number" placeholder="z.B. 85000" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Abrechnungsmodell</label>
                            <div style="display:flex;gap:8px">
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="fixed" checked> Fixpreis</label>
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="time_material"> Time & Material</label>
                                <label style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:rgba(255,255,255,0.6)"><input type="radio" name="prjBilling" value="retainer"> Retainer</label>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(2)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(4)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Weiter →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Team -->
                <div class="prj-step" id="prjStep4" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">4 · Team</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">FA Owner / Projektleiter *</label>
                                <select id="prjOwner" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="GF">Gerhard Fehr (GF)</option>
                                    <option value="MFA">Michael Fehr (MFA)</option>
                                    <option value="NGS">Nora Gavazaj Susuri (NGS)</option>
                                    <option value="AFA">Andrea Fehr (AFA)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">FA Teammitglieder</label>
                                <input id="prjTeam" type="text" placeholder="z.B. MFA, NGS" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div style="margin-top:16px">
                            <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Kunden-Ansprechpartner</label>
                            <div id="prjClientContacts" style="font-size:12px;color:rgba(255,255,255,0.5);padding:8px 0">Wird aus Firma/Lead geladen…</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(3)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjGoStep(5)" style="padding:8px 20px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">Review →</button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review & Eröffnen -->
                <div class="prj-step" id="prjStep5" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">5 · Review & Eröffnen</div>
                        <div id="prjReviewContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        <div style="display:flex;justify-content:space-between;margin-top:20px">
                            <button onclick="prjGoStep(4)" style="padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer">← Zurück</button>
                            <button onclick="prjCreate()" id="prjCreateBtn" style="padding:10px 24px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:14px;font-weight:700;cursor:pointer">✓ Projekt eröffnen → GitHub</button>
                        </div>
                    </div>
                </div>

                <!-- Schnell Mode Panel -->
                <div id="prjSchnellPanel" style="display:none">
                    <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:16px">⚡ Schnell-Eröffnung</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Firma *</label>
                                <select id="prjSchnellFirma" onchange="prjSchnellAutoFill()" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px">
                                    <option value="">Firma auswählen…</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:12px;color:rgba(255,255,255,0.4);display:block;margin-bottom:6px">Projektname *</label>
                                <input id="prjSchnellName" type="text" placeholder="Projektname" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;box-sizing:border-box">
                            </div>
                        </div>
                        <div id="prjSchnellPreview" style="display:none;padding:14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:16px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.6"></div>
                        <button onclick="prjSchnellCreate()" id="prjSchnellBtn" disabled style="width:100%;padding:12px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:14px;font-weight:700;cursor:pointer;opacity:0.5">✓ Jetzt eröffnen → GitHub</button>
                    </div>
                </div>
            </div>

            <!-- Project Landing Page (Hybrid Tab Layout) -->
            <div id="prjLandingView" style="display:none">
                <!-- Sticky Header -->
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <button onclick="prjBackToList()" id="prjBackBtn" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← Projekte</button>
                </div>

                <!-- Project Header Card -->
                <div id="prjLandingHeader" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:0"></div>

                <!-- 3 Main Tabs -->
                <div id="prjTabBar" style="display:flex;gap:2px;padding:12px 0 0 0;margin-bottom:0;border-bottom:1px solid var(--border)">
                    <div class="prj-tab active" data-tab="overview" onclick="prjSwitchMainTab('overview')" style="flex:1;text-align:center;font-weight:700">🏠 Übersicht</div>
                    <div class="prj-tab" data-tab="inhalt" onclick="prjSwitchMainTab('inhalt')" style="flex:1;text-align:center;font-weight:700">🧠 Inhalt</div>
                    <div class="prj-tab" data-tab="pm" onclick="prjSwitchMainTab('pm')" style="flex:1;text-align:center;font-weight:700">📋 PM</div>
                </div>

                <!-- ═══ TAB: ÜBERSICHT ═══ -->
                <div class="prj-main-tab-content active" id="prjMainOverview" style="padding-top:20px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Verfügbare Ressourcen</div>
                            <div id="prjLandingResources" style="display:flex;flex-direction:column;gap:8px"></div>
                        </div>
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Projektdaten</div>
                            <div id="prjLandingData" style="display:flex;flex-direction:column;gap:8px"></div>
                        </div>
                    </div>
                    <div id="prjLandingOtherSection" style="margin-top:20px;display:none">
                        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px">Weitere Projekte mit diesem Kunden</div>
                        <div id="prjLandingOther" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
                    </div>
                </div>

                <!-- ═══ TAB: INHALT (Behavioral Design im Projektkontext) ═══ -->
                <div class="prj-main-tab-content" id="prjMainInhalt" style="padding-top:20px">
                    <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px">Behavioral Design Arbeit für dieses Projekt — alle Analysen und Modelle werden hier gespeichert.</div>

                    <!-- Inhalt Module Cards -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" id="prjInhaltModules">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:4px 0">VERSTEHEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('context')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🔬</span>
                                <div style="font-size:14px;font-weight:700;color:white">Kontext-Analyse</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Land, Branche, Situation → Ψ-Profil</div>
                            <div id="prjModStatus_context" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('segmente')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">👥</span>
                                <div style="font-size:14px;font-weight:700;color:white">Segment-Analyse</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Zielgruppen identifizieren & verstehen</div>
                            <div id="prjModStatus_segmente" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('journey')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🗺️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Behavioral Journey</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Awareness → Readiness → Action</div>
                            <div id="prjModStatus_journey" style="margin-top:8px"></div>
                        </div>

                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:12px 0 4px 0">GESTALTEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('nutzen')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">💎</span>
                                <div style="font-size:14px;font-weight:700;color:white">Nutzen & Anreize</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Nutzen, Kosten, Barrieren</div>
                            <div id="prjModStatus_nutzen" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('architektur')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">⚖️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Entscheidungsarchitektur</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Touchpoints, Defaults, Framing</div>
                            <div id="prjModStatus_architektur" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('model')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🏗️</span>
                                <div style="font-size:14px;font-weight:700;color:white">Modell-Building</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">EEE-Workflow: Gesamtmodell bauen</div>
                            <div id="prjModStatus_model" style="margin-top:8px"></div>
                        </div>

                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:rgba(255,255,255,0.25);letter-spacing:1px;grid-column:1/-1;padding:12px 0 4px 0">MESSEN & PRÜFEN</div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('audit')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">📊</span>
                                <div style="font-size:14px;font-weight:700;color:white">Behavioral Audit</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Ist-Zustand erheben</div>
                            <div id="prjModStatus_audit" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('wirkung')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">📈</span>
                                <div style="font-size:14px;font-weight:700;color:white">Wirkungsmessung</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Soll vs. Ist</div>
                            <div id="prjModStatus_wirkung" style="margin-top:8px"></div>
                        </div>

                        <div class="prj-inhalt-card" onclick="prjLaunchModule('evidenz')" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:18px;cursor:pointer;transition:all 0.15s">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <span style="font-size:22px">🧪</span>
                                <div style="font-size:14px;font-weight:700;color:white">Evidenz-Check</div>
                            </div>
                            <div style="font-size:12px;color:var(--text-muted);line-height:1.5">Forschung, Theorien & Daten</div>
                            <div id="prjModStatus_evidenz" style="margin-top:8px"></div>
                        </div>
                    </div>
                </div>

                <!-- ═══ TAB: PM (Projektmanagement) ═══ -->
                <div class="prj-main-tab-content" id="prjMainPm" style="padding-top:12px">
                    <!-- PM Sub-Tabs -->
                    <div style="display:flex;gap:2px;overflow-x:auto;padding:0 0 0 0;margin-bottom:20px;border-bottom:1px solid var(--border);scrollbar-width:thin">
                        <div class="prj-tab active" data-tab="auftrag" onclick="prjSwitchTab('auftrag')">📋 Auftrag</div>
                        <div class="prj-tab" data-tab="planung" onclick="prjSwitchTab('planung')">📅 Planung</div>
                        <div class="prj-tab" data-tab="meetings" onclick="prjSwitchTab('meetings')">📝 Meetings</div>
                        <div class="prj-tab" data-tab="deliverables" onclick="prjSwitchTab('deliverables')">📦 Deliverables</div>
                        <div class="prj-tab" data-tab="dokumente" onclick="prjSwitchTab('dokumente')">📄 Dokumente</div>
                        <div class="prj-tab" data-tab="budget" onclick="prjSwitchTab('budget')">💰 Budget</div>
                        <div class="prj-tab" data-tab="risiken" onclick="prjSwitchTab('risiken')">⚠ Risiken</div>
                        <div class="prj-tab" data-tab="kommunikation" onclick="prjSwitchTab('kommunikation')">💬 Komm.</div>
                        <div class="prj-tab" data-tab="learnings" onclick="prjSwitchTab('learnings')">📊 Learnings</div>
                    </div>

                    <!-- PM Sub-Tab Contents -->
                    <div class="prj-tab-content active" id="prjTabAuftrag">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📋 Beratungsauftrag</div>
                                <button onclick="prjStartEdit('auftrag')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjAuftragContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabPlanung">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📅 Projektplanung</div>
                                <button onclick="prjStartEdit('planung')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjPlanungContent" style="font-size:13px;color:rgba(255,255,255,0.7);line-height:1.8"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabMeetings">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📝 Meetings & Protokolle</div>
                                <button onclick="prjAddMeeting()" style="padding:6px 14px;background:var(--accent);border:none;border-radius:8px;color:white;font-size:12px;font-weight:600;cursor:pointer">+ Neues Meeting</button>
                            </div>
                            <div id="prjMeetingsContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabDeliverables">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">📦 Deliverables & Ergebnisse</div>
                                <button onclick="prjStartEdit('deliverables')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjDeliverablesContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabDokumente">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">📄 Dokumente</div>
                            <div id="prjDokumenteContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabBudget">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">💰 Budget & Abrechnung</div>
                                <button onclick="prjStartEdit('budget')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjBudgetContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabRisiken">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
                                <div style="font-size:16px;font-weight:700;color:white">⚠ Risiken & Entscheidungen</div>
                                <button onclick="prjStartEdit('risiken')" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer">✏ Bearbeiten</button>
                            </div>
                            <div id="prjRisikenContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabKommunikation">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">💬 Kommunikation</div>
                            <div id="prjKommunikationContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>

                    <div class="prj-tab-content" id="prjTabLearnings">
                        <div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px">
                            <div style="font-size:16px;font-weight:700;color:white;margin-bottom:20px">📊 Learnings & Evaluation</div>
                            <div id="prjLearningsContent" style="font-size:13px;color:rgba(255,255,255,0.7)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="admin-section">
        <div class="container">
            <div class="section-header"><h2>⚙ Administration</h2><p>Benutzer verwalten und Systemeinstellungen konfigurieren.</p></div>
            <div class="admin-cards" id="adminCards">
                <div class="admin-card"><div class="admin-card-label">Benutzer</div><div class="admin-card-value" id="adminStatUsers">–</div><div class="admin-card-sub">Registriert</div></div>
                <div class="admin-card"><div class="admin-card-label">Registrierung</div><div class="admin-card-value" id="adminStatReg" style="font-size:18px">–</div><div class="admin-card-sub" id="adminStatRegSub"></div></div>
                <div class="admin-card"><div class="admin-card-label">Dokumente</div><div class="admin-card-value" id="adminStatDocs">–</div><div class="admin-card-sub">In Datenbank</div></div>
                <div class="admin-card" style="cursor:pointer" onclick="document.getElementById('adminFeedbackSection').scrollIntoView({behavior:'smooth'})"><div class="admin-card-label">Feedback</div><div class="admin-card-value" id="adminStatFb">–</div><div class="admin-card-sub" id="adminStatFbSub">offen</div></div>
            </div>
            <div class="admin-section-title">Benutzer <span class="badge" id="adminUserCount">0</span></div>
            <div id="adminUserTable"></div>
            <div class="admin-section-title" style="margin-top:32px" id="adminFeedbackSection">Feedback <span class="badge" id="adminFbCount">0</span></div>
            <div id="adminFeedbackList"></div>
            <div class="admin-section-title" style="margin-top:32px">Einstellungen</div>
            <div id="adminSettings"></div>
        </div>
    </section>

    <!-- ═══════ PROFILE SECTION ═══════ -->
    <section class="section" id="profile-section">
        <div class="container">
            <div class="section-header"><h2>Profil</h2><p>Dein persönliches Profil in der BEATRIX Intelligence Suite.</p></div>
            <div class="profile-grid">
                <div>
                    <div class="profile-card">
                        <div class="profile-avatar-wrap">
                            <div class="profile-avatar" id="profileAvatar">
                                <span id="profileInitials"></span>
                            </div>
                            <label class="profile-avatar-edit" for="photoUpload" title="Foto ändern">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                            </label>
                            <input type="file" id="photoUpload" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadPhoto(this)">
                        </div>
                        <div class="profile-name" id="profileDisplayName">–</div>
                        <div class="profile-position" id="profileDisplayPosition">–</div>
                        <div class="profile-meta">
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M2 8h20"/></svg>
                                <span id="profileDisplayEmail">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <span id="profileDisplayCompany">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                <span id="profileDisplayPhone">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                <span>Mitglied seit <span id="profileMemberSince">–</span></span>
                            </div>
                        </div>
                        <div class="linkedin-section">
                            <button class="linkedin-btn" id="linkedinBtn" onclick="connectLinkedIn()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                <span id="linkedinBtnText">Mit LinkedIn verbinden</span>
                            </button>
                        </div>
                    </div>
                    <div class="profile-card" style="margin-top:16px">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Expertise</div>
                            <div class="profile-tags" id="profileExpertiseTags"></div>
                            <div style="display:flex;gap:8px;margin-top:10px">
                                <input type="text" class="modal-input" id="expertiseInput" placeholder="Neue Expertise + Enter" style="flex:1;margin:0;font-size:12px;padding:6px 10px" onkeydown="if(event.key==='Enter'){addExpertise();event.preventDefault()}">
                            </div>
                        </div>
                    </div>
                    <!-- ═══ Ψ-PROFILE CARD ═══ -->
                    <div class="profile-card" style="margin-top:16px" id="psiProfileCard">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px">🧠 Ψ-Profil</div>
                            <div id="psiProfileContent" style="color:var(--text-secondary);font-size:13px">Lade Ψ-Profil...</div>
                        </div>
                    </div>
                </div>
                <div class="profile-form">
                    <h3>Profil bearbeiten</h3>
                    <div class="profile-row">
                        <div class="profile-field"><label>Name</label><input type="text" id="profileName" placeholder="Vor- und Nachname"></div>
                        <div class="profile-field"><label>Position</label><input type="text" id="profilePosition" placeholder="z.B. CEO, Researcher"></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field"><label>Unternehmen</label><input type="text" id="profileCompany" placeholder="z.B. FehrAdvice & Partners AG"></div>
                        <div class="profile-field"><label>Telefon</label><input type="text" id="profilePhone" placeholder="+41 ..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>LinkedIn URL</label><input type="text" id="profileLinkedin" placeholder="https://linkedin.com/in/..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>Bio</label><textarea id="profileBio" placeholder="Kurze Beschreibung, Schwerpunkte, Forschungsinteressen..."></textarea></div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary" onclick="openPwModal()">🔑 Passwort ändern</button>
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Profil speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══ Decision Confirmation Overlay ═══ -->
    <div id="mbConfirmOverlay" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(8,12,24,0.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);opacity:0;transition:opacity 0.3s ease">
        <div id="mbConfirmCard" style="position:absolute;bottom:0;left:0;right:0;background:var(--navy-mid);border-top:1px solid var(--border);padding:28px 24px 36px;transform:translateY(100%);transition:transform 0.35s cubic-bezier(0.22,1,0.36,1);max-height:70vh;overflow-y:auto">
            <div style="max-width:680px;margin:0 auto">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div id="mbConfirmIcon" style="font-size:28px;flex-shrink:0"></div>
                    <div>
                        <div id="mbConfirmStep" style="font-size:11px;color:var(--accent);font-weight:600;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px"></div>
                        <div id="mbConfirmTitle" style="font-size:18px;font-weight:700;color:white"></div>
                    </div>
                </div>
                <div id="mbConfirmBody" style="font-size:14px;line-height:1.7;color:rgba(255,255,255,0.7);margin-bottom:20px"></div>
                <div id="mbConfirmImplication" style="background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.12);border-radius:10px;padding:14px 16px;margin-bottom:24px">
                    <div style="font-size:11px;font-weight:600;color:var(--accent);letter-spacing:0.4px;text-transform:uppercase;margin-bottom:6px">Was das bedeutet</div>
                    <div id="mbConfirmImplText" style="font-size:13px;line-height:1.6;color:rgba(255,255,255,0.75)"></div>
                </div>
                <div style="display:flex;gap:12px">
                    <button onclick="mbConfirmBack()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer">← Andere Wahl</button>
                    <button id="mbConfirmBtn" onclick="mbConfirmProceed()" style="flex:1;padding:12px 20px;border-radius:10px;border:none;background:var(--accent);color:white;font-size:14px;font-weight:600;cursor:pointer">Weiter →</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">BEATRIX – The Strategic Intelligence Suite · <a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</footer>
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══ INSIGHT QUESTION MODAL ═══ -->
    <div id="insightModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--card);border-radius:20px;max-width:640px;width:100%;padding:36px;position:relative;border:1px solid rgba(139,170,255,0.15);max-height:90vh;overflow-y:auto">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:28px;margin-bottom:6px">🧠</div>
                <div style="font-size:14px;color:var(--accent);font-weight:600;letter-spacing:1px" id="insightLabel">Ψ-PROFILING</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="insightCounter">Frage 1</div>
            </div>
            <div style="font-size:17px;line-height:1.5;color:rgba(255,255,255,0.9);text-align:center;margin-bottom:20px;font-weight:500" id="insightQuestion"></div>
            <div id="insightNudge" style="display:none;text-align:center;font-size:13px;color:var(--accent);margin-bottom:12px;font-style:italic"></div>
            <div id="insightChoices" style="display:flex;flex-direction:column;gap:8px"></div>
            <div style="display:flex;gap:12px;margin-top:20px;justify-content:center">
                <button id="insightSkipBtn" style="display:none;padding:10px 24px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.5);cursor:pointer;font-size:14px" onclick="insightSkip()">Überspringen</button>
            </div>
            <div style="text-align:center;margin-top:14px">
                <div style="display:flex;gap:6px;justify-content:center" id="insightDots"></div>
            </div>
        </div>
    </div>

    <!-- ═══════ PASSWORD MODAL ═══════ -->
    <div class="modal-overlay" id="pwModal" onclick="if(event.target===this)closePwModal()">
        <div class="modal">
            <h3>🔑 Passwort ändern</h3>
            <div class="modal-msg" id="pwMsg"></div>
            <input type="password" class="modal-input" id="pwCurrent" placeholder="Aktuelles Passwort">
            <input type="password" class="modal-input" id="pwNew" placeholder="Neues Passwort (mind. 6 Zeichen)">
            <input type="password" class="modal-input" id="pwConfirm" placeholder="Neues Passwort bestätigen">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePwModal()">Abbrechen</button>
                <button class="btn btn-primary" id="pwBtn" onclick="changePassword()">Ändern</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        console.log('🟢 BEATRIX v3.12.3 loaded — mbRenderMd active');
        let files=[], tags=[], selectedDB='knowledge_base', currentTab='file', authToken=null, currentUser=null;

        function H() { return authToken ? {'Authorization':`Bearer ${authToken}`} : {}; }

        // ── Auth ────────────────────────────────────────
        function showAuthPanel(panel) {
            document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panel+'Panel').classList.add('active');
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
        }

        async function checkAuth() {
            const saved = sessionStorage.getItem('bea_token');
            const user = sessionStorage.getItem('bea_user');
            if (saved) {
                try {
                    const r = await fetch(`${API}/auth/check`, {headers:{'Authorization':`Bearer ${saved}`}});
                    if (r.ok) {
                        authToken = saved;
                        currentUser = user ? JSON.parse(user) : (await r.json());
                        // Also check JWT for admin + CRM flags
                        try { const p = JSON.parse(atob(saved.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) {}
                        document.getElementById('authOverlay').classList.add('hidden');
                        document.getElementById('navUser').textContent = currentUser.name || currentUser.email;
                        if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
                        applyUserTabs();
                        console.log('Session restore:', currentUser.email, 'admin:', currentUser.admin);
                        if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
                        loadStats();
                        return;
                    }
                } catch(e) {}
                sessionStorage.removeItem('bea_token');
                sessionStorage.removeItem('bea_user');
            }
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function onAuthSuccess(data) {
            authToken = data.token;
            currentUser = data.user;
            // Decode JWT to get admin status + CRM access
            try { const p = JSON.parse(atob(data.token.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) { currentUser.admin = false; currentUser.role = 'researcher'; currentUser.crm_access = false; }
            sessionStorage.setItem('bea_token', authToken);
            sessionStorage.setItem('bea_user', JSON.stringify(currentUser));
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('navUser').textContent = data.user.name || data.user.email;
            if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
            applyUserTabs();
            console.log('Auth success:', currentUser.email, 'admin:', currentUser.admin);
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
            loadStats();
            showToast(`Willkommen, ${data.user.name || data.user.email}!`, 'success');
            // Trigger insight question after login
            setTimeout(() => insightStart('login'), 800);
        }

        // ── Insight / Ψ-Profiling (5-Choice Architecture) ──────────
        let insightState = { questionNum: 0, currentQuestion: null, startTime: null, context: 'login' };

        async function insightStart(context = 'login') {
            insightState = { questionNum: 0, currentQuestion: null, startTime: null, context };
            await insightNext();
        }

        async function insightNext() {
            try {
                const resp = await fetch(`${API}/insight/question?context=${insightState.context}`, { headers: H() });
                if (!resp.ok) return insightClose();
                const data = await resp.json();
                insightState.currentQuestion = data;
                insightState.startTime = Date.now();
                insightState.questionNum = data.question_number;

                const modal = document.getElementById('insightModal');
                modal.style.display = 'flex';
                document.getElementById('insightQuestion').textContent = data.question;
                document.getElementById('insightCounter').textContent = `Frage ${data.question_number}` + (data.total_answered > 0 ? ` · ${data.total_answered} bisherige` : '');

                // Label: mandatory / nudged / voluntary
                const label = document.getElementById('insightLabel');
                if (data.is_mandatory) {
                    label.textContent = 'Ψ-PROFILING · PFLICHTFRAGE';
                    label.style.color = 'var(--accent)';
                } else if (data.is_nudged) {
                    label.textContent = 'Ψ-PROFILING · EMPFOHLEN';
                    label.style.color = '#f59e0b';
                } else {
                    label.textContent = 'Ψ-PROFILING · FREIWILLIG';
                    label.style.color = 'rgba(255,255,255,0.4)';
                }

                // Nudge message
                const nudgeEl = document.getElementById('insightNudge');
                if (data.nudge_message) { nudgeEl.textContent = data.nudge_message; nudgeEl.style.display = 'block'; }
                else { nudgeEl.style.display = 'none'; }

                // Render 5 choice cards
                const choicesEl = document.getElementById('insightChoices');
                if (data.choices && data.choices.length > 0) {
                    choicesEl.innerHTML = data.choices.map((c, i) => `
                        <div onclick="insightSelectChoice(this, ${i + 1}, '${(c.label || '').replace(/'/g, "\'")}')"
                             style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:background 0.15s;-webkit-tap-highlight-color:rgba(139,170,255,0.2)"
                             onmouseover="this.style.background='rgba(255,255,255,0.06)'"
                             onmouseout="if(!this.classList.contains('ins-selected'))this.style.background='transparent'">
                            <div style="font-size:18px;flex-shrink:0;width:28px;text-align:center">${c.icon || '○'}</div>
                            <div style="font-size:15px;color:rgba(255,255,255,0.8)">${c.label}</div>
                        </div>
                    `).join('');
                } else {
                    choicesEl.innerHTML = '';
                }

                // Skip button
                document.getElementById('insightSkipBtn').style.display = data.can_skip ? 'block' : 'none';

                // Progress dots
                const dotsEl = document.getElementById('insightDots');
                let dots = '';
                for (let i = 1; i <= Math.max(3, data.question_number); i++) {
                    const active = i === data.question_number;
                    const done = i < data.question_number;
                    dots += `<div style="width:8px;height:8px;border-radius:50%;background:${done ? 'var(--accent)' : active ? 'white' : 'rgba(255,255,255,0.2)'}"></div>`;
                }
                dotsEl.innerHTML = dots;
            } catch(e) {
                console.error('Insight load error:', e);
                insightClose();
            }
        }

        async function insightSelectChoice(el, choiceIndex, choiceLabel) {
            // Mark selected
            el.parentElement.querySelectorAll('div[onclick]').forEach(c => {
                c.classList.remove('ins-selected');
                c.style.background = 'transparent';
            });
            el.classList.add('ins-selected');
            el.style.background = 'rgba(139,170,255,0.12)';

            await new Promise(r => setTimeout(r, 300));

            const latency = Date.now() - insightState.startTime;
            const q = insightState.currentQuestion;

            try {
                await fetch(`${API}/insight/answer`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question,
                        question_id: q.question_id,
                        answer_text: choiceLabel,
                        choice_index: choiceIndex,
                        latency_ms: latency,
                        question_number: q.question_number,
                        was_mandatory: q.is_mandatory,
                        was_nudged: q.is_nudged,
                        skipped: false,
                        context: insightState.context,
                    })
                });

                // Flow: mandatory→next, nudged→next, voluntary→ask
                if (q.question_number < 3) {
                    await insightNext();
                } else {
                    insightClose();
                    showToast('Ψ-Profil aktualisiert ✓', 'success');
                }
            } catch(e) {
                console.error('Insight submit error:', e);
            }
        }

        async function insightSkip() {
            const q = insightState.currentQuestion;
            try {
                await fetch(`${API}/insight/skip`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question, question_id: q.question_id,
                        question_number: q.question_number, context: insightState.context,
                    })
                });
            } catch(e) {}
            insightClose();
            showToast('Ψ-Profiling übersprungen', 'info');
        }

        function insightClose() {
            document.getElementById('insightModal').style.display = 'none';
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Anmelden...'; err.classList.remove('visible');
            try {
                const r = await fetch(`${API}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                if (!r.ok) {
                    const d=await r.json().catch(()=>({}));
                    const msg = d.detail||'Anmeldung fehlgeschlagen.';
                    if (r.status === 403 && msg.includes('nicht bestätigt')) {
                        err.innerHTML = msg + ' <a style="color:var(--accent);cursor:pointer;font-weight:600" onclick="resendFromLogin()">Erneut senden</a>';
                    } else { err.textContent = msg; }
                    err.classList.add('visible'); btn.disabled=false; btn.textContent='Anmelden'; return;
                }
                onAuthSuccess(await r.json());
            } catch(e) { err.textContent='Verbindungsfehler: ' + e.message + ' [' + API + '/login]'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Anmelden';
        }

        async function resendFromLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            if (!email || !pw) return;
            const err = document.getElementById('loginError');
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { err.innerHTML='✓ Neuer Bestätigungslink gesendet!'; err.style.color='var(--success)'; }
                else { err.textContent = d.detail || 'Fehler'; }
            } catch(e) { err.textContent='Verbindungsfehler'; }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            const err = document.getElementById('forgotError');
            const suc = document.getElementById('forgotSuccess');
            err.classList.remove('visible'); suc.style.display='none';
            if (!email) { err.textContent='Bitte E-Mail-Adresse eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Wird gesendet...';
            try {
                const r = await fetch(`${API}/forgot-password`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})});
                const d = await r.json();
                if (r.ok) { suc.textContent='✓ ' + d.message; suc.style.display='block'; }
                else { err.textContent=d.detail||'Fehler'; err.classList.add('visible'); }
            } catch(e) { err.textContent='Verbindungsfehler'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Reset-Link senden';
        }

        async function doRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pw = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');
            const err = document.getElementById('registerError');
            const suc = document.getElementById('registerSuccess');
            err.classList.remove('visible'); if(suc) suc.classList.remove('visible');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            if (pw.length < 6) { err.textContent='Passwort muss mindestens 6 Zeichen haben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Registrieren...';
            try {
                const r = await fetch(`${API}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw, name:name||null})});
                const d = await r.json();
                if (!r.ok) { err.textContent=d.detail||'Registrierung fehlgeschlagen.'; err.classList.add('visible'); btn.disabled=false; btn.textContent='Registrieren'; return; }
                if (d.status === 'verification_required') {
                    // Show verification message
                    if(suc) { suc.textContent = d.message; suc.classList.add('visible'); }
                    else { err.style.color='var(--success)'; err.style.background='var(--success-bg)'; err.style.borderColor='rgba(52,211,153,0.15)'; err.textContent = d.message; err.classList.add('visible'); }
                    btn.disabled=false; btn.textContent='Registrieren';
                    // Show resend link
                    setTimeout(() => {
                        const resendEl = document.getElementById('resendArea');
                        if (resendEl) { resendEl.style.display='block'; resendEl.dataset.email=email; resendEl.dataset.pw=pw; }
                    }, 500);
                    return;
                }
                onAuthSuccess(d);
            } catch(e) { err.textContent='Verbindungsfehler.'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Registrieren';
        }

        async function resendVerification() {
            const resendEl = document.getElementById('resendArea');
            const email = resendEl?.dataset.email;
            const pw = resendEl?.dataset.pw;
            if (!email || !pw) return;
            const btn = resendEl.querySelector('a');
            const origText = btn.textContent;
            btn.textContent = 'Wird gesendet...'; btn.style.pointerEvents='none';
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { btn.textContent='✓ Gesendet!'; btn.style.color='var(--success)'; }
                else { btn.textContent = d.detail || 'Fehler'; btn.style.color='var(--error)'; }
            } catch(e) { btn.textContent='Fehler'; btn.style.color='var(--error)'; }
            setTimeout(() => { btn.textContent=origText; btn.style.color=''; btn.style.pointerEvents=''; }, 4000);
        }

        function doLogout() {
            authToken=null; currentUser=null;
            sessionStorage.removeItem('bea_token'); sessionStorage.removeItem('bea_user');
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'none';
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('loginEmail').value=''; document.getElementById('loginPassword').value='';
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
            showAuthPanel('login');
        }

        document.getElementById('loginPassword').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('loginEmail').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('regPassword').addEventListener('keydown', e => { if(e.key==='Enter') doRegister(); });

        // ── App Logic ───────────────────────────────────
        function showSection(name,el) {
            // Close any open dropdowns + mobile nav
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            closeMobileNav();
            // Clear all active states
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-trigger').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-item').forEach(i=>i.classList.remove('active'));
            // Set active state
            if(el && el.classList.contains('nav-link')) el.classList.add('active');
            // Show section
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(name+'-section'); if(sec) sec.classList.add('active');
            document.getElementById('hero-section').style.display = (name==='upload') ? '' : 'none';
            if(name==='documents') loadDocuments();
            if(name==='admin') loadAdminData();
            if(name==='context') caInit();
            if(name==='leads') crmLoad();
            if(name==='companies') crmLoadCompanies();
            if(name==='projects') prjLoad();
            if(name==='myprojects') myPrjLoad();
            if(name==='profile') loadProfile();
            if(name==='chat') { loadChatHistory(); document.getElementById('chatInput').focus(); }
            if(name==='model') { if (!mbUserProfile) mbLoadUserProfile().then(() => mbApplyDefault('start')); }
        }

        function toggleMobileNav() {
            const links = document.querySelector('.nav-links');
            const isOpen = links.classList.toggle('mobile-open');
            const icon = document.getElementById('hamburgerIcon');
            if (isOpen) {
                icon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
            } else {
                icon.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
            }
        }

        function closeMobileNav() {
            const links = document.querySelector('.nav-links');
            if (links) links.classList.remove('mobile-open');
            const icon = document.getElementById('hamburgerIcon');
            if (icon) icon.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>';
        }

        function toggleDropdown(id) {
            const dd = document.getElementById(id);
            const wasOpen = dd.classList.contains('open');
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            if (!wasOpen) dd.classList.add('open');
        }

        function navDropClick(section, itemEl) {
            // Close dropdown + mobile nav
            document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            closeMobileNav();
            // Clear all actives
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-trigger').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-item').forEach(i=>i.classList.remove('active'));
            // Mark dropdown item + parent trigger as active
            if(itemEl) itemEl.classList.add('active');
            const parentTrigger = itemEl?.closest('.nav-dropdown')?.querySelector('.nav-dropdown-trigger');
            if(parentTrigger) parentTrigger.classList.add('active');
            // Show the section
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(section+'-section'); if(sec) sec.classList.add('active');
            document.getElementById('hero-section').style.display = (section==='upload') ? '' : 'none';
            if(section==='documents') loadDocuments();
            if(section==='admin') loadAdminData();
            if(section==='context') caInit();
            if(section==='leads') crmLoad();
            if(section==='companies') crmLoadCompanies();
            if(section==='projects') prjLoad();
            if(section==='myprojects') myPrjLoad();
            if(section==='profile') loadProfile();
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
            }
        });
        function switchTab(tab,el) { currentTab=tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); document.getElementById('file-section').classList.toggle('active',tab==='file'); document.getElementById('text-section').classList.toggle('active',tab==='text'); updateCount(); }
        function selectDB(el) { document.querySelectorAll('.db-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selectedDB=el.dataset.db; }

        const dropZone=document.getElementById('dropZone');
        ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.add('dragover');}));
        ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.remove('dragover');}));
        dropZone.addEventListener('drop',e=>addFiles([...e.dataTransfer.files]));
        document.getElementById('fileInput').addEventListener('change',e=>{addFiles([...e.target.files]);e.target.value='';});

        function addFiles(nf) { const ok=['.pdf','.txt','.md','.docx','.csv','.json']; for(const f of nf){const ext='.'+f.name.split('.').pop().toLowerCase(); if(!ok.includes(ext)){showToast(`${f.name}: nicht unterstützt`,'error');continue;} if(f.size>50*1024*1024){showToast(`${f.name}: zu groß`,'error');continue;} files.push({file:f,status:'pending',progress:0,id:Date.now()+Math.random()});} renderFileList();updateCount(); }
        function removeFile(id) { files=files.filter(f=>f.id!==id); renderFileList();updateCount(); }
        function renderFileList() { document.getElementById('fileList').innerHTML=files.map(f=>{const ext=f.file.name.split('.').pop().toLowerCase();const cls=ext==='pdf'?'pdf':ext==='md'?'md':ext==='docx'?'doc':'txt';const sz=f.file.size<1024*1024?(f.file.size/1024).toFixed(1)+' KB':(f.file.size/1024/1024).toFixed(1)+' MB';return`<div class="file-item"><div class="file-type-icon ${cls}">${ext}</div><div class="file-info"><div class="file-name">${f.file.name}</div><div class="file-meta">${sz}</div></div>${f.status==='uploading'?`<div><div class="progress-bar"><div class="progress-fill" style="width:${f.progress}%"></div></div></div>`:''}<span class="file-status ${f.status}">${f.status==='pending'?'Bereit':f.status==='uploading'?f.progress+'%':f.status==='success'?'✓ Fertig':'✗ Fehler'}</span>${f.status==='pending'?`<button class="file-remove" onclick="removeFile(${f.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}</div>`;}).join(''); }
        function updateCount() { const el=document.getElementById('uploadCount'); el.textContent=currentTab==='file'?(files.length?`${files.length} Datei${files.length>1?'en':''}`:''):(document.getElementById('textContent').value.length?`${document.getElementById('textContent').value.length} Zeichen`:''); }

        document.getElementById('tagInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim()){e.preventDefault();if(!tags.includes(e.target.value.trim())){tags.push(e.target.value.trim());renderTags();}e.target.value='';}});
        function removeTag(t){tags=tags.filter(x=>x!==t);renderTags();}
        function renderTags(){const c=document.getElementById('tagContainer'),inp=document.getElementById('tagInput');c.innerHTML='';tags.forEach(t=>{const s=document.createElement('span');s.className='tag';s.innerHTML=`${t} <button onclick="removeTag('${t}')">&times;</button>`;c.appendChild(s);});c.appendChild(inp);}

        async function submitUpload() {
            const btn=document.getElementById('submitBtn');
            if(currentTab==='file'){
                if(!files.length){showToast('Bitte Dateien auswählen','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Hochladen...';
                for(const f of files){if(f.status!=='pending')continue;f.status='uploading';renderFileList();
                    try{const fd=new FormData();fd.append('file',f.file);fd.append('database',selectedDB);const r=await fetch(`${API}/upload`,{method:'POST',headers:H(),body:fd});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());f.status='success';f.progress=100;}catch(e){f.status='error';showToast(`${f.file.name}: ${e.message}`,'error');}renderFileList();}
                const ok=files.filter(f=>f.status==='success').length;if(ok)showToast(`${ok} Datei${ok>1?'en':''} hochgeladen`,'success');
            } else {
                const title=document.getElementById('textTitle').value.trim(),content=document.getElementById('textContent').value.trim();
                if(!content){showToast('Bitte Text eingeben','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Speichern...';
                try{const r=await fetch(`${API}/text`,{method:'POST',headers:{...H(),'Content-Type':'application/json'},body:JSON.stringify({title:title||'Untitled',content,category:document.getElementById('textCategory').value,language:document.getElementById('textLang').value,tags,database:selectedDB})});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());showToast('Text gespeichert','success');document.getElementById('textTitle').value='';document.getElementById('textContent').value='';tags=[];renderTags();}catch(e){showToast(e.message,'error');}
            }
            btn.disabled=false;btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';loadStats();
        }

        async function loadDocuments() {
            const w=document.getElementById('docTableWrapper');
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401){doLogout();return;}const docs=await r.json();
                if(!docs.length){w.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>Noch keine Dokumente</h3><p>Lade dein erstes Dokument hoch.</p></div>`;return;}
                const db={knowledge_base:'Knowledge Base',bcm_axioms:'BCM Axiome',research:'Research'};
                w.innerHTML=`<table class="doc-table"><thead><tr><th>Dokument</th><th>Typ</th><th>Datenbank</th><th>Datum</th><th>Status</th></tr></thead><tbody>${docs.map(d=>{const date=new Date(d.created_at).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});return`<tr><td class="doc-name">${d.title}</td><td><span class="format-badge">${(d.file_type||d.source_type).toUpperCase()}</span></td><td>${db[d.database_target]||d.database_target}</td><td>${date}</td><td><span class="status-badge">${d.status}</span></td></tr>`;}).join('')}</tbody></table>`;
            }catch(e){w.innerHTML='<p style="color:var(--error)">Fehler beim Laden</p>';}
        }

        // ── Role-Based Tab Visibility ──────────────────
        // Role → Tab mapping (which tabs each role can see)
        const ROLE_TABS = {
            researcher:        [],             // standard tabs only
            sales:             ['context'],    // + Ausgangslage (CRM via crm_access)
            operations:        ['context'],    // + Ausgangslage
            senior_management: ['context'],    // + Ausgangslage (CRM auto-enabled)
            partner:           ['context'],    // + Ausgangslage (CRM auto-enabled)
            admin:             ['context']     // + everything (admin+CRM tabs handled separately)
        };

        function applyUserTabs() {
            const email = (currentUser?.email || '').toLowerCase();
            const isAdmin = currentUser?.admin || false;
            const role = currentUser?.role || 'researcher';
            const isFehrAdvice = email.endsWith('@fehradvice.com');
            const hasCrmAccess = currentUser?.crm_access || false;
            console.log('applyUserTabs - email:', email, 'admin:', isAdmin, 'role:', role, 'crm:', hasCrmAccess);

            // Admin gear icon (only for admins)
            const adminEl = document.getElementById('navAdmin');
            if (adminEl) adminEl.style.display = isAdmin ? 'inline' : 'none';

            // Kontext-Analyse is always visible (core EBF workflow under Behavioral Design)
            // No role restriction needed

            // Business dropdown items (CRM, Firmen, Projekte-Admin)
            const showCrm = isFehrAdvice && hasCrmAccess;
            const leadsEl = document.getElementById('navDropLeads');
            if (leadsEl) leadsEl.style.display = showCrm ? 'flex' : 'none';
            const compEl = document.getElementById('navDropCompanies');
            if (compEl) compEl.style.display = showCrm ? 'flex' : 'none';
            const projEl = document.getElementById('navDropProjects');
            if (projEl) projEl.style.display = showCrm ? 'flex' : 'none';
            const myProjEl = document.getElementById('navDropMyProjects');
            if (myProjEl) myProjEl.style.display = 'none'; // hidden, now top-level

            // Top-level Projekte — visible for all logged-in users
            const topProj = document.getElementById('navTopProjects');
            if (topProj) topProj.style.display = '';

            // Business dropdown only visible if CRM items exist
            const businessDrop = document.getElementById('navDropBusiness');
            if (businessDrop) {
                businessDrop.style.display = showCrm ? 'flex' : 'none';
            }

            console.log('Nav: CRM=' + showCrm, 'Admin=' + isAdmin);
        }

        // ── Kontext / Ausgangslage ──────────────────────
        // Kontext-Analyse state managed by caState and caHistoryData

        // ── KONTEXT-ANALYSE WORKFLOW ──────────────────────────
        const caState = { mode: null, step: -1, question: '', macro: null, meso: null, macroCustom: null, mesoCustom: null, orgType: null, orgCode: null, orgName: null, perspective: null, micro: {}, result: null, lineageId: null, currentVersionId: null, customerCode: null, projectSlug: null, smartParse: null, scenarios: [] };
        let caHistoryData = [];

        const PSI_DIMS = [
            { key: 'psi_i', icon: '📋', label: 'Ψ_I Regeln', desc: 'Gesetze, Defaults, Vorschriften' },
            { key: 'psi_s', icon: '👥', label: 'Ψ_S Sozial', desc: 'Soziale Normen, Peer Effects' },
            { key: 'psi_c', icon: '🧠', label: 'Ψ_C Kognitiv', desc: 'Attention, Cognitive Load' },
            { key: 'psi_k', icon: '🌍', label: 'Ψ_K Kultur', desc: 'Werte, Traditionen, Identität' },
            { key: 'psi_e', icon: '💰', label: 'Ψ_E Ressourcen', desc: 'Budget, Zeit, Energie' },
            { key: 'psi_t', icon: '⏰', label: 'Ψ_T Zeit', desc: 'Zeitdruck, Lebensphase' },
            { key: 'psi_m', icon: '🔧', label: 'Ψ_M Tools', desc: 'Technologie, Infrastruktur' },
            { key: 'psi_f', icon: '📍', label: 'Ψ_F Ort', desc: 'Physisches Setting' }
        ];

        function caInit() {
            // Load suggestions based on user profile
            caLoadSuggestions();
        }

        function caSelectMode(el, mode) {
            if (el.classList.contains('selected') && caState.mode === mode) {
                caStartWorkflow(); return;
            }
            document.querySelectorAll('#caStart .mb-mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.mode = mode;
            document.getElementById('caStartBtn').disabled = false;
        }

        function caStartWorkflow() {
            if (!caState.mode) return;
            caState.step = 0;
            caShowPanel('caStep0');
            document.getElementById('caProgress').style.display = 'flex';
            caUpdateProgress(0);
            if (caState.mode === 'schnell') {
                caShowCustomInput(); // Jump to text input for schnell mode
            }
        }

        function caShowPanel(id) {
            document.querySelectorAll('#context-section .mb-panel').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
        }

        function caUpdateProgress(step) {
            document.querySelectorAll('#caProgress .mb-step-dot').forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (i < step) dot.classList.add('completed');
                if (i === step) dot.classList.add('active');
            });
            document.querySelectorAll('#caProgress .mb-step-line').forEach((line, i) => {
                line.classList.toggle('completed', i < step);
            });
        }

        // ═══ BRIEFING FUNCTIONS — Choice Architecture ═══
        const brfState = { type: null, subChoice: null };

        const BRF_TYPES = {
            frage: {
                icon: '🔍', title: 'Du hast eine Frage',
                subtitle: 'Etwas an einem Verhalten gibt dir zu denken.',
                label: 'Was genau willst du verstehen?',
                placeholder: 'z.B. "Warum wechseln Kunden so selten den Anbieter?" oder "Wieso nutzen nur 3% den Self-Service?"',
                quickPicks: [
                    { icon: '🔄', text: 'Warum tun Menschen etwas nicht, obwohl es in ihrem Interesse wäre?' },
                    { icon: '⚡', text: 'Warum handeln Menschen gegen ihre eigenen Absichten?' },
                    { icon: '📉', text: 'Warum ist eine Kennzahl so tief/hoch — was steckt dahinter?' },
                    { icon: '🤷', text: 'Warum funktioniert etwas in einem Kontext, aber nicht in einem anderen?' }
                ]
            },
            kunde: {
                icon: '🏢', title: 'Du hast einen Kunden',
                subtitle: 'Eine Organisation kommt mit einem Anliegen.',
                label: 'Um welchen Kunden geht es — und was ist das Thema?',
                placeholder: 'z.B. "UBS Private Banking — junge Erben wechseln nicht in die Vermögensverwaltung"',
                quickPicks: [
                    { icon: '🏦', text: 'Eine Bank will die Kundenaktivierung verbessern' },
                    { icon: '🏥', text: 'Eine Versicherung will Prävention fördern' },
                    { icon: '🏛️', text: 'Eine Behörde will Compliance erhöhen' },
                    { icon: '⚡', text: 'Ein Energieversorger will Wechselverhalten verstehen' }
                ],
                showCrm: true
            },
            ziel: {
                icon: '🎯', title: 'Du hast ein Ziel',
                subtitle: 'Ein Soll-Zustand, eine Ambition, eine Vision.',
                label: 'Was soll in Zukunft anders sein?',
                placeholder: 'z.B. "In 3 Jahren sollen 40% der Kunden den Self-Service nutzen" oder "NPS von 34 auf 55"',
                quickPicks: [
                    { icon: '📈', text: 'Eine Kennzahl soll sich verbessern (KPI, Conversion, NPS...)' },
                    { icon: '🔄', text: 'Ein Verhalten soll sich ändern (mehr, weniger, anders...)' },
                    { icon: '🌱', text: 'Ein neues Verhalten soll entstehen (Adoption, Gewohnheit...)' },
                    { icon: '🏔️', text: 'Eine Transformation: "So soll es in 5 Jahren aussehen"' }
                ]
            },
            loesung: {
                icon: '🛠️', title: 'Du hast eine Lösung',
                subtitle: 'Ein Produkt, eine Massnahme, eine Intervention — wird sie wirken?',
                label: 'Was ist die Lösung und für wen?',
                placeholder: 'z.B. "Wir launchen eine Vorsorge-App für Millennials" oder "Wir ändern den Default bei der Organspende"',
                quickPicks: [
                    { icon: '📱', text: 'Wir launchen ein digitales Produkt (App, Portal, Tool...)' },
                    { icon: '📝', text: 'Wir ändern einen Prozess (Onboarding, Beratung, Antrag...)' },
                    { icon: '💬', text: 'Wir ändern die Kommunikation (Brief, E-Mail, Kampagne...)' },
                    { icon: '⚙️', text: 'Wir ändern die Entscheidungsarchitektur (Default, Framing, Timing...)' }
                ]
            },
            daten: {
                icon: '📊', title: 'Du hast eine Beobachtung',
                subtitle: 'Die Zahlen zeigen etwas — aber was bedeutet es?',
                label: 'Was zeigen die Daten?',
                placeholder: 'z.B. "Conversion nur 2%, Branchenschnitt ist 8%" oder "80% öffnen die App, aber nur 5% schliessen den Prozess ab"',
                quickPicks: [
                    { icon: '📉', text: 'Ein Gap: Unsere Zahl ist viel schlechter als der Benchmark' },
                    { icon: '🔻', text: 'Ein Drop-off: Viele starten, wenige schliessen ab' },
                    { icon: '🤔', text: 'Eine Anomalie: Das Verhalten ist anders als erwartet' },
                    { icon: '📊', text: 'Ein Vergleich: Zwei Gruppen/Märkte verhalten sich unterschiedlich' }
                ]
            },
            sorge: {
                icon: '🚫', title: 'Du hast eine Sorge',
                subtitle: 'Etwas darf auf keinen Fall passieren.',
                label: 'Was willst du vermeiden — und warum?',
                placeholder: 'z.B. "Die NPS darf nicht unter 40 fallen" oder "Kein Vertrauensverlust bei der Digitalisierung"',
                quickPicks: [
                    { icon: '📉', text: 'Eine Kennzahl darf nicht sinken (NPS, Kundenbindung, Vertrauen...)' },
                    { icon: '💔', text: 'Kunden dürfen nicht abwandern bei einer Veränderung' },
                    { icon: '😤', text: 'Eine Massnahme darf keinen Backlash erzeugen' },
                    { icon: '⚠️', text: 'Ein Reputationsrisiko muss vermieden werden' }
                ]
            }
        };

        function brfSelectType(type) {
            brfState.type = type;
            const cfg = BRF_TYPES[type];
            if (!cfg) return;

            // Mark selected card
            document.querySelectorAll('#brfTypeCards .mb-choice').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Fill Step 2
            document.getElementById('brfStep2Icon').textContent = cfg.icon;
            document.getElementById('brfStep2Title').textContent = cfg.title;
            document.getElementById('brfStep2Subtitle').textContent = cfg.subtitle;
            document.getElementById('brfDetailLabel').textContent = cfg.label;
            document.getElementById('brfDetailInput').placeholder = cfg.placeholder;
            document.getElementById('brfDetailInput').value = '';

            // Build quick picks
            let html = '<div style="font-size:12px;color:var(--text-muted);margin-bottom:10px">Typische Ausgangspunkte — klicke zum Übernehmen:</div>';
            html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
            (cfg.quickPicks || []).forEach(qp => {
                html += `<div class="mb-choice" style="padding:10px 12px;cursor:pointer;text-align:left" onclick="brfQuickPick(this)">
                    <div style="display:flex;align-items:flex-start;gap:8px">
                        <span style="font-size:16px;flex-shrink:0">${qp.icon}</span>
                        <span style="font-size:12px;color:var(--white);line-height:1.5">${qp.text}</span>
                    </div>
                </div>`;
            });
            html += '</div>';

            // CRM search for 'kunde' type
            if (cfg.showCrm && crmCompaniesData && crmCompaniesData.length > 0) {
                html += `<div style="margin-top:16px;padding:14px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="font-size:12px;font-weight:600;color:var(--white);margin-bottom:8px">🔎 Kunde im CRM suchen</div>
                    <input class="mb-input" id="brfCrmSearch" oninput="brfSearchCrm()" placeholder="Name oder Code eingeben..." style="width:100%;box-sizing:border-box;font-size:13px;padding:8px 12px">
                    <div id="brfCrmResults" style="max-height:160px;overflow-y:auto;margin-top:8px"></div>
                </div>`;
            }

            document.getElementById('brfStep2Content').innerHTML = html;

            // Transition
            document.getElementById('brfStep1').style.display = 'none';
            document.getElementById('brfStep2').style.display = 'block';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function brfQuickPick(el) {
            const text = el.querySelector('span:last-child')?.textContent?.trim();
            if (text) document.getElementById('brfDetailInput').value = text;
            // Deselect others, select this
            el.parentElement.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function brfSearchCrm() {
            const q = (document.getElementById('brfCrmSearch')?.value || '').toLowerCase().trim();
            const container = document.getElementById('brfCrmResults');
            if (!q || q.length < 2) { container.innerHTML = ''; return; }
            const matches = (crmCompaniesData || []).filter(c =>
                (c.name||'').toLowerCase().includes(q) ||
                (c.code||'').toLowerCase().includes(q) ||
                (c.children||[]).some(ch => (ch.name||'').toLowerCase().includes(q))
            ).slice(0, 6);
            container.innerHTML = matches.map(c => `
                <div style="padding:8px 10px;cursor:pointer;border-radius:6px;font-size:13px;color:var(--white);display:flex;align-items:center;gap:8px" 
                     onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background=''" 
                     onclick="brfPickCrm('${c.code}','${(c.name||'').replace(/'/g,"\\'")}')">
                    <span style="font-size:16px">🏢</span>
                    <div><div style="font-weight:600">${c.name}</div><div style="font-size:11px;color:var(--text-muted)">${c.code} · ${c.industry || ''}</div></div>
                </div>
            `).join('');
        }

        function brfPickCrm(code, name) {
            brfState.crmCode = code;
            brfState.crmName = name;
            const input = document.getElementById('brfDetailInput');
            const current = input.value.trim();
            input.value = current ? `${name} — ${current}` : name;
            document.getElementById('brfCrmResults').innerHTML = `<div style="padding:6px 10px;font-size:12px;color:#10b981">✓ ${name} (${code}) ausgewählt</div>`;
        }

        function brfBack() {
            document.getElementById('brfStep1').style.display = 'block';
            document.getElementById('brfStep2').style.display = 'none';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function brfBackTo2() {
            document.getElementById('brfStep2').style.display = 'block';
            document.getElementById('brfStep3').style.display = 'none';
        }

        function briefingFill(el) {
            // Legacy compat
            const text = el.querySelector('div:last-child')?.textContent?.replace(/^"|"$/g, '').trim();
            if (text) document.getElementById('brfDetailInput').value = text;
        }

        async function brfAnalyze() {
            const input = document.getElementById('brfDetailInput').value.trim();
            if (!input) { showToast('Bitte beschreibe deinen Ausgangspunkt genauer', 'error'); return; }

            // Show step 3 with loading
            document.getElementById('brfStep2').style.display = 'none';
            document.getElementById('brfStep3').style.display = 'block';
            const resultDiv = document.getElementById('briefingResult');
            resultDiv.innerHTML = `<div style="text-align:center;padding:30px"><div class="spinner" style="margin:0 auto 12px"></div><div style="font-size:13px;color:rgba(255,255,255,0.5)">BEATRIX analysiert dein Briefing...</div></div>`;

            const typeLabel = BRF_TYPES[brfState.type]?.title || brfState.type;

            const prompt = `Analysiere dieses Briefing und erstelle eine strukturierte Einschätzung.

Typ: ${brfState.type} (${typeLabel})
Input: "${input}"
${brfState.crmCode ? `CRM-Kunde: ${brfState.crmName} (${brfState.crmCode})` : ''}

Antworte NUR als valides JSON:
{
  "zusammenfassung": "2-3 Sätze: Was habe ich verstanden? Was ist der Kern des Anliegens?",
  "erkannt": {
    "land": "Erkanntes Land oder null",
    "branche": "Erkannte Branche oder null",
    "organisation": "Erkannte Organisation oder null",
    "perspektive": "Kunden / Mitarbeitende / Management / null",
    "verhalten": "Beschriebenes Verhalten oder null",
    "ziel": "Genanntes Ziel oder null",
    "kennzahlen": "Genannte Zahlen/KPIs oder null"
  },
  "empfehlung": {
    "section": "context|segmente|journey|nutzen|architektur|model|audit|wirkung|evidenz",
    "label": "Name des empfohlenen nächsten Schritts",
    "grund": "2 Sätze: Warum ist das der richtige nächste Schritt?",
    "frage_fuer_analyse": "Die Kernfrage, die an die Analyse übergeben wird — klar formuliert"
  },
  "alternativen": [
    { "section": "...", "label": "...", "grund": "1 Satz warum auch sinnvoll" },
    { "section": "...", "label": "...", "grund": "1 Satz" }
  ],
  "offene_fragen": ["Was BEATRIX noch wissen müsste, um besser zu helfen", "Max 3 Fragen"]
}`;

            try {
                const resp = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: prompt, system_prompt: 'Du bist BEATRIX Briefing-Analyst bei FehrAdvice & Partners. Antworte NUR als valides JSON. Kein Markdown.' })
                });
                const data = await resp.json();
                const text = (data.response || data.answer || '').replace(/```json|```/g, '').trim();
                const result = JSON.parse(text);
                brfRenderResult(result, input);
            } catch (e) {
                console.error('Briefing parse error:', e);
                resultDiv.innerHTML = `<div style="padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="font-size:14px;color:var(--white);margin-bottom:12px">Automatische Einordnung nicht möglich — starte direkt:</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px">
                        <button class="mb-btn mb-btn-primary" onclick="briefingGoTo('context','${encodeURIComponent(input)}')">🔬 Kontext-Analyse</button>
                        <button class="mb-btn" onclick="briefingGoTo('chat','${encodeURIComponent(input)}')">💬 Im Chat besprechen</button>
                    </div>
                </div>`;
            }
        }

        // Keep old briefingAnalyze as alias
        async function briefingAnalyze() { await brfAnalyze(); }

        function brfRenderResult(r, originalInput) {
            const resultDiv = document.getElementById('briefingResult');
            const sectionIcons = { context:'🔬', segmente:'👥', journey:'🗺️', nutzen:'💎', architektur:'⚖️', model:'🏗️', audit:'📊', wirkung:'📈', evidenz:'🧪' };

            // Erkannte Felder als Pills
            const erkannt = r.erkannt || {};
            const erkanntPills = Object.entries(erkannt)
                .filter(([k,v]) => v && v !== 'null' && v !== null)
                .map(([k,v]) => `<span style="display:inline-block;padding:5px 12px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.25);border-radius:14px;font-size:12px;color:#10b981;font-weight:500">✓ ${v}</span>`)
                .join(' ');

            // Offene Fragen
            const offenHtml = (r.offene_fragen || []).filter(q => q)
                .map(q => `<div style="padding:5px 0;font-size:13px;color:rgba(255,255,255,0.7)">❓ ${q}</div>`)
                .join('');

            // Alternativen
            const altHtml = (r.alternativen || [])
                .map(a => `<button class="mb-btn" style="font-size:12px;padding:8px 14px" onclick="briefingGoTo('${a.section}','${encodeURIComponent(r.empfehlung?.frage_fuer_analyse || originalInput)}')">${sectionIcons[a.section]||'📌'} ${a.label}<span style="display:block;font-size:10px;color:var(--text-muted);font-weight:400;margin-top:2px">${a.grund}</span></button>`)
                .join(' ');

            const emp = r.empfehlung || {};

            resultDiv.innerHTML = `
                <div style="padding:24px;background:var(--navy-card);border:1px solid var(--border);border-radius:var(--radius)">
                    <!-- Zusammenfassung -->
                    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:20px">
                        <span style="font-size:28px">${BRF_TYPES[brfState.type]?.icon || '📋'}</span>
                        <div style="font-size:14px;color:rgba(255,255,255,0.88);line-height:1.75">${r.zusammenfassung || ''}</div>
                    </div>

                    <!-- Erkannt -->
                    ${erkanntPills ? `<div style="margin-bottom:18px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.8px;margin-bottom:8px">Erkannt</div><div style="display:flex;flex-wrap:wrap;gap:6px">${erkanntPills}</div></div>` : ''}

                    <!-- Offene Fragen -->
                    ${offenHtml ? `<div style="margin-bottom:20px;padding:14px;background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:var(--radius)"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#f59e0b;letter-spacing:0.8px;margin-bottom:6px">Was noch offen ist</div>${offenHtml}</div>` : ''}

                    <!-- Empfehlung -->
                    <div style="padding:18px;background:linear-gradient(135deg,rgba(91,138,245,0.1),rgba(91,138,245,0.03));border:1px solid rgba(91,138,245,0.25);border-radius:var(--radius);margin-bottom:18px">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--accent);letter-spacing:0.8px;margin-bottom:10px">Empfohlener nächster Schritt</div>
                        <div style="font-size:16px;font-weight:700;color:var(--white);margin-bottom:4px">${sectionIcons[emp.section]||'📌'} ${emp.label || emp.section}</div>
                        <div style="font-size:13px;color:var(--text-muted);margin-bottom:14px;line-height:1.6">${emp.grund || ''}</div>
                        <button class="mb-btn mb-btn-primary" onclick="briefingGoTo('${emp.section}','${encodeURIComponent(emp.frage_fuer_analyse || originalInput)}')">→ ${emp.label || emp.section} starten</button>
                    </div>

                    <!-- Alternativen -->
                    ${altHtml ? `<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.8px;margin-bottom:10px">Oder alternativ</div><div style="display:flex;flex-wrap:wrap;gap:8px">${altHtml}</div></div>` : ''}
                </div>`;
        }

        function briefingGoTo(section, encodedInput) {
            const input = decodeURIComponent(encodedInput);
            // Navigate to section
            const navItem = document.querySelector(`.nav-dropdown-item[data-section="${section}"]`);
            navDropClick(section, navItem);

            // Pre-fill where possible
            if (section === 'context') {
                // Start Kontext-Analyse gefuehrt with this input
                setTimeout(() => {
                    caStartMode('gefuehrt');
                    setTimeout(() => {
                        const qEl = document.getElementById('caQuestion');
                        if (qEl) qEl.value = input;
                        document.getElementById('caCustomInput').style.display = 'block';
                    }, 100);
                }, 200);
            } else if (section === 'chat') {
                // Switch to chat and pre-fill
                showSection('chat');
                setTimeout(() => {
                    const chatInput = document.getElementById('chatInput');
                    if (chatInput) { chatInput.value = input; chatInput.focus(); }
                }, 200);
            }
            // For placeholder sections, navigation is enough
        }

        function caGoToStart() {
            caState.step = -1;
            caState.mode = null;
            caState.lineageId = null;
            caState.currentVersionId = null;
            caState.orgType = null; caState.orgCode = null; caState.orgName = null; caState.perspective = null;
            document.querySelectorAll('#caStart .mb-mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('caStartBtn').disabled = true;
            document.getElementById('caProgress').style.display = 'none';
            caShowPanel('caStart');
        }

        function caBack(toStep) {
            caState.step = toStep;
            caShowPanel(CA_PANELS[toStep]);
            caUpdateProgress(toStep);
        }

        async function caDeepen() {
            // Auto-save schnell result first (v1)
            if (!caState.currentVersionId) {
                await caSaveAndUse();
            }
            // Switch to gefuehrt mode, keep question + lineage
            const keepQuestion = caState.question;
            const keepLineage = caState.lineageId;
            caState.mode = 'gefuehrt';
            caState.result = null;
            caState.step = 1;
            // Reset all context selections
            caState.macro = null; caState.meso = null; caState.micro = null;
            caState.orgType = null; caState.orgCode = null; caState.orgName = null; caState.perspective = null;
            caState.question = keepQuestion;
            caState.lineageId = keepLineage;
            // Go to smart confirm (AI will parse question)
            document.getElementById('caProgress').style.display = 'flex';
            caShowPanel('caStepConfirm');
            caUpdateProgress(1);
            showToast('🔍 Jetzt Kontext vertiefen — gleiche Frage, tiefere Analyse', 'info');
            await caSmartParse(keepQuestion);
        }

        function caSelect(el, value) {
            const parent = el.closest('.mb-choices') || el.parentElement;
            parent.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            // Enable the corresponding next button
            const step = el.closest('.mb-panel');
            if (step) {
                const btn = step.querySelector('.mb-btn-primary');
                if (btn) btn.disabled = false;
            }
            // Store value and toggle custom inputs
            if (step?.id === 'caStep1') {
                caState.macro = value;
                const customEl = document.getElementById('caCustomMacro');
                if (customEl) customEl.style.display = value === 'custom_macro' ? 'block' : 'none';
            }
            if (step?.id === 'caStep2') {
                caState.meso = value;
                const customEl = document.getElementById('caCustomMeso');
                if (customEl) customEl.style.display = value === 'custom_meso' ? 'block' : 'none';
            }
        }

        function caShowCustomInput() {
            document.getElementById('caCustomInput').style.display = 'block';
            document.getElementById('caQuestion').focus();
        }

        async function caLoadSuggestions() {
            const container = document.getElementById('caStep0Suggestions');
            if (!container) return;
            // Generate context-relevant suggestions
            const suggestions = [
                { icon: '🏦', text: 'Warum wechseln Schweizer so selten den Bankanbieter?', domain: 'FIN' },
                { icon: '🏥', text: 'Wie können Patienten zu besserer Medikamenten-Adhärenz motiviert werden?', domain: 'HLT' },
                { icon: '⚡', text: 'Welche Kontextfaktoren beeinflussen die Entscheidung zum Heizungsersatz?', domain: 'ENV' },
                { icon: '🗳️', text: 'Wie verändert Social Media den politischen Entscheidungskontext?', domain: 'POL' },
                { icon: '🏢', text: 'Welcher Kontext fördert/hemmt Innovationsverhalten in Organisationen?', domain: 'ORG' },
            ];
            container.innerHTML = suggestions.map(s => `
                <div class="mb-choice" style="padding:14px 16px;display:flex;align-items:center;gap:12px" onclick="caSelectSuggestion(this,'${s.text.replace(/'/g,"\\'")}')">
                    <div style="font-size:20px;min-width:32px;text-align:center">${s.icon}</div>
                    <div>
                        <div style="font-size:13px;color:var(--white);line-height:1.4">${s.text}</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">${s.domain}</div>
                    </div>
                </div>
            `).join('');
        }

        function caSelectSuggestion(el, text) {
            caState.question = text;
            if (caState.mode === 'schnell') {
                caRunSchnell(text);
            } else {
                // Smart flow: go to confirm with AI parse
                caState.step = 1;
                caShowPanel('caStepConfirm');
                caUpdateProgress(1);
                caSmartParse(text);
            }
        }

        async function caProcessStep0() {
            const q = document.getElementById('caQuestion').value.trim();
            if (!q) { showToast('Bitte Frage eingeben', 'error'); return; }
            caState.question = q;
            if (caState.mode === 'schnell') {
                caRunSchnell(q);
            } else {
                // Smart parse: AI extracts context from question
                caState.step = 1;
                caShowPanel('caStepConfirm');
                caUpdateProgress(1);
                await caSmartParse(q);
            }
        }

        // ═══ SMART PARSE: Extract context from question via AI ═══
        async function caSmartParse(question) {
            document.getElementById('caConfirmLoading').style.display = 'block';
            document.getElementById('caConfirmContent').style.display = 'none';

            const parsePrompt = `Analysiere diese Frage und extrahiere den Kontext. Antworte NUR als JSON:
"${question}"

{
  "land": { "code": "ch|at|de|custom_macro", "label": "Schweiz|Österreich|Deutschland|[Land]", "confidence": 0.0-1.0 },
  "branche": { "code": "finance|health|public|energy|retail|tech|education|custom_meso", "label": "Finanzdienstleistung|Gesundheit|...", "confidence": 0.0-1.0 },
  "organisation": { "code": "company|public|healthcare|general", "label": "Beschreibung der Organisation", "name": "konkreter Name falls erkannt oder null", "confidence": 0.0-1.0 },
  "perspektive": { "code": "kunden|mitarbeitende|management|alle", "label": "Kunden|Mitarbeitende|Management|Alle Perspektiven", "confidence": 0.0-1.0 },
  "szenarien": [
    { "title": "Kurzer Titel (max 6 Worte)", "desc": "2-3 Sätze die die konkrete Entscheidungssituation beschreiben. Wer, Wo, Wann, in welchem Zustand.", "where": "home|workplace|store|online|public|healthcare", "social": "solo|dyadic|small_group|large_group|anonymous", "time": "urgent|moderate|relaxed|recurring", "cognitive": "analytical|intuitive|stressed|fatigued|motivated", "icon": "passendes Emoji" },
    { "title": "...", "desc": "...", "where": "...", "social": "...", "time": "...", "cognitive": "...", "icon": "..." },
    { "title": "...", "desc": "...", "where": "...", "social": "...", "time": "...", "cognitive": "...", "icon": "..." }
  ]
}

Regeln:
- Wenn Land nicht klar: Default "ch" (FehrAdvice ist in Zürich), confidence: 0.3
- Wenn Branche nicht klar: besten Guess machen, confidence angeben
- Szenarien: IMMER genau 3 realistische, unterschiedliche Entscheidungssituationen generieren
- Szenario 1: Die häufigste/typischste Situation
- Szenario 2: Eine alternative Situation
- Szenario 3: Eine weniger offensichtliche aber relevante Situation`;

            try {
                const resp = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: parsePrompt, system_prompt: 'Du bist ein Kontext-Parser. Antworte NUR als valides JSON. Kein Markdown, kein Text.' })
                });
                const data = await resp.json();
                const text = (data.response || data.answer || '').replace(/```json|```/g, '').trim();
                caState.smartParse = JSON.parse(text);
            } catch (e) {
                console.error('Smart parse failed:', e);
                // Fallback defaults
                caState.smartParse = {
                    land: { code: 'ch', label: '🇨🇭 Schweiz', confidence: 0.3 },
                    branche: { code: 'finance', label: '🏦 Finanzdienstleistung', confidence: 0.3 },
                    organisation: { code: 'general', label: 'Allgemein', name: null, confidence: 0.3 },
                    perspektive: { code: 'kunden', label: '🛒 Kunden', confidence: 0.3 },
                    szenarien: []
                };
            }
            caRenderConfirm();
        }

        function caRenderConfirm() {
            const p = caState.smartParse;
            if (!p) return;

            document.getElementById('caConfirmLoading').style.display = 'none';
            document.getElementById('caConfirmContent').style.display = 'block';
            document.getElementById('caConfirmTitle').textContent = 'Erkannter Kontext — stimmt das?';
            document.getElementById('caConfirmDesc').textContent = `"${caState.question}"`;

            // Set state from parsed values
            caState.macro = p.land?.code || 'ch';
            caState.meso = p.branche?.code || 'finance';
            caState.orgType = p.organisation?.code || 'general';
            caState.orgName = p.organisation?.name || p.organisation?.label || 'Allgemein';
            caState.perspective = p.perspektive?.code || 'kunden';

            const landLabels = { ch: '🇨🇭 Schweiz', at: '🇦🇹 Österreich', de: '🇩🇪 Deutschland' };
            const brancheLabels = { finance: '🏦 Finanzdienstleistung', health: '🏥 Gesundheit', public: '🏛️ Öffentlicher Sektor', energy: '⚡ Energie', retail: '🛍️ Retail', tech: '💻 Technologie', education: '🎓 Bildung' };
            const orgLabels = { company: '🏢 Unternehmen', public: '🏛️ Behörde', healthcare: '🏥 Gesundheitseinrichtung', general: '👤 Allgemein' };
            const perspLabels = { kunden: '🛒 Kunden', mitarbeitende: '👔 Mitarbeitende', management: '📊 Management', alle: '🔄 Alle Perspektiven' };

            // Render values with confidence indicator
            const confDot = (c) => c >= 0.7 ? '🟢' : c >= 0.4 ? '🟡' : '🔴';

            document.getElementById('caConfLandValue').innerHTML = `${landLabels[p.land?.code] || p.land?.label || 'Schweiz'} <span style="font-size:11px">${confDot(p.land?.confidence||0)}</span>`;
            document.getElementById('caConfBrancheValue').innerHTML = `${brancheLabels[p.branche?.code] || p.branche?.label || '–'} <span style="font-size:11px">${confDot(p.branche?.confidence||0)}</span>`;
            const orgDisplay = p.organisation?.name ? `${orgLabels[p.organisation?.code] || ''} — ${p.organisation.name}` : (orgLabels[p.organisation?.code] || p.organisation?.label || 'Allgemein');
            document.getElementById('caConfOrgValue').innerHTML = `${orgDisplay} <span style="font-size:11px">${confDot(p.organisation?.confidence||0)}</span>`;
            document.getElementById('caConfPerspValue').innerHTML = `${perspLabels[p.perspektive?.code] || p.perspektive?.label || 'Kunden'} <span style="font-size:11px">${confDot(p.perspektive?.confidence||0)}</span>`;

            // Pre-select dropdowns
            const landSel = document.getElementById('caConfLandSelect');
            if (landSel) landSel.value = p.land?.code || 'ch';
            const brancheSel = document.getElementById('caConfBrancheSelect');
            if (brancheSel) brancheSel.value = p.branche?.code || 'finance';
            const orgSel = document.getElementById('caConfOrgSelect');
            if (orgSel) orgSel.value = p.organisation?.code || 'general';
            const perspSel = document.getElementById('caConfPerspSelect');
            if (perspSel) perspSel.value = p.perspektive?.code || 'kunden';

            // Store scenarios for next step
            caState.scenarios = p.szenarien || [];
        }

        function caConfirmEdit(field) {
            // Toggle edit mode for a field
            const editEl = document.getElementById(`caConf${field.charAt(0).toUpperCase()+field.slice(1)}Edit`);
            if (!editEl) {
                // Handle camelCase fields
                const map = { land: 'Land', branche: 'Branche', org: 'Org', persp: 'Persp' };
                const el = document.getElementById(`caConf${map[field]}Edit`);
                if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
                return;
            }
            editEl.style.display = editEl.style.display === 'none' ? 'block' : 'none';
        }

        function caConfirmPick(field) {
            const map = { land: 'Land', branche: 'Branche', org: 'Org', persp: 'Persp' };
            const sel = document.getElementById(`caConf${map[field]}Select`);
            if (!sel) return;
            const val = sel.value;

            const landLabels = { ch: '🇨🇭 Schweiz', at: '🇦🇹 Österreich', de: '🇩🇪 Deutschland', custom_macro: '🌍 Anderes Land' };
            const brancheLabels = { finance: '🏦 Finanzdienstleistung', health: '🏥 Gesundheit', public: '🏛️ Öffentlicher Sektor', energy: '⚡ Energie', retail: '🛍️ Retail', tech: '💻 Technologie', education: '🎓 Bildung', custom_meso: '🏢 Andere' };
            const orgLabels = { company: '🏢 Unternehmen', public: '🏛️ Behörde', healthcare: '🏥 Gesundheitseinrichtung', general: '👤 Allgemein' };
            const perspLabels = { kunden: '🛒 Kunden', mitarbeitende: '👔 Mitarbeitende', management: '📊 Management', alle: '🔄 Alle Perspektiven' };

            if (field === 'land') {
                caState.macro = val;
                document.getElementById('caConfLandValue').innerHTML = landLabels[val] || val;
                document.getElementById('caConfLandCustom').style.display = val === 'custom_macro' ? 'block' : 'none';
            } else if (field === 'branche') {
                caState.meso = val;
                document.getElementById('caConfBrancheValue').innerHTML = brancheLabels[val] || val;
                document.getElementById('caConfBrancheCustom').style.display = val === 'custom_meso' ? 'block' : 'none';
            } else if (field === 'org') {
                caState.orgType = val;
                document.getElementById('caConfOrgValue').innerHTML = orgLabels[val] || val;
            } else if (field === 'persp') {
                caState.perspective = val;
                document.getElementById('caConfPerspValue').innerHTML = perspLabels[val] || val;
            }

            // Hide edit after pick
            document.getElementById(`caConf${map[field]}Edit`).style.display = 'none';
        }

        function caConfirmDone() {
            // Check custom fields
            if (caState.macro === 'custom_macro') {
                const custom = document.getElementById('caConfLandCustom')?.value?.trim();
                if (custom) caState.macroCustom = custom;
            }
            if (caState.meso === 'custom_meso') {
                const custom = document.getElementById('caConfBrancheCustom')?.value?.trim();
                if (custom) caState.mesoCustom = custom;
            }
            const orgCustom = document.getElementById('caConfOrgCustom')?.value?.trim();
            if (orgCustom) caState.orgName = orgCustom;

            // Go to scenarios
            caState.step = 2;
            caShowPanel('caStepScenarios');
            caUpdateProgress(2);
            caRenderScenarios();
        }

        // ═══ SCENARIO CARDS ═══
        function caRenderScenarios() {
            const scenarios = caState.scenarios || [];
            const container = document.getElementById('caScenarioChoices');
            document.getElementById('caScenarioLoading').style.display = 'none';
            document.getElementById('caScenarioCards').style.display = 'block';

            let html = scenarios.map((s, i) => `
                <div class="mb-choice" onclick="caPickScenario(${i})" data-scenario="${i}">
                    <div class="mb-choice-num">${i+1}</div>
                    <div class="mb-choice-icon">${s.icon || '📌'}</div>
                    <div class="mb-choice-title">${s.title}</div>
                    <div class="mb-choice-desc">${s.desc}</div>
                </div>
            `).join('');

            // Custom scenario option
            html += `
                <div class="mb-choice custom-choice" onclick="caPickCustomScenario()" style="border-style:dashed">
                    <div class="mb-choice-num">✎</div>
                    <div class="mb-choice-icon">🎨</div>
                    <div class="mb-choice-title">Eigenes Szenario</div>
                    <div class="mb-choice-desc">Ort, Beteiligte, Zeitrahmen und mentalen Zustand selbst definieren.</div>
                </div>`;

            container.innerHTML = html;

            // Update description with context
            const desc = document.getElementById('caScenarioDesc');
            if (caState.orgName && caState.orgName !== 'Allgemein') {
                desc.textContent = `In welcher konkreten Situation befinden sich die ${caState.perspective === 'kunden' ? 'Kunden' : caState.perspective === 'mitarbeitende' ? 'Mitarbeitenden' : caState.perspective === 'management' ? 'Entscheider' : 'Stakeholder'} von ${caState.orgName}?`;
            }
        }

        function caPickScenario(idx) {
            const s = caState.scenarios[idx];
            if (!s) return;
            // Deselect all, select this
            document.querySelectorAll('#caScenarioChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            document.querySelector(`#caScenarioChoices .mb-choice[data-scenario="${idx}"]`)?.classList.add('selected');
            document.getElementById('caCustomScenario').style.display = 'none';

            // Store micro from scenario
            caState.micro = {
                where: s.where || '',
                social: s.social || '',
                time: s.time || '',
                cognitive: s.cognitive || '',
                notes: s.desc || '',
                scenario_title: s.title
            };
            document.getElementById('caScenarioBtn').disabled = false;
        }

        function caPickCustomScenario() {
            document.querySelectorAll('#caScenarioChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            document.querySelector('#caScenarioChoices .custom-choice')?.classList.add('selected');
            document.getElementById('caCustomScenario').style.display = 'block';
            caState.micro = {}; // Will be filled from dropdowns
            document.getElementById('caScenarioBtn').disabled = false;
        }

        function caAnalyzeFromScenario() {
            // If custom scenario, collect from dropdowns
            if (!caState.micro?.scenario_title) {
                caState.micro = {
                    where: document.getElementById('caMicroWhere')?.value || '',
                    social: document.getElementById('caMicroSocial')?.value || '',
                    time: document.getElementById('caMicroTime')?.value || '',
                    cognitive: document.getElementById('caMicroCognitive')?.value || '',
                    notes: document.getElementById('caMicroNotes')?.value?.trim() || ''
                };
            }
            caState.step = 3;
            caShowPanel('caStep4');
            caUpdateProgress(3);
            caRunAnalysis();
        }

        const CA_PANELS = ['caStep0','caStepConfirm','caStepScenarios','caStep4','caStep4'];

        function caNextStep(fromStep) {
            const next = fromStep + 1;
            caState.step = next;
            caShowPanel(CA_PANELS[next]);
            caUpdateProgress(next);
        }

        function caBackToStep(panelId, stepNum) {
            caState.step = stepNum;
            caShowPanel(panelId);
            caUpdateProgress(stepNum);
        }

        // ═══ ORGANISATION STEP ═══
        function caGoToOrg() {
            caState.step = 3;
            caShowPanel('caStepOrg');
            caUpdateProgress(3);
        }

        function caSelectOrgType(el, type) {
            document.querySelectorAll('#caOrgTypeChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.orgType = type;
            caState.orgCode = null;
            caState.orgName = null;

            const searchEl = document.getElementById('caOrgSearch');
            const formEl = document.getElementById('caNewOrgForm');
            formEl.style.display = 'none';

            if (type === 'general') {
                searchEl.style.display = 'none';
                caState.orgName = 'Allgemein';
                document.getElementById('caOrgBtn').disabled = false;
            } else {
                searchEl.style.display = 'block';
                document.getElementById('caOrgBtn').disabled = true;
                document.getElementById('caOrgSearchInput').value = '';
                document.getElementById('caOrgResults').innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Tippe um zu suchen...</div>';
                // Load CRM data if not loaded
                if (!crmCompaniesData.length) crmLoadCompanies();
            }
        }

        function caSearchOrg() {
            const q = document.getElementById('caOrgSearchInput').value.toLowerCase().trim();
            const el = document.getElementById('caOrgResults');
            if (!q) { el.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Tippe um zu suchen...</div>'; return; }

            // Search in CRM companies data
            const matches = crmCompaniesData.filter(c =>
                (c.name || '').toLowerCase().includes(q) ||
                (c.code || '').toLowerCase().includes(q) ||
                (c.children || []).some(ch => (ch.name || '').toLowerCase().includes(q))
            ).slice(0, 8);

            if (!matches.length) {
                el.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px">Keine Treffer — erstelle eine neue Organisation ↓</div>';
                return;
            }

            el.innerHTML = matches.map(c => `
                <div onclick="caPickOrg('${c.code || ''}','${(c.name||'').replace(/'/g,"\\\'")}')" style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background 0.15s;font-size:13px;display:flex;align-items:center;gap:10px" onmouseover="this.style.background='rgba(91,138,245,0.1)'" onmouseout="this.style.background='transparent'">
                    <span style="font-size:18px">🏢</span>
                    <div>
                        <div style="color:var(--white);font-weight:500">${c.name || 'Unbekannt'}</div>
                        <div style="font-size:11px;color:var(--text-muted)">${c.code || ''} · ${c.industry || c.type || ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function caPickOrg(code, name) {
            caState.orgCode = code;
            caState.orgName = name;
            caState.customerCode = code;
            document.getElementById('caOrgSearchInput').value = name;
            document.getElementById('caOrgResults').innerHTML = `<div style="padding:10px 14px;background:rgba(91,138,245,0.1);border-radius:8px;font-size:13px;color:var(--accent-light)">✅ ${name} (${code}) ausgewählt</div>`;
            document.getElementById('caOrgBtn').disabled = false;
            document.getElementById('caNewOrgForm').style.display = 'none';
        }

        function caNewOrg() {
            document.getElementById('caNewOrgForm').style.display = 'block';
            document.getElementById('caOrgResults').innerHTML = '';
            document.getElementById('caOrgSearchInput').value = '';
            document.getElementById('caNewOrgName').focus();
            document.getElementById('caNewOrgName').oninput = () => {
                const name = document.getElementById('caNewOrgName').value.trim();
                if (name) {
                    caState.orgName = name;
                    caState.orgCode = null; // New, no code yet
                    document.getElementById('caOrgBtn').disabled = false;
                } else {
                    document.getElementById('caOrgBtn').disabled = true;
                }
            };
        }

        // ═══ PERSPEKTIVE STEP ═══
        function caGoToPersp() {
            caState.step = 4;
            caShowPanel('caStepPersp');
            caUpdateProgress(4);
            // Update description based on org
            const desc = document.getElementById('caPerspDesc');
            if (caState.orgName && caState.orgName !== 'Allgemein') {
                desc.textContent = `Wessen Verhalten bei ${caState.orgName} möchten wir verstehen?`;
            }
        }

        function caSelectPersp(el, value) {
            document.querySelectorAll('#caPerspChoices .mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            caState.perspective = value;
            document.getElementById('caPerspBtn').disabled = false;
        }

        function caGoToSituation() {
            caState.step = 5;
            caShowPanel('caStep3');
            caUpdateProgress(5);
        }

        function caUpdateMicroBtn() {
            const w = document.getElementById('caMicroWhere').value;
            const s = document.getElementById('caMicroSocial').value;
            const btn = document.getElementById('caStep3Btn');
            if (btn) btn.disabled = !(w && s);
        }

        async function caAnalyze() {
            // Collect MICRO data (fallback for old step)
            caState.micro = {
                where: document.getElementById('caMicroWhere')?.value || '',
                social: document.getElementById('caMicroSocial')?.value || '',
                time: document.getElementById('caMicroTime')?.value || '',
                cognitive: document.getElementById('caMicroCognitive')?.value || '',
                notes: document.getElementById('caMicroNotes')?.value?.trim() || ''
            };
            caState.step = 3;
            caShowPanel('caStep4');
            caUpdateProgress(3);
            await caRunAnalysis();
        }

        async function caRunAnalysis() {
            const statusEl = document.getElementById('caAnalysisStatus');
            const progressEl = document.getElementById('caAnalysisProgress');
            const resultEl = document.getElementById('caAnalysisResult');
            progressEl.style.display = 'block';
            resultEl.style.display = 'none';

            const steps = ['Wissen wird geladen...', 'Landeskontext analysieren...', 'Branchenumfeld einordnen...', 'Situation verstehen...', 'Kontextprofil erstellen...', 'Auswirkungen ableiten...'];
            for (let i = 0; i < steps.length; i++) {
                statusEl.textContent = steps[i];
                await new Promise(r => setTimeout(r, 600));
            }

            // Call AI for full analysis
            const orgInfo = caState.orgName && caState.orgName !== 'Allgemein' ? `\nOrganisation: ${caState.orgName}${caState.orgCode ? ' ('+caState.orgCode+')' : ''} [Typ: ${caState.orgType || 'unbekannt'}]` : '';
            const perspInfo = caState.perspective ? `\nPerspektive: ${caState.perspective === 'alle' ? 'Alle Stakeholder (strategische Gesamtanalyse)' : caState.perspective === 'kunden' ? 'Kunden/Endnutzer' : caState.perspective === 'mitarbeitende' ? 'Mitarbeitende/Frontline' : 'Management/Entscheider'}` : '';

            const prompt = caState.mode === 'schnell'
                ? `Führe eine vollständige EBF-Kontextanalyse durch für folgende Frage:\n"${caState.question}"\n\nAnalysiere alle 5 Ebenen (MACRO→MESO→MICRO→INDIVIDUAL→META) und alle 8 Ψ-Dimensionen.`
                : `Führe eine EBF-Kontextanalyse durch:\nFrage: "${caState.question}"\nMACRO: ${caState.macro}${caState.macro==='custom_macro' ? ' ('+(caState.macroCustom || document.getElementById('caMacroCustom')?.value || '')+')' : ''}\nMESO: ${caState.meso}${caState.meso==='custom_meso' ? ' ('+(caState.mesoCustom || document.getElementById('caMesoCustom')?.value || '')+')' : ''}${orgInfo}${perspInfo}\nMICRO: Ort=${caState.micro?.where||''}, Sozial=${caState.micro?.social||''}, Zeit=${caState.micro?.time||''}, Kognitiv=${caState.micro?.cognitive||''}${caState.micro?.notes ? ', Notizen: '+caState.micro.notes : ''}${caState.micro?.scenario_title ? '\nSzenario: '+caState.micro.scenario_title : ''}`;

            const sysPrompt = `Du bist BEATRIX Kontext-Analyst. Analysiere mit dem EBF Ψ-Framework.

Antworte EXAKT in diesem JSON-Format (kein Markdown, kein Text davor/danach):
{
  "psi_profile": {
    "psi_i": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz in Alltagssprache: Was bedeutet das für die Person konkret?" },
    "psi_s": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_c": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_k": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_e": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_t": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_m": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" },
    "psi_f": { "value": 0.0-1.0, "label": "kurze Beschreibung", "key_factors": ["Faktor1","Faktor2"], "plain": "1 Satz Alltagssprache" }
  },
  "context_story": "Ein Absatz (4-6 Sätze) in einfacher Sprache, der die gesamte Situation aus Sicht der betroffenen Person beschreibt. Kein Fachjargon, keine griechischen Buchstaben, keine Zahlenwerte. Schreibe so, als würdest du einem Kunden erklären, in welcher Welt sich die Zielgruppe befindet. Beginne mit 'Die Menschen in diesem Kontext...' oder 'Stell dir vor...'",
  "allgemeine_perspektive": "Ein Absatz (3-5 Sätze) aus der Vogelperspektive: Was ist das GROSSE BILD dieses Kontexts? Welche Kräfte wirken auf das Verhalten? Was macht diesen Kontext besonders oder herausfordernd? Schreibe wie ein erfahrener Berater, der einem CEO in 30 Sekunden erklärt, warum sich Menschen hier so verhalten wie sie es tun. Kein Jargon, keine Zahlenwerte.",
  "parameters": {
    "lambda": { "value": "Zahl", "note": "Erklärung warum dieser Wert im Kontext" },
    "beta": { "value": "Zahl", "note": "Erklärung" },
    "theta": { "value": "Zahl", "note": "Erklärung" },
    "delta": { "value": "Zahl", "note": "Erklärung" }
  },
  "synthesis": "2-3 Sätze Zusammenfassung: Was bedeutet dieser Kontext für Verhaltensvorhersagen?",
  "implications": ["Implikation 1", "Implikation 2", "Implikation 3"],
  "confidence": "LLMMC Prior | Confidence: 0.0-1.0",
  "macro_summary": "1 Satz MACRO",
  "meso_summary": "1 Satz MESO",
  "micro_summary": "1 Satz MICRO"
}

WICHTIG für "plain" und "context_story":
- Schreibe für einen Berater, der den Kontext seinem Kunden erklärt
- Keine griechischen Buchstaben (λ, β, Ψ)
- Keine Zahlenwerte oder Scores
- Konkrete Beispiele aus dem Alltag der Zielgruppe
- "plain" pro Dimension: Was SPÜRT oder ERLEBT die Person?
- "context_story": Die Geschichte des Kontexts als zusammenhängende Erzählung

Werte-Skala für Ψ: 0.0 = minimal/absent, 0.5 = moderat, 1.0 = maximal/dominant.
Parameter sind KONTEXTABHÄNGIG: λ(Ψ), β(Ψ), θ(Ψ) — KEINE Konstanten!`;

            try {
                const r = await fetch(`${API}/chat`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt, system_prompt: sysPrompt, context: 'context_analysis' })
                });
                if (!r.ok) throw new Error('Analysis failed');

                let text = '';
                if (r.headers.get('content-type')?.includes('text/event-stream')) {
                    const reader = r.body.getReader();
                    const decoder = new TextDecoder();
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, { stream: true });
                        for (const line of chunk.split('\n')) {
                            if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                                try { const d = JSON.parse(line.slice(6)); if (d.content) text += d.content; } catch(e) {}
                            }
                        }
                    }
                } else {
                    const data = await r.json();
                    text = data.response || data.content || JSON.stringify(data);
                }

                // Parse JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    caState.result = JSON.parse(jsonMatch[0]);
                    caRenderResult();
                } else {
                    throw new Error('No JSON in response');
                }
            } catch(e) {
                console.error('CA analysis error:', e);
                // Generate fallback result
                caState.result = caGenerateFallback();
                caRenderResult();
            }
        }

        function caGenerateFallback() {
            return {
                allgemeine_perspektive: 'Ohne spezifischere Angaben zum Kontext können wir nur ein grobes Bild zeichnen. Jede Verhaltensveränderung hängt davon ab, in welcher Welt sich die Menschen befinden — welche Regeln gelten, wer zuschaut, wie viel Zeit und Geld zur Verfügung steht, und ob die Situation Nachdenken erlaubt oder schnelle Entscheidungen erzwingt. Je mehr wir über den konkreten Kontext wissen, desto präziser können wir vorhersagen, was funktioniert.',
                psi_profile: {
                    psi_i: { value: 0.6, label: 'Moderater regulatorischer Rahmen', key_factors: ['Gesetzgebung', 'Defaults'], plain: 'Es gibt klare Regeln und Vorgaben, aber auch Spielraum für eigene Entscheidungen.' },
                    psi_s: { value: 0.5, label: 'Gemischte soziale Einflüsse', key_factors: ['Peer Effects', 'Normen'], plain: 'Was andere tun, spielt eine Rolle — aber man fühlt sich nicht stark unter Beobachtung.' },
                    psi_c: { value: 0.4, label: 'Moderate kognitive Belastung', key_factors: ['Komplexität', 'Aufmerksamkeit'], plain: 'Die Entscheidung ist nicht trivial, aber auch nicht überwältigend — man muss sich etwas Zeit nehmen.' },
                    psi_k: { value: 0.5, label: 'Kultureller Standardkontext', key_factors: ['Werte', 'Tradition'], plain: 'Kulturelle Gewohnheiten und Werte spielen mit, ohne die Entscheidung zu dominieren.' },
                    psi_e: { value: 0.5, label: 'Durchschnittliche Ressourcen', key_factors: ['Budget', 'Zeit'], plain: 'Geld und Zeit sind vorhanden, aber begrenzt — man wägt ab, was sich lohnt.' },
                    psi_t: { value: 0.4, label: 'Moderater Zeitdruck', key_factors: ['Deadline', 'Rhythmus'], plain: 'Es besteht kein akuter Zeitdruck, aber die Entscheidung sollte irgendwann fallen.' },
                    psi_m: { value: 0.5, label: 'Standard-Tooling', key_factors: ['Digital', 'Analog'], plain: 'Die nötigen Werkzeuge und Informationen sind grundsätzlich verfügbar.' },
                    psi_f: { value: 0.5, label: 'Neutrales Setting', key_factors: ['Ort', 'Zugang'], plain: 'Der Ort der Entscheidung hat keinen starken Einfluss — weder besonders förderlich noch hinderlich.' }
                },
                context_story: 'Die Menschen in diesem Kontext bewegen sich in einem relativ stabilen Umfeld. Sie haben grundsätzlich Zugang zu Informationen und Ressourcen, stehen aber vor einer Entscheidung, die nicht ganz einfach ist. Soziale Einflüsse spielen eine Rolle — man schaut durchaus, was andere machen — aber letztlich fühlt sich jeder für seine eigene Entscheidung verantwortlich. Es gibt keinen akuten Handlungsdruck, was dazu führen kann, dass Entscheidungen aufgeschoben werden. Die kulturelle Prägung gibt eine Richtung vor, ohne die Wahl zu erzwingen.',
                parameters: {
                    lambda: { value: '2.25', note: 'GGG Default — kein kontextspezifischer Modifier' },
                    beta: { value: '0.95', note: 'Leicht present-biased im Standardkontext' },
                    theta: { value: '0.5', note: 'Mittlere Aufmerksamkeit' },
                    delta: { value: '0.97', note: 'Standard-Diskontierung' }
                },
                synthesis: 'Ohne spezifischere Kontextdaten werden GGG-Defaults verwendet. Die Parameter sind LLMMC Priors und sollten mit empirischen Daten kalibriert werden.',
                implications: ['GGG Defaults aktiv — alle Parameter mit Vorsicht nutzen', 'Kontextspezifische Daten würden die Präzision erhöhen', 'BCM2-Datenbank für empirische Ankerwerte konsultieren'],
                confidence: 'LLMMC Prior | Confidence: 0.35',
                macro_summary: 'Standard DACH-Kontext angenommen',
                meso_summary: 'Branchenkontext nicht spezifiziert',
                micro_summary: 'Situationsspezifische Faktoren unbekannt'
            };
        }

        function caRenderResult() {
            const r = caState.result;
            if (!r) return;

            document.getElementById('caAnalysisProgress').style.display = 'none';
            document.getElementById('caAnalysisResult').style.display = 'block';
            document.querySelector('#caStep4 .mb-step-title').textContent = 'Kontextprofil — Ergebnis';
            document.querySelector('#caStep4 .mb-step-desc').textContent = caState.question;

            // Context breadcrumb
            const bcParts = [];
            if (caState.macro && caState.macro !== 'custom_macro') bcParts.push(caState.macro === 'ch' ? '🇨🇭 Schweiz' : caState.macro === 'at' ? '🇦🇹 Österreich' : caState.macro === 'de' ? '🇩🇪 Deutschland' : caState.macro);
            if (caState.meso && caState.meso !== 'custom_meso') bcParts.push(caState.meso === 'finance' ? '🏦 Finanz' : caState.meso === 'health' ? '🏥 Gesundheit' : caState.meso === 'public' ? '🏛️ Öffentlich' : caState.meso);
            if (caState.orgName && caState.orgName !== 'Allgemein') bcParts.push('🏢 ' + caState.orgName);
            if (caState.perspective) bcParts.push(caState.perspective === 'alle' ? '🔄 Alle Perspektiven' : caState.perspective === 'kunden' ? '🛒 Kunden' : caState.perspective === 'mitarbeitende' ? '👔 Mitarbeitende' : '📊 Management');
            const bcEl = document.getElementById('caResultBreadcrumb');
            if (bcEl) {
                bcEl.innerHTML = bcParts.length ? bcParts.map(p => `<span style="padding:3px 10px;background:rgba(91,138,245,0.1);border:1px solid rgba(91,138,245,0.2);border-radius:12px;font-size:11px;color:var(--accent-light)">${p}</span>`).join('') : '';
                bcEl.style.display = bcParts.length ? 'flex' : 'none';
            }

            caUpdateProgress(4);

            // Show "Kontext vertiefen" button only in schnell mode
            const deepenBtn = document.getElementById('caDeepenBtn');
            if (deepenBtn) deepenBtn.style.display = caState.mode === 'schnell' ? 'inline-flex' : 'none';

            // 0) Allgemeine Perspektive — Big Picture
            const perspEl = document.getElementById('caPerspectiveText');
            if (perspEl) {
                perspEl.textContent = r.allgemeine_perspektive || '';
                document.getElementById('caPerspectiveBox').style.display = r.allgemeine_perspektive ? 'block' : 'none';
            }

            // Render Ψ cards
            const cardsEl = document.getElementById('caPsiCards');
            cardsEl.innerHTML = PSI_DIMS.map(dim => {
                const data = r.psi_profile?.[dim.key] || { value: 0.5, label: '–', key_factors: [] };
                const pct = Math.round(data.value * 100);
                const hue = data.value < 0.3 ? 200 : data.value < 0.7 ? 45 : 140;
                return `
                <div style="padding:14px;background:var(--navy-light);border:1px solid var(--border);border-radius:var(--radius)">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
                        <span style="font-size:16px">${dim.icon}</span>
                        <span style="font-size:12px;font-weight:700;color:var(--white)">${dim.label}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                        <div style="flex:1;height:6px;background:var(--navy-mid);border-radius:3px;overflow:hidden">
                            <div style="width:${pct}%;height:100%;background:hsl(${hue},70%,55%);border-radius:3px;transition:width 0.8s ease"></div>
                        </div>
                        <span style="font-size:13px;font-weight:700;color:hsl(${hue},70%,65%)">${data.value.toFixed(2)}</span>
                    </div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.6);line-height:1.4;margin-bottom:4px">${data.label}</div>
                    <div style="font-size:10px;color:rgba(255,255,255,0.35)">${(data.key_factors||[]).join(' · ')}</div>
                </div>`;
            }).join('');

            // ── Context Story Box: Plain Language Translation ──
            const storyTextEl = document.getElementById('caStoryText');
            const storyDimsEl = document.getElementById('caStoryDims');
            const storyBoxEl = document.getElementById('caStoryBox');

            if (r.context_story || PSI_DIMS.some(d => r.psi_profile?.[d.key]?.plain)) {
                storyBoxEl.style.display = 'block';

                // Main story paragraph
                storyTextEl.innerHTML = r.context_story
                    ? `<p style="margin:0">${r.context_story}</p>`
                    : '';

                // Per-dimension plain-language bullets
                const dimLines = PSI_DIMS.map(dim => {
                    const data = r.psi_profile?.[dim.key];
                    if (!data?.plain) return '';
                    const hue = data.value < 0.3 ? 200 : data.value < 0.7 ? 45 : 140;
                    return `
                    <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:8px">
                        <span style="font-size:16px;min-width:24px;text-align:center;margin-top:1px">${dim.icon}</span>
                        <div style="flex:1">
                            <div style="font-size:12px;font-weight:600;color:hsl(${hue},60%,70%);margin-bottom:2px">${dim.label.replace(/Ψ_[A-Z]\s*/,'')}</div>
                            <div style="font-size:13px;color:rgba(255,255,255,0.75);line-height:1.5">${data.plain}</div>
                        </div>
                    </div>`;
                }).filter(Boolean).join('');

                storyDimsEl.innerHTML = dimLines;
            } else {
                storyBoxEl.style.display = 'none';
            }

            // Render parameters
            const paramsEl = document.getElementById('caParams');
            const params = r.parameters || {};
            paramsEl.innerHTML = Object.entries(params).map(([k, v]) =>
                `<div style="display:flex;align-items:baseline;gap:8px;margin-bottom:6px">
                    <span style="font-weight:700;color:var(--accent-light);min-width:24px">${k === 'lambda' ? 'λ' : k === 'beta' ? 'β' : k === 'theta' ? 'θ' : k === 'delta' ? 'δ' : k}</span>
                    <span style="font-weight:600;color:var(--white)">${v.value}</span>
                    <span style="color:rgba(255,255,255,0.45);font-size:12px">— ${v.note}</span>
                </div>`
            ).join('');

            // Render synthesis
            const insightEl = document.getElementById('caInsight');
            let html = `<p style="margin-bottom:10px">${r.synthesis || ''}</p>`;
            if (r.implications?.length) {
                html += '<div style="margin-top:8px">' + r.implications.map(imp =>
                    `<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:4px;font-size:12px"><span style="color:var(--accent)">→</span> ${imp}</div>`
                ).join('') + '</div>';
            }
            if (r.confidence) {
                html += `<div style="margin-top:10px;padding:8px 12px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px;font-size:11px;color:rgba(251,191,36,0.8)">⚠️ ${r.confidence}</div>`;
            }
            insightEl.innerHTML = html;
        }

        async function caSaveAndUse() {
            const r = caState.result;
            if (!r) return;
            const payload = {
                question: caState.question,
                mode: caState.mode,
                macro_context: caState.macro ? { country: caState.macro, custom: caState.macroCustom || document.getElementById('caMacroCustom')?.value } : null,
                meso_context: caState.meso ? { industry: caState.meso, custom: caState.mesoCustom || document.getElementById('caMesoCustom')?.value, org_type: caState.orgType, org_name: caState.orgName, perspective: caState.perspective } : null,
                micro_context: caState.micro || null,
                psi_profile: r.psi_profile,
                parameters: r.parameters,
                synthesis: r.synthesis,
                implications: r.implications,
                confidence: r.confidence,
                customer_code: caState.customerCode || null,
                project_slug: caState.projectSlug || null,
                lineage_id: caState.lineageId || null
            };
            try {
                // Try new versioned endpoint first
                let resp = await fetch(`${API}/psi-analyses`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (resp.ok) {
                    const result = await resp.json();
                    showToast(`Kontextprofil gespeichert: ${result.lineage_id} v${result.version}`, 'success');
                    caState.lineageId = result.lineage_id;
                    caState.currentVersionId = result.id;
                    return;
                }
                // Fallback: save to old contexts table
                const fallback = {
                    client: 'Ψ-Analyse',
                    project: caState.question.substring(0, 80),
                    domain: 'OTH',
                    status: 'aktiv',
                    situation: JSON.stringify(r.psi_profile || {}),
                    goal: r.synthesis || '',
                    constraints: r.confidence || ''
                };
                resp = await fetch(`${API}/contexts`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(fallback)
                });
                if (resp.ok) {
                    showToast('Kontextprofil gespeichert', 'success');
                } else {
                    throw new Error('Both endpoints failed');
                }
            } catch(e) {
                console.error('Save error:', e);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        function caUseInChat() {
            const r = caState.result;
            if (!r) return;
            // Build context string for chat
            const psiSummary = PSI_DIMS.map(d => {
                const v = r.psi_profile?.[d.key];
                return v ? `${d.label}: ${v.value.toFixed(2)} (${v.label})` : '';
            }).filter(Boolean).join('\n');
            const params = Object.entries(r.parameters||{}).map(([k,v]) => `${k}=${v.value}`).join(', ');
            const ctxMsg = `[KONTEXT-ANALYSE]\nFrage: ${caState.question}\n\nΨ-Profil:\n${psiSummary}\n\nParameter: ${params}\n\nSynthese: ${r.synthesis}`;
            // Switch to chat and populate
            showSection('chat', document.querySelector('[data-section="chat"]'));
            setTimeout(() => {
                const input = document.getElementById('chatInput');
                if (input) {
                    input.value = ctxMsg;
                    input.style.height = 'auto';
                    input.style.height = input.scrollHeight + 'px';
                    input.focus();
                }
            }, 200);
        }

        async function caShowHistory() {
            caShowPanel('caHistory');
            document.getElementById('caProgress').style.display = 'none';
            const container = document.getElementById('caHistoryList');
            container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)"><div class="spinner" style="margin:0 auto 12px"></div>Wird geladen...</div>';
            try {
                let analyses = [];
                // Try new versioned endpoint
                let r = await fetch(`${API}/psi-analyses`, { headers: H() });
                if (r.ok) {
                    analyses = await r.json();
                } else {
                    // Fallback: load from old contexts table
                    r = await fetch(`${API}/contexts`, { headers: H() });
                    if (r.ok) {
                        const old = await r.json();
                        analyses = old.filter(c => c.client === 'Ψ-Analyse' || c.client === 'Kontextanalyse').map(c => {
                            let psiProfile = {};
                            try { psiProfile = JSON.parse(c.situation); } catch(e) {}
                            return {
                                id: c.id,
                                lineage_id: `LEGACY-${c.id}`,
                                version: 1,
                                question: c.project || c.client || '–',
                                mode: 'schnell',
                                psi_profile: psiProfile,
                                parameters: {},
                                synthesis: c.goal || '',
                                confidence: c.constraints || '',
                                created_by: c.created_by,
                                created_at: c.created_at
                            };
                        });
                    }
                }
                if (!analyses.length) {
                    container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Noch keine Ψ-Analysen gespeichert.</div>';
                    return;
                }

                // Group by lineage
                const lineages = {};
                analyses.forEach(a => {
                    if (!lineages[a.lineage_id]) lineages[a.lineage_id] = [];
                    lineages[a.lineage_id].push(a);
                });

                container.innerHTML = Object.entries(lineages).map(([lid, versions]) => {
                    const latest = versions[0]; // already sorted DESC
                    const date = new Date(latest.created_at).toLocaleDateString('de-CH', { day: '2-digit', month: 'short', year: 'numeric' });
                    const psi = latest.psi_profile || {};

                    // Mini Ψ bars
                    const psiMini = PSI_DIMS.map(d => {
                        const v = psi[d.key];
                        if (!v) return '';
                        const pct = Math.round(v.value * 100);
                        const hue = v.value < 0.3 ? 200 : v.value < 0.7 ? 45 : 140;
                        return `<div style="display:flex;align-items:center;gap:4px;min-width:110px">
                            <span style="font-size:12px">${d.icon}</span>
                            <div style="flex:1;height:4px;background:var(--navy-mid);border-radius:2px;overflow:hidden;max-width:50px">
                                <div style="width:${pct}%;height:100%;background:hsl(${hue},70%,55%);border-radius:2px"></div>
                            </div>
                            <span style="font-size:11px;color:hsl(${hue},70%,65%);font-weight:600">${v.value.toFixed(1)}</span>
                        </div>`;
                    }).join('');

                    // Version pills
                    const versionPills = versions.map(v => {
                        const isLatest = v.id === latest.id;
                        const vDate = new Date(v.created_at).toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit' });
                        return `<span onclick="caLoadVersion('${v.id}')" style="font-size:10px;padding:2px 8px;border-radius:10px;cursor:pointer;transition:all 0.2s;${isLatest ? 'background:var(--accent);color:white' : 'background:var(--navy-mid);color:rgba(255,255,255,0.5);border:1px solid var(--border)'}" title="${vDate}">v${v.version}</span>`;
                    }).join('');

                    // Params
                    const params = latest.parameters || {};
                    const paramStr = Object.entries(params).map(([k,v]) => {
                        const sym = k === 'lambda' ? 'λ' : k === 'beta' ? 'β' : k === 'theta' ? 'θ' : k === 'delta' ? 'δ' : k;
                        return `<span style="color:var(--accent-light)">${sym}</span>=${v.value}`;
                    }).join('  ');

                    return `
                    <div style="padding:16px 18px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
                            <span style="font-size:11px;font-family:monospace;color:var(--accent-light);background:var(--accent-glow);padding:2px 8px;border-radius:6px">${lid}</span>
                            <span style="font-weight:600;color:var(--white);font-size:14px;flex:1">${latest.question?.substring(0,80) || '–'}${(latest.question?.length||0) > 80 ? '...' : ''}</span>
                            <span style="font-size:11px;color:rgba(255,255,255,0.25)">${date}</span>
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px 12px;margin-bottom:10px">${psiMini}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:8px">${paramStr}</div>
                        ${latest.synthesis ? `<div style="font-size:12px;color:rgba(255,255,255,0.55);line-height:1.5;margin-bottom:8px">${latest.synthesis.substring(0,200)}${latest.synthesis.length > 200 ? '...' : ''}</div>` : ''}
                        <div style="display:flex;align-items:center;gap:8px;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px;flex-wrap:wrap">
                            <span style="font-size:10px;color:rgba(255,255,255,0.3)">Versionen:</span>
                            ${versionPills}
                            <div style="flex:1"></div>
                            <button onclick="caNewVersion('${lid}','${latest.question?.replace(/'/g,"\\'")}')" style="font-size:11px;padding:3px 10px;background:rgba(139,170,255,0.08);color:var(--accent-light);border:1px solid rgba(139,170,255,0.2);border-radius:6px;cursor:pointer" title="Neue Version dieser Analyse">+ v${versions.length+1}</button>
                            <button onclick="caDeleteAnalysis('${latest.id}')" style="font-size:11px;padding:3px 8px;background:transparent;color:rgba(248,113,113,0.5);border:1px solid rgba(248,113,113,0.15);border-radius:6px;cursor:pointer">Löschen</button>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) {
                console.error('History load:', e);
                container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Fehler beim Laden.</div>';
            }
        }

        function caNewVersion(lineageId, question) {
            caState.lineageId = lineageId;
            caState.question = question;
            caState.mode = 'schnell';
            caRunSchnell(question);
        }

        async function caLoadVersion(analysisId) {
            // Could expand to show full detail of a specific version
            showToast(`Version ${analysisId} — Detail-View kommt bald`, 'info');
        }

        async function caDeleteAnalysis(id) {
            if (!confirm('Ψ-Analyse wirklich löschen?')) return;
            try {
                let resp = await fetch(`${API}/psi-analyses/${id}`, { method: 'DELETE', headers: H() });
                if (!resp.ok) {
                    // Fallback: try old contexts endpoint
                    resp = await fetch(`${API}/contexts/${id}`, { method: 'DELETE', headers: H() });
                }
                showToast('Analyse gelöscht', 'success');
                caShowHistory();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // Keep legacy ctxLoad as alias
        function ctxLoad() { caInit(); }

        // ── CRM ──────────────────────────────────────────
        let crmDeals = [];
        let crmView = 'kanban';
        const CRM_STAGES = [
            { id: 'prospect', label: 'Prospect', color: 'rgba(139,170,255,0.8)', prob: 10, icon: '🎯' },
            { id: 'qualified', label: 'Qualified', color: 'rgba(56,189,248,0.8)', prob: 25, icon: '✅' },
            { id: 'proposal', label: 'Proposal', color: 'rgba(251,191,36,0.8)', prob: 50, icon: '📄' },
            { id: 'negotiation', label: 'Negotiation', color: 'rgba(232,163,61,0.9)', prob: 75, icon: '🤝' },
            { id: 'won', label: 'Won', color: 'rgba(52,211,153,0.8)', prob: 100, icon: '🏆' },
            { id: 'active', label: 'Active', color: 'rgba(52,211,153,0.6)', prob: 100, icon: '⚡' },
            { id: 'dormant', label: 'Dormant', color: 'rgba(148,163,184,0.5)', prob: 5, icon: '💤' },
            { id: 'churned', label: 'Churned', color: 'rgba(248,113,113,0.4)', prob: 0, icon: '📉' },
            { id: 'lost', label: 'Lost', color: 'rgba(248,113,113,0.6)', prob: 0, icon: '✗' }
        ];
        const CRM_PIPELINE = ['prospect', 'qualified', 'proposal', 'negotiation', 'won', 'active'];

        let crmLastSync = null;

        async function crmLoad() {
            try {
                const [dealsR, statsR] = await Promise.all([
                    fetch(`${API}/crm/deals`, { headers: H() }),
                    fetch(`${API}/crm/stats`, { headers: H() })
                ]);
                crmDeals = dealsR.ok ? await dealsR.json() : [];
                const stats = statsR.ok ? await statsR.json() : {};
                crmRenderKpis(stats);
                crmRenderView();
                const hint = document.getElementById('crmSyncHint');
                if (hint) hint.style.display = crmDeals.length ? 'none' : 'block';
                // Date info
                const di = document.getElementById('crmDateInfo');
                if (di) {
                    const today = new Date().toLocaleDateString('de-CH', {day:'2-digit', month:'long', year:'numeric'});
                    const syncInfo = crmLastSync ? ` · Letzter Sync: ${crmLastSync.toLocaleTimeString('de-CH', {hour:'2-digit', minute:'2-digit'})}` : '';
                    di.textContent = `Stand: ${today}${syncInfo}`;
                }
            } catch(e) { console.error('CRM load:', e); crmDeals = []; crmRenderView(); }
        }

        function crmRenderKpis(s) {
            document.getElementById('crmKpiActive').textContent = s.active_deals || 0;
            document.getElementById('crmKpiPipeline').textContent = s.pipeline_value ? new Intl.NumberFormat('de-CH', {notation:'compact'}).format(s.pipeline_value) + ' CHF' : '–';
            document.getElementById('crmKpiWon').textContent = s.won_deals || 0;
            document.getElementById('crmKpiConv').textContent = (s.conversion_rate || 0) + '%';
            document.getElementById('crmKpiCompanies').textContent = s.companies || 0;
        }

        function crmSetView(v) {
            crmView = v;
            document.getElementById('crmViewKanban').classList.toggle('active', v === 'kanban');
            document.getElementById('crmViewTable').classList.toggle('active', v === 'table');
            document.getElementById('crmKanban').style.display = v === 'kanban' ? 'flex' : 'none';
            document.getElementById('crmTable').style.display = v === 'table' ? 'block' : 'none';
            crmRenderView();
        }

        function crmRenderView() {
            // Show/hide filter banner
            const banner = document.getElementById('crmFilterBanner');
            if (banner) banner.style.display = crmCompanyFilter ? 'flex' : 'none';
            if (crmView === 'kanban') crmRenderKanban(); else crmRenderTable();
        }

        function crmGetFilteredDeals() {
            if (!crmCompanyFilter) return crmDeals;
            return crmDeals.filter(d => d.company_id === crmCompanyFilter || d.company === crmCompanyFilter);
        }

        function crmClearFilter() { crmCompanyFilter = null; crmRenderView(); }

        function crmRenderKanban() {
            const container = document.getElementById('crmKanban');
            const deals = crmGetFilteredDeals();
            container.innerHTML = CRM_PIPELINE.map(stageId => {
                const stage = CRM_STAGES.find(s => s.id === stageId);
                const stageDeals = deals.filter(d => d.stage === stageId);
                const stageValue = stageDeals.reduce((s, d) => s + (d.value || 0), 0);
                return `<div class="crm-col" data-stage="${stageId}" ondragover="event.preventDefault();this.style.background='rgba(139,170,255,0.05)'" ondragleave="this.style.background=''" ondrop="crmDrop(event,'${stageId}');this.style.background=''">
                    <div style="padding:10px 12px;border-bottom:2px solid ${stage.color};display:flex;align-items:center;gap:6px">
                        <span style="font-size:11px">${stage.icon}</span>
                        <span style="font-size:12px;font-weight:600;color:white;flex:1">${stage.label}</span>
                        <span style="font-size:11px;color:rgba(255,255,255,0.3)">${stageDeals.length}</span>
                    </div>
                    <div style="padding:6px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:5px;max-height:60vh">
                        ${stageDeals.length === 0 ? '<div style="text-align:center;padding:16px;font-size:11px;color:rgba(255,255,255,0.15)">–</div>' :
                        stageDeals.map(d => crmRenderCard(d, stage.color)).join('')}
                    </div>
                </div>`;
            }).join('');
            const other = crmDeals.filter(d => !CRM_PIPELINE.includes(d.stage));
            if (other.length) {
                container.innerHTML += `<div style="min-width:80px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.04)"><div style="padding:10px;text-align:center"><div style="font-size:11px;color:rgba(255,255,255,0.2)">Archiv</div><div style="font-size:16px;color:rgba(255,255,255,0.3)">${other.length}</div></div></div>`;
            }
        }

        function crmRenderCard(d, stageColor) {
            const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) : '';
            const owner = d.owner ? d.owner.replace('OWN-','') : '';
            const hot = d.notes && d.notes.includes('🔥') ? '🔥' : '';
            return `<div class="crm-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain','${d.id}')" onclick="crmOpenDeal('${d.id}')">
                <div style="font-size:12px;font-weight:600;color:white;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.title||'–'} ${hot}</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:1px">${d.company_name||''}</div>
                ${d.contact_name ? `<div style="font-size:10px;color:rgba(255,255,255,0.25);margin-top:3px">👤 ${d.contact_name}</div>` : ''}
                ${d.next_action ? `<div style="font-size:10px;color:rgba(251,191,36,0.8);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">→ ${d.next_action}</div>` : ''}
                <div style="display:flex;align-items:center;gap:4px;margin-top:4px">
                    ${val ? `<span style="font-size:10px;font-weight:600;color:${stageColor}">${val} CHF</span>` : ''}
                    <span style="flex:1"></span>
                    ${owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${owner}</span>` : ''}
                </div>
            </div>`;
        }

        async function crmDrop(event, newStage) {
            event.preventDefault();
            const dealId = event.dataTransfer.getData('text/plain');
            if (!dealId) return;
            try {
                await fetch(`${API}/crm/deals/${dealId}`, { method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' }, body: JSON.stringify({ stage: newStage }) });
                crmLoad(); showToast('Stage aktualisiert', 'success');
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmRenderTable() {
            const deals = crmGetFilteredDeals();
            if (!deals.length) { document.getElementById('crmTable').innerHTML = `<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">${crmCompanyFilter ? 'Keine Leads für diese Firma.' : 'Keine Leads. Klicke «Synchronisieren» um Leads zu importieren.'} ${crmCompanyFilter ? '<br><a style="color:var(--accent);cursor:pointer" onclick="crmClearFilter()">Filter aufheben</a>' : ''}</div>`; return; }
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const rows = deals.map(d => {
                const s = stageMap[d.stage] || {};
                const date = d.created_at ? new Date(d.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'2-digit'}) : '';
                const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) + ' CHF' : '–';
                const owner = (d.owner||'').replace('OWN-','');
                return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer" onclick="crmOpenDeal('${d.id}')"><td style="padding:8px 10px;font-weight:500;color:white;font-size:13px">${d.title||'–'}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${d.company_name||'–'}</td><td style="padding:8px 10px"><span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}33">${s.icon||''} ${s.label||d.stage}</span></td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${val}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${owner}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${date}</td></tr>`;
            }).join('');
            document.getElementById('crmTable').innerHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)"><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Lead</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Firma</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Stage</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Wert</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Owner</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Erstellt</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function crmShowDealForm() { const f=document.getElementById('crmDealForm'); f.style.display=f.style.display==='none'?'block':'none'; }

        async function crmSaveDeal() {
            const title = document.getElementById('crmDealTitle').value.trim();
            const company = document.getElementById('crmDealCompany').value.trim();
            if (!title && !company) { showToast('Bitte Lead-Titel oder Firma', 'error'); return; }
            try {
                await fetch(`${API}/crm/deals`, { method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title||company, company_name: company, contact_name: document.getElementById('crmDealContact').value.trim(), contact_email: document.getElementById('crmDealEmail').value.trim(), value: parseFloat(document.getElementById('crmDealValue').value)||0, stage: document.getElementById('crmDealStage').value, source: document.getElementById('crmDealSource').value.trim(), next_action: document.getElementById('crmDealNextAction').value.trim(), notes: document.getElementById('crmDealNotes').value.trim() })
                });
                showToast('Lead erstellt ✓', 'success');
                document.getElementById('crmDealForm').style.display = 'none';
                ['crmDealTitle','crmDealCompany','crmDealContact','crmDealEmail','crmDealValue','crmDealSource','crmDealNextAction','crmDealNotes'].forEach(id => document.getElementById(id).value = '');
                crmLoad();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmOpenDeal(id) {
            const deal = crmDeals.find(d => d.id === id);
            if (!deal) return;
            document.getElementById('crmDrawerTitle').textContent = deal.title || '–';
            document.getElementById('crmDrawerCompany').textContent = deal.company_name || '–';
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const s = stageMap[deal.stage] || {};
            const val = deal.value ? new Intl.NumberFormat('de-CH').format(deal.value) + ' CHF' : '–';
            const created = deal.created_at ? new Date(deal.created_at).toLocaleDateString('de-CH') : '';
            const owner = (deal.owner||'').replace('OWN-','');
            document.getElementById('crmDrawerContent').innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}44;font-weight:600">${s.icon||''} ${s.label||deal.stage}</span>
                    <span style="font-size:13px;font-weight:600;color:var(--accent-light)">${val}</span>
                    <span style="font-size:12px;color:rgba(255,255,255,0.3)">${deal.probability||0}%</span>
                    ${owner ? `<span style="font-size:11px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4)">👤 ${owner}</span>` : ''}
                </div>
                <div style="display:flex;gap:3px;margin-bottom:16px;flex-wrap:wrap">
                    ${CRM_STAGES.map(st => `<button onclick="crmChangeStage('${id}','${st.id}')" style="padding:5px 6px;border-radius:6px;border:1px solid ${st.id===deal.stage?st.color:'rgba(255,255,255,0.06)'};background:${st.id===deal.stage?st.color+'22':'transparent'};color:${st.id===deal.stage?'white':'rgba(255,255,255,0.2)'};font-size:9px;cursor:pointer;font-family:inherit">${st.icon} ${st.label}</button>`).join('')}
                </div>
                <div style="border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Details</div>
                <div style="display:grid;grid-template-columns:80px 1fr;gap:6px;font-size:13px">
                    <span style="color:rgba(255,255,255,0.3)">Firma</span><span style="color:white">${deal.company_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Kontakt</span><span style="color:white">${deal.contact_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Quelle</span><span style="color:rgba(255,255,255,0.6)">${deal.source||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Owner</span><span style="color:rgba(255,255,255,0.6)">${owner}</span>
                    <span style="color:rgba(255,255,255,0.3)">Erstellt</span><span style="color:rgba(255,255,255,0.6)">${created}</span>
                </div></div>
                ${deal.next_action ? `<div style="margin-top:12px;padding:10px 12px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px"><div style="font-size:10px;color:rgba(251,191,36,0.7);font-weight:600">NÄCHSTE AKTION</div><div style="font-size:13px;color:white;margin-top:2px">${deal.next_action}</div>${deal.next_action_date?`<div style="font-size:11px;color:rgba(251,191,36,0.5);margin-top:2px">📅 ${deal.next_action_date}</div>`:''}</div>` : ''}
                ${deal.notes ? `<div style="margin-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:6px">Notizen</div><div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5;white-space:pre-wrap;max-height:200px;overflow-y:auto">${deal.notes}</div></div>` : ''}
                <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Quick-Notiz</div>
                <div style="display:flex;gap:6px"><input class="mb-input" id="crmQuickNote" placeholder="Notiz..." style="flex:1;font-size:13px;padding:8px 12px" onkeydown="if(event.key==='Enter')crmAddNote('${id}')"><button class="mb-btn mb-btn-primary" onclick="crmAddNote('${id}')" style="font-size:12px;padding:6px 12px">+</button></div></div>
                <div style="margin-top:12px"><button class="mb-btn mb-btn-back" onclick="crmDeleteDeal('${id}')" style="font-size:11px;padding:5px 12px;color:rgba(248,113,113,0.7)">🗑 Löschen</button></div>`;
            document.getElementById('crmDrawer').style.display = 'block';
        }

        function crmCloseDrawer() { document.getElementById('crmDrawer').style.display = 'none'; }

        let crmCompaniesData = [];
        let companiesExpanded = {};
        let companyCategory = 'all';

        function companyGetCategory(c) {
            // Active Projects: strategic/context type with ACTIVE status or has_customer_folder + active relationship
            if ((c.type === 'strategic' || c.type === 'context') && (c.relationship_status === 'ACTIVE' || c.status === 'ACTIVE'))
                return 'active';
            // Past Projects: has customer folder or context data but NOT active
            if (c.has_customer_folder || c.has_context || c.has_profile)
                return 'past';
            // Leads: has any lead activity, contacts, or next_action
            const hasActivity = (c.children?.length > 0) || c.contact_persons > 0 || c.next_action || c.fit_score > 0 || c.hot_lead;
            if (c.type === 'lead' && hasActivity)
                return 'leads';
            // Also leads if status suggests pipeline
            if (['PROSPECT','QUALIFIED','PROPOSAL','NEGOTIATION'].includes((c.status||'').toUpperCase()))
                return 'leads';
            // New / Never worked with
            return 'new';
        }

        function companySetCategory(cat, el) {
            const catLabels = {active:'Aktive Projekte',leads:'Leads',past:'Frühere Projekte',new:'Noch nie gearbeitet'};
            if (companyCategory === cat || cat === 'all') {
                companyCategory = 'all';
                document.querySelectorAll('.comp-card').forEach(c => c.classList.remove('active'));
                document.getElementById('companyFilterBanner').style.display = 'none';
            } else {
                companyCategory = cat;
                document.querySelectorAll('.comp-card').forEach(c => c.classList.remove('active'));
                if (el) el.classList.add('active');
                const banner = document.getElementById('companyFilterBanner');
                banner.style.display = 'flex';
                document.getElementById('companyFilterLabel').textContent = `Filter: ${catLabels[cat] || cat}`;
            }
            crmFilterCompanies();
        }

        function crmShowCompanies() {
            showSection('companies', document.querySelector('[data-section=companies]'));
        }

        async function crmLoadCompanies() {
            document.getElementById('companiesListView').style.display = '';
            document.getElementById('companiesProfileView').style.display = 'none';
            document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Firmendaten aus GitHub…</div>';
            try {
                const resp = await fetch(`${API}/crm/companies/enriched`, { headers: H() });
                crmCompaniesData = resp.ok ? await resp.json() : [];
                // Assign categories + compute counts
                const counts = {active:0, leads:0, past:0, new:0};
                crmCompaniesData.forEach(c => {
                    c._category = companyGetCategory(c);
                    counts[c._category] = (counts[c._category]||0) + 1;
                });
                document.getElementById('catCountActive').textContent = counts.active;
                document.getElementById('catCountLeads').textContent = counts.leads;
                document.getElementById('catCountPast').textContent = counts.past;
                document.getElementById('catCountNew').textContent = counts.new;
                const totalChildren = crmCompaniesData.reduce((s, c) => s + (c.children?.length || 0), 0);
                document.getElementById('crmCompaniesCount').textContent = `${crmCompaniesData.length} Unternehmen · ${totalChildren + crmCompaniesData.length} Einträge · Quelle: GitHub`;
                crmFilterCompanies();
            } catch(e) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        const COUNTRY_FLAGS = {AT:'\u{1F1E6}\u{1F1F9}',CH:'\u{1F1E8}\u{1F1ED}',DE:'\u{1F1E9}\u{1F1EA}',SE:'\u{1F1F8}\u{1F1EA}',UK:'\u{1F1EC}\u{1F1E7}',US:'\u{1F1FA}\u{1F1F8}'};
        const INDUSTRY_LABELS = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien',precious_metals:'Edelmetalle',automotive:'Automobil',health:'Gesundheit',transport:'Transport',professional_services:'Services',technology:'Tech',energy:'Energie',ngo:'NGO',pharma_health:'Pharma/Health',manufacturing:'Industrie',creative:'Kreativ',consulting:'Consulting'};

        function crmFilterCompanies() {
            const q = (document.getElementById('crmCompaniesSearch')?.value || '').toLowerCase();
            let filtered = crmCompaniesData;

            // Category filter
            if (companyCategory !== 'all') {
                filtered = filtered.filter(c => c._category === companyCategory);
            }

            // Text search
            if (q) {
                filtered = filtered.filter(c =>
                    (c.name || '').toLowerCase().includes(q) ||
                    (c.industry || '').toLowerCase().includes(q) ||
                    (c.code || '').toLowerCase().includes(q) ||
                    (c.country || '').toLowerCase().includes(q) ||
                    (c.children || []).some(ch => (ch.name||'').toLowerCase().includes(q))
                );
            }

            if (!filtered.length) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Keine Firmen gefunden</div>';
                return;
            }

            const rows = filtered.map(c => {
                const flag = COUNTRY_FLAGS[c.country] || '';
                const indLabel = INDUSTRY_LABELS[c.industry] || c.industry || '';
                const ind = indLabel ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${indLabel}</span>` : '';
                const type = c.type === 'strategic' ? '<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:rgba(232,163,61,0.1);color:#E8A33D;border:1px solid rgba(232,163,61,0.2)">Strategic</span>' : '';
                const hasFolder = c.has_customer_folder ? '\u{1F4C1}' : '';
                const hasContext = c.has_context ? '\u{1F9E0}' : '';
                const owner = c.fa_owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${c.fa_owner}</span>` : '';
                const totalContacts = c.total_contacts || c.contact_persons || 0;
                const contactBadge = totalContacts > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">\u{1F464}${totalContacts}</span>` : '';

                // Category indicator
                const catColors = {active:'#34d399',leads:'#fbbf24',past:'rgba(139,170,255,0.5)',new:'rgba(255,255,255,0.15)'};
                const catDot = `<div style="width:8px;height:8px;border-radius:50%;background:${catColors[c._category]||catColors.new};flex-shrink:0" title="${{active:'Aktives Projekt',leads:'Lead',past:'Früheres Projekt',new:'Neu'}[c._category]||''}"></div>`;

                const childCount = (c.children?.length || 0) + 1;
                const isExpanded = companiesExpanded[c.code];
                const expandable = c.children?.length > 0;
                const leadBadge = expandable
                    ? `<span onclick="event.stopPropagation();companyToggle('${c.code}')" style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(251,191,36,0.08);color:#fbbf24;border:1px solid rgba(251,191,36,0.15);cursor:pointer;white-space:nowrap">${childCount} Leads ${isExpanded ? '\u25BE' : '\u25B8'}</span>`
                    : '';

                let html = `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="companyOpenProfile('${c.code}')">
                    ${catDot}
                    <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,rgba(42,127,142,0.15),rgba(27,54,93,0.3));display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#2A7F8E;flex-shrink:0">${flag || (c.name||'?')[0].toUpperCase()}</div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-weight:600;color:white;font-size:14px">${c.short_name || c.name || '\u2013'}</span>
                            ${hasFolder}${hasContext}
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">${ind}${type}${contactBadge}${owner}</div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-shrink:0">${leadBadge}</div>
                </div>`;

                if (expandable && isExpanded) {
                    html += '<div style="border-bottom:1px solid rgba(255,255,255,0.06)">';
                    c.children.forEach(ch => {
                        const chOwner = ch.fa_owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${ch.fa_owner}</span>` : '';
                        const chContacts = ch.contact_persons > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.25)">\u{1F464}${ch.contact_persons}</span>` : '';
                        const chNext = ch.next_action ? `<span style="font-size:10px;color:rgba(251,191,36,0.6)">\u2192 ${ch.next_action}</span>` : '';
                        const chStatus = ch.status ? `<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${ch.status}</span>` : '';
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 20px 10px 72px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.015)'" onmouseout="this.style.background='transparent'" onclick="event.stopPropagation();companyOpenProfile('${ch.code}')">
                            <div style="width:6px;height:6px;border-radius:50%;background:rgba(42,127,142,0.4);flex-shrink:0"></div>
                            <div style="flex:1;min-width:0">
                                <div style="font-size:12px;font-weight:500;color:rgba(255,255,255,0.7)">${ch.name || ch.code}</div>
                                <div style="display:flex;gap:6px;align-items:center;margin-top:2px;flex-wrap:wrap">${chStatus}${chContacts}${chOwner}${chNext}</div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }
                return html;
            }).join('');
            document.getElementById('crmCompaniesList').innerHTML = rows;
        }

        function companyToggle(code) { companiesExpanded[code] = !companiesExpanded[code]; crmFilterCompanies(); }

        function companyBackToList() {
            document.getElementById('companiesListView').style.display = '';
            document.getElementById('companiesProfileView').style.display = 'none';
        }

        function companyOpenProfile(code) {
            let company = crmCompaniesData.find(x => x.code === code);
            if (!company) {
                for (const p of crmCompaniesData) {
                    const ch = (p.children || []).find(x => x.code === code);
                    if (ch) { company = ch; company._parent = p; break; }
                }
            }
            if (!company) return;

            document.getElementById('companiesListView').style.display = 'none';
            document.getElementById('companiesProfileView').style.display = '';
            document.getElementById('companyProfileName').textContent = company.name || company.code;
            document.getElementById('companyProfileCode').textContent = company.code;
            const catLabels = {active:'Aktives Projekt',leads:'Lead',past:'Früheres Projekt',new:'Noch nie gearbeitet'};
            const catColors = {active:'#34d399',leads:'#fbbf24',past:'rgba(139,170,255,0.6)',new:'rgba(255,255,255,0.25)'};
            const cat = company._category || companyGetCategory(company);
            document.getElementById('companyProfileCatBadge').innerHTML = `<span style="font-size:11px;padding:3px 10px;border-radius:8px;display:inline-flex;align-items:center;gap:5px;background:${catColors[cat]}15;color:${catColors[cat]};border:1px solid ${catColors[cat]}30"><span style="width:6px;height:6px;border-radius:50%;background:${catColors[cat]}"></span>${catLabels[cat]}</span>`;

            const flag = COUNTRY_FLAGS[company.country] || '';
            const indLabel = INDUSTRY_LABELS[company.industry] || company.industry || '';

            let ph = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">';
            // Overview Card
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px">
                <div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">\u00DCbersicht</div>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div style="width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,rgba(42,127,142,0.2),rgba(27,54,93,0.4));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:#2A7F8E">${flag || (company.name||'?')[0]}</div>
                    <div>
                        <div style="font-size:18px;font-weight:700;color:white">${company.short_name || company.name}</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.4)">${company.name}</div>
                    </div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${indLabel ? `<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${indLabel}</span>` : ''}
                    ${company.type==='strategic'?'<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(232,163,61,0.1);color:#E8A33D;border:1px solid rgba(232,163,61,0.2)">Strategic</span>':''}
                    ${company.country?`<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4)">${flag} ${company.country}</span>`:''}
                    ${company.segment?`<span style="font-size:11px;padding:3px 10px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.4)">${company.segment}</span>`:''}
                </div>
                ${company.website?`<div style="margin-top:12px"><a href="${company.website}" target="_blank" style="font-size:11px;color:var(--accent)">${company.website}</a></div>`:''}
                ${company.notes?`<div style="margin-top:12px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">${company.notes}</div>`:''}
            </div>`;

            // Data Card
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:20px">
                <div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Daten & Status</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Owner</div><div style="font-size:14px;font-weight:600;color:white;margin-top:2px">${company.fa_owner||'\u2013'}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Status</div><div style="font-size:14px;font-weight:600;color:${company.relationship_status==='ACTIVE'?'#34d399':'white'};margin-top:2px">${company.relationship_status||company.status||'\u2013'}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Kontakte</div><div style="font-size:14px;font-weight:600;color:white;margin-top:2px">${company.contact_persons||0}</div></div>
                    <div style="padding:10px;background:rgba(255,255,255,0.02);border-radius:8px"><div style="font-size:10px;color:rgba(255,255,255,0.3)">Fit Score</div><div style="font-size:14px;font-weight:600;color:${company.fit_score>70?'#34d399':company.fit_score>40?'#fbbf24':'white'};margin-top:2px">${company.fit_score||'\u2013'}</div></div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:14px">
                    ${company.has_customer_folder?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(52,211,153,0.08);color:#34d399;border:1px solid rgba(52,211,153,0.15)">\u{1F4C1} Kunden-Ordner</span>':''}
                    ${company.has_context?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(139,170,255,0.08);color:rgba(139,170,255,0.6);border:1px solid rgba(139,170,255,0.15)">\u{1F9E0} Kontextvektoren</span>':''}
                    ${company.ebf_context_vectors?'<span style="font-size:10px;padding:3px 8px;border-radius:6px;background:rgba(139,170,255,0.08);color:rgba(139,170,255,0.6);border:1px solid rgba(139,170,255,0.15)">\u{1F52C} EBF Vectors</span>':''}
                </div>
                ${company.next_action?`<div style="margin-top:14px;padding:10px;background:rgba(251,191,36,0.05);border:1px solid rgba(251,191,36,0.1);border-radius:8px"><div style="font-size:10px;color:rgba(251,191,36,0.6)">N\u00E4chste Aktion</div><div style="font-size:12px;color:#fbbf24;margin-top:2px">\u2192 ${company.next_action}</div></div>`:''}
            </div>`;
            ph += '</div>';

            // Children
            if (company.children?.length > 0) {
                ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:16px">
                    <div style="padding:14px 20px;border-bottom:1px solid var(--border)"><span style="font-size:13px;font-weight:600;color:white">Abteilungen / Leads (${company.children.length})</span></div>`;
                company.children.forEach(ch => {
                    ph += `<div style="display:flex;align-items:center;gap:10px;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:pointer" onclick="companyOpenProfile('${ch.code}')">
                        <div style="width:6px;height:6px;border-radius:50%;background:rgba(42,127,142,0.4);flex-shrink:0"></div>
                        <div style="flex:1"><div style="font-size:13px;color:rgba(255,255,255,0.7)">${ch.name}</div>
                        ${ch.next_action?`<div style="font-size:11px;color:rgba(251,191,36,0.6);margin-top:2px">\u2192 ${ch.next_action}</div>`:''}</div>
                        ${ch.contact_persons>0?`<span style="font-size:10px;color:rgba(255,255,255,0.25)">\u{1F464}${ch.contact_persons}</span>`:''}
                        ${ch.status?`<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${ch.status}</span>`:''}
                    </div>`;
                });
                ph += '</div>';
            }

            // Placeholder
            ph += `<div style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;padding:24px;text-align:center">
                <div style="font-size:14px;color:rgba(255,255,255,0.25);margin-bottom:8px">\u{1F4CA} Detailliertes Unternehmensprofil</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.15)">Finanzdaten, Projekte, EBF-Modelle und Interventionshistorie.<br>Quelle: data/customers/${(company.code||'').toLowerCase()}/</div>
            </div>`;

            document.getElementById('companyProfileContent').innerHTML = ph;
        }


        // ── PROJECT WIZARD ──
        let prjMode = 'schnell';
        let prjStep = 1;
        let prjCompaniesCache = null;

        // ═══ MY PROJECTS (Kundenprojekte — filtered by user) ═══
        let myPrjCache = null;
        let myPrjAllCache = null;
        let myPrjScope = 'mine'; // 'mine' or 'all'

        function myPrjSetScope(scope) {
            myPrjScope = scope;
            document.getElementById('myPrjToggleMine').style.background = scope === 'mine' ? 'var(--accent)' : 'transparent';
            document.getElementById('myPrjToggleMine').style.color = scope === 'mine' ? 'white' : 'rgba(255,255,255,0.4)';
            document.getElementById('myPrjToggleAll').style.background = scope === 'all' ? 'var(--accent)' : 'transparent';
            document.getElementById('myPrjToggleAll').style.color = scope === 'all' ? 'white' : 'rgba(255,255,255,0.4)';
            myPrjRender();
        }

        async function myPrjLoad() {
            const listEl = document.getElementById('myPrjList');
            listEl.innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade deine Projekte…</div>';
            try {
                const resp = await fetch(`${API}/projects`, { headers: H() });
                const allProjects = resp.ok ? await resp.json() : [];
                myPrjAllCache = allProjects;

                // Filter: projects where user is owner, team member, or creator
                const ownerCode = (currentUser.crm_owner_code || '').toUpperCase();
                const userEmail = (currentUser.email || '').toLowerCase();
                const userName = (currentUser.name || '').toLowerCase();

                myPrjCache = allProjects.filter(p => {
                    if (ownerCode && (p.fa_owner || '').toUpperCase() === ownerCode) return true;
                    if (userEmail && (p.created_by || '').toLowerCase() === userEmail) return true;
                    if (Array.isArray(p.fa_team)) {
                        for (const m of p.fa_team) {
                            const mCode = (typeof m === 'string' ? m : m?.code || m?.name || '').toUpperCase();
                            const mEmail = (typeof m === 'object' ? m?.email || '' : '').toLowerCase();
                            if (ownerCode && mCode === ownerCode) return true;
                            if (userEmail && mEmail === userEmail) return true;
                        }
                    }
                    return false;
                });

                // If no owner code and no matches, show all for admins
                if (!ownerCode && !myPrjCache.length && currentUser.admin) {
                    myPrjCache = allProjects;
                }

                // Show "Alle" toggle only for admins or CRM users
                const showAll = currentUser.admin || currentUser.crm_access;
                const allBtn = document.getElementById('myPrjToggleAll');
                if (allBtn) allBtn.style.display = showAll ? '' : 'none';

                myPrjRender();
            } catch(e) {
                console.error('myPrjLoad error:', e);
                listEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        function myPrjRender() {
            if (!myPrjCache) return;
            const source = myPrjScope === 'all' ? (myPrjAllCache || myPrjCache) : myPrjCache;
            const filterStatus = document.getElementById('myPrjFilter')?.value || 'all';
            const projects = filterStatus === 'all'
                ? source
                : source.filter(p => {
                    if (filterStatus === 'active') return p.status === 'active' || p.status === 'aktiv';
                    return p.status === filterStatus;
                });

            // Subtitle
            const ownerCode = (currentUser.crm_owner_code || '').toUpperCase();
            const subtitle = myPrjScope === 'all'
                ? `${source.length} Projekte gesamt`
                : ownerCode
                    ? `${source.length} Projekte für ${currentUser.name || ownerCode}`
                    : `${source.length} Projekte für ${currentUser.name || currentUser.email}`;
            document.getElementById('myPrjSubtitle').textContent = subtitle;

            // KPIs from source (not filtered)
            const active = source.filter(p => p.status === 'active' || p.status === 'aktiv').length;
            const planning = source.filter(p => p.status === 'planning').length;
            const completed = source.filter(p => p.status === 'completed').length;
            document.getElementById('myPrjActive').textContent = active;
            document.getElementById('myPrjPlanning').textContent = planning;
            document.getElementById('myPrjDone').textContent = completed;
            document.getElementById('myPrjTotal').textContent = source.length;

            if (!projects.length) {
                document.getElementById('myPrjList').innerHTML = `<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">${source.length ? 'Keine Projekte mit diesem Filter.' : myPrjScope === 'all' ? 'Noch keine Projekte vorhanden.' : 'Du hast noch keine Kundenprojekte. Eröffne ein neues Projekt oder lass dich als Teammitglied hinzufügen.'}</div>`;
                return;
            }

            const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.5)',on_hold:'rgba(255,255,255,0.2)'};
            const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen',on_hold:'On Hold'};
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};

            const rows = projects.map(p => {
                const sc = statusColors[p.status] || 'rgba(255,255,255,0.2)';
                const sl = statusLabels[p.status] || p.status;
                const cat = p.project_category || '';
                const catIcon = catIcons[cat] || '';
                const catRgb = catColors[cat] || '255,255,255';
                const code = p.project_code || '';
                return `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="prjCameFrom='myprojects';prjOpenLanding('${p.slug}');showSection('projects')">
                    <div style="width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:8px">
                            ${code ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${code}</span>` : ''}
                            <span style="font-weight:600;color:white;font-size:14px">${p.name || p.project_code}</span>
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">
                            <span style="font-size:11px;color:rgba(255,255,255,0.4)">${p.customer_name || ''}</span>
                            ${cat ? `<span style="font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(${catRgb},0.08);color:rgba(${catRgb},0.7);border:1px solid rgba(${catRgb},0.15)">${catIcon} ${cat}</span>` : ''}
                            <span style="font-size:10px;padding:2px 8px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30">${sl}</span>
                        </div>
                    </div>
                    <div style="text-align:right;flex-shrink:0">
                        ${p.start_date ? `<div style="font-size:10px;color:rgba(255,255,255,0.2)">${p.start_date}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
            document.getElementById('myPrjList').innerHTML = rows;
        }

        async function prjLoad() {
            document.getElementById('prjListView').style.display = '';
            document.getElementById('prjWizardView').style.display = 'none';
            document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Projekte aus GitHub…</div>';
            try {
                const resp = await fetch(`${API}/projects`, { headers: H() });
                const projects = resp.ok ? await resp.json() : [];
                const active = projects.filter(p => p.status === 'active' || p.status === 'aktiv').length;
                const planning = projects.filter(p => p.status === 'planning').length;
                const completed = projects.filter(p => p.status === 'completed').length;
                document.getElementById('prjCountActive').textContent = active;
                document.getElementById('prjCountPlanning').textContent = planning;
                document.getElementById('prjCountCompleted').textContent = completed;
                document.getElementById('prjCountTotal').textContent = projects.length;
                document.getElementById('prjCount').textContent = `${projects.length} Projekte · Quelle: GitHub data/projects/`;

                if (!projects.length) {
                    document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Noch keine Projekte. Klicke „+ Neues Projekt" um zu starten.</div>';
                    return;
                }

                const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.5)',on_hold:'rgba(255,255,255,0.2)'};
                const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen',on_hold:'On Hold'};
                const typeLabels = {beratung:'Beratung',workshop:'Workshop',studie:'Studie',intervention:'Intervention',keynote:'Keynote',training:'Training',retainer:'Retainer'};
                const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
                const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};

                const rows = projects.map(p => {
                    const sc = statusColors[p.status] || 'rgba(255,255,255,0.2)';
                    const sl = statusLabels[p.status] || p.status;
                    const tl = typeLabels[p.type] || p.type || '';
                    const cat = p.project_category || '';
                    const catIcon = catIcons[cat] || '';
                    const catRgb = catColors[cat] || '255,255,255';
                    const code = p.project_code || '';
                    return `<div style="display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="prjCameFrom='projects';prjOpenLanding('${p.slug}')">
                        <div style="width:8px;height:8px;border-radius:50%;background:${sc};flex-shrink:0"></div>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                ${code ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${code}</span>` : ''}
                                <span style="font-weight:600;color:white;font-size:14px">${p.name || p.project_code}</span>
                            </div>
                            <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">
                                <span style="font-size:11px;color:rgba(255,255,255,0.4)">${p.customer_name || ''}</span>
                                ${cat ? `<span style="font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(${catRgb},0.08);color:rgba(${catRgb},0.7);border:1px solid rgba(${catRgb},0.15)">${catIcon} ${cat}</span>` : ''}
                                ${tl ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${tl}</span>` : ''}
                                <span style="font-size:10px;padding:2px 8px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30">${sl}</span>
                            </div>
                        </div>
                        <div style="text-align:right;flex-shrink:0">
                            ${p.fa_owner ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${p.fa_owner}</span>` : ''}
                            ${p.start_date ? `<div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:2px">${p.start_date}</div>` : ''}
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('prjList').innerHTML = rows;
            } catch(e) {
                document.getElementById('prjList').innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        async function prjEnsureCompanies() {
            if (prjCompaniesCache) return prjCompaniesCache;
            try {
                const resp = await fetch(`${API}/crm/companies/enriched`, { headers: H() });
                prjCompaniesCache = resp.ok ? await resp.json() : [];
            } catch(e) { prjCompaniesCache = []; }
            return prjCompaniesCache;
        }

        async function prjStartWizard() {
            document.getElementById('prjListView').style.display = 'none';
            document.getElementById('prjWizardView').style.display = '';
            const companies = await prjEnsureCompanies();
            // Populate firma dropdowns
            const opts = companies.map(c => `<option value="${c.code}">${c.short_name || c.name} (${c.code})</option>`).join('');
            document.getElementById('prjFirma').innerHTML = '<option value="">Firma auswählen…</option>' + opts;
            document.getElementById('prjSchnellFirma').innerHTML = '<option value="">Firma auswählen…</option>' + opts;
            // Set today as default start
            document.getElementById('prjStart').value = new Date().toISOString().slice(0,10);
            prjSetMode(prjMode);
        }

        function prjCancelWizard() {
            document.getElementById('prjListView').style.display = '';
            document.getElementById('prjWizardView').style.display = 'none';
        }

        function prjSetMode(mode) {
            prjMode = mode;
            document.querySelectorAll('.prj-mode-card').forEach(c => {
                c.classList.toggle('active', c.dataset.mode === mode);
                c.style.borderColor = c.dataset.mode === mode ? 'rgba(42,127,142,0.5)' : '';
                c.style.background = c.dataset.mode === mode ? 'rgba(42,127,142,0.08)' : 'var(--navy-card)';
            });
            document.getElementById('prjSchnellPanel').style.display = mode === 'schnell' ? '' : 'none';
            document.getElementById('prjProgress').style.display = mode === 'gefuehrt' ? '' : 'none';
            document.querySelectorAll('.prj-step').forEach(s => s.style.display = 'none');
            if (mode === 'gefuehrt') { prjGoStep(1); }
        }

        function prjSelectCategory(el, cat) {
            document.getElementById('prjCategory').value = cat;
            const colors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            const textColors = {mandat:'#34d399', lead:'#fbbf24', probono:'rgba(139,170,255,0.8)'};
            document.querySelectorAll('#prjCategoryCards .prj-cat-card').forEach(c => {
                const isCat = c.dataset.cat === cat;
                const rgb = colors[c.dataset.cat] || '255,255,255';
                c.style.borderColor = isCat ? `rgba(${rgb},0.3)` : 'var(--border)';
                c.style.background = isCat ? `rgba(${rgb},0.06)` : 'rgba(255,255,255,0.02)';
                c.querySelector('div:nth-child(2)').style.color = isCat ? textColors[c.dataset.cat] : 'rgba(255,255,255,0.5)';
            });
        }

        function prjSchnellCat(el, cat) {
            document.getElementById('prjSchnellCategory').value = cat;
            const colors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            const textColors = {mandat:'#34d399', lead:'#fbbf24', probono:'rgba(139,170,255,0.8)'};
            document.querySelectorAll('.prj-schnell-cat').forEach(b => {
                const isCat = b.dataset.cat === cat;
                const rgb = colors[b.dataset.cat] || '255,255,255';
                b.style.borderColor = isCat ? `rgba(${rgb},0.3)` : 'var(--border)';
                b.style.background = isCat ? `rgba(${rgb},0.08)` : 'rgba(255,255,255,0.02)';
                b.style.color = isCat ? textColors[b.dataset.cat] : 'rgba(255,255,255,0.4)';
            });
        }

        function prjGoStep(n) {
            prjStep = n;
            document.querySelectorAll('.prj-step').forEach(s => s.style.display = 'none');
            const el = document.getElementById('prjStep' + n);
            if (el) el.style.display = '';
            // Progress bar
            const labels = ['Firma & Lead', 'Projekt', 'Timeline', 'Team', 'Review'];
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const active = i === n;
                const done = i < n;
                const col = done ? '#34d399' : active ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
                html += `<div style="flex:1;height:4px;border-radius:2px;background:${col};transition:background 0.3s"></div>`;
            }
            document.getElementById('prjProgressSteps').innerHTML = html;
            document.getElementById('prjProgressLabel').textContent = `Schritt ${n}/5 · ${labels[n-1]}`;
            // Build review on step 5
            if (n === 5) prjBuildReview();
        }

        function prjOnFirmaChange() {
            const code = document.getElementById('prjFirma').value;
            const infoEl = document.getElementById('prjFirmaInfo');
            const leadSel = document.getElementById('prjLead');
            const btn = document.getElementById('prjStep1Next');

            if (!code) { infoEl.style.display = 'none'; btn.disabled = true; btn.style.opacity = '0.5'; return; }
            btn.disabled = false; btn.style.opacity = '1';

            const c = prjCompaniesCache.find(x => x.code === code);
            if (!c) return;
            infoEl.style.display = '';
            const indLabels = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien'};
            infoEl.innerHTML = `<strong>${c.name}</strong> · ${indLabels[c.industry] || c.industry || ''} · ${c.country || ''}<br>
                ${c.fa_owner ? 'Owner: ' + c.fa_owner + ' · ' : ''}Kontakte: ${c.contact_persons || 0}
                ${c.has_customer_folder ? ' · 📁 Kunden-Ordner' : ''}${c.has_context ? ' · 🧠 Kontext' : ''}`;

            // Auto-fill owner in step 4
            if (c.fa_owner) {
                const ownerSel = document.getElementById('prjOwner');
                for (let o of ownerSel.options) { if (o.value === c.fa_owner) { ownerSel.value = c.fa_owner; break; } }
            }

            // Populate leads for this company
            const children = c.children || [];
            const allLeads = [c, ...children];
            let leadOpts = '<option value="">Kein Lead / Neues Projekt</option>';
            allLeads.forEach(l => {
                if (l.code !== c.code || children.length === 0) {
                    leadOpts += `<option value="${l.code}">${l.name}${l.next_action ? ' → ' + l.next_action : ''}</option>`;
                }
            });
            leadSel.innerHTML = leadOpts;

            // Show client contacts in step 4
            const contacts = c.contact_persons > 0 ? `${c.contact_persons} Kontaktpersonen aus GitHub` : 'Keine Kontakte hinterlegt';
            document.getElementById('prjClientContacts').textContent = contacts;
        }

        function prjOnLeadChange() {
            const code = document.getElementById('prjLead').value;
            const infoEl = document.getElementById('prjLeadInfo');
            if (!code) { infoEl.style.display = 'none'; return; }
            // Find lead in companies cache (could be child)
            let lead = null;
            for (const c of prjCompaniesCache) {
                if (c.code === code) { lead = c; break; }
                const ch = (c.children || []).find(x => x.code === code);
                if (ch) { lead = ch; break; }
            }
            if (!lead) { infoEl.style.display = 'none'; return; }
            infoEl.style.display = '';
            infoEl.innerHTML = `<strong>${lead.name}</strong>${lead.status ? ' · Status: ' + lead.status : ''}${lead.fit_score ? ' · Fit: ' + lead.fit_score : ''}
                ${lead.next_action ? '<br>→ ' + lead.next_action : ''}${lead.notes ? '<br>' + lead.notes : ''}`;
            // Auto-fill project name from lead
            if (!document.getElementById('prjName').value && lead.name) {
                document.getElementById('prjName').value = lead.name;
            }
        }

        function prjBuildReview() {
            const firma = document.getElementById('prjFirma');
            const firmaName = firma.options[firma.selectedIndex]?.text || '–';
            const name = document.getElementById('prjName').value || '(kein Name)';
            const type = document.getElementById('prjType');
            const typeName = type.options[type.selectedIndex]?.text || '';
            const category = document.getElementById('prjCategory').value || 'mandat';
            const catLabels = {mandat:'💼 Bezahltes Mandatsprojekt', lead:'🎯 Lead-Projekt (Akquise)', probono:'🤝 Pro-Bono-Projekt'};
            const desc = document.getElementById('prjDesc').value;
            const start = document.getElementById('prjStart').value;
            const end = document.getElementById('prjEnd').value;
            const budget = document.getElementById('prjBudget').value;
            const billing = document.querySelector('input[name="prjBilling"]:checked')?.value || 'fixed';
            const owner = document.getElementById('prjOwner');
            const ownerName = owner.options[owner.selectedIndex]?.text || '';
            const team = document.getElementById('prjTeam').value;

            const slug = (firma.value + '-' + name).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').slice(0, 50);
            // Preview code format
            const prefix = firma.value.toUpperCase().replace(/-/g,'').slice(0,5);
            const previewCode = `${prefix || '???'}0XX`;

            document.getElementById('prjReviewContent').innerHTML = `
                <div style="display:grid;grid-template-columns:120px 1fr;gap:8px 16px">
                    <div style="color:rgba(255,255,255,0.3)">Projektkürzel</div><div><strong style="color:var(--accent-light);font-size:15px">${previewCode}</strong> <span style="font-size:10px;color:rgba(255,255,255,0.2)">(wird bei Erstellung eindeutig vergeben)</span></div>
                    <div style="color:rgba(255,255,255,0.3)">Kategorie</div><div>${catLabels[category] || category}</div>
                    <div style="color:rgba(255,255,255,0.3)">Firma</div><div><strong>${firmaName}</strong></div>
                    <div style="color:rgba(255,255,255,0.3)">Projekt</div><div><strong>${name}</strong></div>
                    <div style="color:rgba(255,255,255,0.3)">Typ</div><div>${typeName}</div>
                    ${desc ? `<div style="color:rgba(255,255,255,0.3)">Beschreibung</div><div>${desc}</div>` : ''}
                    <div style="color:rgba(255,255,255,0.3)">Timeline</div><div>${start || '?'} → ${end || 'offen'}</div>
                    ${budget ? `<div style="color:rgba(255,255,255,0.3)">Budget</div><div>${Number(budget).toLocaleString('de-CH')} CHF (${billing})</div>` : ''}
                    <div style="color:rgba(255,255,255,0.3)">Owner</div><div>${ownerName}</div>
                    ${team ? `<div style="color:rgba(255,255,255,0.3)">Team</div><div>${team}</div>` : ''}
                </div>
                <div style="margin-top:16px;padding:10px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.1);border-radius:8px;font-size:11px;color:rgba(255,255,255,0.3)">
                    📁 Wird erstellt: <code>data/projects/${slug}/project.yaml</code>
                </div>`;
        }

        // Schnell mode
        function prjSchnellAutoFill() {
            const code = document.getElementById('prjSchnellFirma').value;
            const nameInput = document.getElementById('prjSchnellName');
            const preview = document.getElementById('prjSchnellPreview');
            const btn = document.getElementById('prjSchnellBtn');

            if (!code) { preview.style.display = 'none'; btn.disabled = true; btn.style.opacity = '0.5'; return; }

            const c = prjCompaniesCache.find(x => x.code === code);
            if (!c) return;

            // Smart defaults
            const today = new Date().toISOString().slice(0,10);
            const endDate = new Date(Date.now() + 90*24*60*60*1000).toISOString().slice(0,10);

            preview.style.display = '';
            preview.innerHTML = `<strong>${c.short_name || c.name}</strong> · ${c.industry || ''} · ${c.country || ''}<br>
                Owner: ${c.fa_owner || 'GF'} · Start: ${today} · Ende: ~${endDate}<br>
                Typ: Beratung · Status: planning
                ${c.has_customer_folder ? '<br>📁 Kunden-Ordner vorhanden' : ''}
                ${c.next_action ? '<br>→ ' + c.next_action : ''}`;

            // Enable button when name is filled
            const check = () => {
                const ok = code && nameInput.value.trim();
                btn.disabled = !ok; btn.style.opacity = ok ? '1' : '0.5';
            };
            nameInput.oninput = check;
            check();
        }

        async function prjSchnellCreate() {
            const code = document.getElementById('prjSchnellFirma').value;
            const name = document.getElementById('prjSchnellName').value.trim();
            const category = document.getElementById('prjSchnellCategory').value || 'mandat';
            if (!code || !name) return;

            const c = prjCompaniesCache.find(x => x.code === code);
            const today = new Date().toISOString().slice(0,10);
            const btn = document.getElementById('prjSchnellBtn');
            btn.disabled = true; btn.textContent = 'Erstelle auf GitHub…';

            try {
                const resp = await fetch(`${API}/projects`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_code: code,
                        name: name,
                        type: 'beratung',
                        project_category: category,
                        description: '',
                        start_date: today,
                        end_date: '',
                        budget_chf: null,
                        billing_type: 'fixed',
                        fa_owner: c?.fa_owner || 'GF',
                        fa_team: [],
                        lead_code: ''
                    })
                });
                const result = await resp.json();
                if (resp.ok) {
                    const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
                    showToast(`✓ ${catIcons[category]||''} Projekt "${name}" eröffnet · Kürzel: ${result.project_code}`, 'success');
                    prjCancelWizard();
                    prjLoad();
                } else {
                    showToast(result.error || 'Fehler', 'error');
                    btn.disabled = false; btn.textContent = '✓ Jetzt eröffnen → GitHub';
                }
            } catch(e) {
                showToast('Fehler: ' + e.message, 'error');
                btn.disabled = false; btn.textContent = '✓ Jetzt eröffnen → GitHub';
            }
        }

        async function prjCreate() {
            const firmaCode = document.getElementById('prjFirma').value;
            const name = document.getElementById('prjName').value.trim();
            if (!firmaCode || !name) { showToast('Firma und Projektname erforderlich', 'error'); return; }

            const btn = document.getElementById('prjCreateBtn');
            btn.disabled = true; btn.textContent = 'Erstelle auf GitHub…';

            try {
                const resp = await fetch(`${API}/projects`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_code: firmaCode,
                        name: name,
                        type: document.getElementById('prjType').value,
                        project_category: document.getElementById('prjCategory').value || 'mandat',
                        description: document.getElementById('prjDesc').value,
                        start_date: document.getElementById('prjStart').value,
                        end_date: document.getElementById('prjEnd').value,
                        budget_chf: document.getElementById('prjBudget').value ? Number(document.getElementById('prjBudget').value) : null,
                        billing_type: document.querySelector('input[name="prjBilling"]:checked')?.value || 'fixed',
                        fa_owner: document.getElementById('prjOwner').value,
                        fa_team: document.getElementById('prjTeam').value.split(',').map(s => s.trim()).filter(Boolean),
                        lead_code: document.getElementById('prjLead').value
                    })
                });
                const result = await resp.json();
                if (resp.ok) {
                    showToast(`✓ Projekt "${name}" eröffnet · Kürzel: ${result.project_code}`, 'success');
                    prjCancelWizard();
                    prjLoad();
                } else {
                    showToast(result.error || 'Fehler', 'error');
                    btn.disabled = false; btn.textContent = '✓ Projekt eröffnen → GitHub';
                }
            } catch(e) {
                showToast('Fehler: ' + e.message, 'error');
                btn.disabled = false; btn.textContent = '✓ Projekt eröffnen → GitHub';
            }
        }

        // ════════════════════════════════════════════════
        // PROJECT LANDING PAGE
        // ════════════════════════════════════════════════
        let prjLandingData = null;
        let prjCurrentSlug = '';
        let prjCameFrom = 'projects';

        function prjBackToList() {
            document.getElementById('prjLandingView').style.display = 'none';
            if (prjCameFrom === 'myprojects') {
                showSection('myprojects');
            } else {
                document.getElementById('prjListView').style.display = '';
            }
        }

        async function prjOpenLanding(slug) {
            prjCurrentSlug = slug;
            document.getElementById('prjListView').style.display = 'none';
            document.getElementById('prjWizardView').style.display = 'none';
            document.getElementById('prjLandingView').style.display = '';
            document.getElementById('prjLandingHeader').innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.3)">Lade Projektdaten…</div>';
            document.getElementById('prjLandingResources').innerHTML = '';
            document.getElementById('prjLandingData').innerHTML = '';
            // Reset to Übersicht main tab
            prjSwitchMainTab('overview');
            const backBtn = document.getElementById('prjBackBtn');
            if (backBtn) backBtn.textContent = prjCameFrom === 'myprojects' ? '← Meine Projekte' : '← Alle Projekte';

            try {
                const resp = await fetch(`${API}/projects/${slug}/landing`, { headers: H() });
                if (!resp.ok) throw new Error('Projekt nicht gefunden');
                prjLandingData = await resp.json();
                prjLandingData.slug = slug;
                prjRenderLanding();
            } catch(e) {
                document.getElementById('prjLandingHeader').innerHTML = `<div style="text-align:center;padding:20px;color:var(--error)">${e.message}</div>`;
            }
        }

        function prjRenderLanding() {
            const d = prjLandingData;
            const p = d.project || {};
            const meta = p.metadata || {};
            const client = p.client || {};
            const project = p.project || {};
            const timeline = p.timeline || {};
            const team = p.team || {};
            const scope = p.scope || {};
            const objective = p.objective || {};
            const fehradvice_scope = p.fehradvice_scope || {};
            const res = d.resources || {};

            // Status
            const status = (meta.status || 'planning').toLowerCase();
            const statusColors = {active:'#34d399',aktiv:'#34d399',planning:'#fbbf24',completed:'rgba(139,170,255,0.6)','on-hold':'rgba(255,255,255,0.3)'};
            const statusLabels = {active:'Aktiv',aktiv:'Aktiv',planning:'Planung',completed:'Abgeschlossen','on-hold':'On Hold'};
            const sc = statusColors[status] || 'rgba(255,255,255,0.3)';

            // Header
            const prjName = project.name || meta.name || meta.project_code || '–';
            const custName = client.name || client.short_name || '';
            const prjType = project.type || '';
            const owner = team.fa_owner || '';
            const prjCode = meta.project_code || '';
            const prjCat = meta.project_category || '';
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catLabels = {mandat:'Mandat', lead:'Lead', probono:'Pro Bono'};
            const catColors = {mandat:'52,211,153', lead:'251,191,36', probono:'139,170,255'};
            // Extract team members
            let teamMembers = [];
            if (Array.isArray(team.fa_team)) teamMembers = team.fa_team;
            if (Array.isArray(team.fehradvice_team)) {
                teamMembers = team.fehradvice_team.map(t => typeof t === 'string' ? t : t.name || t.code || '');
            }
            // Extract contacts
            let contacts = [];
            if (Array.isArray(client.contacts)) contacts = client.contacts.map(c => typeof c === 'string' ? c : c.name || '');
            if (Array.isArray(team.customer_contacts)) contacts = team.customer_contacts.map(c => typeof c === 'string' ? c : c.name || '');

            // ── Tab Status (must be calculated before header) ──
            const cv = res.context_vector || {};
            const mo = res.models || {};
            const pr = res.profile || {};
            const sc2 = res.scenarios || {};
            const pe = res.personas || {};
            const docs = res.documents || {};
            const df = res.data_files || {};
            const kpisRes = res.kpis || {};

            const objSummaryCheck = objective.summary || project.description || '';
            const inScopeCheck = scope.in_scope || fehradvice_scope.deliverables || [];
            const behObjCheck = fehradvice_scope.behavioral_objectives || [];
            let tlCheck = Array.isArray(p.timeline) ? p.timeline : [];
            const phasesCheck = p.phases || [];
            const sessionsCheck = p.sessions || [];
            const deliverablesCheck = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
            const risksCheck = p.risks || [];
            const kpisCheck = p.kpis || [];
            const ebfCheck = (p.ebf_integration||{}).primary_10c_dimensions || fehradvice_scope.ten_c_focus || [];
            let budgetCheck = false;
            if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                budgetCheck = !!(p.timeline.budget_chf || p.timeline.budget_eur);
            }
            const teamCheck = teamMembers.length > 0 || contacts.length > 0 || !!owner;

            const tabStatus = {
                overview: true,
                auftrag: !!(objSummaryCheck || inScopeCheck.length || behObjCheck.length),
                planung: !!(tlCheck.length || phasesCheck.length),
                meetings: sessionsCheck.length > 0,
                deliverables: deliverablesCheck.length > 0,
                dokumente: !!(docs.available),
                modelle: !!(mo.available || cv.available || ebfCheck.length),
                risiken: risksCheck.length > 0,
                kommunikation: false,
                budget: budgetCheck,
                learnings: kpisCheck.length > 0
            };

            const filledCount = Object.values(tabStatus).filter(v => v).length - 1;
            const totalTabs = 10;

            document.getElementById('prjLandingHeader').innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:16px">
                    <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,${sc}30,${sc}10);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;border:1px solid ${sc}40">📋</div>
                    <div style="flex:1">
                        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                            ${prjCode ? `<span style="font-size:12px;padding:3px 10px;border-radius:6px;background:rgba(255,255,255,0.06);color:var(--accent-light);font-weight:700;font-family:monospace;letter-spacing:0.5px">${prjCode}</span>` : ''}
                            <div style="font-size:20px;font-weight:700;color:white">${prjName}</div>
                            <span style="font-size:10px;padding:3px 10px;border-radius:8px;background:${sc}15;color:${sc};border:1px solid ${sc}30;font-weight:600">${statusLabels[status]||status}</span>
                            ${prjCat ? `<span style="font-size:10px;padding:3px 10px;border-radius:8px;background:rgba(${catColors[prjCat]||'255,255,255'},0.08);color:rgba(${catColors[prjCat]||'255,255,255'},0.7);border:1px solid rgba(${catColors[prjCat]||'255,255,255'},0.15)">${catIcons[prjCat]||''} ${catLabels[prjCat]||prjCat}</span>` : ''}
                        </div>
                        <div style="display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap;font-size:13px;color:rgba(255,255,255,0.5)">
                            ${custName ? `<span>🏢 ${custName}</span>` : ''}
                            ${owner ? `<span>👤 ${owner}</span>` : ''}
                            ${prjType ? `<span>📌 ${prjType}</span>` : ''}
                            ${meta.project_id ? `<span style="font-size:10px;color:rgba(255,255,255,0.2)">${meta.project_id}</span>` : ''}
                        </div>
                        ${contacts.length ? `<div style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.3)">Kundenkontakte: ${contacts.join(', ')}</div>` : ''}
                        ${teamMembers.length ? `<div style="margin-top:4px;font-size:11px;color:rgba(255,255,255,0.3)">FA Team: ${teamMembers.join(', ')}</div>` : ''}
                    </div>
                </div>
                <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;align-items:center;gap:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">Projektdaten</div>
                    <div style="flex:1;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;overflow:hidden">
                        <div style="height:100%;width:${Math.round(filledCount/totalTabs*100)}%;background:linear-gradient(90deg,#34d399,#2A7F8E);border-radius:2px;transition:width 0.3s"></div>
                    </div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);font-weight:600">${filledCount}/${totalTabs}</div>
                    ${d.has_local_edits ? `<button onclick="prjSyncGitHub()" style="padding:4px 10px;background:rgba(232,163,61,0.1);border:1px solid rgba(232,163,61,0.3);border-radius:6px;color:#E8A33D;font-size:10px;cursor:pointer;margin-left:8px" title="Lokale Änderungen noch nicht in GitHub">⟳ Sync</button>` : ''}
                </div>`;

            // ── Tab Status Dots (apply) ──
            document.querySelectorAll('#prjMainPm .prj-tab').forEach(tab => {
                const key = tab.dataset.tab;
                if (key === 'overview') return;
                const has = tabStatus[key];
                const dot = has ? '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#34d399;margin-left:5px;vertical-align:middle"></span>'
                               : '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:rgba(248,113,113,0.6);margin-left:5px;vertical-align:middle"></span>';
                // Preserve original text, add dot
                const icon = tab.textContent.trim().split(' ')[0];
                const label = tab.textContent.trim().substring(icon.length).trim();
                tab.innerHTML = `${icon} ${label} ${dot}`;
            });

            // ── Left: Verfügbare Ressourcen ──
            const tile = (icon, label, available, detail, sub, tabTarget) => `
                <div onclick="${tabTarget ? `prjSwitchMainTab('pm');prjSwitchTab('${tabTarget}')` : ''}" style="background:var(--navy-card);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='rgba(42,127,142,0.3)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:18px;width:32px;text-align:center">${icon}</div>
                    <div style="flex:1;min-width:0">
                        <div style="font-size:13px;font-weight:600;color:white">${label}</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px">${detail}</div>
                        ${sub ? `<div style="font-size:10px;color:rgba(255,255,255,0.2);margin-top:2px">${sub}</div>` : ''}
                    </div>
                    <div style="font-size:14px;flex-shrink:0">${available ? '✅' : '❌'}</div>
                </div>`;

            let resourceHtml = '';
            resourceHtml += tile('🧭', 'Kontextvektor',
                cv.available,
                cv.available ? `${cv.count} Dimensionen erfasst` : 'Noch nicht erstellt',
                cv.available ? cv.files?.slice(0,3).map(f => f.replace(/.*_context_/,'').replace('.yaml','')).join(', ') : '', 'modelle');
            resourceHtml += tile('🧠', 'Modelle',
                mo.available,
                mo.available ? `${mo.count} Modell${mo.count>1?'e':''}` : 'Noch kein Modell',
                mo.available ? mo.files?.join(', ') : '', 'modelle');
            resourceHtml += tile('📁', 'Kundenprofil',
                pr.available,
                pr.available ? 'Profil vorhanden' : 'Noch nicht angelegt',
                '', '');
            resourceHtml += tile('📊', 'KPIs & Daten',
                kpisRes.available || df.available,
                `${kpisRes.available ? 'KPIs definiert' : ''}${kpisRes.available && df.available ? ' · ' : ''}${df.available ? df.count + ' Datensätze' : ''}` || 'Keine Daten',
                '', 'learnings');
            resourceHtml += tile('🔮', 'Szenarien',
                sc2.available,
                sc2.available ? `${sc2.count} Szenario${sc2.count>1?'s':''}` : 'Keine Szenarien',
                '', '');
            resourceHtml += tile('👤', 'Personas',
                pe.available,
                pe.available ? 'Personas vorhanden' : 'Keine Personas',
                '', '');
            resourceHtml += tile('📄', 'Dokumente',
                docs.available,
                `${docs.pdfs||0} PDFs · ${docs.mds||0} Markdown`,
                docs.available ? docs.pdf_files?.slice(0,2).map(f => f.length > 35 ? f.substring(0,32)+'…' : f).join(', ') : '', 'dokumente');

            if (res.total_files) {
                resourceHtml += `<div style="text-align:center;font-size:10px;color:rgba(255,255,255,0.2);padding:8px">📁 ${res.total_files} Dateien in data/customers/${res.customer_code}/</div>`;
            }
            if (res.customer_folder_exists === false) {
                resourceHtml += `<div style="text-align:center;padding:16px;font-size:12px;color:rgba(255,255,255,0.3)">Kein Kundenordner vorhanden.<br>Wird bei erster Analyse automatisch erstellt.</div>`;
            }

            document.getElementById('prjLandingResources').innerHTML = resourceHtml;

            // ── Right: Projektdaten ──
            let projHtml = '';

            // Beratungsauftrag (Scope)
            const objSummary = objective.summary || project.description || fehradvice_scope.behavioral_objectives?.join(', ') || '';
            const inScope = scope.in_scope || fehradvice_scope.deliverables || [];
            const outScope = scope.out_of_scope || [];
            const scopeCount = inScope.length + outScope.length;
            projHtml += tile('📋', 'Beratungsauftrag',
                !!(objSummary || scopeCount),
                objSummary ? (objSummary.length > 60 ? objSummary.substring(0,57)+'…' : objSummary) : (scopeCount ? `${inScope.length} Scope-Punkte definiert` : 'Noch nicht definiert'),
                outScope.length ? `${outScope.length} Out-of-Scope` : '', 'auftrag');

            // Team
            const teamCount = teamMembers.length + (owner ? 1 : 0);
            const contactCount = contacts.length;
            projHtml += tile('👥', 'Team & Kontakte',
                teamCount > 0 || contactCount > 0,
                `${teamCount ? teamCount + ' FA' : ''}${teamCount && contactCount ? ' · ' : ''}${contactCount ? contactCount + ' Kunde' : ''}` || 'Noch nicht zugewiesen',
                '', 'auftrag');

            // Timeline
            let tlItems = [];
            if (Array.isArray(p.timeline)) {
                tlItems = p.timeline;
            } else if (p.timeline && typeof p.timeline === 'object') {
                if (p.timeline.start_date) tlItems.push({date: p.timeline.start_date, milestone: 'Start'});
                if (p.timeline.end_date) tlItems.push({date: p.timeline.end_date, milestone: 'Ende'});
            }
            const phases = p.phases || [];
            projHtml += tile('📅', 'Timeline',
                tlItems.length > 0 || phases.length > 0,
                tlItems.length ? `${tlItems.length} Milestones` : (phases.length ? `${phases.length} Phasen` : 'Keine Timeline'),
                phases.length ? phases.map(ph => ph.name || ph.phase || '').filter(Boolean).slice(0,3).join(' → ') : '', 'planung');

            // Deliverables
            const deliverables = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
            projHtml += tile('📦', 'Deliverables',
                deliverables.length > 0,
                deliverables.length ? `${deliverables.length} Deliverable${deliverables.length>1?'s':''}` : 'Keine definiert',
                deliverables.length ? deliverables.slice(0,3).map(d => typeof d === 'string' ? d : d.name || d.id || '').filter(Boolean).join(', ') : '', 'deliverables');

            // EBF Integration
            const ebf = p.ebf_integration || {};
            const tenC = ebf.primary_10c_dimensions || fehradvice_scope.ten_c_focus || [];
            const bcm = ebf.bcm_models || [];
            const barriers = ebf.behavioral_barriers || [];
            projHtml += tile('🧬', 'EBF Integration',
                tenC.length > 0 || bcm.length > 0,
                tenC.length ? `10C: ${tenC.join(', ')}` : (bcm.length ? `${bcm.length} BCM Modell${bcm.length>1?'e':''}` : 'Keine EBF-Verknüpfung'),
                barriers.length ? `Barriers: ${barriers.slice(0,2).join(', ')}` : '', 'modelle');

            // KPIs
            const projKpis = p.kpis || [];
            projHtml += tile('📊', 'KPIs & Wirkung',
                projKpis.length > 0,
                projKpis.length ? `${projKpis.length} KPI${projKpis.length>1?'s':''}` : 'Keine KPIs definiert',
                projKpis.length ? projKpis.slice(0,2).map(k => k.name || k.kpi_id || '').filter(Boolean).join(', ') : '', 'learnings');

            // Budget
            let budget = '';
            if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                budget = p.timeline.budget_chf || p.timeline.budget_eur || '';
            }
            if (budget) {
                const curr = p.timeline.budget_eur ? 'EUR' : 'CHF';
                projHtml += tile('💰', 'Budget',
                    true,
                    `${curr} ${parseInt(budget).toLocaleString('de-CH')}`,
                    p.timeline.billing_type || '', 'budget');
            }

            // Risks
            const risks = p.risks || [];
            if (risks.length) {
                projHtml += tile('⚠', 'Risiken',
                    true,
                    `${risks.length} identifiziert`,
                    risks.slice(0,2).map(r => typeof r === 'string' ? r : r.description || '').filter(Boolean).map(s => s.length > 40 ? s.substring(0,37)+'…' : s).join(', '), 'risiken');
            }

            document.getElementById('prjLandingData').innerHTML = projHtml;

            // ── Other Projects ──
            const other = d.other_projects || [];
            const otherSection = document.getElementById('prjLandingOtherSection');
            if (other.length > 0) {
                otherSection.style.display = '';
                const otherStatusColors = {active:'#34d399',completed:'rgba(139,170,255,0.5)',proposal:'#fbbf24',scoping:'#fbbf24'};
                const rows = other.map(op => {
                    const osc = otherStatusColors[op.status] || 'rgba(255,255,255,0.2)';
                    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 16px;border-bottom:1px solid rgba(255,255,255,0.03)">
                        <div style="width:6px;height:6px;border-radius:50%;background:${osc};flex-shrink:0"></div>
                        <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.6)">${op.name}</div>
                        <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:${osc}15;color:${osc};border:1px solid ${osc}30">${op.status}</span>
                        ${op.deliverables_count ? `<span style="font-size:10px;color:rgba(255,255,255,0.2)">${op.deliverables_count} Deliv.</span>` : ''}
                    </div>`;
                }).join('');
                document.getElementById('prjLandingOther').innerHTML = rows;
            } else {
                otherSection.style.display = 'none';
            }
        }

        let prjActiveTab = 'overview';

        function prjSwitchMainTab(tab) {
            // Main tabs: overview, inhalt, pm
            document.querySelectorAll('#prjTabBar .prj-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.prj-main-tab-content').forEach(c => c.classList.remove('active'));
            const mainMap = {overview:'prjMainOverview', inhalt:'prjMainInhalt', pm:'prjMainPm'};
            const el = document.getElementById(mainMap[tab]);
            if (el) el.classList.add('active');
            // On PM open, render first sub-tab
            if (tab === 'pm' && prjLandingData) {
                prjSwitchTab('auftrag');
            }
            // On inhalt open, render module status badges
            if (tab === 'inhalt' && prjLandingData) {
                prjRenderModuleStatus();
            }
        }

        function prjSwitchTab(tab) {
            prjActiveTab = tab;
            // Only toggle PM sub-tabs
            document.querySelectorAll('#prjMainPm .prj-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('#prjMainPm .prj-tab-content').forEach(c => c.classList.remove('active'));
            const tabMap = {auftrag:'prjTabAuftrag',planung:'prjTabPlanung',meetings:'prjTabMeetings',deliverables:'prjTabDeliverables',dokumente:'prjTabDokumente',risiken:'prjTabRisiken',kommunikation:'prjTabKommunikation',budget:'prjTabBudget',learnings:'prjTabLearnings'};
            const el = document.getElementById(tabMap[tab]);
            if (el) el.classList.add('active');
            if (prjLandingData) prjRenderTab(tab);
        }

        function prjLaunchModule(module) {
            // Navigate to the Behavioral Design module with project context pre-loaded
            const slug = prjLandingData?.slug || '';
            const code = prjLandingData?.project?.metadata?.project_code || '';
            const customerCode = prjLandingData?.project?.client?.customer_code || '';
            const customerName = prjLandingData?.project?.client?.name || '';

            // Store project context for the module
            window._prjContext = { slug, code, customerCode, customerName, fromProject: true };

            // Switch to the module section
            navDropClick(module);

            // Show toast with context info
            showToast(`🔗 ${code || slug} → ${module.charAt(0).toUpperCase() + module.slice(1)}`, 'success');
        }

        function prjRenderModuleStatus() {
            if (!prjLandingData) return;
            const res = prjLandingData.resources || {};
            const modules = ['context','segmente','journey','nutzen','architektur','model','audit','wirkung','evidenz'];
            modules.forEach(mod => {
                const el = document.getElementById('prjModStatus_' + mod);
                if (!el) return;
                const hasData = res[mod] || res[mod + '_analysis'];
                if (hasData) {
                    el.innerHTML = '<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(52,211,153,0.1);color:#34d399;border:1px solid rgba(52,211,153,0.2)">✓ Daten vorhanden</span>';
                } else {
                    el.innerHTML = '<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.03);color:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.06)">Noch leer</span>';
                }
            });
        }

        function prjRenderTab(tab) {
            const d = prjLandingData;
            const p = d.project || {};
            const res = d.resources || {};
            const scope = p.scope || {};
            const objective = p.objective || {};
            const fehradvice_scope = p.fehradvice_scope || {};
            const project = p.project || {};
            const client = p.client || {};
            const team = p.team || {};
            const meta = p.metadata || {};

            if (tab === 'auftrag') {
                const objSummary = objective.summary || project.description || '';
                const coreInsight = objective.core_insight || '';
                const inScope = scope.in_scope || fehradvice_scope.deliverables || [];
                const outScope = scope.out_of_scope || [];
                const behObj = fehradvice_scope.behavioral_objectives || [];
                const tenC = fehradvice_scope.ten_c_focus || (p.ebf_integration||{}).primary_10c_dimensions || [];
                const stratCtx = project.strategic_context || '';
                // Contacts
                let auftraggeber = '', projektleiter = '';
                const contacts = client.contacts || team.customer_contacts || [];
                contacts.forEach(c => {
                    if (typeof c === 'object') {
                        if ((c.role||'').toLowerCase().includes('auftrag') || (c.role||'').toLowerCase().includes('sponsor')) auftraggeber = c.name || '';
                        if ((c.role||'').toLowerCase().includes('projektl') || (c.role||'').toLowerCase().includes('lead')) projektleiter = c.name || '';
                    }
                });

                let html = '<div style="display:flex;flex-direction:column;gap:20px">';
                // Beratungsziel
                html += `<div>
                    <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Beratungsziel</div>
                    <div style="padding:14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px">${objSummary || '<span style="color:rgba(255,255,255,0.3)">Noch nicht definiert</span>'}</div>
                    ${coreInsight ? `<div style="margin-top:8px;padding:10px 14px;background:rgba(251,191,36,0.05);border-left:3px solid rgba(251,191,36,0.4);border-radius:0 8px 8px 0;font-size:12px;color:rgba(255,255,255,0.5)">💡 ${coreInsight}</div>` : ''}
                </div>`;
                // Scope
                if (inScope.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Beratungs-Scope</div>
                        <div style="display:flex;flex-direction:column;gap:6px">${inScope.map(s => {
                            const txt = typeof s === 'string' ? s : s.name || s.id || JSON.stringify(s);
                            return `<div style="padding:8px 12px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.1);border-radius:6px;font-size:12px">✅ ${txt}</div>`;
                        }).join('')}</div>
                    </div>`;
                }
                if (outScope.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.4);margin-bottom:8px">Out-of-Scope</div>
                        <div style="display:flex;flex-direction:column;gap:6px">${outScope.map(s => `<div style="padding:8px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:6px;font-size:12px;color:rgba(255,255,255,0.4)">⛔ ${s}</div>`).join('')}</div>
                    </div>`;
                }
                // Behavioral Objectives & 10C
                if (behObj.length || tenC.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Behavioral Framework</div>
                        ${behObj.length ? `<div style="margin-bottom:8px">${behObj.map(b => `<div style="padding:6px 12px;font-size:12px;color:rgba(255,255,255,0.5)">🎯 ${b}</div>`).join('')}</div>` : ''}
                        ${tenC.length ? `<div style="display:flex;gap:6px;flex-wrap:wrap">${tenC.map(c => `<span style="padding:4px 10px;font-size:11px;border-radius:6px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${c}</span>`).join('')}</div>` : ''}
                    </div>`;
                }
                // Auftraggeber / Projektleiter
                if (auftraggeber || projektleiter || contacts.length) {
                    html += `<div>
                        <div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:8px">Kundenseitige Verantwortung</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <div style="padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3)">Auftraggeber</div>
                                <div style="font-size:13px;color:white;margin-top:4px">${auftraggeber || '–'}</div>
                            </div>
                            <div style="padding:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                                <div style="font-size:10px;color:rgba(255,255,255,0.3)">Projektleiter (Kunde)</div>
                                <div style="font-size:13px;color:white;margin-top:4px">${projektleiter || '–'}</div>
                            </div>
                        </div>
                    </div>`;
                }
                if (!objSummary && !inScope.length && !outScope.length) {
                    html += '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Beratungsauftrag noch nicht definiert.<br>Wird beim Import aus Proposal/Offerte automatisch befüllt.</div>';
                }
                html += '</div>';
                document.getElementById('prjAuftragContent').innerHTML = html;
            }

            else if (tab === 'planung') {
                let tl = p.timeline || [];
                const phases = p.phases || [];
                let html = '';
                if (Array.isArray(tl) && tl.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:12px">Milestones</div>';
                    html += '<div style="display:flex;flex-direction:column;gap:6px">';
                    tl.forEach(m => {
                        const statusIcon = (m.status||'').toLowerCase().includes('done') || (m.status||'').toLowerCase().includes('erledigt') ? '✅' : (m.status||'').toUpperCase() === 'HEUTE' ? '📍' : '⏳';
                        html += `<div style="display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                            <div style="font-size:14px">${statusIcon}</div>
                            <div style="width:90px;font-size:11px;color:rgba(255,255,255,0.3);flex-shrink:0">${m.date||''}</div>
                            <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${m.milestone||m.name||''}</div>
                            <div style="font-size:10px;color:rgba(255,255,255,0.2)">${m.status||''}</div>
                        </div>`;
                    });
                    html += '</div>';
                }
                if (phases.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:12px;margin-top:20px">Phasen</div>';
                    phases.forEach((ph, i) => {
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
                                <span style="font-size:11px;padding:2px 8px;border-radius:6px;background:var(--accent-glow);color:var(--accent-light)">${ph.phase||'Phase '+(i+1)}</span>
                                <span style="font-size:13px;font-weight:600;color:white">${ph.name||''}</span>
                                ${ph.duration_weeks ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">${ph.duration_weeks} Wochen</span>` : ''}
                            </div>
                            ${ph.description ? `<div style="font-size:12px;color:rgba(255,255,255,0.5)">${ph.description}</div>` : ''}
                        </div>`;
                    });
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Projektplanung hinterlegt.</div>';
                }
                document.getElementById('prjPlanungContent').innerHTML = html;
            }

            else if (tab === 'meetings') {
                const sessions = p.sessions || [];
                let html = '';
                if (sessions.length) {
                    sessions.forEach(s => {
                        const statusIcon = s.status === 'completed' ? '✅' : s.status === 'scheduled' ? '📅' : '📝';
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="display:flex;align-items:center;gap:10px">
                                <span style="font-size:16px">${statusIcon}</span>
                                <div style="flex:1">
                                    <div style="font-size:13px;font-weight:600;color:white">${s.purpose||s.type||s.id||'Session'}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">${s.date||''} · ${s.type||''} · ${s.mode||''}</div>
                                </div>
                                <span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.3)">${s.status||''}</span>
                            </div>
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Meetings erfasst.</div>';
                }
                document.getElementById('prjMeetingsContent').innerHTML = html;
            }

            else if (tab === 'deliverables') {
                const deliverables = p.deliverables || p.final_deliverables || fehradvice_scope.deliverables || [];
                let html = '';
                if (deliverables.length) {
                    deliverables.forEach(d => {
                        const name = typeof d === 'string' ? d : d.name || d.id || '';
                        const desc = typeof d === 'object' ? d.description || '' : '';
                        html += `<div style="padding:12px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                            <div style="font-size:13px;font-weight:600;color:white">📦 ${name}</div>
                            ${desc ? `<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px">${desc}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Keine Deliverables definiert.</div>';
                }
                document.getElementById('prjDeliverablesContent').innerHTML = html;
            }

            else if (tab === 'dokumente') {
                const docs = res.documents || {};
                let html = '';
                if (docs.available) {
                    if (docs.pdf_files?.length) {
                        html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">PDFs</div>';
                        docs.pdf_files.forEach(f => {
                            html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                                <span style="font-size:16px">📕</span>
                                <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f}</div>
                            </div>`;
                        });
                    }
                    if (docs.md_files?.length) {
                        html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">Markdown</div>';
                        docs.md_files.forEach(f => {
                            html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                                <span style="font-size:16px">📝</span>
                                <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f}</div>
                            </div>`;
                        });
                    }
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Keine Dokumente im Kundenordner.</div>';
                }
                document.getElementById('prjDokumenteContent').innerHTML = html;
            }

            else if (tab === 'modelle') {
                const models = res.models || {};
                const ebf = p.ebf_integration || {};
                let html = '';
                if (models.available) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">Vorhandene Modelle</div>';
                    models.files.forEach(f => {
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:8px;margin-bottom:6px">
                            <span style="font-size:16px">🧠</span>
                            <div style="flex:1;font-size:13px;color:rgba(255,255,255,0.7)">${f.replace('.yaml','').replace(/_/g,' ')}</div>
                        </div>`;
                    });
                }
                // Context Vector
                const cv = res.context_vector || {};
                if (cv.available) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">Kontextvektor</div>';
                    html += `<div style="display:flex;flex-wrap:wrap;gap:6px">`;
                    cv.files.forEach(f => {
                        const dim = f.replace(/.*_context_/,'').replace('.yaml','').replace('_',' ');
                        html += `<span style="padding:4px 10px;font-size:11px;border-radius:6px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${dim}</span>`;
                    });
                    html += '</div>';
                }
                // EBF
                if (ebf.primary_10c_dimensions?.length || ebf.behavioral_barriers?.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px;margin-top:16px">EBF Integration</div>';
                    if (ebf.primary_10c_dimensions?.length) html += `<div style="margin-bottom:6px;font-size:12px;color:rgba(255,255,255,0.5)">10C: ${ebf.primary_10c_dimensions.join(', ')}</div>`;
                    if (ebf.behavioral_barriers?.length) html += `<div style="font-size:12px;color:rgba(255,255,255,0.5)">Barriers: ${ebf.behavioral_barriers.join(', ')}</div>`;
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Modelle für diesen Kunden erstellt.<br>→ Modell über den Model Builder anlegen.</div>';
                }
                document.getElementById('prjModelleContent').innerHTML = html;
            }

            else if (tab === 'risiken') {
                const risks = p.risks || [];
                let html = '';
                if (risks.length) {
                    risks.forEach(r => {
                        const desc = typeof r === 'string' ? r : r.description || '';
                        const prob = r.probability || '';
                        const impact = r.impact || '';
                        const mitigation = r.mitigation || '';
                        html += `<div style="padding:14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
                            <div style="font-size:13px;font-weight:600;color:white">⚠ ${desc}</div>
                            ${prob || impact ? `<div style="display:flex;gap:12px;margin-top:6px;font-size:11px;color:rgba(255,255,255,0.3)">${prob ? `<span>P: ${prob}</span>` : ''}${impact ? `<span>Impact: ${impact}</span>` : ''}</div>` : ''}
                            ${mitigation ? `<div style="margin-top:6px;padding:8px 10px;background:rgba(52,211,153,0.05);border-left:2px solid rgba(52,211,153,0.3);border-radius:0 6px 6px 0;font-size:12px;color:rgba(255,255,255,0.5)">Mitigation: ${mitigation}</div>` : ''}
                        </div>`;
                    });
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Keine Risiken erfasst.</div>';
                }
                document.getElementById('prjRisikenContent').innerHTML = html;
            }

            else if (tab === 'budget') {
                let budget = null, billing = '', currency = 'CHF';
                if (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) {
                    budget = p.timeline.budget_chf || p.timeline.budget_eur || null;
                    billing = p.timeline.billing_type || '';
                    if (p.timeline.budget_eur) currency = 'EUR';
                }
                let html = '';
                if (budget) {
                    const billingLabels = {fixed:'Fixpreis',time_material:'Time & Material',retainer:'Retainer'};
                    html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div style="padding:20px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.15);border-radius:10px;text-align:center">
                            <div style="font-size:10px;color:rgba(255,255,255,0.3)">Projektbudget</div>
                            <div style="font-size:28px;font-weight:700;color:#34d399;margin-top:6px">${currency} ${parseInt(budget).toLocaleString('de-CH')}</div>
                        </div>
                        <div style="padding:20px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:10px;text-align:center">
                            <div style="font-size:10px;color:rgba(255,255,255,0.3)">Abrechnungsmodell</div>
                            <div style="font-size:20px;font-weight:600;color:white;margin-top:6px">${billingLabels[billing]||billing||'–'}</div>
                        </div>
                    </div>`;
                } else {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Kein Budget hinterlegt.</div>';
                }
                document.getElementById('prjBudgetContent').innerHTML = html;
            }

            else if (tab === 'kommunikation') {
                document.getElementById('prjKommunikationContent').innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Kommunikationslog wird in einer nächsten Version verfügbar.<br>Hier werden E-Mails, Abstimmungen und Vereinbarungen erfasst.</div>';
            }

            else if (tab === 'learnings') {
                const kpis = p.kpis || [];
                const sm = p.success_metrics || {};
                let html = '';
                if (kpis.length) {
                    html += '<div style="font-size:12px;font-weight:600;color:var(--accent-light);margin-bottom:10px">KPIs & Wirkungsmessung</div>';
                    kpis.forEach(k => {
                        html += `<div style="padding:12px 14px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:13px;font-weight:600;color:white">${k.name||k.kpi_id||''}</span>
                                ${k.target ? `<span style="font-size:10px;padding:2px 8px;border-radius:6px;background:rgba(52,211,153,0.1);color:#34d399">Ziel: ${k.target}</span>` : ''}
                            </div>
                            ${k.description ? `<div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px">${k.description}</div>` : ''}
                        </div>`;
                    });
                }
                if (!html) {
                    html = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch keine Learnings oder KPIs erfasst.<br>Wird nach Projektabschluss / Meilensteinen befüllt.</div>';
                }
                document.getElementById('prjLearningsContent').innerHTML = html;
            }
        }

        function prjAddMeeting() { prjStartEdit('meetings'); }

        // ════════════════════════════════════════════════
        // PROJECT EDIT SYSTEM
        // ════════════════════════════════════════════════
        let prjEditMode = false;

        const prjInputStyle = 'width:100%;padding:10px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:white;font-size:13px;font-family:inherit;resize:vertical;outline:none;';
        const prjBtnSave = 'padding:8px 20px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer;';
        const prjBtnCancel = 'padding:8px 20px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:13px;cursor:pointer;';
        const prjFieldLabel = 'font-size:11px;font-weight:600;color:rgba(255,255,255,0.4);margin-bottom:4px;';

        function prjStartEdit(tab) {
            prjEditMode = true;
            const d = prjLandingData;
            const p = d.project || {};

            if (tab === 'auftrag') {
                const obj = p.objective || {};
                const scope = p.scope || {};
                const project = p.project || {};
                const fs = p.fehradvice_scope || {};
                document.getElementById('prjAuftragContent').innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:16px">
                        <div><div style="${prjFieldLabel}">Beratungsziel</div>
                            <textarea id="prjEditObjSummary" style="${prjInputStyle}min-height:80px">${obj.summary || project.description || ''}</textarea></div>
                        <div><div style="${prjFieldLabel}">Core Insight</div>
                            <input id="prjEditCoreInsight" style="${prjInputStyle}" value="${(obj.core_insight||'').replace(/"/g,'&quot;')}" placeholder="Zentrale Erkenntnis…"></div>
                        <div><div style="${prjFieldLabel}">In-Scope (eine Zeile pro Punkt)</div>
                            <textarea id="prjEditInScope" style="${prjInputStyle}min-height:80px">${(scope.in_scope || fs.deliverables || []).map(s => typeof s === 'string' ? s : s.name || '').join('\n')}</textarea></div>
                        <div><div style="${prjFieldLabel}">Out-of-Scope (eine Zeile pro Punkt)</div>
                            <textarea id="prjEditOutScope" style="${prjInputStyle}min-height:60px">${(scope.out_of_scope || []).join('\n')}</textarea></div>
                        <div><div style="${prjFieldLabel}">Behavioral Objectives (eine Zeile pro Ziel)</div>
                            <textarea id="prjEditBehObj" style="${prjInputStyle}min-height:60px">${(fs.behavioral_objectives || []).join('\n')}</textarea></div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                            <button onclick="prjCancelEdit('auftrag')" style="${prjBtnCancel}">Abbrechen</button>
                            <button onclick="prjSaveEdit('auftrag')" style="${prjBtnSave}">💾 Speichern</button>
                        </div>
                    </div>`;
            }

            else if (tab === 'planung') {
                const tl = Array.isArray(p.timeline) ? p.timeline : [];
                const rows = tl.map((m,i) => `
                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px" data-ms="${i}">
                        <input style="${prjInputStyle}width:120px;flex-shrink:0" value="${m.date||''}" placeholder="YYYY-MM-DD">
                        <input style="${prjInputStyle}flex:1" value="${(m.milestone||m.name||'').replace(/"/g,'&quot;')}" placeholder="Milestone">
                        <select style="${prjInputStyle}width:110px;flex-shrink:0"><option ${m.status==='planned'?'selected':''}>planned</option><option ${m.status==='done'?'selected':''}>done</option><option ${m.status==='HEUTE'?'selected':''}>HEUTE</option></select>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px">✕</button>
                    </div>`).join('');
                document.getElementById('prjPlanungContent').innerHTML = `
                    <div id="prjEditMilestones">${rows}</div>
                    <button onclick="prjAddMilestone()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Milestone</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('planung')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('planung')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'meetings') {
                const now = new Date().toISOString().split('T')[0];
                document.getElementById('prjMeetingsContent').innerHTML += `
                    <div style="background:rgba(42,127,142,0.05);border:1px solid rgba(42,127,142,0.15);border-radius:10px;padding:16px;margin-top:12px">
                        <div style="font-size:13px;font-weight:600;color:var(--accent-light);margin-bottom:12px">Neues Meeting</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                            <div><div style="${prjFieldLabel}">Datum</div><input id="prjNewMeetDate" type="date" value="${now}" style="${prjInputStyle}"></div>
                            <div><div style="${prjFieldLabel}">Typ</div><select id="prjNewMeetType" style="${prjInputStyle}"><option>workshop</option><option>call</option><option>presentation</option><option>review</option><option>kickoff</option><option>offsite</option></select></div>
                            <div><div style="${prjFieldLabel}">Zweck / Titel</div><input id="prjNewMeetPurpose" style="${prjInputStyle}" placeholder="Zweck des Meetings…"></div>
                            <div><div style="${prjFieldLabel}">Modus</div><select id="prjNewMeetMode" style="${prjInputStyle}"><option>in-person</option><option>remote</option><option>hybrid</option></select></div>
                        </div>
                        <div style="margin-top:10px"><div style="${prjFieldLabel}">Notizen</div><textarea id="prjNewMeetNotes" style="${prjInputStyle}min-height:60px" placeholder="Agenda, Teilnehmer, Ergebnisse…"></textarea></div>
                        <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:10px">
                            <button onclick="prjCancelEdit('meetings')" style="${prjBtnCancel}">Abbrechen</button>
                            <button onclick="prjSaveEdit('meetings')" style="${prjBtnSave}">💾 Meeting speichern</button>
                        </div>
                    </div>`;
            }

            else if (tab === 'deliverables') {
                const deliverables = p.deliverables || p.final_deliverables || (p.fehradvice_scope||{}).deliverables || [];
                const rows = deliverables.map((d,i) => {
                    const name = typeof d === 'string' ? d : d.name || d.id || '';
                    const desc = typeof d === 'object' ? d.description || '' : '';
                    return `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px" data-del="${i}">
                        <div style="flex:1"><input style="${prjInputStyle}" value="${name.replace(/"/g,'&quot;')}" placeholder="Name"><input style="${prjInputStyle}margin-top:4px;font-size:11px" value="${desc.replace(/"/g,'&quot;')}" placeholder="Beschreibung (optional)"></div>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                    </div>`;
                }).join('');
                document.getElementById('prjDeliverablesContent').innerHTML = `
                    <div id="prjEditDeliverables">${rows}</div>
                    <button onclick="prjAddDeliverable()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Deliverable</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('deliverables')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('deliverables')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'risiken') {
                const risks = p.risks || [];
                const rows = risks.map((r,i) => {
                    const desc = typeof r === 'string' ? r : r.description || '';
                    const mit = typeof r === 'object' ? r.mitigation || '' : '';
                    return `<div style="display:flex;gap:8px;align-items:start;margin-bottom:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px" data-risk="${i}">
                        <div style="flex:1"><input style="${prjInputStyle}" value="${desc.replace(/"/g,'&quot;')}" placeholder="Risiko-Beschreibung"><input style="${prjInputStyle}margin-top:4px;font-size:11px" value="${mit.replace(/"/g,'&quot;')}" placeholder="Mitigation"></div>
                        <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                    </div>`;
                }).join('');
                document.getElementById('prjRisikenContent').innerHTML = `
                    <div id="prjEditRisiken">${rows}</div>
                    <button onclick="prjAddRisk()" style="padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer;margin:10px 0">+ Risiko</button>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:8px">
                        <button onclick="prjCancelEdit('risiken')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('risiken')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }

            else if (tab === 'budget') {
                const tl = (typeof p.timeline === 'object' && !Array.isArray(p.timeline)) ? p.timeline : {};
                document.getElementById('prjBudgetContent').innerHTML = `
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                        <div><div style="${prjFieldLabel}">Budget (CHF)</div><input id="prjEditBudgetCHF" type="number" style="${prjInputStyle}" value="${tl.budget_chf||''}"></div>
                        <div><div style="${prjFieldLabel}">Abrechnungsmodell</div><select id="prjEditBilling" style="${prjInputStyle}"><option value="">–</option><option ${tl.billing_type==='fixed'?'selected':''} value="fixed">Fixpreis</option><option ${tl.billing_type==='time_material'?'selected':''} value="time_material">Time & Material</option><option ${tl.billing_type==='retainer'?'selected':''} value="retainer">Retainer</option></select></div>
                    </div>
                    <div style="display:flex;gap:10px;justify-content:flex-end;padding-top:16px">
                        <button onclick="prjCancelEdit('budget')" style="${prjBtnCancel}">Abbrechen</button>
                        <button onclick="prjSaveEdit('budget')" style="${prjBtnSave}">💾 Speichern</button>
                    </div>`;
            }
        }

        function prjAddMilestone() {
            const el = document.getElementById('prjEditMilestones');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                    <input style="${prjInputStyle}width:120px;flex-shrink:0" placeholder="YYYY-MM-DD">
                    <input style="${prjInputStyle}flex:1" placeholder="Milestone">
                    <select style="${prjInputStyle}width:110px;flex-shrink:0"><option>planned</option><option>done</option></select>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px">✕</button>
                </div>`);
        }

        function prjAddDeliverable() {
            const el = document.getElementById('prjEditDeliverables');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:start;margin-bottom:8px">
                    <div style="flex:1"><input style="${prjInputStyle}" placeholder="Name"><input style="${prjInputStyle}margin-top:4px;font-size:11px" placeholder="Beschreibung (optional)"></div>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                </div>`);
        }

        function prjAddRisk() {
            const el = document.getElementById('prjEditRisiken');
            if (!el) return;
            el.insertAdjacentHTML('beforeend', `
                <div style="display:flex;gap:8px;align-items:start;margin-bottom:8px;padding:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:8px">
                    <div style="flex:1"><input style="${prjInputStyle}" placeholder="Risiko-Beschreibung"><input style="${prjInputStyle}margin-top:4px;font-size:11px" placeholder="Mitigation"></div>
                    <button onclick="this.parentElement.remove()" style="background:none;border:none;color:rgba(248,113,113,0.6);cursor:pointer;font-size:16px;margin-top:8px">✕</button>
                </div>`);
        }

        function prjCancelEdit(tab) {
            prjEditMode = false;
            prjRenderTab(tab);
        }

        async function prjSyncGitHub() {
            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/sync`, { method:'POST', headers:H() });
                const r = await resp.json();
                if (r.synced?.length) showToast(`${r.synced.length} Sektionen nach GitHub synchronisiert`, 'success');
                else if (r.failed?.length) showToast(`GitHub-Sync fehlgeschlagen: ${r.failed.map(f=>f.section).join(', ')}`, 'error');
                else showToast('Alles bereits synchronisiert', 'success');
                // Reload
                const resp2 = await fetch(`${API}/projects/${prjCurrentSlug}/landing`, { headers: H() });
                prjLandingData = await resp2.json();
                prjRenderLanding();
                prjSwitchTab(prjActiveTab);
            } catch(e) { showToast('Sync-Fehler: '+e.message,'error'); }
        }

        async function prjSaveEdit(tab) {
            let section = '', data = {};

            if (tab === 'auftrag') {
                const summary = document.getElementById('prjEditObjSummary')?.value.trim() || '';
                const insight = document.getElementById('prjEditCoreInsight')?.value.trim() || '';
                const inScope = document.getElementById('prjEditInScope')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                const outScope = document.getElementById('prjEditOutScope')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                const behObj = document.getElementById('prjEditBehObj')?.value.split('\n').map(s=>s.trim()).filter(Boolean) || [];
                // Save to multiple sections
                try {
                    await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'objective', data:{summary, core_insight:insight}})});
                    await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'scope', data:{in_scope:inScope, out_of_scope:outScope}})});
                    if (behObj.length) await fetch(`${API}/projects/${prjCurrentSlug}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({section:'fehradvice_scope', data:{behavioral_objectives:behObj}})});
                    showToast('Beratungsauftrag gespeichert', 'success');
                } catch(e) { showToast('Fehler: '+e.message,'error'); return; }
            }

            else if (tab === 'planung') {
                const rows = document.querySelectorAll('#prjEditMilestones > div');
                const milestones = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input, select');
                    if (inputs[0]?.value || inputs[1]?.value) {
                        milestones.push({date:inputs[0].value, milestone:inputs[1].value, status:inputs[2].value});
                    }
                });
                section = 'timeline'; data = milestones;
            }

            else if (tab === 'meetings') {
                const date = document.getElementById('prjNewMeetDate')?.value || '';
                const type = document.getElementById('prjNewMeetType')?.value || '';
                const purpose = document.getElementById('prjNewMeetPurpose')?.value || '';
                const mode = document.getElementById('prjNewMeetMode')?.value || '';
                const notes = document.getElementById('prjNewMeetNotes')?.value || '';
                if (!purpose) { showToast('Bitte Zweck eingeben','error'); return; }
                const newSession = {id:`SES-${Date.now()}`, date, type, purpose, mode, status:'scheduled', notes};
                section = 'sessions'; data = {action:'add', session:newSession};
            }

            else if (tab === 'deliverables') {
                const rows = document.querySelectorAll('#prjEditDeliverables > div');
                const items = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (inputs[0]?.value) items.push({name:inputs[0].value, description:inputs[1]?.value||''});
                });
                section = 'deliverables'; data = items;
            }

            else if (tab === 'risiken') {
                const rows = document.querySelectorAll('#prjEditRisiken > div');
                const items = [];
                rows.forEach(r => {
                    const inputs = r.querySelectorAll('input');
                    if (inputs[0]?.value) items.push({description:inputs[0].value, mitigation:inputs[1]?.value||''});
                });
                section = 'risks'; data = items;
            }

            else if (tab === 'budget') {
                const budgetCHF = document.getElementById('prjEditBudgetCHF')?.value || '';
                const billing = document.getElementById('prjEditBilling')?.value || '';
                section = 'budget'; data = {};
                if (budgetCHF) data.budget_chf = parseInt(budgetCHF);
                if (billing) data.billing_type = billing;
            }

            // Send to API (unless auftrag which was already sent above)
            if (section && tab !== 'auftrag') {
                try {
                    const resp = await fetch(`${API}/projects/${prjCurrentSlug}`, {
                        method: 'PUT', headers: {...H(), 'Content-Type':'application/json'},
                        body: JSON.stringify({section, data})
                    });
                    if (!resp.ok) { const e = await resp.json(); throw new Error(e.error || 'Fehler'); }
                    showToast(`${tab} gespeichert → GitHub`, 'success');
                } catch(e) { showToast('Fehler: '+e.message,'error'); return; }
            }

            // Reload project data
            prjEditMode = false;
            try {
                const resp = await fetch(`${API}/projects/${prjCurrentSlug}/landing`, { headers: H() });
                prjLandingData = await resp.json();
                prjRenderLanding();
                prjSwitchTab(tab);
            } catch(e) { prjRenderTab(tab); }
        }

        let crmCompanyFilter = null;

        async function crmChangeStage(dealId, ns) {
            try { await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({stage:ns}) }); crmCloseDrawer(); crmLoad(); showToast('Stage → '+ns, 'success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmAddNote(dealId) {
            const note = document.getElementById('crmQuickNote')?.value.trim();
            if (!note) return;
            try {
                await fetch(`${API}/crm/activities`, { method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({deal_id:dealId,type:'note',subject:note}) });
                const deal = crmDeals.find(d=>d.id===dealId);
                const ts = new Date().toLocaleString('de-CH');
                await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({notes:(deal?.notes||'')+`\n[${ts}] ${note}`}) });
                showToast('Notiz ✓','success'); crmLoad(); crmCloseDrawer();
            } catch(e) { showToast('Fehler','error'); }
        }

        async function crmDeleteDeal(id) {
            if (!confirm('Lead löschen?')) return;
            try { await fetch(`${API}/crm/deals/${id}`,{method:'DELETE',headers:H()}); crmCloseDrawer(); crmLoad(); showToast('Lead gelöscht','success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmSyncGithub() {
            const btn = document.getElementById('crmSyncBtn');
            btn.disabled=true; btn.textContent='⏳ Synchronisiere...';
            try {
                const r = await fetch(`${API}/crm/sync-github`, { method:'POST', headers:H() });
                const data = await r.json();
                if (r.ok) { crmLastSync = new Date(); showToast(`Sync: ${data.stats.deals} Leads, ${data.stats.companies} Firmen ✓`, 'success'); crmLoad(); }
                else throw new Error(data.detail||'failed');
            } catch(e) { showToast('Sync fehlgeschlagen: '+e.message, 'error'); }
            btn.disabled=false; btn.textContent='🔄 Synchronisieren';
        }

        async function loadStats() {
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401)return;const d=await r.json();
                document.getElementById('statDocs').textContent=d.length;document.getElementById('statKB').textContent=d.filter(x=>x.database_target==='knowledge_base').length;document.getElementById('statAxioms').textContent=d.filter(x=>x.database_target==='bcm_axioms').length;
            }catch(e){document.getElementById('statDocs').textContent='–';}
        }

        function showToast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${{success:'✓',error:'✗',info:'ℹ'}[type]||''}</span> ${msg}`;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='0.3s';setTimeout(()=>t.remove(),300);},4000);}
        function clearAll(){files=[];tags=[];renderFileList();renderTags();document.getElementById('textTitle').value='';document.getElementById('textContent').value='';updateCount();}
        document.getElementById('textContent').addEventListener('input',updateCount);

        // ── Admin Dashboard ──────────────────────────────
        const ROLE_CONFIG = {
            researcher:        { label: 'Researcher',   color: '#8b9aff', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Profil'] },
            sales:             { label: 'Sales',        color: '#fbbf24', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            operations:        { label: 'Operations',   color: '#34d399', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            senior_management: { label: 'Senior Mgmt',  color: '#f59e0b', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            partner:           { label: 'Partner',      color: '#ef4444', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            admin:             { label: 'Admin',        color: '#f87171', tabs: ['Alle Tabs'] }
        };
        // Owner codes from YAML team_registry
        const CRM_OWNER_CODES = ['','OWN-GF','OWN-EB','OWN-MdL','OWN-AJ','OWN-MR','OWN-MFA','OWN-MF'];

        async function loadAdminData() {
            if (!currentUser || !currentUser.admin) return;
            try {
                const [usersR, settingsR, docsR] = await Promise.all([
                    fetch(`${API}/admin/users`, {headers:H()}),
                    fetch(`${API}/admin/settings`, {headers:H()}),
                    fetch(`${API}/documents`, {headers:H()})
                ]);
                if (usersR.status===401) { doLogout(); return; }
                const users = usersR.ok ? await usersR.json() : [];
                const settings = settingsR.ok ? await settingsR.json() : {};
                const docs = docsR.ok ? await docsR.json() : [];

                // Stats
                document.getElementById('adminStatUsers').textContent = users.length;
                document.getElementById('adminStatDocs').textContent = docs.length;
                const regMode = settings.registration === 'open' ? 'Offen' : 'Eingeschränkt';
                document.getElementById('adminStatReg').textContent = regMode;
                const domains = settings.allowed_email_domains || [];
                document.getElementById('adminStatRegSub').textContent = domains.includes('*') ? 'Alle Domains' : domains.map(d => '@'+d).join(', ') || 'Alle Domains';
                document.getElementById('adminUserCount').textContent = users.length;

                // User table
                const tbody = users.map(u => {
                    const created = u.created_at ? new Date(u.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric'}) : '–';
                    const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Nie';
                    const userRole = u.is_admin ? 'admin' : (u.role || 'researcher');
                    const rc = ROLE_CONFIG[userRole] || ROLE_CONFIG.researcher;
                    const statusBadge = u.is_active ? '<span class="user-badge active">Aktiv</span>' : '<span class="user-badge inactive">Inaktiv</span>';
                    const verifiedBadge = u.email_verified ? '<span class="user-badge active">✓</span>' : '<span class="user-badge inactive">✗</span>';

                    // Role dropdown + admin toggle
                    const isSelf = u.email === currentUser.email;
                    const adminToggle = !isSelf
                        ? (u.is_admin
                            ? `<button onclick="adminToggleAdmin('${u.id}','${u.email}',false)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(248,113,113,0.6);border:1px solid rgba(248,113,113,0.2);border-radius:6px;cursor:pointer" title="Admin-Rechte entziehen">✕</button>`
                            : `<button onclick="adminToggleAdmin('${u.id}','${u.email}',true)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(251,191,36,0.5);border:1px solid rgba(251,191,36,0.2);border-radius:6px;cursor:pointer" title="Zum Admin ernennen">👑</button>`)
                        : '';
                    const roleCell = u.is_admin
                        ? `<span style="font-size:11px;padding:4px 10px;border-radius:12px;background:${ROLE_CONFIG.admin.color}18;color:${ROLE_CONFIG.admin.color};border:1px solid ${ROLE_CONFIG.admin.color}44;font-weight:600">Admin</span>${adminToggle}`
                        : `<select onchange="adminSetRole('${u.id}',this.value)" style="font-size:11px;padding:4px 8px;background:${rc.color}12;color:${rc.color};border:1px solid ${rc.color}44;border-radius:8px;cursor:pointer;font-weight:600;appearance:auto">
                            ${Object.entries(ROLE_CONFIG).filter(([k]) => k !== 'admin').map(([k, v]) =>
                                `<option value="${k}" ${k === userRole ? 'selected' : ''} style="color:#000">${v.label}</option>`
                            ).join('')}
                        </select>${adminToggle}`;

                    // CRM access controls (only for @fehradvice.com)
                    const isFa = u.email.toLowerCase().endsWith('@fehradvice.com');
                    const isSenior = ['senior_management','partner'].includes(u.role);
                    const crmCell = isFa
                        ? `<div style="display:flex;flex-direction:column;gap:4px">
                            <label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="CRM-Zugang">
                                <input type="checkbox" ${u.crm_access ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{crm_access:this.checked})" style="accent-color:#2A7F8E;cursor:pointer">
                                <span style="font-size:10px;color:${u.crm_access ? '#2A7F8E' : 'rgba(255,255,255,0.25)'}">CRM</span>
                            </label>
                            ${u.crm_access ? `<label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="Lead-Management (eigene Leads)">
                                <input type="checkbox" ${u.lead_management ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{lead_management:this.checked})" style="accent-color:#E8A33D;cursor:pointer">
                                <span style="font-size:10px;color:${u.lead_management ? '#E8A33D' : 'rgba(255,255,255,0.25)'}">Leads</span>
                            </label>
                            <select onchange="adminToggleCrm('${u.id}',{crm_owner_code:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${CRM_OWNER_CODES.map(c => `<option value="${c}" ${c===(u.crm_owner_code||'') ? 'selected' : ''} style="color:#000">${c || '– kein Owner –'}</option>`).join('')}
                            </select>
                            <select onchange="adminToggleCrm('${u.id}',{crm_role:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${['none','viewer','manager','admin'].map(r => `<option value="${r}" ${r===(u.crm_role||'none') ? 'selected' : ''} style="color:#000">${r==='none'?'– keine Rolle –':r==='viewer'?'Viewer (eigene)':r==='manager'?'Manager (alle)':'Admin'}</option>`).join('')}
                            </select>` : ''}
                          </div>`
                        : '<span style="font-size:10px;color:rgba(255,255,255,0.15)">–</span>';

                    // Tab access pills (include CRM if access)
                    const tabs = u.is_admin ? ['Alle'] : [...rc.tabs.filter(t => !['Profil'].includes(t)), ...(u.crm_access && isFa ? ['CRM'] : [])];
                    const tabPills = tabs.map(t =>
                        `<span style="font-size:9px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.35);border:1px solid rgba(255,255,255,0.06)">${t}</span>`
                    ).join(' ');

                    const toggleBtn = u.is_active
                        ? `<button class="btn-toggle deactivate" onclick="toggleUserActive('${u.id}','${u.email}')">Deaktivieren</button>`
                        : `<button class="btn-toggle activate" onclick="toggleUserActive('${u.id}','${u.email}')">Aktivieren</button>`;
                    const verifyBtn = !u.email_verified ? ` <button class="btn-toggle activate" onclick="adminVerifyUser('${u.id}','${u.email}')">Bestätigen</button>` : '';

                    return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
                        <td style="padding:10px 8px"><span style="font-weight:500;color:white">${u.name || '–'}</span><br><span style="font-size:11px;color:var(--text-muted)">${u.email}</span></td>
                        <td style="padding:10px 6px">${roleCell}</td>
                        <td style="padding:10px 4px">${crmCell}</td>
                        <td style="padding:10px 4px"><div style="display:flex;flex-wrap:wrap;gap:3px">${tabPills}</div></td>
                        <td style="padding:10px 4px;text-align:center">${verifiedBadge}</td>
                        <td style="padding:10px 4px">${statusBadge}</td>
                        <td style="padding:10px 4px;font-size:11px;color:rgba(255,255,255,0.4)">${lastLogin}</td>
                        <td style="padding:10px 4px">${toggleBtn}${verifyBtn}</td>
                    </tr>`;
                }).join('');

                document.getElementById('adminUserTable').innerHTML = `<table class="user-table" style="width:100%;border-collapse:collapse">
                    <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Benutzer</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Rolle</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">CRM</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Tab-Zugang</th>
                        <th style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">E-Mail</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Status</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Letzter Login</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Aktionen</th>
                    </tr></thead>
                    <tbody>${tbody}</tbody>
                </table>`;

                // Settings
                document.getElementById('adminSettings').innerHTML = `
                    <div class="settings-row"><span class="settings-label">E-Mail-Verifizierung</span><span class="settings-value" style="color:${settings.email_verification?'var(--success)':'var(--text-muted)'}">${settings.email_verification ? '✓ Aktiv' : '✗ Deaktiviert'}</span></div>
                    <div class="settings-row"><span class="settings-label">E-Mail-Versand (Resend)</span><span class="settings-value" style="color:${settings.smtp_configured?'var(--success)':'var(--error)'}">${settings.smtp_configured ? '✓ Konfiguriert' : '✗ Nicht konfiguriert'}</span></div>
                    <div class="settings-row"><span class="settings-label">Registrierung</span><span class="settings-value">${regMode}</span></div>
                    <div class="settings-row"><span class="settings-label">Erlaubte Domains</span><span class="settings-value">${domains.includes('*') ? 'Alle (*)' : domains.map(d=>'@'+d).join(', ') || 'Alle (*)'}</span></div>
                    <div class="settings-row"><span class="settings-label">JWT Gültigkeit</span><span class="settings-value">${settings.jwt_expiry_hours || 24}h</span></div>
                `;

                // Load feedback
                try {
                    const fbR = await fetch(`${API}/feedback`, {headers:H()});
                    const feedbacks = fbR.ok ? await fbR.json() : [];
                    const openFb = feedbacks.filter(f => f.status === 'neu');
                    document.getElementById('adminStatFb').textContent = openFb.length;
                    document.getElementById('adminStatFbSub').textContent = `von ${feedbacks.length} gesamt`;
                    document.getElementById('adminFbCount').textContent = feedbacks.length;

                    if (feedbacks.length === 0) {
                        document.getElementById('adminFeedbackList').innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch kein Feedback eingegangen.</div>';
                    } else {
                        const typeIcons = { bug: '🐛', wunsch: '💡', frage: '❓' };
                        const statusColors = { neu: '#f87171', bearbeitung: '#fbbf24', erledigt: '#34d399' };
                        document.getElementById('adminFeedbackList').innerHTML = feedbacks.map(f => {
                            const sc = statusColors[f.status] || '#94a3b8';
                            const date = f.created_at ? new Date(f.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '–';
                            return `<div style="padding:14px 16px;background:var(--navy-card);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
                                <span style="font-size:20px">${typeIcons[f.type] || '📝'}</span>
                                <div style="flex:1;min-width:0">
                                    <div style="font-size:13px;color:white;margin-bottom:3px">${f.comment || '–'}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">${f.created_by} · ${date} · Tab: ${f.page || '–'} · ${f.viewport || ''}</div>
                                </div>
                                <button onclick="fbShowScreenshot('${f.id}')" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(139,170,255,0.2);background:transparent;color:rgba(139,170,255,0.7);font-size:11px;cursor:pointer;white-space:nowrap">📸 Bild</button>
                                <select onchange="fbUpdateStatus('${f.id}',this.value)" style="font-size:11px;padding:4px 8px;background:transparent;color:${sc};border:1px solid ${sc}44;border-radius:6px;cursor:pointer">
                                    ${['neu','bearbeitung','erledigt'].map(s => `<option value="${s}" ${s===f.status?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </div>`;
                        }).join('');
                    }
                } catch(e) { console.error('Feedback load:', e); }
            } catch(e) {
                document.getElementById('adminUserTable').innerHTML = '<p style="color:var(--error)">Fehler beim Laden der Admin-Daten.</p>';
            }
        }

        async function toggleUserActive(userId, email) {
            if (!confirm(`Benutzer ${email} wirklich umschalten?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-active`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler beim Ändern', 'error'); return; }
                const data = await r.json();
                showToast(`${email}: ${data.is_active ? 'aktiviert' : 'deaktiviert'}`, data.is_active ? 'success' : 'info');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminVerifyUser(userId, email) {
            if (!confirm(`E-Mail von ${email} manuell bestätigen?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/verify`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler', 'error'); return; }
                showToast(`${email}: E-Mail bestätigt ✓`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminSetRole(userId, role) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/role`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                if (!r.ok) { showToast('Fehler beim Setzen der Rolle', 'error'); return; }
                const rc = ROLE_CONFIG[role] || ROLE_CONFIG.researcher;
                showToast(`Rolle → ${rc.label} gesetzt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleAdmin(userId, email, makeAdmin) {
            const action = makeAdmin ? `${email} zum Admin ernennen?` : `Admin-Rechte von ${email} entziehen?`;
            if (!confirm(action)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-admin`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_admin: makeAdmin })
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); return; }
                showToast(makeAdmin ? `${email} ist jetzt Admin 👑` : `Admin-Rechte entfernt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleCrm(userId, data) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/crm-access`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); loadAdminData(); return; }
                const label = data.crm_access !== undefined ? (data.crm_access ? 'CRM freigeschaltet ✓' : 'CRM deaktiviert')
                    : data.lead_management !== undefined ? (data.lead_management ? 'Lead-Mgmt aktiviert ✓' : 'Lead-Mgmt deaktiviert')
                    : data.crm_owner_code !== undefined ? `Owner: ${data.crm_owner_code || '–'}`
                    : data.crm_role !== undefined ? `CRM-Rolle: ${data.crm_role}`
                    : 'Aktualisiert ✓';
                showToast(label, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function fbShowScreenshot(id) {
            try {
                const r = await fetch(`${API}/feedback/${id}/screenshot`, { headers: H() });
                if (!r.ok) { showToast('Bild nicht gefunden', 'error'); return; }
                const data = await r.json();
                // Show in modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;cursor:pointer;padding:20px';
                modal.onclick = () => modal.remove();
                const img = document.createElement('img');
                img.src = data.screenshot;
                img.style.cssText = 'max-width:95%;max-height:95%;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.5)';
                modal.appendChild(img);
                document.body.appendChild(modal);
            } catch(e) { showToast('Fehler', 'error'); }
        }

        async function fbUpdateStatus(id, status) {
            try {
                await fetch(`${API}/feedback/${id}`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadAdminData();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // ── Password Change ──────────────────────────────
        function openPwModal() {
            document.getElementById('pwModal').classList.add('visible');
            document.getElementById('pwCurrent').value='';
            document.getElementById('pwNew').value='';
            document.getElementById('pwConfirm').value='';
            document.getElementById('pwMsg').className='modal-msg';
            document.getElementById('pwCurrent').focus();
        }
        function closePwModal() { document.getElementById('pwModal').classList.remove('visible'); }

        async function changePassword() {
            const cur = document.getElementById('pwCurrent').value;
            const nw = document.getElementById('pwNew').value;
            const conf = document.getElementById('pwConfirm').value;
            const msg = document.getElementById('pwMsg');
            const btn = document.getElementById('pwBtn');
            msg.className='modal-msg';
            if (!cur) { msg.className='modal-msg error'; msg.textContent='Bitte aktuelles Passwort eingeben.'; return; }
            if (nw.length < 6) { msg.className='modal-msg error'; msg.textContent='Neues Passwort muss mindestens 6 Zeichen haben.'; return; }
            if (nw !== conf) { msg.className='modal-msg error'; msg.textContent='Neue Passwörter stimmen nicht überein.'; return; }
            btn.disabled=true; btn.textContent='Wird geändert...';
            try {
                const r = await fetch(`${API}/change-password`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({current_password:cur, new_password:nw})});
                const d = await r.json();
                if (!r.ok) { msg.className='modal-msg error'; msg.textContent=d.detail||'Fehler'; btn.disabled=false; btn.textContent='Ändern'; return; }
                msg.className='modal-msg success'; msg.textContent='✓ Passwort erfolgreich geändert!';
                showToast('Passwort geändert','success');
                setTimeout(closePwModal, 1500);
            } catch(e) { msg.className='modal-msg error'; msg.textContent='Verbindungsfehler'; }
            btn.disabled=false; btn.textContent='Ändern';
        }
        document.addEventListener('keydown', e => { if(e.key==='Escape') closePwModal(); });

        // ── Profile ──────────────────────────────────────────────────────────
        let profileData = null;
        let profileExpertise = [];

        async function loadProfile() {
            try {
                const r = await fetch(`${API}/profile`, {headers:H()});
                if (!r.ok) return;
                profileData = await r.json();
                profileExpertise = profileData.expertise || [];
                // Fill form
                document.getElementById('profileName').value = profileData.name || '';
                document.getElementById('profilePosition').value = profileData.position || '';
                document.getElementById('profileCompany').value = profileData.company || '';
                document.getElementById('profilePhone').value = profileData.phone || '';
                document.getElementById('profileLinkedin').value = profileData.linkedin_url || '';
                document.getElementById('profileBio').value = profileData.bio || '';
                // Fill display card
                const name = profileData.name || profileData.email.split('@')[0];
                document.getElementById('profileDisplayName').textContent = name;
                document.getElementById('profileDisplayPosition').textContent = [profileData.position, profileData.company].filter(Boolean).join(' · ') || '–';
                document.getElementById('profileDisplayEmail').textContent = profileData.email;
                document.getElementById('profileDisplayCompany').textContent = profileData.company || '–';
                document.getElementById('profileDisplayPhone').textContent = profileData.phone || '–';
                if (profileData.created_at) {
                    document.getElementById('profileMemberSince').textContent = new Date(profileData.created_at).toLocaleDateString('de-CH', {month:'long', year:'numeric'});
                }
                // Avatar
                const avatar = document.getElementById('profileAvatar');
                if (profileData.profile_photo_url) {
                    avatar.innerHTML = `<img src="${profileData.profile_photo_url}" alt="Foto">`;
                } else {
                    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
                    document.getElementById('profileInitials').textContent = initials;
                }
                // LinkedIn button state
                if (profileData.linkedin_connected) {
                    document.getElementById('linkedinBtn').className = 'linkedin-btn connected';
                    document.getElementById('linkedinBtnText').textContent = 'LinkedIn verbunden ✓';
                }
                // Expertise tags
                renderExpertise();
                // Load Ψ-Profile
                loadPsiProfile();
            } catch(e) { console.error('Profile load error:', e); }
        }

        async function loadPsiProfile() {
            try {
                const r = await fetch(`${API}/insight/profile`, { headers: H() });
                if (!r.ok) return;
                const psi = await r.json();
                const el = document.getElementById('psiProfileContent');

                if (!psi.has_profile || psi.total_insights === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px 0;color:rgba(255,255,255,0.4)">
                            <div style="font-size:20px;margin-bottom:8px">○</div>
                            <div>Noch kein Ψ-Profil vorhanden.</div>
                            <div style="margin-top:4px;font-size:12px">Beantworte Login-Fragen um dein Profil aufzubauen.</div>
                        </div>`;
                    return;
                }

                // Engagement bar
                const engColor = psi.engagement_score > 60 ? '#22c55e' : psi.engagement_score > 30 ? '#f59e0b' : 'var(--accent)';

                // Domain labels
                const domainLabels = { FIN: '💰 Finanzen', HLT: '🏥 Gesundheit', ORG: '🏢 Organisation', REL: '🕊️ Religion', EDU: '🎓 Bildung', ENV: '🌱 Umwelt', POL: '🏛️ Politik', OTH: '📋 Andere' };

                // Speed icon
                const speedIcon = psi.decision_speed === 'fast' ? '⚡' : psi.decision_speed === 'deliberate' ? '🧘' : '⚖️';

                // Build answer list
                let answersHtml = '';
                if (psi.answers && psi.answers.length > 0) {
                    answersHtml = '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px">' +
                        '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Deine Antworten</div>' +
                        psi.answers.map(a => {
                            const domBadge = a.domain ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(139,170,255,0.1);color:var(--accent)">${a.domain}</span>` : '';
                            const styleBadge = a.style ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,0.05);color:var(--text-secondary)">${a.style.split('_')[0]}</span>` : '';
                            const latency = a.latency_ms ? `<span style="font-size:10px;color:var(--text-muted)">${(a.latency_ms/1000).toFixed(1)}s</span>` : '';
                            return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
                                <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:3px">${a.question}</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.85);font-weight:500">${a.choice_index ? '●' : '○'} ${a.answer}</div>
                                <div style="display:flex;gap:6px;margin-top:4px;align-items:center">${domBadge}${styleBadge}${latency}</div>
                            </div>`;
                        }).join('') + '</div>';
                }

                el.innerHTML = `
                    <div style="margin-bottom:14px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span style="font-size:12px;color:var(--text-muted)">Engagement</span>
                            <span style="font-size:12px;font-weight:700;color:${engColor}">${psi.engagement_score}/100</span>
                        </div>
                        <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden">
                            <div style="height:100%;width:${psi.engagement_score}%;background:${engColor};border-radius:3px;transition:width 0.5s"></div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${domainLabels[psi.primary_domain] || '📋'}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Primary Domain</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${speedIcon}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${psi.decision_speed}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                        ${Object.entries(psi.thinking_styles || {}).map(([s, c]) =>
                            '<span style="font-size:11px;padding:3px 8px;border-radius:8px;background:rgba(139,170,255,0.1);color:var(--accent)">' + s + ' (' + c + ')</span>'
                        ).join('')}
                    </div>
                    <div style="font-size:12px;color:var(--text-muted)">
                        ${psi.total_insights} Insights · ${psi.avg_decision_latency_ms ? (psi.avg_decision_latency_ms/1000).toFixed(1)+'s ø Entscheidungszeit' : ''}
                    </div>
                    ${answersHtml}
                `;
            } catch(e) { console.error('Ψ-Profile load error:', e); }
        }

        function renderExpertise() {
            document.getElementById('profileExpertiseTags').innerHTML = profileExpertise.map((t,i) =>
                `<span class="profile-tag">${t}<span class="remove" onclick="removeExpertise(${i})">×</span></span>`
            ).join('') || '<span style="font-size:12px;color:var(--text-muted)">Noch keine Expertise hinzugefügt</span>';
        }

        function addExpertise() {
            const input = document.getElementById('expertiseInput');
            const val = input.value.trim();
            if (!val || profileExpertise.includes(val)) { input.value=''; return; }
            if (profileExpertise.length >= 20) { showToast('Max. 20 Expertise-Tags','info'); return; }
            profileExpertise.push(val);
            input.value = '';
            renderExpertise();
            saveProfile(true);
        }

        function removeExpertise(idx) {
            profileExpertise.splice(idx, 1);
            renderExpertise();
            saveProfile(true);
        }

        async function saveProfile(silent) {
            const data = {
                name: document.getElementById('profileName').value.trim(),
                position: document.getElementById('profilePosition').value.trim(),
                company: document.getElementById('profileCompany').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                linkedin_url: document.getElementById('profileLinkedin').value.trim(),
                bio: document.getElementById('profileBio').value.trim(),
                expertise: profileExpertise
            };
            try {
                const r = await fetch(`${API}/profile`, {method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(data)});
                if (!r.ok) { showToast('Fehler beim Speichern','error'); return; }
                if (!silent) showToast('Profil gespeichert ✓','success');
                // Update nav user name
                if (data.name) document.getElementById('navUser').textContent = data.name;
                loadProfile();
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        async function uploadPhoto(input) {
            if (!input.files.length) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            try {
                const r = await fetch(`${API}/profile/photo`, {method:'POST', headers:H(), body:fd});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'Fehler','error'); return; }
                showToast('Foto aktualisiert ✓','success');
                loadProfile();
            } catch(e) { showToast('Upload fehlgeschlagen','error'); }
            input.value='';
        }

        async function connectLinkedIn() {
            if (profileData?.linkedin_connected) {
                if (!confirm('LinkedIn-Verbindung trennen?')) return;
                try {
                    await fetch(`${API}/profile/linkedin/disconnect`, {method:'POST', headers:H()});
                    showToast('LinkedIn getrennt','info');
                    loadProfile();
                } catch(e) { showToast('Fehler','error'); }
                return;
            }
            try {
                const r = await fetch(`${API}/auth/linkedin`, {headers:H()});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'LinkedIn nicht konfiguriert','error'); return; }
                const {auth_url} = await r.json();
                const popup = window.open(auth_url, 'linkedin', 'width=600,height=700,left=200,top=100');
                window.addEventListener('message', async function handler(e) {
                    if (e.data?.type === 'linkedin_success') {
                        window.removeEventListener('message', handler);
                        try {
                            await fetch(`${API}/profile/linkedin`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(e.data.data)});
                            showToast('LinkedIn verbunden ✓','success');
                            loadProfile();
                        } catch(err) { showToast('Fehler beim Speichern','error'); }
                    } else if (e.data?.type === 'linkedin_error') {
                        window.removeEventListener('message', handler);
                        showToast('LinkedIn-Verbindung fehlgeschlagen','error');
                    }
                });
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        // ── Chat ──────────────────────────────────────────────────────────────
        let chatLoaded = false;

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function formatMessage(text) {
            // Use full markdown renderer
            return mbRenderMd(text);
        }

        function appendMessage(role, content, sources) {
            const welcome = document.getElementById('chatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('chatMessages');
            const initials = role === 'user' ? (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : 'B';
            let html = `<div class="chat-msg ${role}">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${formatMessage(content)}`;
            if (sources && sources.length > 0) {
                html += `<div class="chat-sources">${sources.map(s => `<span class="chat-source-tag">${s.title}</span>`).join('')}</div>`;
            }
            html += `</div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping(message) {
            const container = document.getElementById('chatMessages');
            const existing = document.getElementById('typingIndicator');
            if (existing) existing.remove();
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant" id="typingIndicator">
                <div class="chat-msg-avatar">B</div>
                <div class="chat-msg-body">
                    <div style="display:flex;align-items:center;gap:10px;color:var(--text-muted);">
                        <div class="chat-typing"><span></span><span></span><span></span></div>
                        <span id="typingText">${message || 'BEATRIX denkt nach...'}</span>
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        function updateTypingText(text) {
            const el = document.getElementById('typingText');
            if (el) el.textContent = text;
        }

        function removeTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        async function pollForAnswer(issueNumber) {
            const maxAttempts = 60; // 5 min max
            const interval = 5000; // 5 seconds
            const phases = [
                'BEATRIX liest das Evidence-Based Framework...',
                'Analysiert relevante Modelle und Axiome...',
                'Prüft Ψ-Dimensionen und Kontextfaktoren...',
                'Formuliert die Antwort...'
            ];

            for (let i = 0; i < maxAttempts; i++) {
                // Update phase message
                const phase = phases[Math.min(Math.floor(i / 5), phases.length - 1)];
                updateTypingText(phase);

                await new Promise(r => setTimeout(r, interval));
                try {
                    const r = await fetch(`${API}/chat/poll/${issueNumber}`, {headers:H()});
                    if (r.status === 401) { doLogout(); return null; }
                    const data = await r.json();
                    if (data.status === 'done') return data;
                    if (data.status === 'error') return {status:'error', answer: data.message};
                } catch(e) { /* retry */ }
            }
            return {status: 'timeout', answer: 'Die Analyse dauert länger als erwartet. Die Antwort wird in Issue #' + issueNumber + ' auf GitHub erscheinen.'};
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('chatSendBtn');
            const question = input.value.trim();
            if (!question) return;

            // ── Auto-detect intent OR use command mode ──
            const intentKeywords = /\b(neues projekt|projekt eröffnen|projekt anlegen|eröffne.*projekt|erstell.*projekt|leg.*projekt an|mandat.*für|probono.*für|workshop.*für|beratung.*für|neuer lead|lead.*anlegen|lead.*erfassen|opportunity|akquise.*für|bcm.*modell|modell.*bauen|psi.*dimension|kontextvektor|behavioral.*model|intervention.*design|ausgangslage|kontext.*erfassen|situation.*bei|marktumfeld|herausforderung.*bei)\b/i;
            if (bxCmdMode || intentKeywords.test(question)) {
                if (!bxCmdMode) {
                    bxCmdMode = true;
                    const tbtn = document.getElementById('prjChatToggle');
                    tbtn.style.background = 'rgba(42,127,142,0.15)';
                    tbtn.style.borderColor = 'rgba(42,127,142,0.4)';
                    tbtn.style.color = 'var(--accent-light)';
                    document.getElementById('prjChatIndicator').style.display = '';
                    bxCmdDraft = {};
                    bxCmdHistory = [];
                    bxCmdIntent = '';
                }
                sendBxCmd(question);
                return;
            }

            input.value = ''; autoResize(input);
            btn.disabled = true;
            appendMessage('user', question);
            showTyping('BEATRIX sucht in der Wissensbasis...');
            try {
                const r = await fetch(`${API}/chat`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({question})});
                if (r.status === 401) { doLogout(); return; }
                const d = await r.json();
                if (!r.ok) { removeTyping(); appendMessage('assistant', d.detail || 'Entschuldigung, es gab einen Fehler.'); return; }

                if (d.status === 'done' && d.path === 'fast') {
                    // ⚡ FAST PATH: Instant answer from Knowledge Base
                    removeTyping();
                    appendMessage('assistant', d.answer, d.sources);
                } else if (d.status === 'processing' && d.issue_number) {
                    // 🔬 DEEP PATH: Claude Code analysis
                    showTyping('Neue Frage! BEATRIX erarbeitet die Antwort mit dem EBF Framework (~3-5 Min)...');
                    const result = await pollForAnswer(d.issue_number);
                    removeTyping();
                    if (result && result.answer) {
                        appendMessage('assistant', result.answer, [{title: '🔬 EBF Deep Analysis', type: 'github', url: d.issue_url}]);
                    } else {
                        appendMessage('assistant', 'BEATRIX konnte keine Antwort generieren. Versuche es erneut.');
                    }
                } else if (d.answer) {
                    removeTyping();
                    appendMessage('assistant', d.answer, d.sources);
                }
            } catch(e) {
                removeTyping();
                appendMessage('assistant', 'Verbindungsfehler. Bitte versuche es erneut.');
            }
            btn.disabled = false;
            input.focus();
        }

        function askSuggestion(el) {
            document.getElementById('chatInput').value = el.textContent;
            sendChat();
        }

        // ── BEATRIX COMMAND MODE (Universal Intent) ──
        let bxCmdMode = false;
        let bxCmdDraft = {};
        let bxCmdHistory = [];
        let bxCmdIntent = '';  // current active intent

        const BX_INTENTS = {
            project: {icon:'📋', label:'Projekt', color:'52,211,153'},
            lead:    {icon:'🎯', label:'Lead', color:'251,191,36'},
            model:   {icon:'🔬', label:'Modell', color:'139,170,255'},
            context: {icon:'🧠', label:'Kontext', color:'232,163,61'}
        };

        function toggleBxCmd() {
            bxCmdMode = !bxCmdMode;
            const btn = document.getElementById('prjChatToggle');
            const indicator = document.getElementById('prjChatIndicator');
            const input = document.getElementById('chatInput');
            if (bxCmdMode) {
                btn.style.background = 'rgba(42,127,142,0.15)';
                btn.style.borderColor = 'rgba(42,127,142,0.4)';
                btn.style.color = 'var(--accent-light)';
                btn.title = 'BEATRIX Command Mode aktiv (klicken zum Beenden)';
                indicator.style.display = '';
                input.placeholder = '💡 Beschreibe was du brauchst... Projekt, Lead, Modell, Kontext-Analyse...';
                bxCmdDraft = {};
                bxCmdHistory = [];
                bxCmdIntent = '';
            } else {
                btn.style.background = 'rgba(255,255,255,0.04)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'rgba(255,255,255,0.4)';
                btn.title = 'BEATRIX Command Mode';
                indicator.style.display = 'none';
                input.placeholder = 'Stelle eine Frage an BEATRIX...';
                bxCmdDraft = {};
                bxCmdHistory = [];
                bxCmdIntent = '';
            }
        }

        // ── Card Renderers per Intent ──

        function renderProjectCard(data, status, missing, confidence, message) {
            const p = data;
            const catIcons = {mandat:'💼', lead:'🎯', probono:'🤝'};
            const catLabels = {mandat:'Bezahltes Mandat', lead:'Lead-Projekt', probono:'Pro Bono'};
            const typeLabels = {beratung:'Beratung',workshop:'Workshop',studie:'Studie',intervention:'Intervention',keynote:'Keynote',training:'Training',retainer:'Retainer'};
            const cat = p.project_category || '';
            const rgb = '52,211,153';
            const isComplete = status === 'complete' && confidence >= 0.7;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Kunde', (p.customer_code||'').toUpperCase());
            f += field('Projekt', p.name);
            f += field('Kategorie', `${catIcons[cat]||''} ${catLabels[cat]||cat}`);
            f += field('Typ', typeLabels[p.type]||p.type);
            if (p.description) f += field('Beschreibung', p.description);
            f += field('Start', p.start_date);
            if (p.end_date) f += field('Ende', p.end_date);
            if (p.budget_chf) f += field('Budget', `${Number(p.budget_chf).toLocaleString('de-CH')} CHF`);
            f += field('Owner', p.fa_owner);
            if (p.fa_team?.length) f += field('Team', p.fa_team.join(', '));
            return bxCard('📋','Projekt', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmProject()" style="${bxBtnConfirm}">✓ Projekt eröffnen → GitHub</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderLeadCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '251,191,36';
            const stageLabels = {initial_contact:'Erstkontakt',qualification:'Qualifizierung',proposal:'Proposal',negotiation:'Verhandlung',won:'Gewonnen',lost:'Verloren'};
            const isComplete = status === 'complete' && confidence >= 0.7;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${v}</span></div>` : '';
            let f = '';
            f += field('Kunde', d.customer_name || (d.customer_code||'').toUpperCase());
            if (d.customer_code) f += field('Code', d.customer_code.toUpperCase());
            const neuBadge = d.is_new_customer === false ? '<span style="padding:2px 8px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;font-size:10px;color:#34d399;font-weight:600">B · Bestandskunde</span>' : '<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border:1px solid rgba(139,170,255,0.3);border-radius:8px;font-size:10px;color:rgba(139,170,255,0.8);font-weight:600">N · Neukunde</span>';
            f += `<div style="padding:3px 0">${neuBadge}</div>`;
            f += field('Opportunity', d.opportunity);
            f += field('Phase', stageLabels[d.stage]||d.stage);
            f += field('Kontakt', d.contact_person);
            if (d.contact_email) f += field('E-Mail', d.contact_email);
            if (d.estimated_value_chf) f += field('Wert', `${Number(d.estimated_value_chf).toLocaleString('de-CH')} CHF`);
            if (d.probability) f += field('Wahrsch.', `${d.probability}%`);
            f += field('Next Step', d.next_action);
            if (d.next_action_date) f += field('Datum', d.next_action_date);
            f += field('Owner', d.fa_owner);
            if (d.notes) f += field('Notizen', d.notes);
            return bxCard('🎯','Lead', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmLead()" style="${bxBtnConfirm}">✓ Lead erfassen → GitHub</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderModelCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '139,170,255';
            const isComplete = status === 'complete' && confidence >= 0.6;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${typeof v==='object'?JSON.stringify(v):v}</span></div>` : '';
            let f = '';
            f += field('Typ', d.model_type);
            f += field('Kunde', (d.customer_code||'').toUpperCase());
            f += field('Zielverhalten', d.target_behavior);
            f += field('Zielgruppe', d.target_group);
            if (d.current_state) f += field('Ist-Zustand', d.current_state);
            if (d.desired_state) f += field('Soll-Zustand', d.desired_state);
            if (d.psi_dimensions && typeof d.psi_dimensions === 'object') {
                const psiHtml = (Array.isArray(d.psi_dimensions) ? d.psi_dimensions : Object.entries(d.psi_dimensions)).map(p => {
                    if (typeof p === 'string') return `<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border-radius:6px;font-size:10px;color:rgba(139,170,255,0.7)">${p}</span>`;
                    const [k,v] = Array.isArray(p) ? p : [p.dimension||p.name, p.level||p.score||''];
                    return `<span style="padding:2px 8px;background:rgba(139,170,255,0.1);border-radius:6px;font-size:10px;color:rgba(139,170,255,0.7)">${k}: ${v}</span>`;
                }).join(' ');
                f += `<div style="padding:3px 0"><span style="color:rgba(255,255,255,0.3);font-size:11px">Ψ-Dimensionen</span><div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">${psiHtml}</div></div>`;
            }
            if (d.hypotheses) f += field('Hypothesen', Array.isArray(d.hypotheses) ? d.hypotheses.join('; ') : d.hypotheses);
            if (d.interventions) f += field('Interventionen', Array.isArray(d.interventions) ? d.interventions.join('; ') : d.interventions);
            return bxCard('🔬','Modell', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmModel()" style="${bxBtnConfirm}">✓ Modell speichern</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        function renderContextCard(data, status, missing, confidence, message) {
            const d = data;
            const rgb = '232,163,61';
            const isComplete = status === 'complete' && confidence >= 0.6;
            const field = (l,v) => v ? `<div style="display:flex;gap:8px;padding:3px 0"><span style="color:rgba(255,255,255,0.3);min-width:100px;font-size:11px">${l}</span><span style="color:white;font-size:12px">${typeof v==='object'?(Array.isArray(v)?v.join('; '):JSON.stringify(v)):v}</span></div>` : '';
            let f = '';
            f += field('Kunde', (d.customer_code||'').toUpperCase());
            f += field('Typ', d.context_type);
            f += field('Zusammenfassung', d.summary);
            if (d.challenges) f += field('Herausforderungen', d.challenges);
            if (d.opportunities) f += field('Chancen', d.opportunities);
            if (d.behavioral_patterns) f += field('Verhaltensmuster', d.behavioral_patterns);
            if (d.assessment) f += field('Einschätzung', d.assessment);
            return bxCard('🧠','Kontext', rgb, isComplete, f, missing, message, confidence, isComplete ? `<button onclick="bxConfirmContext()" style="${bxBtnConfirm}">✓ Kontext speichern</button><button onclick="bxRefine()" style="${bxBtnRefine}">✏ Anpassen</button>` : '');
        }

        // Shared card shell
        const bxBtnConfirm = "flex:1;padding:10px;background:linear-gradient(135deg,#34d399,#2A7F8E);border:none;border-radius:8px;color:white;font-size:13px;font-weight:700;cursor:pointer";
        const bxBtnRefine = "padding:10px 16px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);font-size:12px;cursor:pointer";

        function bxCard(icon, label, rgb, isComplete, fieldsHtml, missing, message, confidence, buttonsHtml) {
            const missingHtml = (missing?.length && !isComplete) ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:8px;font-size:11px;color:rgba(251,191,36,0.7)">⚠ Noch offen: ${missing.join(', ')}</div>` : '';
            const msgHtml = message ? `<div style="margin-top:10px;font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">${message}</div>` : '';
            return `<div style="background:rgba(${rgb},0.04);border:1px solid rgba(${rgb},0.15);border-radius:12px;padding:16px;margin:8px 0;max-width:520px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                    <span style="font-size:16px">${isComplete?'✅':icon}</span>
                    <span style="font-size:13px;font-weight:700;color:white">${isComplete?label+' bereit':label+'-Entwurf'}</span>
                    ${confidence?`<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(${rgb},0.1);color:rgba(${rgb},0.7)">${Math.round(confidence*100)}%</span>`:''}
                </div>
                ${fieldsHtml}${missingHtml}${msgHtml}
                ${buttonsHtml?`<div style="display:flex;gap:8px;margin-top:14px">${buttonsHtml}</div>`:''}
            </div>`;
        }

        // ── Universal Send ──
        async function sendBxCmd(message) {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('chatSendBtn');
            if (!message) message = input.value.trim();
            if (!message) return;
            input.value = ''; autoResize(input);
            btn.disabled = true;

            appendMessage('user', message);
            bxCmdHistory.push({role:'user', content:message});

            const intentLabels = {project:'Projekt analysieren',lead:'Lead analysieren',model:'Modell bauen',context:'Kontext erfassen'};
            showTyping(bxCmdIntent ? `BEATRIX: ${intentLabels[bxCmdIntent]||'analysiert'}...` : 'BEATRIX erkennt Intent...');

            try {
                const r = await fetch(`${API}/chat/intent`, {
                    method:'POST',
                    headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify({
                        message, history: bxCmdHistory, current_draft: bxCmdDraft,
                        intent: bxCmdIntent  // force intent if already in conversation
                    })
                });
                const d = await r.json();
                removeTyping();

                if (!r.ok || !d.ok) {
                    appendMessage('assistant', d.error || 'Fehler.');
                    btn.disabled = false; input.focus(); return;
                }

                // If redirect to KB (knowledge/general questions)
                if (d.status === 'redirect_kb') {
                    bxCmdMode = false;
                    toggleBxCmd(); // deactivate
                    document.getElementById('chatInput').value = message;
                    sendChat(); // redirect to normal chat
                    return;
                }

                // Set intent for follow-up messages
                const intent = d.intent || 'project';
                bxCmdIntent = intent;
                updateBxIndicator(intent);

                // Update draft
                if (d.data && Object.keys(d.data).length > 0) {
                    bxCmdDraft = {...bxCmdDraft, ...d.data};
                }

                // Render appropriate card
                const container = document.getElementById('chatMessages');
                let cardHtml = '';
                const hasData = d.data && Object.keys(d.data).length > 0;

                if (hasData) {
                    switch(intent) {
                        case 'project': cardHtml = renderProjectCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                        case 'lead': cardHtml = renderLeadCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                        case 'model': cardHtml = renderModelCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                        case 'context': cardHtml = renderContextCard(bxCmdDraft, d.status, d.missing, d.confidence, d.message); break;
                    }
                }
                const textHtml = (!cardHtml && d.message) ? formatMessage(d.message) : '';
                const bi = BX_INTENTS[intent] || {icon:'💡', color:'42,127,142'};

                container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                    <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(${bi.color},0.8),rgba(${bi.color},0.4));font-size:12px">${bi.icon}</div>
                    <div class="chat-msg-body">${cardHtml}${textHtml}</div>
                </div>`);
                container.scrollTop = container.scrollHeight;
                bxCmdHistory.push({role:'assistant', content: d.message || JSON.stringify(d.data)});

            } catch(e) {
                removeTyping();
                appendMessage('assistant', 'Verbindungsfehler: ' + e.message);
            }
            btn.disabled = false;
            input.focus();
        }

        function updateBxIndicator(intent) {
            const bi = BX_INTENTS[intent];
            if (!bi) return;
            const el = document.getElementById('prjChatIndicator');
            el.innerHTML = `${bi.icon} <strong>${bi.label}-Modus</strong> – Beschreibe Details, BEATRIX strukturiert automatisch.
                <span onclick="toggleBxCmd()" style="cursor:pointer;margin-left:8px;color:rgba(255,255,255,0.3)">✕</span>`;
            el.style.borderColor = `rgba(${bi.color},0.15)`;
            el.style.background = `rgba(${bi.color},0.06)`;
            el.style.color = `rgba(${bi.color},0.7)`;
        }

        function bxRefine() {
            document.getElementById('chatInput').focus();
            document.getElementById('chatInput').placeholder = '✏ Was möchtest du ändern?';
        }

        // ── Confirm Actions ──
        async function bxConfirmProject() {
            const d = bxCmdDraft;
            if (!d.customer_code || !d.name) { showToast('Kunde und Projektname fehlen', 'error'); return; }
            showTyping('Projekt wird auf GitHub eröffnet...');
            try {
                const r = await fetch(`${API}/projects`, {
                    method:'POST', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify({
                        customer_code: d.customer_code, name: d.name,
                        type: d.type||'beratung', project_category: d.project_category||'mandat',
                        description: d.description||'', start_date: d.start_date||new Date().toISOString().slice(0,10),
                        end_date: d.end_date||'', budget_chf: d.budget_chf||null,
                        billing_type: d.billing_type||'fixed', fa_owner: d.fa_owner||'GF',
                        fa_team: d.fa_team||[]
                    })
                });
                const res = await r.json();
                removeTyping();
                if (r.ok && res.ok) {
                    bxShowSuccess('Projekt eröffnet', res.project_code, d.name, d.project_category, `prjOpenLanding('${res.slug}');switchTab('projects')`);
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${res.project_code} eröffnet!`, 'success');
                } else { appendMessage('assistant', '❌ ' + (res.error||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmLead() {
            const d = bxCmdDraft;
            if (!d.customer_name && !d.customer_code) { showToast('Kundenname fehlt', 'error'); return; }
            showTyping('Lead wird erfasst...');
            try {
                const payload = {
                    company: d.customer_name || d.customer_code || '',
                    customer_code: d.customer_code || '',
                    is_new_customer: d.is_new_customer !== false,
                    contact: d.contact_person || '',
                    email: d.contact_email || '',
                    stage: d.stage || 'initial_contact',
                    value: d.estimated_value_chf || 0,
                    source: d.source || 'inbound',
                    notes: [d.opportunity, d.notes, d.next_action ? `Next: ${d.next_action}` : ''].filter(Boolean).join(' | ')
                };
                const r = await fetch(`${API}/leads`, {
                    method:'POST', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });
                const res = await r.json();
                removeTyping();
                if (r.ok) {
                    const leadCode = res.lead_code || '';
                    bxShowSuccess('Lead erfasst', leadCode, d.opportunity||d.customer_name, 'lead', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast(`✓ ${leadCode || 'Lead'} erfasst!`, 'success');
                } else { appendMessage('assistant', '❌ ' + (res.error||res.detail||'Fehler')); }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmModel() {
            // Save model to project or as standalone
            const d = bxCmdDraft;
            showTyping('Modell wird gespeichert...');
            try {
                if (d.project_slug) {
                    const r = await fetch(`${API}/projects/${d.project_slug}`, {
                        method:'PUT', headers:{...H(),'Content-Type':'application/json'},
                        body: JSON.stringify({section:'ebf_integration', data: d})
                    });
                    removeTyping();
                    if (r.ok) {
                        bxShowSuccess('Modell gespeichert', '', d.model_type||'BCM', 'model', d.project_slug ? `prjOpenLanding('${d.project_slug}');switchTab('projects')` : '');
                        bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                        showToast('✓ Modell gespeichert!', 'success');
                    } else { appendMessage('assistant', '❌ Fehler beim Speichern'); }
                } else {
                    removeTyping();
                    // Show as downloadable summary
                    const container = document.getElementById('chatMessages');
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(139,170,255,0.8),rgba(139,170,255,0.4));font-size:12px">🔬</div>
                        <div class="chat-msg-body"><div style="padding:12px;background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.15);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.5)">
                            ✅ Modell erstellt. Um es in ein Projekt zu integrieren, nenne das Projektkürzel oder erstelle zuerst ein Projekt.
                            <pre style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;overflow-x:auto;color:rgba(255,255,255,0.4)">${JSON.stringify(d, null, 2)}</pre>
                        </div></div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        async function bxConfirmContext() {
            const d = bxCmdDraft;
            if (!d.customer_code) { showToast('Kundencode fehlt', 'error'); return; }
            showTyping('Kontext wird gespeichert...');
            try {
                // Save to customer folder as context.yaml
                const r = await fetch(`${API}/customers/${d.customer_code}/context`, {
                    method:'PUT', headers:{...H(),'Content-Type':'application/json'},
                    body: JSON.stringify(d)
                });
                removeTyping();
                if (r.ok) {
                    bxShowSuccess('Kontext gespeichert', '', (d.customer_code||'').toUpperCase(), 'context', '');
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                    showToast('✓ Kontext gespeichert!', 'success');
                } else {
                    // Fallback: show summary
                    const container = document.getElementById('chatMessages');
                    container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                        <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(232,163,61,0.8),rgba(232,163,61,0.4));font-size:12px">🧠</div>
                        <div class="chat-msg-body"><div style="padding:12px;background:rgba(232,163,61,0.06);border:1px solid rgba(232,163,61,0.15);border-radius:12px;font-size:12px;color:rgba(255,255,255,0.5)">
                            ✅ Kontext erfasst. Speicher-Endpoint noch nicht eingerichtet – hier die strukturierten Daten:
                            <pre style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:10px;overflow-x:auto;color:rgba(255,255,255,0.4)">${JSON.stringify(d, null, 2)}</pre>
                        </div></div>
                    </div>`);
                    container.scrollTop = container.scrollHeight;
                    bxCmdDraft = {}; bxCmdHistory = []; bxCmdIntent = '';
                }
            } catch(e) { removeTyping(); appendMessage('assistant', '❌ ' + e.message); }
        }

        function bxShowSuccess(title, code, subtitle, cat, onclickAction) {
            const container = document.getElementById('chatMessages');
            const bi = BX_INTENTS[cat] || {icon:'✅', color:'52,211,153'};
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant">
                <div class="chat-msg-avatar" style="background:linear-gradient(135deg,rgba(${bi.color},0.8),rgba(${bi.color},0.4));font-size:12px">✓</div>
                <div class="chat-msg-body">
                    <div style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.2);border-radius:12px;padding:16px">
                        <div style="font-size:14px;font-weight:700;color:#34d399;margin-bottom:8px">✅ ${title}</div>
                        ${code ? `<div style="font-size:20px;font-weight:800;color:white;font-family:monospace;letter-spacing:1px;margin-bottom:4px">${code}</div>` : ''}
                        <div style="font-size:12px;color:rgba(255,255,255,0.4)">${subtitle}</div>
                        ${onclickAction ? `<div style="margin-top:12px"><button onclick="${onclickAction}" style="padding:8px 16px;background:rgba(42,127,142,0.15);border:1px solid rgba(42,127,142,0.3);border-radius:8px;color:var(--accent-light);font-size:12px;font-weight:600;cursor:pointer">→ Öffnen</button></div>` : ''}
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        async function loadChatHistory() {
            if (chatLoaded) return;
            try {
                const r = await fetch(`${API}/chat/history?limit=30`, {headers:H()});
                if (!r.ok) return;
                const msgs = await r.json();
                if (msgs.length > 0) {
                    const welcome = document.getElementById('chatWelcome');
                    if (welcome) welcome.style.display = 'none';
                    for (const m of msgs) {
                        appendMessage(m.role, m.content, m.sources);
                    }
                }
                chatLoaded = true;
            } catch(e) { console.error('Chat history error:', e); }
        }

        // ═══════ MODEL BUILDING WORKFLOW ═══════
        const mbState = { mode: null, step: 0, question: '', selections: {}, sessionId: null, selectedProblem: null };

        const MB_MODELS = [
            { id:'MOD-001', name:'Religious Tradition Distance Model', v:'2.0', domain:'REL', type:'distance_comparison' },
            { id:'MOD-REF-001', name:'Organic Referral Behavior Model', v:'1.0', domain:'ORG', type:'behavior' },
            { id:'MOD-PSF', name:'Papal Succession Framework', v:'2.0', domain:'REL', type:'process' },
            { id:'MOD-ESL', name:'Empirical Stability of Language Framework', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-NEAR-001', name:'Nearshoring Location Decision Model', v:'1.0', domain:'FIN', type:'decision' },
            { id:'MOD-IDV-001', name:'Interdependence Understanding Model', v:'2.0', domain:'ORG', type:'analysis' },
            { id:'MOD-PSM-001', name:'Philoro Strategy Model', v:'1.0', domain:'FIN', type:'strategy' },
            { id:'MOD-MSR-001', name:'Mission Statement Resonance Model', v:'1.0', domain:'ORG', type:'analysis' },
            { id:'MOD-ECHfP-001', name:'ECHfP Heating Replacement Behavioral Model', v:'1.0', domain:'ENV', type:'decision' },
            { id:'MOD-CPS-001', name:'Complex Problem Solving 10C Mapping', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-TA-001', name:'Time-Intensive Goods Substitution Model', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-HMWM-001', name:'Holistic Migration Welfare Model', v:'3.3', domain:'POL', type:'process' },
            { id:'MOD-012', name:'Fiscal Behavior Model (FBM-CH)', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-ZIN-001', name:'Kreislaufwirtschaft Behavior Dynamics ODE Model', v:'1.0', domain:'ENV', type:'process' },
            { id:'MOD-PMWT-001', name:'Pharma-MFN Welfare Transfer Model', v:'1.0', domain:'HLT', type:'analysis' },
            { id:'MOD-FIN-BUBBLE-001', name:'AI Bubble Diagnostic & Prognostic Model', v:'1.1', domain:'FIN', type:'analysis' },
            { id:'MOD-ORG-BMW-001', name:'BMW Product Compliance Behavioral Model', v:'1.0', domain:'ORG', type:'decision' },
            { id:'MOD-HLT-RES-001', name:'Health Reskilling Readiness Model', v:'1.0', domain:'HLT', type:'process' },
            { id:'MOD-EDU-LLL-001', name:'Lifelong Learning Adoption Model', v:'1.0', domain:'EDU', type:'continuous' },
            { id:'MOD-POL-TAX-001', name:'Tax Compliance Behavioral Model', v:'1.0', domain:'POL', type:'continuous' },
            { id:'MOD-ENV-MOB-001', name:'Sustainable Mobility Transition Model', v:'1.0', domain:'ENV', type:'process' }
        ];

        const DOMAIN_LABELS = { REL:'Religion', FIN:'Finance', HLT:'Health', ENV:'Environment', POL:'Policy', ORG:'Organization', EDU:'Education', OTH:'Other' };
        const DOMAIN_COLORS = { REL:'#a78bfa', FIN:'#34d399', HLT:'#f87171', ENV:'#60a5fa', POL:'#fbbf24', ORG:'#f472b6', EDU:'#38bdf8', OTH:'#94a3b8' };

        function mbSelectMode(el, mode) {
            // Double-tap = Workflow starten
            if (el.classList.contains('selected') && mbState.mode === mode) {
                mbStartWorkflow();
                return;
            }
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.mode = mode;
            document.getElementById('mbStartBtn').disabled = false;
        }

        // ── Smart Defaults Engine ──────────────────────
        let mbUserProfile = null;  // loaded on workflow start
        let mbDefaults = {};       // computed defaults per step

        async function mbLoadUserProfile() {
            try {
                const [profResp, psiResp] = await Promise.all([
                    fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }),
                    fetch('/api/insight/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }).catch(() => null)
                ]);
                const profile = await profResp.json();
                let psi = null;
                if (psiResp && psiResp.ok) psi = await psiResp.json();

                mbUserProfile = {
                    name: profile.name || '',
                    expertise: profile.expertise || [],
                    position: profile.position || '',
                    company: profile.company || '',
                    psiInsights: psi?.total_insights || 0,
                    psiDomain: psi?.primary_domain || null,
                    psiStyle: psi?.primary_thinking_style || null,
                    psiEngagement: psi?.engagement_score || 0,
                    psiSpeed: psi?.avg_decision_speed || null,
                };
                console.log('📊 User profile loaded:', mbUserProfile);
                mbComputeDefaults();
                return profile;
            } catch(e) {
                console.warn('Profile load failed, using BEATRIX defaults');
                mbUserProfile = null;
                mbComputeDefaults();
                return null;
            }
        }

        function mbComputeDefaults() {
            const u = mbUserProfile;
            const isNew = !u || (u.psiInsights === 0 && u.expertise.length === 0);
            const isExperienced = u && (u.psiInsights >= 3 || u.expertise.length >= 2);
            const domain = mbState.selections?.domain || u?.psiDomain || null;
            const style = u?.psiStyle || null;

            // Mode
            if (isNew) {
                mbDefaults.mode = 'gefuehrt';
            } else if (isExperienced) {
                mbDefaults.mode = 'schnell';
            } else {
                mbDefaults.mode = 'gefuehrt';
            }

            // Step 1: Entry Point
            if (style?.includes('analytical') || style?.includes('systemic')) {
                mbDefaults.step1 = 'theory';
            } else if (style?.includes('intuitive') || style?.includes('empathic')) {
                mbDefaults.step1 = 'practice';
            } else if (isExperienced) {
                mbDefaults.step1 = 'hybrid';
            } else {
                mbDefaults.step1 = 'practice';
            }

            // Step 2: Scope (Behavior Type)
            if (['FIN', 'POL'].includes(domain)) {
                mbDefaults.step2 = 'decision';
            } else if (['HLT', 'ENV', 'EDU'].includes(domain)) {
                mbDefaults.step2 = 'continuous';
            } else if (['ORG'].includes(domain)) {
                mbDefaults.step2 = 'process';
            } else {
                mbDefaults.step2 = 'decision';
            }

            // Step 3: Context Ψ
            if (isNew) {
                mbDefaults.step3 = 'ggg-default';
            } else if (isExperienced) {
                mbDefaults.step3 = 'full-8psi';
            } else {
                mbDefaults.step3 = 'ggg-default';
            }

            // Step 6: Report Depth
            if (isNew) {
                mbDefaults.depth = 'standard';
            } else {
                mbDefaults.depth = 'deep';
            }

            console.log('🎯 Defaults computed:', mbDefaults, '(isNew:', isNew, 'isExperienced:', isExperienced, ')');
        }

        function mbApplyDefault(step) {
            // Recompute with latest domain info from Step 0
            mbComputeDefaults();

            if (step === 'start') {
                // Auto-select mode
                const cards = document.querySelectorAll('.mb-mode-card');
                const modeMap = ['schnell', 'gefuehrt', 'template', 'custom'];
                cards.forEach((card, i) => {
                    card.querySelector('.mb-default-badge')?.remove();
                    if (modeMap[i] === mbDefaults.mode) {
                        card.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                        // Auto-select
                        if (!mbState.mode) {
                            mbSelectMode(card, mbDefaults.mode);
                        }
                    }
                });
            }

            if (step === 1) {
                mbApplyChoiceDefault('mbStep1', mbDefaults.step1);
            }
            if (step === 2) {
                mbApplyChoiceDefault('mbStep2', mbDefaults.step2);
            }
            if (step === 3) {
                mbApplyChoiceDefault('mbStep3', mbDefaults.step3);
            }
            if (step === 6) {
                // Depth default
                const def = mbDefaults.depth || 'standard';
                setTimeout(() => {
                    // Remove old badges first
                    document.querySelectorAll('#mbDepthChoice .mb-default-badge').forEach(b => b.remove());
                    const el = def === 'deep' ? document.getElementById('mbDepthDeep') : document.getElementById('mbDepthStd');
                    if (el) {
                        el.style.position = 'relative';
                        el.insertAdjacentHTML('afterbegin', '<div class="mb-default-badge" style="position:absolute;top:10px;right:12px">empfohlen</div>');
                        mbSelectDepth(def, el);
                    }
                }, 150);
            }
        }

        function mbApplyChoiceDefault(panelId, defaultValue) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            const choices = panel.querySelectorAll('.mb-choice');
            let applied = false;

            choices.forEach(choice => {
                // Remove old badges
                choice.querySelector('.mb-default-badge')?.remove();

                // Find value from onclick
                const onclick = choice.getAttribute('onclick') || '';
                const match = onclick.match(/mbSelect\(this,'([^']+)'\)/);
                if (match && match[1] === defaultValue) {
                    choice.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                    // Auto-select if nothing selected yet
                    const alreadySelected = panel.querySelector('.mb-choice.selected');
                    if (!alreadySelected) {
                        mbSelect(choice, defaultValue, true);  // silent, no confirmation
                        applied = true;
                    }
                }
            });
        }

        function mbStartWorkflow() {
            if (!mbState.mode) return;
            mbState.step = 0;
            mbState.selectedProblem = null;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
            mbLoadPersonalizedQuestions();
            mbApplyDefault(0);
        }

        async function mbLoadPersonalizedQuestions() {
            const container = document.getElementById('mbStep0Choices');
            try {
                // Use already-loaded profile or load fresh
                const profile = mbUserProfile || await mbLoadUserProfile();
                const expertise = (profile?.expertise || []).join(', ') || 'Behavioral Economics';
                const userName = profile?.name || 'User';
                const position = profile?.position || '';
                const company = profile?.company || '';

                // 2. Ask BEATRIX to generate 3 personalized questions
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere genau 3 Problemstellungen für den EEE Model-Building Workflow, personalisiert für dieses Profil:
- Name: ${userName}
- Position: ${position}
- Unternehmen: ${company}
- Expertise: ${expertise}

Jede Problemstellung soll ein reales Verhaltensphänomen beschreiben, das mit dem BCM modellierbar ist.

Antworte NUR als JSON Array:
[{"icon":"emoji","title":"Kurztitel max 4 Worte","phenomenon":"Beobachtbares Verhalten, 1 Satz mit Zahlen/Fakten","paradox":"Warum ist das überraschend/problematisch, 1 Satz","question":"Konkrete Forschungsfrage, 1 Satz","domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"}]` })
                });
                const data = await resp.json();

                let questions = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\[[\s\S]*\]/);
                        if (jsonMatch) questions = JSON.parse(jsonMatch[0]);
                    } catch(e) { console.error('Parse error:', e); }
                }

                // 3. Fallback if generation failed
                if (!questions || questions.length < 3) {
                    questions = [
                        { icon: '🏢', title: 'Strategie & Verhalten', phenomenon: `Über 70% der strategischen Initiativen in Beratungsunternehmen wie ${company || 'FehrAdvice'} stoßen auf interne Verhaltenswiderstände.`, paradox: 'Selbst Mitarbeiter, die den Wandel befürworten, fallen in alte Routinen zurück.', question: 'Welche BCM-Hebel können die Umsetzungsrate strategischer Entscheidungen nachhaltig steigern?', domain: 'ORG' },
                        { icon: '🧠', title: 'Decision Architecture', phenomenon: 'Change-Prozesse in Organisationen erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Kommunikation und Incentives führen paradoxerweise zu stärkerem Widerstand.', question: 'Wie kann Choice Architecture die Akzeptanz von Veränderungsprozessen in Organisationen erhöhen?', domain: 'ORG' },
                        { icon: '💰', title: 'Finanzentscheidungen', phenomenon: 'Privatinvestoren erzielen im Schnitt 2-4% weniger Rendite als passive Markt-Benchmarks.', paradox: 'Trotz verfügbarer ETF-Strategien handeln 80% aktiv und systematisch schlechter.', question: 'Wie kann Decision Architecture die rationalen Anlageentscheidungen von Privatinvestoren korrigieren?', domain: 'FIN' }
                    ];
                }

                // 4. Render personalized choices as clean tap cards
                // Store questions globally for structured selection
                window._mbQuestions = questions.slice(0, 3);
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon || '📋'}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon || q.question || ''}</div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Load questions error:', e);
                window._mbQuestions = [
                    { icon: '🧠', title: 'Behavioral Strategy', phenomenon: 'Über 60% der strategischen Initiativen in Organisationen scheitern an Verhaltensbarrieren.', paradox: 'Selbst wenn alle Stakeholder zustimmen, blockiert Status-Quo-Bias die Umsetzung.', question: 'Wie kann Behavioral Economics die Implementierungsrate strategischer Entscheidungen verbessern?', domain: 'ORG' },
                    { icon: '🏗️', title: 'Change & Architecture', phenomenon: 'Change-Prozesse erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Information und Kommunikation führt paradoxerweise zu mehr Widerstand.', question: 'Wie kann Decision Architecture die Akzeptanz von Veränderungsprozessen erhöhen?', domain: 'ORG' },
                    { icon: '💰', title: 'Investment Biases', phenomenon: 'Privatanleger erzielen im Schnitt 2-4% weniger Rendite als Markt-Benchmarks.', paradox: 'Trotz verfügbarer passiver Strategien handeln 80% aktiv und verlieren.', question: 'Welche BCM-Hebel können systematische Anlage-Verzerrungen korrigieren?', domain: 'FIN' }
                ];
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon}</div>
                    </div>
                `).join('');
            }
        }

        // ── Universal Streaming + Progressive Reveal ──────────
        function mbRenderMd(text) {
            // v3.12 Full markdown → HTML renderer
            if (!text || typeof text !== 'string') return '';
            try {
            const lines = text.split('\n');
            let html = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;

            function flushTable() {
                if (!tableRows.length) return '';
                let t = '<table style="width:100%;border-collapse:collapse;margin:16px 0;font-size:13px">';
                tableRows.forEach((row, ri) => {
                    // Skip separator rows (|---|---|)
                    if (/^\|[\s\-:]+\|/.test(row) && row.replace(/[\s\-:|]/g, '') === '') return;
                    const cells = row.split('|').filter((c, i, a) => i > 0 && i < a.length - 1);
                    const isHeader = ri === 0;
                    t += '<tr>';
                    cells.forEach(cell => {
                        const tag = isHeader ? 'th' : 'td';
                        const style = isHeader
                            ? 'padding:8px 10px;text-align:left;font-weight:600;color:var(--accent);border-bottom:2px solid rgba(139,170,255,0.2);font-size:12px;text-transform:uppercase;letter-spacing:0.3px'
                            : 'padding:8px 10px;text-align:left;color:rgba(255,255,255,0.8);border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:top;line-height:1.5';
                        const content = cell.trim().replace(/\*\*(.*?)\*\*/g, '<strong style="color:white">$1</strong>');
                        t += `<${tag} style="${style}">${content}</${tag}>`;
                    });
                    t += '</tr>';
                });
                t += '</table>';
                tableRows = [];
                inTable = false;
                return t;
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Table detection
                if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                    if (!inTable) inTable = true;
                    tableRows.push(line);
                    continue;
                } else if (inTable) {
                    html += flushTable();
                }

                // Horizontal rule
                if (/^---+$/.test(line.trim())) {
                    html += '<hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:20px 0">';
                    continue;
                }

                // Headers
                if (line.startsWith('#### ')) {
                    html += `<div style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.85);margin:16px 0 6px">${inlineMd(line.slice(5))}</div>`;
                    continue;
                }
                if (line.startsWith('### ')) {
                    html += `<h4 style="color:var(--accent);font-size:14px;font-weight:700;margin:20px 0 8px;letter-spacing:0.3px">${line.slice(4)}</h4>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    html += `<div style="font-size:16px;font-weight:700;color:white;margin:24px 0 10px;padding-bottom:6px;border-bottom:1px solid rgba(139,170,255,0.15)">${line.slice(3)}</div>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    html += `<div style="font-size:20px;font-weight:700;color:white;margin:8px 0 12px">${line.slice(2)}</div>`;
                    continue;
                }

                // List items
                if (/^[-*] /.test(line.trim())) {
                    const content = line.trim().replace(/^[-*] /, '');
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0">•</span><span>${inlineMd(content)}</span></div>`;
                    continue;
                }
                if (/^\d+\. /.test(line.trim())) {
                    const m = line.trim().match(/^(\d+)\. (.*)/);
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0;font-weight:600;min-width:18px">${m[1]}.</span><span>${inlineMd(m[2])}</span></div>`;
                    continue;
                }

                // Empty line = paragraph break
                if (line.trim() === '') {
                    html += '<div style="height:8px"></div>';
                    continue;
                }

                // Normal paragraph
                html += `<div style="padding:2px 0;line-height:1.7">${inlineMd(line)}</div>`;
            }

            // Flush remaining table
            if (inTable) html += flushTable();

            return html;
            } catch(e) {
                console.error('mbRenderMd error:', e);
                // Fallback: basic inline rendering
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
            }
        }

        function inlineMd(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:rgba(255,255,255,0.95)">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color:rgba(255,255,255,0.7)">$1</em>')
                .replace(/`(.*?)`/g, '<code style="background:rgba(139,170,255,0.1);padding:1px 5px;border-radius:4px;font-size:12px;color:var(--accent)">$1</code>');
        }

        async function mbStreamChat(prompt, targetEl, opts = {}) {
            /**
             * Streams Claude response into targetEl with typewriter effect.
             * opts: { onStart, onDone, onError, showCursor }
             */
            const { onStart, onDone, onError, showCursor = true } = opts;
            let fullText = '';
            let renderBuffer = '';
            let renderTimer = null;

            // Show cursor
            if (showCursor) {
                targetEl.innerHTML = '<span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>';
            }
            if (onStart) onStart();

            try {
                const resp = await fetch(`${API}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: prompt })
                });

                if (!resp.ok) {
                    throw new Error(`Stream error: ${resp.status}`);
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let sseBuffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });

                    // Parse SSE events
                    const events = sseBuffer.split('\n\n');
                    sseBuffer = events.pop(); // Keep incomplete event

                    for (const evt of events) {
                        for (const line of evt.split('\n')) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'token' && data.text) {
                                    fullText += data.text;
                                    // Throttle rendering to every 50ms for performance
                                    if (!renderTimer) {
                                        renderTimer = setTimeout(() => {
                                            targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' +
                                                mbRenderMd(fullText) +
                                                (showCursor ? '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>' : '') +
                                                '</div>';
                                            targetEl.scrollTop = targetEl.scrollHeight;
                                            renderTimer = null;
                                        }, 50);
                                    }
                                } else if (data.type === 'done') {
                                    // Final render without cursor
                                    if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                                    targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                                }
                            } catch(e) {}
                        }
                    }
                }

                // Ensure final render
                if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                if (onDone) onDone(fullText);
                return fullText;

            } catch(e) {
                console.error('Stream error:', e);
                // Fallback to non-streaming
                try {
                    const resp = await fetch(`${API}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                        body: JSON.stringify({ question: prompt })
                    });
                    const data = await resp.json();
                    if (data.answer) {
                        fullText = data.answer;
                        targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                        if (onDone) onDone(fullText);
                        return fullText;
                    }
                } catch(e2) {}
                if (onError) onError(e);
                targetEl.innerHTML = '<div style="color:#ef4444;padding:12px">⚠ Fehler bei der Verbindung. Bitte erneut versuchen.</div>';
                return '';
            }
        }

        function mbShowThinking(targetEl, stages) {
            /**
             * Shows animated "thinking" stages while waiting.
             * Returns { stop() } to call when done.
             */
            let currentStage = 0;
            const startTime = Date.now();

            function render() {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
                let html = '<div style="padding:8px 0">';
                for (let i = 0; i < stages.length; i++) {
                    const isDone = i < currentStage;
                    const isActive = i === currentStage;
                    const icon = isDone ? '<span style="color:#22c55e">✓</span>' :
                                 isActive ? '<span style="display:inline-block;width:12px;height:12px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle"></span>' :
                                 '<span style="color:rgba(255,255,255,0.2)">○</span>';
                    const opacity = isDone ? '0.5' : isActive ? '1' : '0.25';
                    html += `<div style="display:flex;align-items:center;gap:10px;padding:5px 0;opacity:${opacity};transition:all 0.3s">
                        <div style="width:20px;text-align:center">${icon}</div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.7)">${stages[i]}</div>
                    </div>`;
                }
                html += `<div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px;padding-left:30px">${elapsed}s</div>`;
                html += '</div>';
                targetEl.innerHTML = html;
            }

            render();
            const interval = setInterval(() => {
                if (currentStage < stages.length - 1) currentStage++;
                render();
            }, 2000);

            return {
                stop() { clearInterval(interval); },
                complete() {
                    clearInterval(interval);
                    currentStage = stages.length;
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    let html = '<div style="padding:8px 0">';
                    for (const s of stages) {
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:3px 0;opacity:0.5"><div style="width:20px;text-align:center"><span style="color:#22c55e">✓</span></div><div style="font-size:13px;color:rgba(255,255,255,0.5)">${s}</div></div>`;
                    }
                    html += `<div style="font-size:11px;color:#22c55e;margin-top:6px;padding-left:30px">✓ Abgeschlossen in ${elapsed}s</div></div>`;
                    targetEl.innerHTML = html;
                }
            };
        }

        function mbGoToStart() {
            mbState.step = 0;
            mbState.selections = {};
            mbState.question = '';
            document.getElementById('mbProgress').style.display = 'none';
            mbShowPanel('mbStart');
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('mbStartBtn').disabled = true;
        }

        function mbShowPanel(panelId) {
            document.querySelectorAll('#model-section .mb-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
        }

        function mbUpdateProgress(step) {
            document.querySelectorAll('.mb-step-dot').forEach(d => {
                const s = parseInt(d.dataset.step);
                d.classList.remove('active','completed');
                if (s < step) d.classList.add('completed');
                else if (s === step) d.classList.add('active');
            });
            document.querySelectorAll('.mb-step-line').forEach((l, i) => {
                l.classList.toggle('completed', i < step);
            });
        }

        function mbGoStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for steps with dual views
            mbResetStepViews(step);
            mbApplyDefault(step);
        }

        function mbResetStepViews(step) {
            const viewA = document.getElementById('mbStep' + step + 'ViewA');
            const viewB = document.getElementById('mbStep' + step + 'ViewB');
            if (viewA) viewA.style.display = 'block';
            if (viewB) viewB.style.display = 'none';
        }

        function mbNextStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for the new step
            mbResetStepViews(step);
            // Step 6: reset depth choice first, THEN apply defaults
            if (step === 6) {
                mbState.reportDepth = null;
                const btn = document.getElementById('mbComputeBtn');
                if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
                document.getElementById('mbDepthChoice').style.display = 'flex';
                document.getElementById('mbComputeProgress').style.display = 'none';
                document.getElementById('mbResultContent').style.display = 'none';
                document.getElementById('mbExportBtn').style.display = 'none';
                document.getElementById('mbNewModelBtn').style.display = 'none';
                document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                    d.classList.remove('depth-active');
                    d.style.borderColor = 'rgba(255,255,255,0.08)';
                    d.style.background = 'transparent';
                });
            }
            // Apply defaults AFTER any resets
            mbApplyDefault(step);
        }

        function mbSelectDepth(depth, el) {
            // Double-tap = Report generieren
            if (el.classList.contains('depth-active') && mbState.reportDepth === depth) {
                const btn = document.getElementById('mbComputeBtn');
                if (btn && !btn.disabled) btn.click();
                return;
            }
            mbState.reportDepth = depth;
            document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                d.classList.remove('depth-active');
                d.style.borderColor = 'rgba(255,255,255,0.08)';
                d.style.background = 'transparent';
            });
            el.classList.add('depth-active');
            el.style.borderColor = 'var(--accent)';
            el.style.background = 'rgba(139,170,255,0.08)';
            const btn = document.getElementById('mbComputeBtn');
            if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
        }

        // ── Choice Confirmation System ──────────────────
        let mbPendingConfirm = null; // { step, value, nextAction }

        const mbChoiceExplanations = {
            // Step 1: Entry Point
            'mbStep1': {
                'theory': {
                    icon: '📚', title: 'Theory-Driven',
                    body: 'Du startest mit einem bestehenden EBF-Konzept aus den CORE Appendices (AAA–AW). BEATRIX leitet daraus die praktische Anwendung ab.',
                    implication: 'BEATRIX wird zuerst relevante Theorien und Frameworks identifizieren, dann auf dein konkretes Problem anwenden. Ideal wenn du weisst, welches Konzept du nutzen möchtest.'
                },
                'practice': {
                    icon: '🎯', title: 'Practice-Driven',
                    body: 'Du startest mit deinem konkreten Problem oder Gestaltungsanlass. BEATRIX findet die passenden theoretischen Grundlagen automatisch.',
                    implication: 'BEATRIX analysiert dein Problem und mapped es auf die relevanten BCM-Dimensionen. Der schnellste Weg zu einem anwendbaren Modell.'
                },
                'hybrid': {
                    icon: '🔄', title: 'Hybrid (Iteration)',
                    body: 'Abwechselnde Theorie-Praxis-Zyklen. Du pendelt zwischen EBF-Konzepten und praktischer Anwendung.',
                    implication: 'BEATRIX wird iterativ vorgehen: Theorie → Praxis → Validierung → Anpassung. Braucht mehr Zeit, liefert aber das robusteste Modell.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Entry Point',
                    body: 'Du definierst den Startpunkt selbst. Maximale Flexibilität für erfahrene Modellierer.',
                    implication: 'BEATRIX gibt dir volle Kontrolle über den Entry Point. Du kannst Theorie und Praxis frei kombinieren.'
                }
            },
            // Step 2: Scope
            'mbStep2': {
                'decision': {
                    icon: '⚖️', title: 'Decision (Einmalentscheidung)',
                    body: 'Du modellierst eine diskrete Entscheidung: Ja/Nein, Option A vs. B. Typisch für Versicherungswahl, Impfentscheidung, Jobwechsel.',
                    implication: 'Mathematik: Logistic / Binary Choice Model. BEATRIX berechnet die Wahrscheinlichkeit P(B=1) dass das Zielverhalten eintritt. Ergebnis ist eine klare Ja/Nein-Prognose mit Konfidenz.'
                },
                'continuous': {
                    icon: '📈', title: 'Continuous (Wiederholtes Verhalten)',
                    body: 'Du modellierst ein Verhalten mit variabler Intensität: Sparbetrag, Energieverbrauch, Trainingsfrequenz.',
                    implication: 'Mathematik: CES Functional Form. BEATRIX berechnet den erwarteten Verhaltenslevel B* und die Elastizitäten der Einflussfaktoren.'
                },
                'process': {
                    icon: '🔄', title: 'Process (Veränderung über Zeit)',
                    body: 'Du modellierst eine Verhaltensveränderung über Zeit: Habit-Bildung, Adoption Journey, Lernprozesse.',
                    implication: 'Mathematik: Dynamic BCJ Models. BEATRIX modelliert die Trajektorie und identifiziert kritische Übergangspunkte zwischen Stages.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Scope',
                    body: 'Du kombinierst oder erweiterst die Standard-Typen frei.',
                    implication: 'Flexible Modell-Spezifikation – du definierst die funktionale Form und den Outcome-Typ selbst.'
                }
            },
            // Step 3: Context Ψ
            'mbStep3': {
                'ggg-default': {
                    icon: '📊', title: 'GGG Defaults',
                    body: 'Vorkonfigurierte Ψ-Werte aus Tabelle GGG-1 basierend auf Domain und Level. Schnell und empirisch validiert.',
                    implication: 'BEATRIX nutzt die Standard-Kalibrierung: trust, digital_adoption, autonomy, risk_aversion. Das spart ~15 Minuten und liefert robuste Baseline-Werte.'
                },
                'custom-psi': {
                    icon: '🎛️', title: 'Custom Ψ-Dimensionen',
                    body: 'Du definierst explizit welche Kontextfaktoren relevant sind – z.B. Saisonalität, Peer Effects, Availability.',
                    implication: 'BEATRIX verwendet deine spezifischen Ψ-Dimensionen statt der Defaults. Ideal wenn du den Kontext besser kennst als die Standard-Kalibrierung.'
                },
                'full-8psi': {
                    icon: '🔬', title: 'Alle 8 Ψ-Dimensionen',
                    body: 'Vollständige Analyse aller 8 Kontextdimensionen: Institutional, Social, Knowledge, Cultural, Temporal, Economic, Motivational, Framing.',
                    implication: 'Maximale Tiefe und Differenzierung. BEATRIX analysiert jeden Kontextfaktor einzeln und berechnet den gewichteten Gesamt-Ψ-Score. Dauert etwas länger, liefert aber die präziseste Kalibrierung.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Context',
                    body: 'Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.',
                    implication: 'Du wählst und gewichtest die Ψ-Dimensionen selbst. Für Experten mit spezifischen Kontext-Hypothesen.'
                }
            }
        };

        function mbSelect(el, value, silent) {
            const panel = el.closest('.mb-panel');
            const stepId = panel.id;

            // Double-tap same choice = weiter (fallback)
            if (el.classList.contains('selected') && mbState.selections[stepId] === value) {
                const btn = panel.querySelector('.mb-btn-primary');
                if (btn && !btn.disabled) btn.click();
                return;
            }

            panel.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.selections[stepId] = value;
            const btn = panel.querySelector('.mb-btn-primary');
            if (btn) btn.disabled = false;

            // Auto-advance: tap = select + go
            if (!silent) {
                setTimeout(() => {
                    if (btn && !btn.disabled) btn.click();
                }, 350);
            }
        }

        function mbShowConfirmation(stepLabel, icon, title, body, implication) {
            document.getElementById('mbConfirmStep').textContent = stepLabel;
            document.getElementById('mbConfirmIcon').textContent = icon;
            document.getElementById('mbConfirmTitle').textContent = title;
            document.getElementById('mbConfirmBody').textContent = body;
            document.getElementById('mbConfirmImplText').textContent = implication;

            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            overlay.style.display = 'block';
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            });
        }

        function mbHideConfirmation() {
            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            card.style.transform = 'translateY(100%)';
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 350);
        }

        function mbConfirmProceed() {
            if (!mbPendingConfirm) return;
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        function mbConfirmBack() {
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        // Steps 1-2: advance to next step
        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        function mbRenderProblemCard(data) {
            // data: { icon, title, phenomenon, paradox, question, domain, generated }
            const labels = { phenomenon: 'Phänomen', paradox: 'Paradox', question: 'Forschungsfrage' };
            const icons = { phenomenon: '🔍', paradox: '⚡', question: '🎯' };
            const colors = { phenomenon: 'rgba(255,255,255,0.7)', paradox: 'rgba(251,191,36,0.8)', question: 'rgba(139,170,255,0.9)' };

            let rows = '';
            for (const key of ['phenomenon', 'paradox', 'question']) {
                if (data[key]) {
                    rows += `
                    <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;${key !== 'question' ? 'border-bottom:1px solid rgba(255,255,255,0.04)' : ''}">
                        <div style="flex-shrink:0;width:20px;text-align:center;font-size:13px;padding-top:1px">${icons[key]}</div>
                        <div>
                            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.3);margin-bottom:3px">${labels[key]}</div>
                            <div style="font-size:13px;color:${colors[key]};line-height:1.55">${data[key]}</div>
                        </div>
                    </div>`;
                }
            }

            return `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <span style="font-size:20px">${data.icon || '📋'}</span>
                    <span style="font-weight:600;color:white;font-size:15px">${data.title || ''}</span>
                    <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.5">${data.domain || ''}</span>
                </div>
                ${rows}
                ${data.generated ? '<div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.25)">🤖 Von BEATRIX generiert</div>' : ''}
            `;
        }

        // Parse a flat question string into structured components
        function mbParseQuestion(text) {
            // Try to split by sentence-ending patterns (? or .)
            const sentences = text.match(/[^.?!]+[.?!]+/g) || [text];
            if (sentences.length >= 3) {
                return { phenomenon: sentences[0].trim(), paradox: sentences[1].trim(), question: sentences.slice(2).join(' ').trim() };
            } else if (sentences.length === 2) {
                return { phenomenon: sentences[0].trim(), question: sentences[1].trim() };
            }
            return { question: text };
        }

        function mbSelectProblemStructured(idx) {
            const q = (typeof idx === 'number') ? window._mbQuestions[idx] : idx;
            if (!q) return;
            const fullQ = [q.phenomenon, q.paradox, q.question].filter(Boolean).join(' ');
            mbState.selectedProblem = fullQ;

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(q);
            mbProcessStep0();
        }

        function mbSelectProblem(el, question) {
            mbState.selectedProblem = question;
            // Get structured data from the card if available
            const titleEl = el.querySelector('[style*="font-weight:600"]');
            const icon = el.querySelector('[style*="font-size:18px"]');
            const domainEl = el.querySelector('[style*="opacity:0.6"]');

            const parsed = mbParseQuestion(question);
            parsed.icon = icon ? icon.textContent : '📋';
            parsed.title = titleEl ? titleEl.textContent : '';
            parsed.domain = domainEl ? domainEl.textContent : '';

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            mbProcessStep0();
        }

        function mbStep0Back() {
            document.getElementById('mbStep0ViewB').style.display = 'none';
            document.getElementById('mbStep0ViewA').style.display = 'block';
            document.getElementById('mbStep0Result').style.display = 'none';
            mbState.selectedProblem = null;
        }

        function mbShowCustomInput() {
            mbState.selectedProblem = null;
            const ci = document.getElementById('mbCustomInput');
            ci.style.display = 'block';
            ci.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => document.getElementById('mbQuestion').focus(), 200);
        }

        async function mbLetBeatrixDefine() {
            // Switch to a generation view
            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = `
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                    <span style="color:rgba(255,255,255,0.5)">BEATRIX generiert eine Problemstellung...</span>
                </div>`;
            document.getElementById('mbStep0Result').style.display = 'none';
            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'Wird generiert...';

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere eine Problemstellung für den EEE Model-Building Workflow.
Antworte NUR als JSON:
{
  "icon": "passendes emoji",
  "title": "Kurztitel 3-4 Worte",
  "phenomenon": "Das beobachtbare Verhalten in 1 Satz (was passiert konkret, mit Zahlen/Fakten)",
  "paradox": "Die Spannung/das Paradox in 1 Satz (warum ist es überraschend oder problematisch)",
  "question": "Die konkrete Forschungsfrage in 1 Satz (was wollen wir herausfinden)",
  "domain": "REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"
}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }
                if (!parsed) parsed = { icon: '🔬', title: 'Behavioral Analysis', phenomenon: data.answer || '', paradox: '', question: '', domain: 'OTH' };

                // Compose full question for state
                const fullQ = [parsed.phenomenon, parsed.paradox, parsed.question].filter(Boolean).join(' ');
                mbState.selectedProblem = fullQ;

                // Show as structured card
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);

                // Auto-trigger analysis
                mbProcessStep0();

            } catch(e) {
                console.error('Generate error:', e);
                document.getElementById('mbStep0SelectedQ').innerHTML = '<div style="color:#ef4444">⚠ Fehler bei der Generierung. Bitte erneut versuchen.</div>';
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
            }
        }

        // ── Universal Inline Progress ──────────────────────────
        const MB_STEP_STAGES = {
            0: [
                { label: 'Frage parsen', pct: 15 },
                { label: 'Domain erkennen', pct: 35 },
                { label: 'Verhaltensziel identifizieren', pct: 55 },
                { label: 'Scope definieren', pct: 75 },
                { label: 'Session erstellen', pct: 92 },
            ],
            3: [
                { label: 'Kontext-Variablen laden', pct: 12 },
                { label: 'Ψ-Dimensionen berechnen', pct: 30 },
                { label: '10C CORE Mapping', pct: 50 },
                { label: 'Domain-Konfiguration', pct: 68 },
                { label: 'Sensitivität prüfen', pct: 82 },
                { label: 'Modell-Match suchen', pct: 95 },
            ],
        };

        function mbStartProgress(stepNum) {
            const el = document.getElementById('mbProgress' + stepNum);
            if (!el) return null;
            const stages = MB_STEP_STAGES[stepNum] || [];
            el.style.display = 'block';
            el.innerHTML = `
                <div class="mb-prog-header">
                    <div class="mb-prog-spinner"></div>
                    <div>
                        <div style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)" id="mbProgLabel${stepNum}">BEATRIX arbeitet...</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px" id="mbProgDetail${stepNum}"></div>
                    </div>
                </div>
                <div class="mb-prog-bar-bg"><div class="mb-prog-bar" id="mbProgBar${stepNum}"></div></div>
                <div class="mb-prog-meta">
                    <span id="mbProgPct${stepNum}">0%</span>
                    <span id="mbProgTime${stepNum}">Geschätzt: ~${Math.round(stages.length * 2)}s</span>
                </div>
                <div class="mb-prog-stages">
                    ${stages.map((s, i) => `
                        <div class="mb-prog-stage" id="mbProgS${stepNum}_${i}">
                            <div class="mb-prog-dot" id="mbProgD${stepNum}_${i}">○</div>
                            <span>${s.label}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const startTime = Date.now();
            let idx = 0;
            const interval = setInterval(() => {
                if (idx >= stages.length) { clearInterval(interval); return; }
                const s = stages[idx];

                // Update bar
                const bar = document.getElementById('mbProgBar' + stepNum);
                const pct = document.getElementById('mbProgPct' + stepNum);
                const label = document.getElementById('mbProgLabel' + stepNum);
                const time = document.getElementById('mbProgTime' + stepNum);
                if (bar) bar.style.width = s.pct + '%';
                if (pct) pct.textContent = s.pct + '%';
                if (label) label.textContent = s.label + '...';

                // Elapsed
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                const remaining = Math.max(1, Math.round((stages.length - idx) * 2));
                if (time) time.textContent = `${elapsed}s · ~${remaining}s verbleibend`;

                // Mark active
                const row = document.getElementById('mbProgS' + stepNum + '_' + idx);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + idx);
                if (row) row.className = 'mb-prog-stage active';
                if (dot) dot.innerHTML = '●';

                // Mark previous done
                if (idx > 0) {
                    const prevRow = document.getElementById('mbProgS' + stepNum + '_' + (idx - 1));
                    const prevDot = document.getElementById('mbProgD' + stepNum + '_' + (idx - 1));
                    if (prevRow) prevRow.className = 'mb-prog-stage done';
                    if (prevDot) prevDot.innerHTML = '✓';
                }

                idx++;
            }, 2000);

            return { interval, startTime, stepNum };
        }

        function mbStopProgress(handle) {
            if (!handle) return;
            clearInterval(handle.interval);
            const stepNum = handle.stepNum;
            const el = document.getElementById('mbProgress' + stepNum);
            const stages = MB_STEP_STAGES[stepNum] || [];
            const totalTime = ((Date.now() - handle.startTime) / 1000).toFixed(1);

            // Mark all done
            stages.forEach((s, i) => {
                const row = document.getElementById('mbProgS' + stepNum + '_' + i);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + i);
                if (row) row.className = 'mb-prog-stage done';
                if (dot) dot.innerHTML = '✓';
            });

            // Complete bar
            const bar = document.getElementById('mbProgBar' + stepNum);
            const pct = document.getElementById('mbProgPct' + stepNum);
            const label = document.getElementById('mbProgLabel' + stepNum);
            const time = document.getElementById('mbProgTime' + stepNum);
            if (bar) bar.style.width = '100%';
            if (pct) pct.textContent = '100%';
            if (label) label.textContent = '✓ Abgeschlossen';
            if (time) time.textContent = `Fertig in ${totalTime}s`;

            // Hide after delay
            setTimeout(() => { if (el) el.style.display = 'none'; }, 1200);
        }

        async function mbProcessStep0() {
            const q = document.getElementById('mbQuestion') ? document.getElementById('mbQuestion').value.trim() : '';
            const selectedQ = mbState.selectedProblem || q;
            if (!selectedQ) return;
            mbState.question = selectedQ;

            // Switch to View B if not already there (custom input case)
            if (document.getElementById('mbStep0ViewA').style.display !== 'none') {
                document.getElementById('mbStep0ViewA').style.display = 'none';
                document.getElementById('mbStep0ViewB').style.display = 'block';
                const parsed = mbParseQuestion(selectedQ);
                parsed.icon = '✏️';
                parsed.title = 'Eigene Problemstellung';
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            }

            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(0);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Analysiere diese Frage für den EEE Model-Building Workflow. Antworte NUR als JSON: {"domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH","domain_signals":["..."],"question_type":"analysis/decision/behavior_change/comparison","has_behavior_goal":true/false,"behavior_goal":"...oder null","scope_in":["..."],"scope_out":["..."],"suggested_mode":"schnell/gefuehrt/template/custom","session_id":"EBF-S-2026-02-08-XXX-001"}\n\nFrage: ${q}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\{[\s\S]*\}/);
                        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
                    } catch(e) {}
                }

                if (!parsed) {
                    parsed = {
                        domain: 'OTH', domain_signals: [q.split(' ').slice(0,3).join(' ')],
                        question_type: 'analysis', has_behavior_goal: false, behavior_goal: null,
                        scope_in: ['Modell-Analyse'], scope_out: ['Interventionen'],
                        suggested_mode: mbState.mode, session_id: `EBF-S-2026-02-08-OTH-001`
                    };
                }

                mbState.sessionId = parsed.session_id;
                mbState.selections.domain = parsed.domain;
                mbState.selections.questionType = parsed.question_type;

                const summaryEl = document.getElementById('mbSessionSummary');
                const domainColor = DOMAIN_COLORS[parsed.domain] || '#94a3b8';
                const domainLabel = DOMAIN_LABELS[parsed.domain] || parsed.domain;
                const typeLabels = { analysis: 'Analyse', decision: 'Entscheidung', behavior_change: 'Behavior Change', comparison: 'Vergleich', strategy: 'Strategie' };
                const typeLabel = typeLabels[parsed.question_type] || parsed.question_type;

                const signalTags = (parsed.domain_signals || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(139,170,255,0.08);border:1px solid rgba(139,170,255,0.12);color:rgba(255,255,255,0.7);margin:2px 4px 2px 0">${s}</span>`
                ).join('');

                const scopeInTags = (parsed.scope_in || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15);color:rgba(34,197,94,0.8);margin:2px 4px 2px 0">✓ ${s}</span>`
                ).join('');

                const scopeOutTags = (parsed.scope_out || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.35);margin:2px 4px 2px 0">✗ ${s}</span>`
                ).join('');

                summaryEl.innerHTML = `
                    <!-- Header: Domain + Type + ID -->
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px">
                        <span style="display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;background:${domainColor}18;border:1px solid ${domainColor}40;font-size:13px;font-weight:600;color:${domainColor}">
                            <span style="width:8px;height:8px;border-radius:50%;background:${domainColor}"></span>
                            ${domainLabel}
                        </span>
                        <span style="display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.6)">
                            ${typeLabel}
                        </span>
                        <span style="margin-left:auto;font-size:11px;font-family:monospace;color:rgba(255,255,255,0.25);letter-spacing:0.3px">${parsed.session_id}</span>
                    </div>

                    ${parsed.has_behavior_goal ? `
                    <!-- Behavior Goal: Prominent -->
                    <div style="padding:14px 16px;border-radius:10px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.7);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Verhaltensziel</div>
                        <div style="font-size:14px;color:rgba(255,255,255,0.9);line-height:1.5">${parsed.behavior_goal || 'Definiert'}</div>
                    </div>` : `
                    <div style="padding:12px 16px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);margin-bottom:16px;font-size:13px;color:rgba(255,255,255,0.4)">
                        ⚠ Kein explizites Verhaltensziel erkannt — BEATRIX leitet eines ab.
                    </div>`}

                    <!-- Signals -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Erkannte Signale</div>
                        <div style="display:flex;flex-wrap:wrap">${signalTags}</div>
                    </div>

                    <!-- Scope: In / Out -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">In Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeInTags}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Out of Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeOutTags}</div>
                        </div>
                    </div>
                `;
                document.getElementById('mbStep0Result').style.display = 'block';

                mbStopProgress(progHandle);
                btn.textContent = 'Weiter zu Schritt 1 →';
                btn.disabled = false;
                btn.onclick = () => mbNextStep(1);

            } catch(e) {
                mbStopProgress(progHandle);
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
                console.error('Step 0 error:', e);
            }
        }

        async function mbProcessStep3() {
            const psiChoice = mbState.selections.mbStep3 || 'ggg-default';
            const psiLabels = { 'ggg-default': '📊 GGG Defaults', 'custom-psi': '🎛️ Custom Ψ', 'full-8psi': '🔬 Alle 8 Ψ-Dimensionen', 'custom': '🔧 Custom' };

            // Switch to ViewB
            document.getElementById('mbStep3ViewA').style.display = 'none';
            document.getElementById('mbStep3ViewB').style.display = 'block';
            document.getElementById('mbStep3Selection').textContent = psiLabels[psiChoice] || psiChoice;

            const btn = document.getElementById('mbStep3NextBtn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(3);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Für den EEE Model-Building Workflow Step 3 (Kontext Ψ). Frage: "${mbState.question}". Domain: ${mbState.selections.domain}. Modus: ${psiChoice}. Entry: ${mbState.selections.mbStep1||'practice'}. Scope: ${mbState.selections.mbStep2||'decision'}. Erstelle eine Kontext-Analyse mit den Ψ-Dimensionen. Antworte NUR als JSON: {"psi_dimensions":[{"id":"Ψ_I","name":"Institutional","value":0.7,"rationale":"..."},...],"domain_config":"...","level":"Individual/Household/Organization","10c_mapping":{"WHO":"...","WHAT":"...","HOW":"...","WHEN":"...","WHERE":"...","AWARE":"...","READY":"...","STAGE":"...","HIERARCHY":"...","EIT":"..."}}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }

                if (parsed && parsed.psi_dimensions) {
                    mbState.selections.psi = parsed;
                    // Store for use in Step 4+5 prompts
                    mbState.selections.psiSummary = parsed.psi_dimensions.map(p => `${p.id}=${p.value}`).join(', ');
                }

                mbStopProgress(progHandle);
                mbNextStep(4);

            } catch(e) {
                mbStopProgress(progHandle);
                console.error('Step 3 error:', e);
                btn.textContent = 'Erneut versuchen →';
                btn.disabled = false;
                btn.onclick = () => mbProcessStep3();
            }
        }

        function mbStep3Back() {
            document.getElementById('mbStep3ViewB').style.display = 'none';
            document.getElementById('mbStep3ViewA').style.display = 'block';
            document.getElementById('mbStep3Result').innerHTML = '';
        }

        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        async function mbRunStep4() {
            const btn = document.getElementById('mbStep4Btn');
            const resultEl = document.getElementById('mbModelResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX erstellt Modell...';

            const prompt = `Erstelle die 10C Modell-Spezifikation für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Entry: ${mbState.selections.mbStep1 || 'practice'}. Scope: ${mbState.selections.mbStep2 || 'decision'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.

Strukturiere mit Markdown:
### Modell-Typ & ID
Identifiziere den passenden Modell-Typ (Decision/Continuous/Process) und vergib eine BCM-Modell-ID.

### 10C Complementarity Mapping
Tabelle mit | Dimension | Spezifikation | Relevanz (Hoch/Mittel/Niedrig) |
für alle 10 Dimensionen: WHO, WHAT, HOW, WHEN, WHERE, AWARE, READY, STAGE, HIERARCHY, EIT.

### Funktionale Form
Welche mathematische Spezifikation: Logistic, CES, Dynamic BCJ?

Schreibe kompakt und präzise.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep4Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep4Meta">Modell wird erstellt...</div>
            </div><div id="mbStep4Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep4Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep4Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep4Meta');
                    if (meta) meta.textContent = `✓ Modell erstellt in ${t}s`;
                    mbState.selections.step4Result = text;
                    btn.textContent = 'Weiter zu Parameter →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(5);
                }
            });
        }

        async function mbRunStep5() {
            const btn = document.getElementById('mbStep5Btn');
            const resultEl = document.getElementById('mbParamResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX schätzt Parameter...';

            const prompt = `Schätze die BCM-Parameter für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.
Modell-Kontext aus Step 4: ${(mbState.selections.step4Result || '').slice(0, 500)}

Strukturiere mit Markdown:
### Willingness (W)
- **Aktueller Wert:** [0.0–1.0]
- **Gate Condition:** W ≥ θ_W? Ja/Nein
- Begründung (2–3 Sätze) basierend auf motivationalen Faktoren

### Ability (A_mod)
- **Aktueller Wert:** [0.0–1.0]
- Subkomponenten: Skills, Knowledge, Resources
- Begründung

### Capacity (C)
- **Aktueller Wert:** [0.0–1.0]
- Externe Constraints, Facilitating Conditions
- Begründung

### BCM Gesamtschätzung
Tabelle: | Parameter | Wert | Gate | Interpretation |
| W | ... | ... | ... |
| A_mod | ... | ... | ... |
| C | ... | ... | ... |
| **P(B)** | ... | — | Verhaltenswahrscheinlichkeit |

Berechne P(B) nach BCM-Formel. Schreibe wissenschaftlich fundiert.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep5Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep5Meta">Parameter werden geschätzt...</div>
            </div><div id="mbStep5Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep5Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep5Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep5Meta');
                    if (meta) meta.textContent = `✓ Parameter geschätzt in ${t}s`;
                    mbState.selections.step5Result = text;
                    btn.textContent = 'Weiter zum Ergebnis →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(6);
                }
            });
        }

        function mbShowRegistry() {
            mbShowPanel('mbRegistry');
            document.getElementById('mbProgress').style.display = 'none';

            const list = document.getElementById('mbRegistryList');
            list.innerHTML = MB_MODELS.map(m => {
                const color = DOMAIN_COLORS[m.domain] || '#94a3b8';
                return `<div class="mb-model-card" onclick="mbUseTemplate('${m.id}')">
                    <span class="mb-model-id" style="background:${color}22;color:${color}">${m.id}</span>
                    <div class="mb-model-info">
                        <div class="mb-model-name">${m.name}</div>
                        <div class="mb-model-meta">${DOMAIN_LABELS[m.domain]||m.domain} · ${m.type}</div>
                    </div>
                    <span class="mb-model-version">v${m.v}</span>
                </div>`;
            }).join('');
        }

        function mbUseTemplate(modelId) {
            const model = MB_MODELS.find(m => m.id === modelId);
            if (!model) return;
            mbState.mode = 'template';
            mbState.selections.templateModel = model;
            document.getElementById('mbQuestion').value = `Basierend auf ${model.name} (${model.id})`;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
        }

        const MB_COMPUTE_STAGES = [
            { label: 'Modell initialisieren', detail: 'Session-Daten laden und validieren', pct: 5 },
            { label: 'Frage analysieren', detail: 'Problemstellung und Kontext parsen', pct: 12 },
            { label: '10C Mapping', detail: 'Complementarity-Dimensionen zuordnen', pct: 22 },
            { label: 'Ψ-Kontext laden', detail: 'Psychologische Kontextvariablen integrieren', pct: 35 },
            { label: 'Modellparameter setzen', detail: 'Willingness · Ability · Capacity kalibrieren', pct: 48 },
            { label: 'BCM Berechnung', detail: 'Behavioral Compliance Model anwenden', pct: 62 },
            { label: 'Sensitivitätsanalyse', detail: 'Parameter-Robustheit über ±20% Range testen', pct: 78 },
            { label: 'Report generieren', detail: 'Ergebnis, Empfehlungen und Visualisierungen erstellen', pct: 90 },
            { label: 'Finalisieren', detail: 'Qualitätsprüfung und Formatierung', pct: 97 },
        ];

        async function mbComputeResult() {
            const depth = mbState.reportDepth || 'standard';
            const isDeep = depth === 'deep';

            // Hide choice, show progress
            document.getElementById('mbDepthChoice').style.display = 'none';
            document.getElementById('mbComputeBtn').style.display = 'none';

            const progressEl = document.getElementById('mbComputeProgress');
            const resultEl = document.getElementById('mbResultContent');
            const stageEl = document.getElementById('mbComputeStage');
            const detailEl = document.getElementById('mbComputeDetail');
            const timeEl = document.getElementById('mbComputeTime');

            progressEl.style.display = 'block';
            resultEl.style.display = 'none';
            stageEl.textContent = isDeep ? 'Tiefenanalyse wird vorbereitet...' : 'Report wird vorbereitet...';
            detailEl.textContent = isDeep ? 'Standard++ · 4–6 Seiten' : 'Standard · 1–2 Seiten';
            timeEl.textContent = '';

            const startTime = Date.now();
            const s4 = mbState.selections.step4Result ? `\n\nModell-Spezifikation aus Step 4:\n${mbState.selections.step4Result.slice(0, 800)}` : '';
            const s5 = mbState.selections.step5Result ? `\n\nParameter-Schätzung aus Step 5:\n${mbState.selections.step5Result.slice(0, 800)}` : '';

            const promptStandard = `Erstelle einen kompakten BCM Modell-Report für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain
Kurze Einordnung (3–4 Sätze).
### 2. 10C Mapping
Nenne die 3–4 relevantesten Complementarity-Dimensionen als Aufzählung mit je 1 Satz.
### 3. BCM Parameter
Tabelle mit | Parameter | Wert | Interpretation |
für Willingness (W), Ability (A), Capacity (C). Nutze die Werte aus Step 5 falls vorhanden.
### 4. Ergebnis
Klare Verhaltensvorhersage in 2–3 Sätzen.
### 5. Handlungsempfehlungen
3–5 konkrete Massnahmen als nummerierte Liste.

Schreibe präzise und professionell. Maximal 500 Wörter.`;

            const promptDeep = `Erstelle einen umfassenden BCM Modell-Report (Standard++) für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain-Analyse
Detaillierte Einordnung der Fragestellung, Zielgruppe, Verhaltensänderungsziel.
### 2. 10C Complementarity Mapping
Vollständige Tabelle | Dimension | Spezifikation | BCM Relevanz | für alle 10 Dimensionen. Nutze die Spezifikation aus Step 4 falls vorhanden.
### 3. Ψ-Kontextdimensionen
Tabelle | Ψ-Dimension | Wert (0–1) | Impact | Rationale | für die 8 Ψ-Dimensionen.
### 4. BCM Parameter (Willingness · Ability · Capacity)
Detaillierte Tabelle mit Subkomponenten, Werten und Interpretation. Nutze die Schätzungen aus Step 5 falls vorhanden.
#### Key Insight
Zusammenfassende Erkenntnis.
### 5. Ergebnis & Verhaltensvorhersage
Klare Vorhersage mit Konfidenzintervall und Begründung. Berechne P(B) nach BCM-Formel.
### 6. Sensitivitätsanalyse
Welche Parameter haben den grössten Einfluss? ±20% Variation analysieren.
### 7. Handlungsempfehlungen
#### Strategische Intervention Roadmap
Phasenplan mit 3–4 Phasen, jeweils mit Zeitrahmen, Ziel, Taktiken und Interventionen.

Schreibe detailliert, wissenschaftlich fundiert und praxisorientiert. Nutze Tabellen wo sinnvoll.`;

            const prompt = isDeep ? promptDeep : promptStandard;

            try {
                await new Promise(r => setTimeout(r, 500));
                progressEl.style.display = 'none';
                resultEl.style.display = 'block';
                const depthLabel = isDeep ? '🔬 Standard++' : '📋 Standard';
                resultEl.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
                        <div style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbReportSpinner"></div>
                        <div>
                            <div style="font-size:14px;font-weight:600;color:white">📊 Modell-Report <span style="font-size:12px;color:var(--accent);font-weight:400">${depthLabel}</span></div>
                            <div style="font-size:11px;color:var(--text-secondary)" id="mbReportMeta">Session ${mbState.sessionId || 'N/A'} · Streaming...</div>
                        </div>
                    </div>
                    <div id="mbStreamTarget" style="max-height:65vh;overflow-y:auto;padding-right:8px"></div>
                `;

                const targetEl = document.getElementById('mbStreamTarget');
                await mbStreamChat(prompt, targetEl, {
                    onDone: (text) => {
                        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        const spinner = document.getElementById('mbReportSpinner');
                        if (spinner) { spinner.style.animation = 'none'; spinner.style.borderColor = '#22c55e'; spinner.style.borderTopColor = '#22c55e'; }
                        const meta = document.getElementById('mbReportMeta');
                        if (meta) meta.textContent = `Session ${mbState.sessionId || 'N/A'} · Generiert in ${totalTime}s`;
                        document.getElementById('mbExportBtn').style.display = '';
                        document.getElementById('mbNewModelBtn').style.display = '';
                    }
                });

            } catch(e) {
                console.error('Compute error:', e);
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="color:#ef4444;padding:20px;text-align:center">⚠ Fehler. Bitte erneut versuchen.</div>';
                document.getElementById('mbExportBtn').style.display = '';
                document.getElementById('mbNewModelBtn').style.display = '';
            }
        }

        async function mbExportModel() {
            // Re-run computation or copy to clipboard
            const content = document.getElementById('mbResultContent').innerText;
            if (content) {
                try {
                    await navigator.clipboard.writeText(content);
                    showToast('Modell-Report in Zwischenablage kopiert ✓', 'success');
                } catch(e) {
                    // Fallback: download as text
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `BEATRIX-Report-${mbState.sessionId || 'export'}.txt`;
                    a.click(); URL.revokeObjectURL(url);
                    showToast('Report heruntergeladen ✓', 'success');
                }
            }
        }

        checkAuth();
    </script>

    <!-- ═══ Feedback Widget v3.17 – Single Screen ═══ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #fbBtn { position:fixed; bottom:24px; right:24px; z-index:9999; width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,#8b9aff,#6366f1); border:none; cursor:pointer; box-shadow:0 4px 20px rgba(99,102,241,0.4); display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
        #fbBtn:hover { transform:scale(1.1); box-shadow:0 6px 28px rgba(99,102,241,0.6); }
        #fbBtn svg { width:22px; height:22px; fill:white; }
        #fbOverlay { display:none; position:fixed; inset:0; z-index:10000; background:rgba(6,8,20,0.97); flex-direction:column; }
        #fbOverlay.active { display:flex; }
        #fbToolbar { display:flex; align-items:center; gap:6px; padding:8px 12px; background:rgba(20,20,40,0.95); border-bottom:1px solid rgba(255,255,255,0.08); flex-shrink:0; flex-wrap:wrap; }
        .fb-tool { padding:5px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.6); font-size:12px; cursor:pointer; transition:all 0.15s; }
        .fb-tool:hover, .fb-tool.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        /* CRM Kanban */
        .crm-col { min-width:180px; flex:1; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; }
        .crm-card { padding:10px; background:var(--navy-card); border:1px solid rgba(255,255,255,0.06); border-radius:8px; cursor:pointer; transition:all 0.15s; }
        .crm-card:hover { border-color:rgba(139,170,255,0.3); background:rgba(139,170,255,0.04); transform:translateY(-1px); }
        .crm-card[draggable=true] { cursor:grab; }
        .crm-card[draggable=true]:active { cursor:grabbing; opacity:0.7; }
        .fb-color { width:22px; height:22px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:transform 0.15s; }
        .fb-color:hover, .fb-color.active { transform:scale(1.2); border-color:white; }
        #fbCanvas { flex:1; cursor:crosshair; }
        #fbBottom { display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(20,20,40,0.95); border-top:1px solid rgba(255,255,255,0.08); flex-shrink:0; }
        #fbComment { flex:1; padding:8px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; font-size:13px; outline:none; font-family:inherit; }
        #fbComment::placeholder { color:rgba(255,255,255,0.25); }
        #fbComment:focus { border-color:rgba(139,170,255,0.4); }
        .fb-type { padding:4px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.5); font-size:12px; cursor:pointer; }
        .fb-type.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        #fbSend { padding:8px 18px; border-radius:10px; border:none; background:linear-gradient(135deg,#8b9aff,#6366f1); color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; }
        #fbSend:hover { filter:brightness(1.1); }
        #fbSend:disabled { opacity:0.5; cursor:not-allowed; }
        /* AI circles on screenshot */
        .fb-ai-circle { position:absolute; z-index:3; pointer-events:auto; cursor:pointer; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color:white; box-shadow:0 2px 10px rgba(0,0,0,0.5); animation:fbPop 0.4s ease-out; border:2px solid rgba(255,255,255,0.4); }
        .fb-ai-circle:hover { transform:scale(1.15); }
        .fb-ai-area { position:absolute; z-index:2; border:2px dashed; border-radius:6px; pointer-events:none; animation:fbPop 0.5s ease-out; }
        @keyframes fbPop { from { transform:scale(0.5); opacity:0; } to { transform:scale(1); opacity:1; } }
        /* Suggestion list items */
        .fb-sug-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; margin-bottom:4px; }
        .fb-sug-item:hover { background:rgba(139,170,255,0.06); border-color:rgba(139,170,255,0.2); }
        .fb-sug-num { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:white; flex-shrink:0; }
        .fb-sug-text { flex:1; min-width:0; }
        .fb-sug-title { font-size:12px; font-weight:600; color:rgba(255,255,255,0.85); }
        .fb-sug-desc { font-size:11px; color:rgba(255,255,255,0.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #fbAiLoading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:4; display:flex; align-items:center; gap:10px; padding:12px 22px; background:rgba(20,20,40,0.9); border-radius:12px; border:1px solid rgba(255,255,255,0.08); }
    </style>

    <button id="fbBtn" onclick="fbCapture()" title="Feedback geben" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM11 5h2v4h-2zm0 6h2v2h-2z"/></svg>
    </button>

    <div id="fbOverlay">
        <div id="fbToolbar">
            <span id="fbHeaderMsg" style="font-size:12px;color:rgba(255,255,255,0.5);margin-right:4px">🙏 Danke! Markiere oder tippe auf einen Vorschlag.</span>
            <div style="flex:1"></div>
            <button class="fb-tool active" onclick="fbSetTool('draw')" id="fbToolDraw">✏️</button>
            <button class="fb-tool" onclick="fbSetTool('arrow')" id="fbToolArrow">➡️</button>
            <button class="fb-tool" onclick="fbSetTool('rect')" id="fbToolRect">▢</button>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <div class="fb-color active" style="background:#f87171" onclick="fbSetColor('#f87171')" data-color="#f87171"></div>
            <div class="fb-color" style="background:#fbbf24" onclick="fbSetColor('#fbbf24')" data-color="#fbbf24"></div>
            <div class="fb-color" style="background:#34d399" onclick="fbSetColor('#34d399')" data-color="#34d399"></div>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <button class="fb-tool" onclick="fbUndo()">↩</button>
            <button class="fb-tool" onclick="fbClose()" style="color:rgba(248,113,113,0.8)">✕</button>
        </div>
        <div style="flex:1;position:relative;overflow:hidden" id="fbCanvasWrap">
            <canvas id="fbCanvas"></canvas>
            <div id="fbAnnotations" style="position:absolute;inset:0;pointer-events:none"></div>
            <div id="fbAiLoading" style="display:none">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid #8b9aff;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                <span style="font-size:12px;color:rgba(255,255,255,0.5)">BEATRIX analysiert...</span>
            </div>
        </div>
        <!-- AI Suggestion List (appears after analysis) -->
        <div id="fbSugList" style="display:none;padding:8px 12px;background:rgba(20,20,40,0.95);border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0">
            <div style="display:flex;align-items:center;margin-bottom:6px">
                <span style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;flex:1">BEATRIX Vorschläge</span>
                <button onclick="fbDismissAll()" style="border:none;background:none;color:rgba(255,255,255,0.25);font-size:11px;cursor:pointer;padding:2px 6px">alle ausblenden</button>
            </div>
            <div id="fbSugItems"></div>
        </div>
        <div id="fbBottom">
            <button class="fb-type active" onclick="fbSetType('bug')" id="fbTypeBug">🐛</button>
            <button class="fb-type" onclick="fbSetType('wunsch')" id="fbTypeWunsch">💡</button>
            <button class="fb-type" onclick="fbSetType('frage')" id="fbTypeFrage">❓</button>
            <input id="fbComment" placeholder="Was fällt dir auf?" maxlength="500" onkeydown="if(event.key==='Enter')fbSend()">
            <button id="fbSend" onclick="fbSend()">Senden ➤</button>
        </div>
    </div>

    <script>
    // ═══ Feedback Widget v3.17 ═══
    const fbState = { tool:'draw', color:'#f87171', type:'bug', drawing:false, history:[], baseImage:null, startX:0, startY:0, suggestions:[] };

    async function fbCapture() {
        document.getElementById('fbBtn').style.display = 'none';
        try {
            const canvas = await html2canvas(document.body, { scale: window.devicePixelRatio > 1 ? 1.5 : 1, useCORS:true, logging:false, backgroundColor:'#0a0f1c' });
            fbState.baseImage = new Image();
            fbState.baseImage.onload = () => {
                const fbC = document.getElementById('fbCanvas');
                const wrap = document.getElementById('fbCanvasWrap');
                fbC.width = wrap.clientWidth;
                fbC.height = wrap.clientHeight;
                fbState.history = [];
                fbRedraw();
            };
            fbState.baseImage.src = canvas.toDataURL('image/jpeg', 0.85);

            document.getElementById('fbOverlay').classList.add('active');
            document.getElementById('fbComment').value = '';
            document.getElementById('fbAnnotations').innerHTML = '';
            document.getElementById('fbAiLoading').style.display = 'flex';
            document.getElementById('fbSugList').style.display = 'none';
            document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! BEATRIX analysiert...';

            fbAnalyzeScreen();
        } catch(e) {
            console.error('Screenshot failed:', e);
            showToast('Screenshot fehlgeschlagen', 'error');
        }
        document.getElementById('fbBtn').style.display = 'flex';
    }

    async function fbAnalyzeScreen() {
        const colors = ['#f87171', '#fbbf24', '#34d399'];
        try {
            const section = (document.querySelector('.nav-link.active')?.dataset?.section || document.querySelector('.nav-dropdown-item.active')?.dataset?.section || 'unknown');
            const r = await fetch(`${API}/feedback/analyze`, {
                method: 'POST',
                headers: { ...H(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ screenshot: fbState.baseImage.src, page: section, viewport: `${window.innerWidth}x${window.innerHeight}` })
            });
            if (!r.ok) throw new Error('Analyze failed');
            const data = await r.json();
            fbState.suggestions = data.suggestions || [];

            document.getElementById('fbAiLoading').style.display = 'none';

            if (fbState.suggestions.length > 0) {
                document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! Tippe auf einen Vorschlag oder zeichne eigenes Feedback.';
                const wrap = document.getElementById('fbCanvasWrap');
                const cW = wrap.clientWidth, cH = wrap.clientHeight;
                const annotEl = document.getElementById('fbAnnotations');
                annotEl.style.pointerEvents = 'auto';

                // Small numbered circles on screenshot + dashed areas
                annotEl.innerHTML = fbState.suggestions.map((s, i) => {
                    const color = colors[i % 3];
                    const x = (s.x || 50) / 100 * cW;
                    const y = (s.y || 30 + i * 25) / 100 * cH;
                    const aW = (s.w || 20) / 100 * cW;
                    const aH = (s.h || 8) / 100 * cH;
                    return `<div class="fb-ai-area" id="fbArea${i}" style="left:${x - aW/2}px;top:${y - aH/2}px;width:${aW}px;height:${aH}px;border-color:${color}50;background:${color}08;animation-delay:${i*0.15}s"></div>
                    <div class="fb-ai-circle" id="fbCircle${i}" style="left:${x - aW/2 - 10}px;top:${y - aH/2 - 10}px;background:${color};animation-delay:${i*0.15}s" onclick="fbUseSuggestion(${i})">${i+1}</div>`;
                }).join('');

                // Suggestion list panel
                const typeIcons = { bug:'🐛', wunsch:'💡', ux:'✨', performance:'⚡', frage:'❓' };
                document.getElementById('fbSugItems').innerHTML = fbState.suggestions.map((s, i) => {
                    const color = colors[i % 3];
                    return `<div class="fb-sug-item" onclick="fbUseSuggestion(${i})" id="fbSugItem${i}">
                        <div class="fb-sug-num" style="background:${color}">${i+1}</div>
                        <div class="fb-sug-text">
                            <div class="fb-sug-title">${typeIcons[s.type] || '💡'} ${s.title}</div>
                            <div class="fb-sug-desc">${s.description}</div>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('fbSugList').style.display = 'block';
            } else {
                document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! Zeichne und beschreibe dein Feedback.';
            }
        } catch(e) {
            console.error('AI analyze:', e);
            document.getElementById('fbAiLoading').style.display = 'none';
            document.getElementById('fbHeaderMsg').textContent = '🙏 Zeichne und beschreibe dein Feedback.';
        }
    }

    function fbUseSuggestion(i) {
        const s = fbState.suggestions[i];
        if (!s) return;
        const typeMap = { bug:'bug', wunsch:'wunsch', ux:'wunsch', performance:'bug', frage:'frage' };
        fbSetType(typeMap[s.type] || 'wunsch');
        const input = document.getElementById('fbComment');
        input.value = s.title + ': ' + s.description;
        input.focus();
    }

    function fbDismissBadge(i) {
        ['fbCircle','fbArea','fbSugItem'].forEach(prefix => {
            const el = document.getElementById(prefix + i);
            if (el) { el.style.transition = 'opacity 0.3s'; el.style.opacity = '0'; setTimeout(() => el?.remove(), 300); }
        });
    }

    function fbDismissAll() {
        document.getElementById('fbAnnotations').innerHTML = '';
        document.getElementById('fbSugList').style.display = 'none';
        document.getElementById('fbHeaderMsg').textContent = '🙏 Zeichne und beschreibe dein Feedback.';
    }

    function fbRedraw() {
        const c = document.getElementById('fbCanvas');
        const ctx = c.getContext('2d');
        if (!fbState.baseImage || !fbState.baseImage.complete) return;
        const scale = Math.min(c.width / fbState.baseImage.width, c.height / fbState.baseImage.height);
        const w = fbState.baseImage.width * scale, h = fbState.baseImage.height * scale;
        const ox = (c.width - w) / 2, oy = (c.height - h) / 2;
        ctx.fillStyle = '#0a0f1c'; ctx.fillRect(0, 0, c.width, c.height);
        ctx.drawImage(fbState.baseImage, ox, oy, w, h);
        for (const item of fbState.history) {
            ctx.strokeStyle = item.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (item.type === 'draw' && item.points.length > 1) {
                ctx.beginPath(); ctx.moveTo(item.points[0].x, item.points[0].y);
                for (let p = 1; p < item.points.length; p++) ctx.lineTo(item.points[p].x, item.points[p].y);
                ctx.stroke();
            } else if (item.type === 'rect') { ctx.strokeRect(item.x, item.y, item.w, item.h); }
            else if (item.type === 'arrow') { fbDrawArrow(ctx, item.x1, item.y1, item.x2, item.y2, item.color); }
        }
    }

    function fbDrawArrow(ctx, x1, y1, x2, y2, color) {
        const hl = 14, a = Math.atan2(y2-y1, x2-x1);
        ctx.strokeStyle = color; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x2,y2); ctx.lineTo(x2-hl*Math.cos(a-Math.PI/6), y2-hl*Math.sin(a-Math.PI/6));
        ctx.moveTo(x2,y2); ctx.lineTo(x2-hl*Math.cos(a+Math.PI/6), y2-hl*Math.sin(a+Math.PI/6)); ctx.stroke();
    }

    // Canvas drawing events
    const fbCanvas = document.getElementById('fbCanvas');
    function fbXY(e) {
        const r = fbCanvas.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
        return { x:(t.clientX-r.left)*(fbCanvas.width/r.width), y:(t.clientY-r.top)*(fbCanvas.height/r.height) };
    }
    fbCanvas.addEventListener('pointerdown', e => {
        e.preventDefault(); fbState.drawing = true; const p = fbXY(e);
        fbState.startX = p.x; fbState.startY = p.y;
        if (fbState.tool === 'draw') fbState.history.push({ type:'draw', color:fbState.color, points:[p] });
    });
    fbCanvas.addEventListener('pointermove', e => {
        if (!fbState.drawing) return; e.preventDefault(); const p = fbXY(e);
        if (fbState.tool === 'draw') { const last = fbState.history[fbState.history.length-1]; if (last?.type==='draw') { last.points.push(p); fbRedraw(); } }
        else if (fbState.tool === 'rect' || fbState.tool === 'arrow') {
            fbRedraw(); const ctx = fbCanvas.getContext('2d'); ctx.strokeStyle = fbState.color; ctx.lineWidth = 3;
            if (fbState.tool === 'rect') ctx.strokeRect(fbState.startX, fbState.startY, p.x-fbState.startX, p.y-fbState.startY);
            else fbDrawArrow(ctx, fbState.startX, fbState.startY, p.x, p.y, fbState.color);
        }
    });
    fbCanvas.addEventListener('pointerup', e => {
        if (!fbState.drawing) return; fbState.drawing = false; const p = fbXY(e);
        if (fbState.tool === 'rect') fbState.history.push({ type:'rect', color:fbState.color, x:fbState.startX, y:fbState.startY, w:p.x-fbState.startX, h:p.y-fbState.startY });
        else if (fbState.tool === 'arrow') fbState.history.push({ type:'arrow', color:fbState.color, x1:fbState.startX, y1:fbState.startY, x2:p.x, y2:p.y });
        fbRedraw();
    });
    fbCanvas.addEventListener('pointerleave', () => { fbState.drawing = false; });

    function fbSetTool(t) { fbState.tool = t; document.querySelectorAll('.fb-tool').forEach(el => el.classList.remove('active')); document.getElementById('fbTool'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.add('active'); }
    function fbSetColor(c) { fbState.color = c; document.querySelectorAll('.fb-color').forEach(el => el.classList.toggle('active', el.dataset.color===c)); }
    function fbSetType(t) { fbState.type = t; document.querySelectorAll('.fb-type').forEach(el => el.classList.remove('active')); document.getElementById('fbType'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.add('active'); }
    function fbUndo() { if (fbState.history.length) { fbState.history.pop(); fbRedraw(); } }
    function fbClose() { document.getElementById('fbOverlay').classList.remove('active'); }

    async function fbSend() {
        const comment = document.getElementById('fbComment').value.trim();
        if (!comment) { const inp = document.getElementById('fbComment'); inp.focus(); inp.style.borderColor='#f87171'; setTimeout(()=>inp.style.borderColor='',1500); return; }
        const btn = document.getElementById('fbSend'); btn.disabled = true; btn.textContent = '...';
        try {
            const imgData = document.getElementById('fbCanvas').toDataURL('image/jpeg', 0.7);
            const section = (document.querySelector('.nav-link.active')?.dataset?.section || document.querySelector('.nav-dropdown-item.active')?.dataset?.section || 'unknown');
            const r = await fetch(`${API}/feedback`, { method:'POST', headers:{...H(),'Content-Type':'application/json'},
                body: JSON.stringify({ type:fbState.type, comment, screenshot:imgData, page:section, url:window.location.href, viewport:`${window.innerWidth}x${window.innerHeight}`, userAgent:navigator.userAgent.substring(0,200) })
            });
            if (!r.ok) throw new Error('Send failed');
            fbClose(); showToast('Feedback gesendet – danke! 🙏', 'success');
        } catch(e) { showToast('Senden fehlgeschlagen', 'error'); console.error(e); }
        btn.disabled = false; btn.textContent = 'Senden ➤';
    }
    </script>
</body>
</html>

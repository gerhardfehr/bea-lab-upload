<!DOCTYPE html>
<html lang="de">
<head>
<script>if(location.hostname==='bea-lab.io')location.replace('https://www.bea-lab.io'+location.pathname+location.search+location.hash);</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BEATRIX – The Strategic Intelligence Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0a1628; --navy-light: #111d35; --navy-mid: #162244; --navy-card: #1a2847; --navy-hover: #1f3055;
            --border: #253556; --border-light: #2d4070;
            --accent: #5b8af5; --accent-light: #7ba3ff; --accent-glow: rgba(91,138,245,0.12); --accent-glow-strong: rgba(91,138,245,0.25);
            --text: #e4e9f2; --text-secondary: #8899b8; --text-muted: #586a8e; --white: #ffffff;
            --success: #34d399; --success-bg: rgba(52,211,153,0.1); --warning: #fbbf24;
            --error: #f87171; --error-bg: rgba(248,113,113,0.08);
            --radius: 14px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Plus Jakarta Sans',-apple-system,sans-serif; background:var(--navy); color:var(--text); min-height:100vh; overflow-x:hidden; -webkit-font-smoothing:antialiased; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(91,138,245,0.06),transparent),radial-gradient(ellipse 60% 50% at 80% 100%,rgba(91,138,245,0.04),transparent); pointer-events:none; z-index:0; }

        /* ── Login/Register Overlay ──────────────────────── */
        .auth-overlay { position:fixed; inset:0; z-index:10000; background:var(--navy); display:flex; align-items:center; justify-content:center; transition:opacity 0.5s ease, visibility 0.5s ease; }
        .auth-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }
        .auth-card { width:100%; max-width:420px; padding:48px 40px; text-align:center; }
        .auth-logo { width:80px; height:80px; border-radius:20px; margin:0 auto 28px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.2); }
        .auth-title { font-size:28px; font-weight:800; color:var(--white); margin-bottom:6px; letter-spacing:-0.3px; }
        .auth-title span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .auth-subtitle { font-size:14px; color:var(--text-secondary); margin-bottom:32px; line-height:1.6; }
        .auth-form { display:flex; flex-direction:column; gap:14px; }
        .auth-input-wrapper { position:relative; }
        .auth-input-wrapper svg { position:absolute; left:16px; top:50%; transform:translateY(-50%); width:18px; height:18px; stroke:var(--text-muted); transition:var(--transition); pointer-events:none; }
        .auth-input { width:100%; padding:14px 16px 14px 46px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:15px; outline:none; transition:var(--transition); }
        .auth-input::placeholder { color:var(--text-muted); }
        .auth-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); background:var(--navy-card); }
        .auth-btn { width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:var(--radius); font-size:15px; font-weight:700; font-family:inherit; cursor:pointer; transition:var(--transition); box-shadow:0 4px 20px rgba(91,138,245,0.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 6px 28px rgba(91,138,245,0.4); }
        .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .auth-error { font-size:13px; color:var(--error); padding:10px 14px; background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); border-radius:var(--radius-sm); display:none; animation:shake 0.4s ease; text-align:left; }
        .auth-error.visible { display:block; }
        .auth-success { font-size:13px; color:var(--success); padding:10px 14px; background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); border-radius:var(--radius-sm); display:none; text-align:left; }
        .auth-success.visible { display:block; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} }
        .auth-switch { margin-top:24px; font-size:13px; color:var(--text-muted); }
        .auth-switch a { color:var(--accent); text-decoration:none; font-weight:600; cursor:pointer; }
        .auth-switch a:hover { color:var(--accent-light); text-decoration:underline; }
        .auth-footer { margin-top:28px; font-size:11px; color:var(--text-muted); }
        .auth-footer a { color:var(--accent); text-decoration:none; }
        .auth-panel { display:none; }
        .auth-panel.active { display:block; }
        .auth-divider { display:flex; align-items:center; gap:12px; margin:4px 0; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
        .auth-divider::before, .auth-divider::after { content:''; flex:1; height:1px; background:var(--border); }

        /* ── Nav ─────────────────────────────────────────── */
        .nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:0 40px; height:64px; background:rgba(10,22,40,0.9); backdrop-filter:blur(24px); border-bottom:1px solid var(--border); }
        .nav-brand { display:flex; align-items:center; gap:14px; text-decoration:none; }
        .nav-logo-img { height:34px; width:auto; border-radius:6px; }
        .nav-title { font-size:16px; font-weight:700; color:var(--white); letter-spacing:1.5px; text-transform:uppercase; }
        .nav-links { display:flex; align-items:center; gap:8px; }
        .nav-link { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); }
        .nav-link:hover, .nav-link.active { color:var(--white); background:var(--navy-mid); }
        .nav-right { display:flex; align-items:center; gap:12px; }
        .nav-status { display:flex; align-items:center; gap:7px; font-size:12px; font-weight:500; color:var(--success); padding:5px 12px; background:var(--success-bg); border-radius:20px; }
        .nav-status .dot { width:6px; height:6px; border-radius:50%; background:var(--success); animation:pulse 2s infinite; }
        .nav-user { font-size:12px; color:var(--text-secondary); padding:5px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:20px; }
        .nav-logout { padding:5px 12px; font-size:12px; font-weight:500; color:var(--text-muted); background:var(--navy-light); border:1px solid var(--border); border-radius:20px; cursor:pointer; transition:var(--transition); font-family:inherit; display:flex; align-items:center; gap:5px; }
        .nav-logout:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* ── Hero ────────────────────────────────────────── */
        .hero { position:relative; z-index:1; text-align:center; padding:80px 24px 60px; border-bottom:1px solid var(--border); }
        .hero-logo { width:120px; height:120px; border-radius:24px; margin:0 auto 32px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.15); }
        .hero h1 { font-size:42px; font-weight:800; letter-spacing:-0.5px; color:var(--white); margin-bottom:12px; }
        .hero h1 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .hero .subtitle { font-size:17px; color:var(--text-secondary); max-width:520px; margin:0 auto 36px; line-height:1.7; }
        .hero-stats { display:flex; justify-content:center; gap:40px; }
        .hero-stat { text-align:center; }
        .hero-stat .num { font-size:28px; font-weight:800; color:var(--white); }
        .hero-stat .label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }

        /* ── Sections ───────────────────────────────────── */
        .section { display:none; position:relative; z-index:1; }
        .section.active { display:block; }
        .container { max-width:960px; margin:0 auto; padding:40px 24px 80px; }
        .section-header { margin-bottom:32px; }
        .section-header h2 { font-size:24px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .section-header p { font-size:14px; color:var(--text-secondary); line-height:1.6; }
        .db-selector { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:28px; }
        .db-option { padding:16px 18px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); }
        .db-option:hover { background:var(--navy-card); border-color:var(--border-light); }
        .db-option.selected { background:var(--navy-card); border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .db-option-title { font-size:14px; font-weight:600; color:var(--white); margin-bottom:3px; display:flex; align-items:center; gap:8px; }
        .db-dot { width:8px; height:8px; border-radius:50%; }
        .db-option-desc { font-size:12px; color:var(--text-muted); }
        .tabs { display:flex; gap:4px; margin-bottom:28px; background:var(--navy-light); padding:4px; border-radius:var(--radius); border:1px solid var(--border); width:fit-content; }
        .tab { padding:10px 22px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:var(--transition); border:none; background:none; font-family:inherit; }
        .tab:hover { color:var(--text); }
        .tab.active { background:var(--navy-card); color:var(--white); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:52px 40px; text-align:center; cursor:pointer; transition:var(--transition); background:var(--navy-light); position:relative; overflow:hidden; }
        .upload-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,var(--accent-glow),transparent 70%); opacity:0; transition:var(--transition); }
        .upload-zone:hover,.upload-zone.dragover { border-color:var(--accent); background:var(--navy-card); }
        .upload-zone:hover::before,.upload-zone.dragover::before { opacity:1; }
        .upload-icon { position:relative; z-index:1; margin-bottom:16px; }
        .upload-icon svg { width:36px; height:36px; stroke:var(--accent); }
        .upload-zone h3 { position:relative; z-index:1; font-size:16px; font-weight:600; margin-bottom:6px; color:var(--white); }
        .upload-zone h3 span { color:var(--accent-light); text-decoration:underline; text-underline-offset:2px; }
        .upload-zone p { position:relative; z-index:1; font-size:13px; color:var(--text-muted); margin-bottom:12px; }
        .upload-formats { position:relative; z-index:1; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
        .format-badge { padding:3px 9px; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; background:var(--navy-card); border:1px solid var(--border); border-radius:5px; color:var(--text-secondary); }
        .file-section,.text-section { display:none; }
        .file-section.active,.text-section.active { display:block; }
        .input-group { margin-bottom:16px; }
        .input-group label { display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
        .input-field,.textarea-field { width:100%; padding:10px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:var(--transition); }
        .input-field:focus,.textarea-field:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .textarea-field { min-height:200px; resize:vertical; line-height:1.7; }
        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .tag-container { display:flex; flex-wrap:wrap; gap:6px; padding:8px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:40px; align-items:center; cursor:text; transition:var(--transition); }
        .tag-container:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .tag { display:flex; align-items:center; gap:4px; padding:3px 8px 3px 10px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.3); border-radius:6px; font-size:12px; font-weight:500; color:var(--accent-light); }
        .tag button { background:none; border:none; color:var(--accent-light); cursor:pointer; font-size:14px; padding:0 2px; opacity:0.6; }
        .tag button:hover { opacity:1; }
        .tag-input { border:none; outline:none; background:none; color:var(--text); font-family:inherit; font-size:13px; flex:1; min-width:80px; }
        .file-list { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
        .file-item { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); animation:slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
        .file-type-icon { width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; text-transform:uppercase; flex-shrink:0; }
        .file-type-icon.pdf { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.2); }
        .file-type-icon.txt { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-type-icon.md { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.2); }
        .file-type-icon.doc { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-info { flex:1; min-width:0; }
        .file-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .file-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .progress-bar { height:3px; background:var(--navy); border-radius:2px; overflow:hidden; max-width:180px; }
        .progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s; }
        .file-status { font-size:11px; font-weight:600; padding:3px 9px; border-radius:5px; white-space:nowrap; }
        .file-status.pending { color:var(--text-muted); background:var(--navy-light); }
        .file-status.uploading { color:var(--accent-light); background:var(--accent-glow); }
        .file-status.success { color:var(--success); background:var(--success-bg); }
        .file-status.error { color:var(--error); background:var(--error-bg); }
        .file-remove { background:none; border:none; color:var(--text-muted); cursor:pointer; padding:4px; transition:var(--transition); border-radius:4px; }
        .file-remove:hover { color:var(--error); background:var(--error-bg); }
        .actions { margin-top:28px; display:flex; align-items:center; justify-content:space-between; }
        .btn { padding:11px 24px; border-radius:var(--radius-sm); font-size:13px; font-weight:600; font-family:inherit; cursor:pointer; transition:var(--transition); border:none; display:flex; align-items:center; gap:8px; }
        .btn-primary { background:var(--accent); color:white; box-shadow:0 2px 12px rgba(91,138,245,0.3); }
        .btn-primary:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 4px 20px rgba(91,138,245,0.4); }
        .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-secondary { background:var(--navy-card); color:var(--text-secondary); border:1px solid var(--border); }
        .btn-secondary:hover { background:var(--navy-hover); color:var(--text); }
        .upload-count { font-size:13px; color:var(--text-muted); }
        .doc-table { width:100%; border-collapse:collapse; }
        .doc-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .doc-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .doc-table tr:hover td { background:var(--navy-light); }
        .doc-table .doc-name { color:var(--white); font-weight:500; }
        .status-badge { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:600; }
        .status-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--success); }
        .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
        .empty-state svg { width:48px; height:48px; stroke:var(--border-light); margin-bottom:16px; }
        .empty-state h3 { font-size:16px; color:var(--text-secondary); margin-bottom:6px; }
        .toast-container { position:fixed; bottom:24px; right:24px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
        .toast { padding:12px 18px; border-radius:var(--radius-sm); font-size:13px; font-weight:500; display:flex; align-items:center; gap:8px; animation:toastIn 0.3s ease; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid var(--border); background:var(--navy-card); }
        .toast.success { border-left:3px solid var(--success); } .toast.error { border-left:3px solid var(--error); } .toast.info { border-left:3px solid var(--accent); }
        @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
        .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
        @keyframes fadeSlideIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
        .mb-default-badge { display:inline-block;font-size:10px;font-weight:600;color:var(--accent);background:rgba(139,170,255,0.1);border:1px solid rgba(139,170,255,0.2);padding:2px 8px;border-radius:10px;margin-top:6px;letter-spacing:0.3px;text-transform:uppercase; }
        .footer { position:relative; z-index:1; text-align:center; padding:32px 24px; border-top:1px solid var(--border); font-size:12px; color:var(--text-muted); }
        .footer a { color:var(--accent); text-decoration:none; }

        /* ── Admin Dashboard ───────────────────────────────── */
        .admin-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:32px; }
        .admin-card { padding:24px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); }
        .admin-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:8px; }
        .admin-card-value { font-size:28px; font-weight:800; color:var(--white); }
        .admin-card-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }
        .admin-section-title { font-size:16px; font-weight:700; color:var(--white); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
        .admin-section-title .badge { font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; background:var(--accent-glow); color:var(--accent-light); border:1px solid rgba(91,138,245,0.2); }
        .user-table { width:100%; border-collapse:collapse; margin-bottom:32px; }
        .user-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .user-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .user-table tr:hover td { background:var(--navy-light); }
        .user-email { color:var(--white); font-weight:500; }
        .user-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 8px; border-radius:4px; text-transform:uppercase; letter-spacing:0.3px; }
        .user-badge.admin { background:rgba(251,191,36,0.12); color:var(--warning); border:1px solid rgba(251,191,36,0.2); }
        .user-badge.user { background:var(--navy-light); color:var(--text-muted); border:1px solid var(--border); }
        .user-badge.active { background:var(--success-bg); color:var(--success); border:1px solid rgba(52,211,153,0.2); }
        .user-badge.inactive { background:var(--error-bg); color:var(--error); border:1px solid rgba(248,113,113,0.2); }
        .btn-toggle { padding:5px 12px; font-size:11px; font-weight:600; font-family:inherit; cursor:pointer; border-radius:6px; transition:var(--transition); border:1px solid var(--border); background:var(--navy-light); color:var(--text-secondary); }
        .btn-toggle:hover { background:var(--navy-hover); color:var(--white); border-color:var(--border-light); }
        .btn-toggle.deactivate:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        .btn-toggle.activate:hover { color:var(--success); border-color:rgba(52,211,153,0.3); background:var(--success-bg); }
        .settings-row { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:10px; }
        .settings-label { font-size:13px; color:var(--text); font-weight:500; }
        .settings-value { font-size:13px; color:var(--accent-light); font-weight:600; font-family:'JetBrains Mono',monospace; }
        .nav-link.admin-link { color:var(--warning); }
        .nav-link.admin-link:hover,.nav-link.admin-link.active { color:var(--warning); background:rgba(251,191,36,0.08); }

        /* ── Password Modal ──────────────────────────────── */
        .modal-overlay { position:fixed; inset:0; z-index:9999; background:rgba(10,22,40,0.85); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:all 0.3s ease; }
        .modal-overlay.visible { opacity:1; visibility:visible; }
        .modal { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:36px; width:100%; max-width:400px; }
        .modal h3 { font-size:18px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .modal-input { width:100%; padding:12px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .modal-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
        .modal-msg { font-size:13px; padding:10px 14px; border-radius:var(--radius-sm); margin-bottom:12px; display:none; }
        .modal-msg.error { display:block; color:var(--error); background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); }
        .modal-msg.success { display:block; color:var(--success); background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); }
        .nav-user { cursor:pointer; transition:var(--transition); }
        .nav-user:hover { border-color:var(--accent); color:var(--text); }
        /* ── Profile ──────────────────────── */
        .profile-grid { display:grid; grid-template-columns:280px 1fr; gap:32px; }
        .profile-card { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; text-align:center; }
        .profile-avatar-wrap { position:relative; width:120px; height:120px; margin:0 auto 20px; }
        .profile-avatar { width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid var(--border); background:var(--navy-mid); display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:700; color:var(--accent); overflow:hidden; }
        .profile-avatar img { width:100%; height:100%; object-fit:cover; }
        .profile-avatar-edit { position:absolute; bottom:4px; right:4px; width:32px; height:32px; border-radius:50%; background:var(--accent); border:2px solid var(--navy-card); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:var(--transition); }
        .profile-avatar-edit:hover { transform:scale(1.1); }
        .profile-avatar-edit svg { width:14px; height:14px; stroke:white; }
        .profile-name { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .profile-position { font-size:13px; color:var(--text-secondary); margin-bottom:16px; }
        .profile-meta { display:flex; flex-direction:column; gap:8px; text-align:left; padding-top:16px; border-top:1px solid var(--border); }
        .profile-meta-item { display:flex; align-items:center; gap:10px; font-size:13px; color:var(--text-secondary); }
        .profile-meta-item svg { width:16px; height:16px; stroke:var(--text-muted); flex-shrink:0; }
        .profile-form { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:32px; }
        .profile-form h3 { font-size:16px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .profile-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
        .profile-field { display:flex; flex-direction:column; gap:6px; }
        .profile-field.full { grid-column:1/-1; }
        .profile-field label { font-size:12px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.5px; }
        .profile-field input, .profile-field textarea { background:var(--navy-mid); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 14px; color:var(--text); font-family:inherit; font-size:14px; transition:var(--transition); }
        .profile-field input:focus, .profile-field textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .profile-field textarea { resize:vertical; min-height:80px; }
        .profile-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .profile-tag { padding:4px 12px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); border-radius:20px; font-size:12px; color:var(--accent-light); display:flex; align-items:center; gap:4px; }
        .profile-tag .remove { cursor:pointer; opacity:0.6; } .profile-tag .remove:hover { opacity:1; }
        .profile-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:24px; padding-top:20px; border-top:1px solid var(--border); }
        .linkedin-btn { display:inline-flex; align-items:center; gap:8px; padding:10px 20px; background:#0a66c2; color:white; border:none; border-radius:var(--radius-sm); font-family:inherit; font-size:13px; font-weight:600; cursor:pointer; transition:var(--transition); }
        .linkedin-btn:hover { background:#004182; }
        .linkedin-btn.connected { background:var(--navy-mid); border:1px solid var(--border); color:var(--text-secondary); }
        .linkedin-section { margin-top:20px; padding-top:16px; border-top:1px solid var(--border); }
        /* ── Chat ──────────────────────── */
        .chat-container { max-width:900px; margin:0 auto; display:flex; flex-direction:column; height:calc(100vh - 72px); padding:0 20px; }
        .chat-header { padding:24px 0 16px; text-align:center; flex-shrink:0; }
        .chat-header h2 { font-size:22px; font-weight:800; color:var(--white); margin-bottom:4px; }
        .chat-header h2 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .chat-header p { font-size:13px; color:var(--text-secondary); }
        .chat-messages { flex:1; overflow-y:auto; padding:8px 0 16px; display:flex; flex-direction:column; gap:16px; scroll-behavior:smooth; }
        .chat-messages::-webkit-scrollbar { width:6px; } .chat-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
        .chat-msg { display:flex; gap:12px; max-width:85%; animation:msgIn 0.3s ease; }
        @keyframes msgIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
        .chat-msg.user { align-self:flex-end; flex-direction:row-reverse; }
        .chat-msg-avatar { width:32px; height:32px; border-radius:50%; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
        .chat-msg.user .chat-msg-avatar { background:var(--accent-glow); color:var(--accent); border:1px solid rgba(91,138,245,0.3); }
        .chat-msg.assistant .chat-msg-avatar { background:linear-gradient(135deg,#1a2a47,#162244); color:var(--accent-light); border:1px solid var(--border); }
        .chat-msg-body { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:14px 18px; font-size:14px; line-height:1.7; color:var(--text); }
        .chat-msg.user .chat-msg-body { background:var(--accent-glow-strong); border-color:rgba(91,138,245,0.25); }
        .chat-msg-body p { margin-bottom:8px; } .chat-msg-body p:last-child { margin-bottom:0; }
        .chat-msg-body code { background:var(--navy-mid); padding:1px 6px; border-radius:4px; font-family:'JetBrains Mono',monospace; font-size:13px; }
        .chat-msg-body strong { color:var(--white); font-weight:600; }
        .chat-msg-body ul, .chat-msg-body ol { margin:8px 0; padding-left:20px; } .chat-msg-body li { margin:4px 0; }
        .chat-sources { display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; padding-top:8px; border-top:1px solid var(--border); }
        .chat-source-tag { font-size:11px; padding:3px 10px; background:var(--navy-mid); border:1px solid var(--border); border-radius:12px; color:var(--text-secondary); }
        .chat-input-area { flex-shrink:0; padding:16px 0 24px; }
        .chat-input-wrap { display:flex; gap:10px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:8px 8px 8px 18px; transition:var(--transition); }
        .chat-input-wrap:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .chat-input { flex:1; background:none; border:none; color:var(--text); font-family:inherit; font-size:15px; outline:none; resize:none; max-height:120px; line-height:1.5; }
        .chat-input::placeholder { color:var(--text-muted); }
        .chat-send-btn { width:42px; height:42px; border-radius:12px; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:var(--transition); flex-shrink:0; }
        .chat-send-btn:hover { background:var(--accent-light); transform:scale(1.05); }
        .chat-send-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
        .chat-send-btn svg { width:18px; height:18px; stroke:white; }
        .chat-typing { display:flex; gap:4px; padding:8px 0; }
        .chat-typing span { width:8px; height:8px; border-radius:50%; background:var(--text-muted); animation:typing 1.4s ease-in-out infinite; }
        .chat-typing span:nth-child(2) { animation-delay:0.2s; } .chat-typing span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,60%,100% { transform:translateY(0); opacity:0.4; } 30% { transform:translateY(-6px); opacity:1; } }
        .chat-welcome { text-align:center; padding:60px 20px; }
        .chat-welcome-icon { width:80px; height:80px; border-radius:50%; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.2); display:flex; align-items:center; justify-content:center; margin:0 auto 24px; }
        .chat-welcome-icon img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
        .chat-welcome h3 { font-size:20px; font-weight:700; color:var(--white); margin-bottom:8px; }
        .chat-welcome p { font-size:14px; color:var(--text-secondary); max-width:500px; margin:0 auto 28px; line-height:1.6; }
        .chat-suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
        .chat-suggestion { padding:8px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:20px; font-size:13px; color:var(--text-secondary); cursor:pointer; transition:var(--transition); font-family:inherit; }
        .chat-suggestion:hover { border-color:var(--accent); color:var(--accent-light); background:var(--accent-glow); }

        /* ═══════ MODEL BUILDING ═══════ */
        .mb-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:32px; flex-wrap:wrap; gap:16px; }
        .mb-header h2 { font-size:24px; font-weight:700; color:var(--white); margin:0; }
        .mb-header p { font-size:14px; color:var(--text-secondary); margin:4px 0 0; }
        .mb-progress { display:flex; gap:4px; padding:16px 0; margin-bottom:28px; overflow-x:auto; }
        .mb-step-dot { display:flex; flex-direction:column; align-items:center; gap:6px; min-width:80px; cursor:pointer; }
        .mb-step-num { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; border:2px solid var(--border); color:var(--text-muted); background:var(--navy-light); transition:var(--transition); }
        .mb-step-dot.active .mb-step-num { border-color:var(--accent); color:var(--white); background:var(--accent); box-shadow:0 0 16px var(--accent-glow); }
        .mb-step-dot.completed .mb-step-num { border-color:var(--success); color:var(--white); background:var(--success); }
        .mb-step-dot.completed .mb-step-num::after { content:'✓'; }
        .mb-step-label { font-size:10px; color:var(--text-muted); text-align:center; white-space:nowrap; transition:var(--transition); }
        .mb-step-dot.active .mb-step-label { color:var(--accent-light); font-weight:600; }
        .mb-step-dot.completed .mb-step-label { color:var(--success); }
        .mb-step-line { flex:1; height:2px; background:var(--border); align-self:center; margin:0 -8px; margin-bottom:22px; }
        .mb-step-line.completed { background:var(--success); }

        .mb-panel { display:none; animation:fadeIn 0.3s ease; }
        .mb-panel.active { display:block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

        .mb-step-title { font-size:20px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-step-desc { font-size:14px; color:var(--text-secondary); margin-bottom:24px; line-height:1.6; }

        .mb-choices { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:24px; }
        .mb-choice { padding:20px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); position:relative; }
        .mb-choice:hover { border-color:var(--border-light); background:var(--navy-card); transform:translateY(-2px); }
        .mb-choice.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-choice-num { position:absolute; top:12px; right:14px; width:24px; height:24px; border-radius:50%; background:var(--navy-mid); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:var(--text-muted); }
        .mb-choice.selected .mb-choice-num { background:var(--accent); border-color:var(--accent); color:var(--white); }
        .mb-choice-icon { font-size:24px; margin-bottom:10px; }
        .mb-choice-title { font-size:15px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .mb-choice-desc { font-size:12px; color:var(--text-secondary); line-height:1.5; }
        .mb-choice-meta { font-size:11px; color:var(--text-muted); margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
        .mb-choice.custom-choice { border-style:dashed; }

        .mb-actions { display:flex; gap:12px; margin-top:24px; }
        .mb-btn { padding:12px 28px; border-radius:var(--radius); font-size:14px; font-weight:600; cursor:pointer; transition:var(--transition); border:none; font-family:inherit; }
        .mb-btn-primary { background:var(--accent); color:var(--white); }
        .mb-btn-primary:hover { background:var(--accent-light); box-shadow:0 4px 16px rgba(91,138,245,0.3); }
        .mb-btn-primary:disabled { opacity:0.4; cursor:not-allowed; }
        .mb-btn-secondary { background:var(--navy-light); color:var(--text-secondary); border:1px solid var(--border); }
        .mb-btn-secondary:hover { color:var(--white); border-color:var(--border-light); }
        .mb-btn-back { background:none; color:var(--text-muted); border:1px solid var(--border); }

        .mb-input { width:100%; padding:12px 16px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .mb-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .mb-textarea { min-height:80px; resize:vertical; }
        .mb-label { font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; display:block; }

        .mb-info-box { padding:16px 20px; background:rgba(91,138,245,0.06); border:1px solid rgba(91,138,245,0.15); border-radius:var(--radius); margin-bottom:20px; }
        .mb-info-box p { font-size:13px; color:var(--text-secondary); line-height:1.6; margin:0; }
        .mb-info-box strong { color:var(--accent-light); }
        .mb-inline-progress { margin-top:20px;padding:20px;background:rgba(139,170,255,0.04);border:1px solid rgba(139,170,255,0.1);border-radius:var(--radius); }
        .mb-prog-header { display:flex;align-items:center;gap:12px;margin-bottom:14px; }
        .mb-prog-spinner { width:18px;height:18px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0; }
        .mb-prog-bar-bg { height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;margin-bottom:8px; }
        .mb-prog-bar { height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#818cf8);border-radius:3px;transition:width 0.6s ease; }
        .mb-prog-meta { display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:12px; }
        .mb-prog-stages { display:flex;flex-direction:column;gap:4px; }
        .mb-prog-stage { display:flex;align-items:center;gap:8px;font-size:12px;color:rgba(255,255,255,0.35);transition:all 0.3s; }
        .mb-prog-stage.active { color:rgba(255,255,255,0.9); }
        .mb-prog-stage.done { color:rgba(34,197,94,0.8); }
        .mb-prog-dot { width:16px;height:16px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:9px;flex-shrink:0; }
        .mb-prog-stage.active .mb-prog-dot { border-color:var(--accent);background:rgba(139,170,255,0.15); }
        .mb-prog-stage.done .mb-prog-dot { border-color:#22c55e;background:rgba(34,197,94,0.15); }

        .mb-registry { display:grid; gap:12px; margin-top:20px; }
        .mb-model-card { padding:16px 20px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); display:flex; align-items:center; gap:16px; transition:var(--transition); cursor:pointer; }
        .mb-model-card:hover { border-color:var(--border-light); background:var(--navy-card); }
        .mb-model-id { font-size:11px; font-weight:700; color:var(--accent); background:var(--accent-glow); padding:4px 10px; border-radius:12px; white-space:nowrap; }
        .mb-model-info { flex:1; }
        .mb-model-name { font-size:14px; font-weight:600; color:var(--white); }
        .mb-model-meta { font-size:12px; color:var(--text-muted); margin-top:2px; }
        .mb-model-version { font-size:11px; color:var(--text-muted); background:var(--navy-mid); padding:3px 8px; border-radius:8px; }

        .mb-summary { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:20px; }
        .mb-summary-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px; }
        .mb-summary-row:last-child { border-bottom:none; }
        .mb-summary-label { color:var(--text-muted); }
        .mb-summary-value { color:var(--white); font-weight:600; }

        .mb-mode-cards { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
        .mb-mode-card { padding:20px 16px; background:var(--navy-light); border:2px solid var(--border); border-radius:var(--radius); cursor:pointer; text-align:center; transition:var(--transition); }
        .mb-mode-card:hover { border-color:var(--border-light); transform:translateY(-2px); }
        .mb-mode-card.selected { border-color:var(--accent); background:rgba(91,138,245,0.06); }
        .mb-mode-icon { font-size:28px; margin-bottom:10px; }
        .mb-mode-name { font-size:14px; font-weight:700; color:var(--white); margin-bottom:4px; }
        .mb-mode-time { font-size:11px; color:var(--accent-light); margin-bottom:6px; }
        .mb-mode-desc { font-size:11px; color:var(--text-muted); line-height:1.4; }

        @media (max-width:768px) { .mb-choices { grid-template-columns:1fr; } .mb-mode-cards { grid-template-columns:1fr 1fr; } }
        @media (max-width:768px) { .profile-grid { grid-template-columns:1fr; } .profile-row { grid-template-columns:1fr; } }
        @media (max-width:640px) {
            .nav { padding:0 16px; } .nav-links { display:none; } .hero { padding:48px 16px 40px; } .hero h1 { font-size:28px; }
            .hero-stats { gap:20px; } .container { padding:24px 16px 60px; } .db-selector { grid-template-columns:1fr; }
            .input-row { grid-template-columns:1fr; } .upload-zone { padding:36px 20px; } .actions { flex-direction:column; gap:12px; }
            .auth-card { padding:36px 24px; } .auth-title { font-size:24px; }
        }
    </style>
</head>
<body>

    <!-- ═══════ AUTH OVERLAY ═══════ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <img src="/logo.jpeg" alt="BEATRIX" class="auth-logo">
            <h1 class="auth-title">BEATRIX <span>Lab</span></h1>
            <p class="auth-subtitle">Strategic Intelligence Suite</p>

            <!-- LOGIN PANEL -->
            <div class="auth-panel active" id="loginPanel">
                <div class="auth-form">
                    <div class="auth-error" id="loginError"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="loginEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="loginPassword" placeholder="Passwort" autocomplete="current-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="loginBtn" onclick="doLogin()">Anmelden</button>
                    <div style="text-align:center;margin-top:10px"><a onclick="showAuthPanel('forgot')" style="font-size:13px;color:var(--accent);cursor:pointer">Passwort vergessen?</a></div>
                </div>
                <div class="auth-switch">Noch kein Konto? <a onclick="showAuthPanel('register')">Jetzt registrieren</a></div>
            </div>

            <!-- REGISTER PANEL -->
            <div class="auth-panel" id="registerPanel">
                <div class="auth-form">
                    <div class="auth-error" id="registerError"></div>
                    <div class="auth-success" id="registerSuccess"></div>
                    <div class="auth-input-wrapper">
                        <input type="text" class="auth-input" id="regName" placeholder="Name (optional)" autocomplete="name">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="regEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="regPassword" placeholder="Passwort (mind. 6 Zeichen)" autocomplete="new-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="registerBtn" onclick="doRegister()">Registrieren</button>
                    <div id="resendArea" style="display:none;margin-top:12px;text-align:center;font-size:13px;color:var(--text-muted)">
                        Keine E-Mail erhalten? <a onclick="resendVerification()" style="color:var(--accent);cursor:pointer;font-weight:600">Erneut senden</a>
                    </div>
                </div>
                <div class="auth-switch">Bereits registriert? <a onclick="showAuthPanel('login')">Anmelden</a></div>
            </div>

            <!-- FORGOT PASSWORD PANEL -->
            <div class="auth-panel" id="forgotPanel">
                <div class="auth-form">
                    <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px;text-align:center">Gib deine E-Mail-Adresse ein und wir senden dir einen Link zum Zurücksetzen deines Passworts.</p>
                    <div class="auth-error" id="forgotError"></div>
                    <div class="auth-success" id="forgotSuccess" style="display:none;padding:12px;background:var(--success-bg);border:1px solid rgba(52,211,153,0.15);border-radius:var(--radius-sm);color:var(--success);font-size:13px;margin-bottom:12px"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="forgotEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <button class="auth-btn" id="forgotBtn" onclick="doForgotPassword()">Reset-Link senden</button>
                </div>
                <div class="auth-switch">Zurück zur <a onclick="showAuthPanel('login')">Anmeldung</a></div>
            </div>

            <div class="auth-footer"><a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</div>
        </div>
    </div>

    <!-- ═══════ MAIN APP ═══════ -->
    <nav class="nav">
        <a href="#" class="nav-brand" onclick="showSection('hero')"><img src="/logo.jpeg" alt="BEATRIX" class="nav-logo-img"><span class="nav-title">BEATRIX</span></a>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-section="chat" onclick="showSection('chat',this)">Fragen</a>
            <a href="#" class="nav-link" data-section="model" onclick="showSection('model',this)">Modell-Building</a>
            <a href="#" class="nav-link" data-section="upload" onclick="showSection('upload',this)">Upload</a>
            <a href="#" class="nav-link" data-section="documents" onclick="showSection('documents',this)">Dokumente</a>
            <a href="#" class="nav-link" data-section="profile" onclick="showSection('profile',this)">Profil</a>
            <a href="#" class="nav-link" data-section="context" id="navContext" onclick="showSection('context',this)" style="display:none">Ausgangslage</a>
            <a href="#" class="nav-link" data-section="leads" id="navLeads" onclick="showSection('leads',this)" style="display:none">CRM</a>
            <a href="#" class="nav-link" data-section="companies" id="navCompanies" onclick="showSection('companies',this)" style="display:none">Firmen</a>
            <a href="#" class="nav-link admin-link" data-section="admin" id="navAdmin" onclick="showSection('admin',this)" style="display:none">Admin</a>
        </div>
        <div class="nav-right">
            <div class="nav-status"><span class="dot"></span> Online</div>
            <span style="font-size:10px;color:rgba(255,255,255,0.15);margin-left:4px" id="appVersion">v3.17</span>
            <span class="nav-user" id="navUser" onclick="showSection('profile',document.querySelector('[data-section=profile]'))" title="Profil"></span>
            <button class="nav-logout" onclick="doLogout()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Abmelden
            </button>
        </div>
    </nav>

    <section class="hero" id="hero-section" style="display:none">
        <img src="/logo.jpeg" alt="BEATRIX Logo" class="hero-logo">
        <h1>BEATRIX <span>Intelligence Suite</span></h1>
        <p class="subtitle">Knowledge Base für Behavioral Economics. Lade Dokumente, Axiome und Research Papers in die BEATRIX-Datenbank.</p>
        <div class="hero-stats">
            <div class="hero-stat"><div class="num" id="statDocs">–</div><div class="label">Dokumente</div></div>
            <div class="hero-stat"><div class="num" id="statKB">–</div><div class="label">Knowledge Base</div></div>
            <div class="hero-stat"><div class="num" id="statAxioms">–</div><div class="label">BCM Axiome</div></div>
        </div>
    </section>

    <!-- ═══════ CHAT SECTION ═══════ -->
    <section class="section active" id="chat-section">
        <div class="chat-container">
            <div class="chat-header">
                <h2>Frag <span>BEATRIX</span></h2>
                <p>Deine Fragen zu Behavioral Economics, BCM und der Knowledge Base</p>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-welcome" id="chatWelcome">
                    <div class="chat-welcome-icon"><img src="/logo.jpeg" alt="BEATRIX"></div>
                    <h3>Hallo! Ich bin BEATRIX.</h3>
                    <p>Stelle mir eine Frage zu Behavioral Economics, zum Behavioral Competence Model oder zu Dokumenten in der Knowledge Base.</p>
                    <div class="chat-suggestions">
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Was ist das BCM?</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Erkläre Complementarity</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Welche Dokumente sind in der Knowledge Base?</button>
                        <button class="chat-suggestion" onclick="askSuggestion(this)">Was ist Decision Architecture?</button>
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrap">
                    <textarea class="chat-input" id="chatInput" placeholder="Stelle eine Frage an BEATRIX..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat()}" oninput="autoResize(this)"></textarea>
                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendChat()" title="Senden">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="upload-section">
        <div class="container">
            <div class="section-header"><h2>Dokument hochladen</h2><p>PDFs, Texte und Axiom-Definitionen in die BEATRIX Knowledge Base einfügen.</p></div>
            <div class="db-selector">
                <div class="db-option selected" data-db="knowledge_base" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--accent)"></span> Knowledge Base</div><div class="db-option-desc">Dokumente & Literatur</div></div>
                <div class="db-option" data-db="bcm_axioms" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--success)"></span> BCM Axiome</div><div class="db-option-desc">Axiom-Definitionen</div></div>
                <div class="db-option" data-db="research" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--warning)"></span> Research Papers</div><div class="db-option-desc">Akademische Publikationen</div></div>
            </div>
            <div class="tabs"><button class="tab active" onclick="switchTab('file',this)">Datei-Upload</button><button class="tab" onclick="switchTab('text',this)">Text eingeben</button></div>
            <div class="file-section active" id="file-section">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    <h3>Dateien hierher ziehen oder <span>durchsuchen</span></h3>
                    <p>Maximal 50 MB pro Datei</p>
                    <div class="upload-formats"><span class="format-badge">PDF</span><span class="format-badge">TXT</span><span class="format-badge">MD</span><span class="format-badge">DOCX</span><span class="format-badge">CSV</span><span class="format-badge">JSON</span></div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md,.docx,.csv,.json" style="display:none">
                <div class="file-list" id="fileList"></div>
            </div>
            <div class="text-section" id="text-section">
                <div class="input-group"><label>Titel</label><input type="text" class="input-field" id="textTitle" placeholder="z.B. Axiom INU-3200 Definition"></div>
                <div class="input-row">
                    <div class="input-group"><label>Kategorie</label><select class="input-field" id="textCategory"><option value="general">Allgemein</option><option value="axiom">Axiom</option><option value="paper">Paper</option><option value="note">Notiz</option></select></div>
                    <div class="input-group"><label>Sprache</label><select class="input-field" id="textLang"><option value="de">Deutsch</option><option value="en">English</option></select></div>
                </div>
                <div class="input-group"><label>Tags</label><div class="tag-container" onclick="this.querySelector('.tag-input').focus()"><input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter"></div></div>
                <div class="input-group"><label>Inhalt</label><textarea class="textarea-field" id="textContent" placeholder="Text oder Axiom-Definition hier einfügen..."></textarea></div>
            </div>
            <div class="actions">
                <span class="upload-count" id="uploadCount"></span>
                <div style="display:flex;gap:10px;align-items:center">
                    <button class="btn btn-secondary" onclick="clearAll()">Zurücksetzen</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitUpload()">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        In Datenbank laden
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="documents-section">
        <div class="container"><div class="section-header"><h2>Dokumente</h2><p>Übersicht aller indexierten Dokumente in der BEATRIX Knowledge Base.</p></div><div id="docTableWrapper"></div></div>
    </section>

    <!-- ═══════ MODEL BUILDING SECTION ═══════ -->
    <section class="section" id="model-section">
        <div class="container">
            <div class="mb-header">
                <div>
                    <h2>Modell-Building</h2>
                    <p>Evidenzbasierte Verhaltensmodelle mit dem EEE Workflow designen</p>
                </div>
                <button class="mb-btn mb-btn-secondary" onclick="mbShowRegistry()" id="mbRegistryBtn">📋 Modell-Registry (21)</button>
            </div>

            <!-- PROGRESS BAR -->
            <div class="mb-progress" id="mbProgress" style="display:none">
                <div class="mb-step-dot active" data-step="0"><div class="mb-step-num">0</div><div class="mb-step-label">Init</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="1"><div class="mb-step-num">1</div><div class="mb-step-label">Entry Point</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="2"><div class="mb-step-num">2</div><div class="mb-step-label">Scope</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="3"><div class="mb-step-num">3</div><div class="mb-step-label">Kontext Ψ</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="4"><div class="mb-step-num">4</div><div class="mb-step-label">Modell</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="5"><div class="mb-step-num">5</div><div class="mb-step-label">Parameter</div></div>
                <div class="mb-step-line"></div>
                <div class="mb-step-dot" data-step="6"><div class="mb-step-num">6</div><div class="mb-step-label">Ergebnis</div></div>
            </div>

            <!-- ═══ START: Mode Selection ═══ -->
            <div class="mb-panel active" id="mbStart">
                <div class="mb-step-title">Neues Verhaltensmodell designen</div>
                <div class="mb-step-desc">Der EEE Workflow (Appendix EEE: METHOD-DESIGN) führt dich Schritt für Schritt zum evidenzbasierten Modell. Wähle deinen Modus:</div>

                <div class="mb-mode-cards">
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'schnell')">
                        <div class="mb-mode-icon">⚡</div>
                        <div class="mb-mode-name">Schnell</div>
                        <div class="mb-mode-time">~10 Minuten</div>
                        <div class="mb-mode-desc">3 Fragen → komplettes 10C Modell via GGG Defaults</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'gefuehrt')">
                        <div class="mb-mode-icon">🎯</div>
                        <div class="mb-mode-name">Geführt</div>
                        <div class="mb-mode-time">~45 Minuten</div>
                        <div class="mb-mode-desc">Alle Steps mit Erklärungen & 3+1 Optionen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'template')">
                        <div class="mb-mode-icon">📦</div>
                        <div class="mb-mode-name">Template</div>
                        <div class="mb-mode-time">~20 Minuten</div>
                        <div class="mb-mode-desc">Seed-Modell aus Registry anpassen</div>
                    </div>
                    <div class="mb-mode-card" onclick="mbSelectMode(this,'custom')">
                        <div class="mb-mode-icon">🔧</div>
                        <div class="mb-mode-name">Custom</div>
                        <div class="mb-mode-time">Variabel</div>
                        <div class="mb-mode-desc">Freie Gestaltung, maximale Kontrolle</div>
                    </div>
                </div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-primary" id="mbStartBtn" disabled onclick="mbStartWorkflow()">Workflow starten →</button>
                </div>
            </div>

            <!-- ═══ STEP 0: Session Init ═══ -->
            <div class="mb-panel" id="mbStep0">
                <!-- VIEW A: Choices -->
                <div id="mbStep0ViewA">
                    <div class="mb-step-title">Wähle deine Problemstellung</div>
                    <div class="mb-step-desc">BEATRIX leitet daraus Domain, Scope und Lieferobjekte ab.</div>

                    <div id="mbStep0Choices" style="display:flex;flex-direction:column;gap:10px;margin:20px 0">
                        <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.5)">
                            <div style="font-size:24px;margin-bottom:8px">⏳</div>
                            Lade personalisierte Vorschläge...
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:8px">
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbShowCustomInput()">
                            <div class="mb-choice-icon" style="font-size:16px">✏️</div>
                            <div class="mb-choice-title">Eigene Problemstellung</div>
                        </div>
                        <div class="mb-choice" style="flex:1;border:1px dashed rgba(139,170,255,0.25)" onclick="mbLetBeatrixDefine()">
                            <div class="mb-choice-icon" style="font-size:16px">🤖</div>
                            <div class="mb-choice-title">BEATRIX definiert</div>
                        </div>
                    </div>

                    <div id="mbCustomInput" style="display:none;margin-top:16px">
                        <textarea class="mb-input mb-textarea" id="mbQuestion" placeholder="Beschreibe das Verhalten, die Entscheidung oder das Phänomen, das du modellieren möchtest..." style="min-height:80px"></textarea>
                        <div style="margin-top:10px">
                            <button class="mb-btn mb-btn-primary" onclick="mbProcessStep0()">Analysieren →</button>
                        </div>
                    </div>
                </div>

                <!-- VIEW B: Analysis (hidden initially) -->
                <div id="mbStep0ViewB" style="display:none">
                    <div class="mb-step-title">Session-Analyse</div>
                    <div id="mbStep0SelectedQ" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;line-height:1.6"></div>

                    <div id="mbProgress0" class="mb-inline-progress" style="display:none"></div>

                    <div id="mbStep0Result" style="display:none">
                        <div class="mb-summary" id="mbSessionSummary"></div>
                    </div>

                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep0Back()">↻ Andere Frage</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep0Btn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 1: Entry Point ═══ -->
            <div class="mb-panel" id="mbStep1">
                <div id="mbStep1ViewA">
                    <div class="mb-step-title">Entry Point wählen</div>
                    <div class="mb-step-desc">Starte mit Theorie oder Praxis?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'theory')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📚</div>
                            <div class="mb-choice-title">Theory-Driven</div>
                            <div class="mb-choice-desc">Start mit existierenden CORE Appendices (AAA-AW). Passt, wenn du ein EBF-Konzept anwenden möchtest.</div>
                            <div class="mb-choice-meta">→ Begin with EBF concept</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'practice')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎯</div>
                            <div class="mb-choice-title">Practice-Driven</div>
                            <div class="mb-choice-desc">Start mit konkretem Problem oder Situation. Passt, wenn du ein reales Verhalten modellieren musst.</div>
                            <div class="mb-choice-meta">→ Begin with Gestaltungsanlass</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'hybrid')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Hybrid</div>
                            <div class="mb-choice-desc">Abwechselnde Theorie-Praxis-Zyklen. Passt, wenn Iteration erforderlich ist.</div>
                            <div class="mb-choice-meta">→ Theory ↔ Practice Iteration</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Freie Wahl — du definierst den Entry Point selbst.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(0)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep1Btn" onclick="mbConfirmAndAdvance(1,2)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 2: Scope ═══ -->
            <div class="mb-panel" id="mbStep2">
                <div id="mbStep2ViewA">
                    <div class="mb-step-title">Scope wählen</div>
                    <div class="mb-step-desc">Welchen Verhaltenstyp modellierst du?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'decision')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">⚖️</div>
                            <div class="mb-choice-title">Decision</div>
                            <div class="mb-choice-desc">Einmalentscheidung: Rentenmodell wählen, Impfung, Jobwechsel, Kaufentscheid.</div>
                            <div class="mb-choice-meta">Mathematik: Logistic / Binary Choice</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'continuous')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">📈</div>
                            <div class="mb-choice-title">Continuous</div>
                            <div class="mb-choice-desc">Wiederholtes Verhalten: Sparbetrag, Energieverbrauch, Trainingsfrequenz.</div>
                            <div class="mb-choice-meta">Mathematik: Linear / CES Functional Form</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'process')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔄</div>
                            <div class="mb-choice-title">Process</div>
                            <div class="mb-choice-desc">Veränderung über Zeit: Habit-Bildung, Learning, Adoption Journey.</div>
                            <div class="mb-choice-meta">Mathematik: Dynamic / BCJ Models</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Spezifisch definieren — kombiniere oder erweitere die Typen.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(1)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep2Btn" onclick="mbConfirmAndAdvance(2,3)">Weiter →</button>
                    </div>
                </div>
            </div>

            <!-- ═══ STEP 3: Context Ψ ═══ -->
            <div class="mb-panel" id="mbStep3">
                <div id="mbStep3ViewA">
                    <div class="mb-step-title">Kontext-Spezifikation (Ψ)</div>
                    <div class="mb-step-desc">Welche Kontextdimensionen sind relevant?</div>
                    <div class="mb-choices">
                        <div class="mb-choice" onclick="mbSelect(this,'ggg-default')">
                            <div class="mb-choice-num">1</div>
                            <div class="mb-choice-icon">📊</div>
                            <div class="mb-choice-title">GGG Defaults</div>
                            <div class="mb-choice-desc">Vorkonfigurierte Ψ-Werte nach Domain & Level aus Tabelle GGG-1 (trust, digital_adoption, autonomy, risk_aversion).</div>
                            <div class="mb-choice-meta">Empfohlen für Schnell-Modus</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'custom-psi')">
                            <div class="mb-choice-num">2</div>
                            <div class="mb-choice-icon">🎛️</div>
                            <div class="mb-choice-title">Custom Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Du definierst explizit welche Ψ-Faktoren relevant sind (z.B. Saisonalität, Peer Effects, Availability).</div>
                            <div class="mb-choice-meta">Für spezifische Kontexte</div>
                        </div>
                        <div class="mb-choice" onclick="mbSelect(this,'full-8psi')">
                            <div class="mb-choice-num">3</div>
                            <div class="mb-choice-icon">🔬</div>
                            <div class="mb-choice-title">Alle 8 Ψ-Dimensionen</div>
                            <div class="mb-choice-desc">Vollständige Analyse: Ψ_I, Ψ_S, Ψ_K, Ψ_C, Ψ_T, Ψ_E, Ψ_M, Ψ_F.</div>
                            <div class="mb-choice-meta">Maximale Tiefe</div>
                        </div>
                        <div class="mb-choice custom-choice" onclick="mbSelect(this,'custom')">
                            <div class="mb-choice-num">4</div>
                            <div class="mb-choice-icon">🔧</div>
                            <div class="mb-choice-title">Custom</div>
                            <div class="mb-choice-desc">Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.</div>
                        </div>
                    </div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-primary" disabled id="mbStep3Btn" onclick="mbProcessStep3()">BEATRIX analysieren lassen →</button>
                    </div>
                </div>

                <!-- ViewB: Processing -->
                <div id="mbStep3ViewB" style="display:none">
                    <div class="mb-step-title">Ψ-Kontext wird analysiert</div>
                    <div id="mbStep3Selection" style="font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:16px;padding:12px 16px;background:rgba(139,170,255,0.05);border-left:3px solid var(--accent);border-radius:0 8px 8px 0"></div>
                    <div id="mbProgress3" class="mb-inline-progress" style="display:none"></div>
                    <div id="mbStep3Result" style="margin-top:16px"></div>
                    <div class="mb-actions">
                        <button class="mb-btn mb-btn-back" onclick="mbGoStep(2)">← Zurück</button>
                        <button class="mb-btn mb-btn-back" onclick="mbStep3Back()">↻ Andere Wahl</button>
                        <button class="mb-btn mb-btn-primary" id="mbStep3NextBtn" disabled>BEATRIX analysiert...</button>
                    </div>
                </div>
            </div>
                </div>
            </div>

            <!-- ═══ STEP 4: Model ═══ -->
            <div class="mb-panel" id="mbStep4">
                <div class="mb-step-title">Schritt 4: Modell-Spezifikation</div>
                <div class="mb-step-desc">BEATRIX durchsucht die Modell-Registry und baut das 10C-Mapping.</div>
                <div id="mbModelResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">📊</div>
                        Klicke «Modell erstellen» um die Analyse zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(3)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep4Btn" onclick="mbRunStep4()">Modell erstellen →</button>
                </div>
            </div>

            <!-- ═══ STEP 5: Parameters ═══ -->
            <div class="mb-panel" id="mbStep5">
                <div class="mb-step-title">Schritt 5: Parameter-Schätzung</div>
                <div class="mb-step-desc">LLMMC Prior generieren und Bayesian Updating mit BCM2 & Papers.</div>
                <div id="mbParamResult" style="min-height:120px">
                    <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">
                        <div style="font-size:20px;margin-bottom:8px">🔬</div>
                        Klicke «Parameter schätzen» um die Berechnung zu starten.
                    </div>
                </div>
                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(4)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbStep5Btn" onclick="mbRunStep5()">Parameter schätzen →</button>
                </div>
            </div>

            <!-- ═══ STEP 6: Result ═══ -->
            <div class="mb-panel" id="mbStep6">
                <div class="mb-step-title">Schritt 6: Ergebnis & Report</div>
                <div class="mb-step-desc">Wähle die Report-Tiefe. BEATRIX streamt den Bericht live.</div>

                <!-- Depth Choice -->
                <div id="mbDepthChoice" style="display:flex;gap:12px;margin:20px 0">
                    <div onclick="mbSelectDepth('standard', this)" id="mbDepthStd" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">📋 Standard</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Kompakter Report mit Key Facts, 10C Mapping, BCM Parametern und Handlungsempfehlungen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~15 Sek. · 1–2 Seiten</div>
                    </div>
                    <div onclick="mbSelectDepth('deep', this)" id="mbDepthDeep" style="flex:1;padding:18px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s"
                         onmouseover="if(!this.classList.contains('depth-active'))this.style.background='rgba(255,255,255,0.04)'"
                         onmouseout="if(!this.classList.contains('depth-active'))this.style.background='transparent'">
                        <div style="font-size:15px;font-weight:600;color:white;margin-bottom:6px">🔬 Standard++</div>
                        <div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5">Vertiefte Analyse mit Ψ-Kontext-Matrix, Sensitivitätsanalyse, Interventions-Roadmap und Detail-Tabellen.</div>
                        <div style="font-size:11px;color:var(--accent);margin-top:8px">~30 Sek. · 4–6 Seiten</div>
                    </div>
                </div>

                <!-- Progress Container -->
                <div id="mbComputeProgress" style="margin:24px 0;display:none">
                    <div style="display:flex;align-items:center;gap:12px">
                        <div id="mbComputeSpinner" style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                        <div>
                            <div id="mbComputeStage" style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)">Verbinde mit BEATRIX...</div>
                            <div id="mbComputeDetail" style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px"></div>
                        </div>
                    </div>
                    <div id="mbComputeStages"></div>
                    <div id="mbComputeTime" style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px"></div>
                    <div id="mbProgressBar" style="display:none"></div>
                    <div id="mbComputePercent" style="display:none"></div>
                </div>

                <!-- Result (streamed) -->
                <div id="mbResultContent" style="display:none"></div>

                <div class="mb-actions">
                    <button class="mb-btn mb-btn-back" onclick="mbGoStep(5)">← Zurück</button>
                    <button class="mb-btn mb-btn-primary" id="mbComputeBtn" onclick="mbComputeResult()" disabled style="opacity:0.4">Report generieren →</button>
                    <button class="mb-btn mb-btn-primary" id="mbExportBtn" onclick="mbExportModel()" style="display:none">📄 Exportieren</button>
                    <button class="mb-btn mb-btn-secondary" onclick="mbGoToStart()" style="display:none" id="mbNewModelBtn">Neues Modell</button>
                </div>
            </div>

            <!-- ═══ REGISTRY VIEW ═══ -->
            <div class="mb-panel" id="mbRegistry">
                <div class="mb-step-title">Modell-Registry</div>
                <div class="mb-step-desc">21 evidenzbasierte Modelle im EBF Framework.</div>
                <div class="mb-registry" id="mbRegistryList"></div>
                <div class="mb-actions" style="margin-top:20px">
                    <button class="mb-btn mb-btn-back" onclick="mbGoToStart()">← Zurück zum Workflow</button>
                </div>
            </div>

        </div>
    </section>

    <!-- ═══════ AUSGANGSLAGE / KONTEXT SECTION ═══════ -->
    <section class="section" id="context-section">
        <div class="container">
            <div class="section-header">
                <h2>Ausgangslage</h2>
                <p>Kontext und Rahmenbedingungen für Projekte und Mandate erfassen.</p>
            </div>

            <!-- Context Cards Grid -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px">
                <div style="padding:16px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Aktive Kontexte</div>
                    <div id="ctxKpiActive" style="font-size:28px;font-weight:700;color:white;margin:6px 0">–</div>
                    <div style="font-size:11px;color:rgba(139,170,255,0.7)">erfasst</div>
                </div>
                <div style="padding:16px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Laufende Mandate</div>
                    <div id="ctxKpiActive2" style="font-size:28px;font-weight:700;color:#34d399;margin:6px 0">–</div>
                    <div style="font-size:11px;color:rgba(52,211,153,0.7)">aktiv</div>
                </div>
                <div style="padding:16px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:11px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Zuletzt aktualisiert</div>
                    <div id="ctxKpiLast" style="font-size:16px;font-weight:700;color:var(--accent-light);margin:6px 0">–</div>
                    <div style="font-size:11px;color:rgba(139,170,255,0.7)">letztes Update</div>
                </div>
            </div>

            <!-- New Context Button -->
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                <div style="font-size:14px;font-weight:600;color:white">Kontexte <span id="ctxCount" style="font-size:12px;color:rgba(255,255,255,0.4)"></span></div>
                <button class="mb-btn mb-btn-primary" onclick="ctxShowAdd()" style="font-size:12px;padding:6px 14px">+ Neuer Kontext</button>
            </div>

            <!-- Add Context Form (hidden) -->
            <div id="ctxAddForm" style="display:none;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
                <div style="font-size:14px;font-weight:600;color:white;margin-bottom:12px">Neuer Kontext / Ausgangslage</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <input class="mb-input" id="ctxClient" placeholder="Kunde / Mandant" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="ctxProject" placeholder="Projekt / Mandat" style="font-size:13px;padding:8px 12px">
                    <select class="mb-input" id="ctxDomain" style="font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                        <option value="">Domain wählen...</option>
                        <option value="FIN">Finanzen</option>
                        <option value="HLT">Gesundheit</option>
                        <option value="POL">Politik</option>
                        <option value="ORG">Organisation</option>
                        <option value="EDU">Bildung</option>
                        <option value="ENV">Umwelt / Energie</option>
                        <option value="REL">Beziehungen</option>
                        <option value="OTH">Andere</option>
                    </select>
                    <select class="mb-input" id="ctxStatus" style="font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                        <option value="aktiv">Aktiv</option>
                        <option value="planung">In Planung</option>
                        <option value="abgeschlossen">Abgeschlossen</option>
                        <option value="pausiert">Pausiert</option>
                    </select>
                </div>
                <textarea class="mb-input" id="ctxSituation" placeholder="Ausgangslage: Was ist die aktuelle Situation des Kunden? Welches Problem soll gelöst werden?" style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:80px;width:100%;box-sizing:border-box"></textarea>
                <textarea class="mb-input" id="ctxGoal" placeholder="Ziel: Was soll erreicht werden? Welches Verhalten soll verändert werden?" style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:60px;width:100%;box-sizing:border-box"></textarea>
                <textarea class="mb-input" id="ctxConstraints" placeholder="Rahmenbedingungen: Budget, Zeitrahmen, Stakeholder, Einschränkungen..." style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:60px;width:100%;box-sizing:border-box"></textarea>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="mb-btn mb-btn-primary" onclick="ctxSave()" style="font-size:12px;padding:6px 14px">Speichern</button>
                    <button class="mb-btn mb-btn-back" onclick="document.getElementById('ctxAddForm').style.display='none'" style="font-size:12px;padding:6px 14px">Abbrechen</button>
                </div>
            </div>

            <!-- Context List -->
            <div id="ctxTable" style="display:flex;flex-direction:column;gap:10px">
                <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Kontexte werden geladen...</div>
            </div>
        </div>
    </section>

    <!-- ═══════ LEADS SECTION ═══════ -->
    <section class="section" id="leads-section">
        <div class="container">
            <div class="section-header">
                <h2>CRM</h2>
                <p>Pipeline, Kontakte und Lead-Management. <span id="crmDateInfo" style="color:rgba(255,255,255,0.3)"></span></p>
            </div>

            <!-- KPI Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px" id="crmKpis">
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Aktive Leads</div>
                    <div id="crmKpiActive" style="font-size:24px;font-weight:700;color:white;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Pipeline (gew.)</div>
                    <div id="crmKpiPipeline" style="font-size:24px;font-weight:700;color:var(--accent-light);margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Won</div>
                    <div id="crmKpiWon" style="font-size:24px;font-weight:700;color:#34d399;margin:4px 0">–</div>
                </div>
                <div style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Conversion</div>
                    <div id="crmKpiConv" style="font-size:24px;font-weight:700;color:#fbbf24;margin:4px 0">–</div>
                </div>
                <div onclick="crmShowCompanies()" style="padding:14px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:border-color 0.2s" onmouseover="this.style.borderColor='rgba(255,255,255,0.15)'" onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px">Firmen ↗</div>
                    <div id="crmKpiCompanies" style="font-size:24px;font-weight:700;color:rgba(255,255,255,0.6);margin:4px 0">–</div>
                </div>
            </div>

            <!-- View Toggle + Actions -->
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden">
                    <button class="fb-tool active" id="crmViewKanban" onclick="crmSetView('kanban')" style="border:none;border-radius:0;font-size:12px">▣ Kanban</button>
                    <button class="fb-tool" id="crmViewTable" onclick="crmSetView('table')" style="border:none;border-radius:0;font-size:12px">☰ Tabelle</button>
                </div>
                <div style="flex:1"></div>
                <button class="mb-btn mb-btn-primary" onclick="crmShowDealForm()" style="font-size:12px;padding:6px 14px">+ Neuer Lead</button>
                <button class="mb-btn mb-btn-back" onclick="crmSyncGithub()" style="font-size:12px;padding:6px 14px" id="crmSyncBtn">🔄 Synchronisieren</button>
            </div>

            <!-- Sync Hint -->
            <div id="crmSyncHint" style="display:none;padding:20px;background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.15);border-radius:12px;margin-bottom:16px;text-align:center;cursor:pointer" onclick="crmSyncGithub()">
                <div style="font-size:14px;color:white;margin-bottom:6px">🔄 60 Leads verfügbar</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-bottom:12px">Klicke hier um die Lead-Datenbank zu synchronisieren.</div>
                <button class="mb-btn mb-btn-primary" onclick="event.stopPropagation();crmSyncGithub()" style="font-size:13px;padding:10px 28px;cursor:pointer">Jetzt synchronisieren</button>
            </div>

            <!-- New Deal Form (hidden) -->
            <div id="crmDealForm" style="display:none;padding:20px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px;margin-bottom:16px">
                <div style="font-size:14px;font-weight:600;color:white;margin-bottom:12px" id="crmDealFormTitle">Neuer Lead</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                    <input class="mb-input" id="crmDealTitle" placeholder="Lead-Titel / Projekt" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealCompany" placeholder="Firma" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealContact" placeholder="Kontaktperson" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealEmail" placeholder="E-Mail" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealValue" placeholder="Wert (CHF)" type="number" style="font-size:13px;padding:8px 12px">
                    <select class="mb-input" id="crmDealStage" style="font-size:13px;padding:8px 12px;background:var(--navy-card);color:white;border:1px solid var(--border)">
                        <option value="prospect">Prospect</option>
                        <option value="qualified">Qualified</option>
                        <option value="proposal">Proposal</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="won">Won</option>
                        <option value="active">Active</option>
                    </select>
                    <input class="mb-input" id="crmDealSource" placeholder="Quelle" style="font-size:13px;padding:8px 12px">
                    <input class="mb-input" id="crmDealNextAction" placeholder="Nächste Aktion" style="font-size:13px;padding:8px 12px">
                </div>
                <textarea class="mb-input" id="crmDealNotes" placeholder="Notizen..." style="font-size:13px;padding:8px 12px;margin-top:10px;min-height:50px;width:100%;box-sizing:border-box"></textarea>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="mb-btn mb-btn-primary" onclick="crmSaveDeal()" style="font-size:12px;padding:6px 14px">Speichern</button>
                    <button class="mb-btn mb-btn-back" onclick="document.getElementById('crmDealForm').style.display='none'" style="font-size:12px;padding:6px 14px">Abbrechen</button>
                </div>
            </div>

            <!-- Kanban Board -->
            <!-- Company Filter Banner -->
            <div id="crmFilterBanner" style="display:none;align-items:center;gap:10px;padding:10px 16px;background:rgba(42,127,142,0.08);border:1px solid rgba(42,127,142,0.2);border-radius:10px;margin-bottom:12px">
                <span style="font-size:12px;color:#2A7F8E">🏢 Gefiltert nach Firma</span>
                <span style="flex:1"></span>
                <button onclick="crmClearFilter()" style="font-size:11px;padding:4px 12px;background:rgba(42,127,142,0.15);color:#2A7F8E;border:1px solid rgba(42,127,142,0.3);border-radius:8px;cursor:pointer">✕ Filter aufheben</button>
            </div>

            <div id="crmKanban" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:12px;min-height:300px">
                <!-- Columns injected by JS -->
            </div>

            <!-- Table View (hidden) -->
            <div id="crmTable" style="display:none;overflow-x:auto">
                <div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Laden...</div>
            </div>
        </div>
    </section>

    <!-- Deal Detail Drawer -->
    <div id="crmDrawer" style="display:none;position:fixed;top:0;right:0;bottom:0;width:min(440px,90vw);z-index:9000;background:var(--navy-card);border-left:1px solid var(--border);box-shadow:-8px 0 30px rgba(0,0,0,0.4);overflow-y:auto;transition:transform 0.25s ease">
        <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
            <div style="flex:1">
                <div style="font-size:16px;font-weight:700;color:white" id="crmDrawerTitle">Lead</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4)" id="crmDrawerCompany">Firma</div>
            </div>
            <button onclick="crmCloseDrawer()" style="border:none;background:none;color:rgba(255,255,255,0.4);font-size:18px;cursor:pointer;padding:4px">✕</button>
        </div>
        <div id="crmDrawerContent" style="padding:16px"></div>
    </div>

    <!-- Companies Section (full page) -->
    <section class="section" id="companies-section">
        <div class="container">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap">
                <div style="flex:1">
                    <h2 style="margin:0;font-size:22px;color:white">🏢 Firmen</h2>
                    <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="crmCompaniesCount"></div>
                </div>
                <input id="crmCompaniesSearch" type="text" placeholder="Suchen nach Name, Branche, Land…" oninput="crmFilterCompanies()" style="font-size:13px;padding:8px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;color:white;width:min(300px,50vw);outline:none">
                <button onclick="showSection('leads',document.querySelector('[data-section=leads]'))" style="font-size:12px;padding:6px 14px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;color:rgba(255,255,255,0.5);cursor:pointer">← CRM</button>
            </div>
            <div id="crmCompaniesList" style="background:var(--navy-card);border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
        </div>
    </section>

    <section class="section" id="admin-section">
        <div class="container">
            <div class="section-header"><h2>⚙ Administration</h2><p>Benutzer verwalten und Systemeinstellungen konfigurieren.</p></div>
            <div class="admin-cards" id="adminCards">
                <div class="admin-card"><div class="admin-card-label">Benutzer</div><div class="admin-card-value" id="adminStatUsers">–</div><div class="admin-card-sub">Registriert</div></div>
                <div class="admin-card"><div class="admin-card-label">Registrierung</div><div class="admin-card-value" id="adminStatReg" style="font-size:18px">–</div><div class="admin-card-sub" id="adminStatRegSub"></div></div>
                <div class="admin-card"><div class="admin-card-label">Dokumente</div><div class="admin-card-value" id="adminStatDocs">–</div><div class="admin-card-sub">In Datenbank</div></div>
                <div class="admin-card" style="cursor:pointer" onclick="document.getElementById('adminFeedbackSection').scrollIntoView({behavior:'smooth'})"><div class="admin-card-label">Feedback</div><div class="admin-card-value" id="adminStatFb">–</div><div class="admin-card-sub" id="adminStatFbSub">offen</div></div>
            </div>
            <div class="admin-section-title">Benutzer <span class="badge" id="adminUserCount">0</span></div>
            <div id="adminUserTable"></div>
            <div class="admin-section-title" style="margin-top:32px" id="adminFeedbackSection">Feedback <span class="badge" id="adminFbCount">0</span></div>
            <div id="adminFeedbackList"></div>
            <div class="admin-section-title" style="margin-top:32px">Einstellungen</div>
            <div id="adminSettings"></div>
        </div>
    </section>

    <!-- ═══════ PROFILE SECTION ═══════ -->
    <section class="section" id="profile-section">
        <div class="container">
            <div class="section-header"><h2>Profil</h2><p>Dein persönliches Profil in der BEATRIX Intelligence Suite.</p></div>
            <div class="profile-grid">
                <div>
                    <div class="profile-card">
                        <div class="profile-avatar-wrap">
                            <div class="profile-avatar" id="profileAvatar">
                                <span id="profileInitials"></span>
                            </div>
                            <label class="profile-avatar-edit" for="photoUpload" title="Foto ändern">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                            </label>
                            <input type="file" id="photoUpload" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadPhoto(this)">
                        </div>
                        <div class="profile-name" id="profileDisplayName">–</div>
                        <div class="profile-position" id="profileDisplayPosition">–</div>
                        <div class="profile-meta">
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M2 8h20"/></svg>
                                <span id="profileDisplayEmail">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                <span id="profileDisplayCompany">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.362 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.338 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                                <span id="profileDisplayPhone">–</span>
                            </div>
                            <div class="profile-meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                                <span>Mitglied seit <span id="profileMemberSince">–</span></span>
                            </div>
                        </div>
                        <div class="linkedin-section">
                            <button class="linkedin-btn" id="linkedinBtn" onclick="connectLinkedIn()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                <span id="linkedinBtnText">Mit LinkedIn verbinden</span>
                            </button>
                        </div>
                    </div>
                    <div class="profile-card" style="margin-top:16px">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">Expertise</div>
                            <div class="profile-tags" id="profileExpertiseTags"></div>
                            <div style="display:flex;gap:8px;margin-top:10px">
                                <input type="text" class="modal-input" id="expertiseInput" placeholder="Neue Expertise + Enter" style="flex:1;margin:0;font-size:12px;padding:6px 10px" onkeydown="if(event.key==='Enter'){addExpertise();event.preventDefault()}">
                            </div>
                        </div>
                    </div>
                    <!-- ═══ Ψ-PROFILE CARD ═══ -->
                    <div class="profile-card" style="margin-top:16px" id="psiProfileCard">
                        <div style="text-align:left">
                            <div style="font-size:12px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px">🧠 Ψ-Profil</div>
                            <div id="psiProfileContent" style="color:var(--text-secondary);font-size:13px">Lade Ψ-Profil...</div>
                        </div>
                    </div>
                </div>
                <div class="profile-form">
                    <h3>Profil bearbeiten</h3>
                    <div class="profile-row">
                        <div class="profile-field"><label>Name</label><input type="text" id="profileName" placeholder="Vor- und Nachname"></div>
                        <div class="profile-field"><label>Position</label><input type="text" id="profilePosition" placeholder="z.B. CEO, Researcher"></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field"><label>Unternehmen</label><input type="text" id="profileCompany" placeholder="z.B. FehrAdvice & Partners AG"></div>
                        <div class="profile-field"><label>Telefon</label><input type="text" id="profilePhone" placeholder="+41 ..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>LinkedIn URL</label><input type="text" id="profileLinkedin" placeholder="https://linkedin.com/in/..."></div>
                    </div>
                    <div class="profile-row">
                        <div class="profile-field full"><label>Bio</label><textarea id="profileBio" placeholder="Kurze Beschreibung, Schwerpunkte, Forschungsinteressen..."></textarea></div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary" onclick="openPwModal()">🔑 Passwort ändern</button>
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Profil speichern
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══ Decision Confirmation Overlay ═══ -->
    <div id="mbConfirmOverlay" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(8,12,24,0.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);opacity:0;transition:opacity 0.3s ease">
        <div id="mbConfirmCard" style="position:absolute;bottom:0;left:0;right:0;background:var(--navy-mid);border-top:1px solid var(--border);padding:28px 24px 36px;transform:translateY(100%);transition:transform 0.35s cubic-bezier(0.22,1,0.36,1);max-height:70vh;overflow-y:auto">
            <div style="max-width:680px;margin:0 auto">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
                    <div id="mbConfirmIcon" style="font-size:28px;flex-shrink:0"></div>
                    <div>
                        <div id="mbConfirmStep" style="font-size:11px;color:var(--accent);font-weight:600;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:2px"></div>
                        <div id="mbConfirmTitle" style="font-size:18px;font-weight:700;color:white"></div>
                    </div>
                </div>
                <div id="mbConfirmBody" style="font-size:14px;line-height:1.7;color:rgba(255,255,255,0.7);margin-bottom:20px"></div>
                <div id="mbConfirmImplication" style="background:rgba(139,170,255,0.06);border:1px solid rgba(139,170,255,0.12);border-radius:10px;padding:14px 16px;margin-bottom:24px">
                    <div style="font-size:11px;font-weight:600;color:var(--accent);letter-spacing:0.4px;text-transform:uppercase;margin-bottom:6px">Was das bedeutet</div>
                    <div id="mbConfirmImplText" style="font-size:13px;line-height:1.6;color:rgba(255,255,255,0.75)"></div>
                </div>
                <div style="display:flex;gap:12px">
                    <button onclick="mbConfirmBack()" style="padding:12px 20px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:14px;cursor:pointer">← Andere Wahl</button>
                    <button id="mbConfirmBtn" onclick="mbConfirmProceed()" style="flex:1;padding:12px 20px;border-radius:10px;border:none;background:var(--accent);color:white;font-size:14px;font-weight:600;cursor:pointer">Weiter →</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">BEATRIX – The Strategic Intelligence Suite · <a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> · Zürich</footer>
    <div class="toast-container" id="toastContainer"></div>

    <!-- ═══ INSIGHT QUESTION MODAL ═══ -->
    <div id="insightModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;padding:20px">
        <div style="background:var(--card);border-radius:20px;max-width:640px;width:100%;padding:36px;position:relative;border:1px solid rgba(139,170,255,0.15);max-height:90vh;overflow-y:auto">
            <div style="text-align:center;margin-bottom:20px">
                <div style="font-size:28px;margin-bottom:6px">🧠</div>
                <div style="font-size:14px;color:var(--accent);font-weight:600;letter-spacing:1px" id="insightLabel">Ψ-PROFILING</div>
                <div style="font-size:12px;color:rgba(255,255,255,0.4);margin-top:4px" id="insightCounter">Frage 1</div>
            </div>
            <div style="font-size:17px;line-height:1.5;color:rgba(255,255,255,0.9);text-align:center;margin-bottom:20px;font-weight:500" id="insightQuestion"></div>
            <div id="insightNudge" style="display:none;text-align:center;font-size:13px;color:var(--accent);margin-bottom:12px;font-style:italic"></div>
            <div id="insightChoices" style="display:flex;flex-direction:column;gap:8px"></div>
            <div style="display:flex;gap:12px;margin-top:20px;justify-content:center">
                <button id="insightSkipBtn" style="display:none;padding:10px 24px;border-radius:12px;border:1px solid rgba(255,255,255,0.15);background:transparent;color:rgba(255,255,255,0.5);cursor:pointer;font-size:14px" onclick="insightSkip()">Überspringen</button>
            </div>
            <div style="text-align:center;margin-top:14px">
                <div style="display:flex;gap:6px;justify-content:center" id="insightDots"></div>
            </div>
        </div>
    </div>

    <!-- ═══════ PASSWORD MODAL ═══════ -->
    <div class="modal-overlay" id="pwModal" onclick="if(event.target===this)closePwModal()">
        <div class="modal">
            <h3>🔑 Passwort ändern</h3>
            <div class="modal-msg" id="pwMsg"></div>
            <input type="password" class="modal-input" id="pwCurrent" placeholder="Aktuelles Passwort">
            <input type="password" class="modal-input" id="pwNew" placeholder="Neues Passwort (mind. 6 Zeichen)">
            <input type="password" class="modal-input" id="pwConfirm" placeholder="Neues Passwort bestätigen">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePwModal()">Abbrechen</button>
                <button class="btn btn-primary" id="pwBtn" onclick="changePassword()">Ändern</button>
            </div>
        </div>
    </div>

    <script>
        const API = '/api';
        console.log('🟢 BEATRIX v3.12.3 loaded — mbRenderMd active');
        let files=[], tags=[], selectedDB='knowledge_base', currentTab='file', authToken=null, currentUser=null;

        function H() { return authToken ? {'Authorization':`Bearer ${authToken}`} : {}; }

        // ── Auth ────────────────────────────────────────
        function showAuthPanel(panel) {
            document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panel+'Panel').classList.add('active');
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
        }

        async function checkAuth() {
            const saved = sessionStorage.getItem('bea_token');
            const user = sessionStorage.getItem('bea_user');
            if (saved) {
                try {
                    const r = await fetch(`${API}/auth/check`, {headers:{'Authorization':`Bearer ${saved}`}});
                    if (r.ok) {
                        authToken = saved;
                        currentUser = user ? JSON.parse(user) : (await r.json());
                        // Also check JWT for admin + CRM flags
                        try { const p = JSON.parse(atob(saved.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) {}
                        document.getElementById('authOverlay').classList.add('hidden');
                        document.getElementById('navUser').textContent = currentUser.name || currentUser.email;
                        if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
                        applyUserTabs();
                        console.log('Session restore:', currentUser.email, 'admin:', currentUser.admin);
                        if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
                        loadStats();
                        return;
                    }
                } catch(e) {}
                sessionStorage.removeItem('bea_token');
                sessionStorage.removeItem('bea_user');
            }
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function onAuthSuccess(data) {
            authToken = data.token;
            currentUser = data.user;
            // Decode JWT to get admin status + CRM access
            try { const p = JSON.parse(atob(data.token.split('.')[1])); currentUser.admin = p.admin || false; currentUser.role = p.role || 'researcher'; currentUser.crm_access = p.crm_access || false; currentUser.crm_role = p.crm_role || 'none'; currentUser.crm_owner_code = p.crm_owner_code || ''; currentUser.lead_management = p.lead_management || false; } catch(e) { currentUser.admin = false; currentUser.role = 'researcher'; currentUser.crm_access = false; }
            sessionStorage.setItem('bea_token', authToken);
            sessionStorage.setItem('bea_user', JSON.stringify(currentUser));
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('navUser').textContent = data.user.name || data.user.email;
            if (currentUser.admin) document.getElementById('navAdmin').style.display = 'inline';
            applyUserTabs();
            console.log('Auth success:', currentUser.email, 'admin:', currentUser.admin);
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'flex';
            loadStats();
            showToast(`Willkommen, ${data.user.name || data.user.email}!`, 'success');
            // Trigger insight question after login
            setTimeout(() => insightStart('login'), 800);
        }

        // ── Insight / Ψ-Profiling (5-Choice Architecture) ──────────
        let insightState = { questionNum: 0, currentQuestion: null, startTime: null, context: 'login' };

        async function insightStart(context = 'login') {
            insightState = { questionNum: 0, currentQuestion: null, startTime: null, context };
            await insightNext();
        }

        async function insightNext() {
            try {
                const resp = await fetch(`${API}/insight/question?context=${insightState.context}`, { headers: H() });
                if (!resp.ok) return insightClose();
                const data = await resp.json();
                insightState.currentQuestion = data;
                insightState.startTime = Date.now();
                insightState.questionNum = data.question_number;

                const modal = document.getElementById('insightModal');
                modal.style.display = 'flex';
                document.getElementById('insightQuestion').textContent = data.question;
                document.getElementById('insightCounter').textContent = `Frage ${data.question_number}` + (data.total_answered > 0 ? ` · ${data.total_answered} bisherige` : '');

                // Label: mandatory / nudged / voluntary
                const label = document.getElementById('insightLabel');
                if (data.is_mandatory) {
                    label.textContent = 'Ψ-PROFILING · PFLICHTFRAGE';
                    label.style.color = 'var(--accent)';
                } else if (data.is_nudged) {
                    label.textContent = 'Ψ-PROFILING · EMPFOHLEN';
                    label.style.color = '#f59e0b';
                } else {
                    label.textContent = 'Ψ-PROFILING · FREIWILLIG';
                    label.style.color = 'rgba(255,255,255,0.4)';
                }

                // Nudge message
                const nudgeEl = document.getElementById('insightNudge');
                if (data.nudge_message) { nudgeEl.textContent = data.nudge_message; nudgeEl.style.display = 'block'; }
                else { nudgeEl.style.display = 'none'; }

                // Render 5 choice cards
                const choicesEl = document.getElementById('insightChoices');
                if (data.choices && data.choices.length > 0) {
                    choicesEl.innerHTML = data.choices.map((c, i) => `
                        <div onclick="insightSelectChoice(this, ${i + 1}, '${(c.label || '').replace(/'/g, "\'")}')"
                             style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:background 0.15s;-webkit-tap-highlight-color:rgba(139,170,255,0.2)"
                             onmouseover="this.style.background='rgba(255,255,255,0.06)'"
                             onmouseout="if(!this.classList.contains('ins-selected'))this.style.background='transparent'">
                            <div style="font-size:18px;flex-shrink:0;width:28px;text-align:center">${c.icon || '○'}</div>
                            <div style="font-size:15px;color:rgba(255,255,255,0.8)">${c.label}</div>
                        </div>
                    `).join('');
                } else {
                    choicesEl.innerHTML = '';
                }

                // Skip button
                document.getElementById('insightSkipBtn').style.display = data.can_skip ? 'block' : 'none';

                // Progress dots
                const dotsEl = document.getElementById('insightDots');
                let dots = '';
                for (let i = 1; i <= Math.max(3, data.question_number); i++) {
                    const active = i === data.question_number;
                    const done = i < data.question_number;
                    dots += `<div style="width:8px;height:8px;border-radius:50%;background:${done ? 'var(--accent)' : active ? 'white' : 'rgba(255,255,255,0.2)'}"></div>`;
                }
                dotsEl.innerHTML = dots;
            } catch(e) {
                console.error('Insight load error:', e);
                insightClose();
            }
        }

        async function insightSelectChoice(el, choiceIndex, choiceLabel) {
            // Mark selected
            el.parentElement.querySelectorAll('div[onclick]').forEach(c => {
                c.classList.remove('ins-selected');
                c.style.background = 'transparent';
            });
            el.classList.add('ins-selected');
            el.style.background = 'rgba(139,170,255,0.12)';

            await new Promise(r => setTimeout(r, 300));

            const latency = Date.now() - insightState.startTime;
            const q = insightState.currentQuestion;

            try {
                await fetch(`${API}/insight/answer`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question,
                        question_id: q.question_id,
                        answer_text: choiceLabel,
                        choice_index: choiceIndex,
                        latency_ms: latency,
                        question_number: q.question_number,
                        was_mandatory: q.is_mandatory,
                        was_nudged: q.is_nudged,
                        skipped: false,
                        context: insightState.context,
                    })
                });

                // Flow: mandatory→next, nudged→next, voluntary→ask
                if (q.question_number < 3) {
                    await insightNext();
                } else {
                    insightClose();
                    showToast('Ψ-Profil aktualisiert ✓', 'success');
                }
            } catch(e) {
                console.error('Insight submit error:', e);
            }
        }

        async function insightSkip() {
            const q = insightState.currentQuestion;
            try {
                await fetch(`${API}/insight/skip`, {
                    method: 'POST',
                    headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_text: q.question, question_id: q.question_id,
                        question_number: q.question_number, context: insightState.context,
                    })
                });
            } catch(e) {}
            insightClose();
            showToast('Ψ-Profiling übersprungen', 'info');
        }

        function insightClose() {
            document.getElementById('insightModal').style.display = 'none';
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Anmelden...'; err.classList.remove('visible');
            try {
                const r = await fetch(`${API}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                if (!r.ok) {
                    const d=await r.json().catch(()=>({}));
                    const msg = d.detail||'Anmeldung fehlgeschlagen.';
                    if (r.status === 403 && msg.includes('nicht bestätigt')) {
                        err.innerHTML = msg + ' <a style="color:var(--accent);cursor:pointer;font-weight:600" onclick="resendFromLogin()">Erneut senden</a>';
                    } else { err.textContent = msg; }
                    err.classList.add('visible'); btn.disabled=false; btn.textContent='Anmelden'; return;
                }
                onAuthSuccess(await r.json());
            } catch(e) { err.textContent='Verbindungsfehler: ' + e.message + ' [' + API + '/login]'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Anmelden';
        }

        async function resendFromLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            if (!email || !pw) return;
            const err = document.getElementById('loginError');
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { err.innerHTML='✓ Neuer Bestätigungslink gesendet!'; err.style.color='var(--success)'; }
                else { err.textContent = d.detail || 'Fehler'; }
            } catch(e) { err.textContent='Verbindungsfehler'; }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            const err = document.getElementById('forgotError');
            const suc = document.getElementById('forgotSuccess');
            err.classList.remove('visible'); suc.style.display='none';
            if (!email) { err.textContent='Bitte E-Mail-Adresse eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Wird gesendet...';
            try {
                const r = await fetch(`${API}/forgot-password`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})});
                const d = await r.json();
                if (r.ok) { suc.textContent='✓ ' + d.message; suc.style.display='block'; }
                else { err.textContent=d.detail||'Fehler'; err.classList.add('visible'); }
            } catch(e) { err.textContent='Verbindungsfehler'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Reset-Link senden';
        }

        async function doRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pw = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');
            const err = document.getElementById('registerError');
            const suc = document.getElementById('registerSuccess');
            err.classList.remove('visible'); if(suc) suc.classList.remove('visible');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            if (pw.length < 6) { err.textContent='Passwort muss mindestens 6 Zeichen haben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Registrieren...';
            try {
                const r = await fetch(`${API}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw, name:name||null})});
                const d = await r.json();
                if (!r.ok) { err.textContent=d.detail||'Registrierung fehlgeschlagen.'; err.classList.add('visible'); btn.disabled=false; btn.textContent='Registrieren'; return; }
                if (d.status === 'verification_required') {
                    // Show verification message
                    if(suc) { suc.textContent = d.message; suc.classList.add('visible'); }
                    else { err.style.color='var(--success)'; err.style.background='var(--success-bg)'; err.style.borderColor='rgba(52,211,153,0.15)'; err.textContent = d.message; err.classList.add('visible'); }
                    btn.disabled=false; btn.textContent='Registrieren';
                    // Show resend link
                    setTimeout(() => {
                        const resendEl = document.getElementById('resendArea');
                        if (resendEl) { resendEl.style.display='block'; resendEl.dataset.email=email; resendEl.dataset.pw=pw; }
                    }, 500);
                    return;
                }
                onAuthSuccess(d);
            } catch(e) { err.textContent='Verbindungsfehler.'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Registrieren';
        }

        async function resendVerification() {
            const resendEl = document.getElementById('resendArea');
            const email = resendEl?.dataset.email;
            const pw = resendEl?.dataset.pw;
            if (!email || !pw) return;
            const btn = resendEl.querySelector('a');
            const origText = btn.textContent;
            btn.textContent = 'Wird gesendet...'; btn.style.pointerEvents='none';
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { btn.textContent='✓ Gesendet!'; btn.style.color='var(--success)'; }
                else { btn.textContent = d.detail || 'Fehler'; btn.style.color='var(--error)'; }
            } catch(e) { btn.textContent='Fehler'; btn.style.color='var(--error)'; }
            setTimeout(() => { btn.textContent=origText; btn.style.color=''; btn.style.pointerEvents=''; }, 4000);
        }

        function doLogout() {
            authToken=null; currentUser=null;
            sessionStorage.removeItem('bea_token'); sessionStorage.removeItem('bea_user');
            if(document.getElementById('fbBtn')) document.getElementById('fbBtn').style.display = 'none';
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('loginEmail').value=''; document.getElementById('loginPassword').value='';
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
            showAuthPanel('login');
        }

        document.getElementById('loginPassword').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('loginEmail').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('regPassword').addEventListener('keydown', e => { if(e.key==='Enter') doRegister(); });

        // ── App Logic ───────────────────────────────────
        function showSection(name,el) {
            if(el){document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));el.classList.add('active');}
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(name+'-section'); if(sec) sec.classList.add('active');
            document.getElementById('hero-section').style.display = (name==='upload') ? '' : 'none';
            if(name==='documents') loadDocuments();
            if(name==='admin') loadAdminData();
            if(name==='context') ctxLoad();
            if(name==='leads') crmLoad();
            if(name==='companies') crmLoadCompanies();
            if(name==='profile') loadProfile();
            if(name==='chat') { loadChatHistory(); document.getElementById('chatInput').focus(); }
            if(name==='model') { if (!mbUserProfile) mbLoadUserProfile().then(() => mbApplyDefault('start')); }
        }
        function switchTab(tab,el) { currentTab=tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); document.getElementById('file-section').classList.toggle('active',tab==='file'); document.getElementById('text-section').classList.toggle('active',tab==='text'); updateCount(); }
        function selectDB(el) { document.querySelectorAll('.db-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selectedDB=el.dataset.db; }

        const dropZone=document.getElementById('dropZone');
        ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.add('dragover');}));
        ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.remove('dragover');}));
        dropZone.addEventListener('drop',e=>addFiles([...e.dataTransfer.files]));
        document.getElementById('fileInput').addEventListener('change',e=>{addFiles([...e.target.files]);e.target.value='';});

        function addFiles(nf) { const ok=['.pdf','.txt','.md','.docx','.csv','.json']; for(const f of nf){const ext='.'+f.name.split('.').pop().toLowerCase(); if(!ok.includes(ext)){showToast(`${f.name}: nicht unterstützt`,'error');continue;} if(f.size>50*1024*1024){showToast(`${f.name}: zu groß`,'error');continue;} files.push({file:f,status:'pending',progress:0,id:Date.now()+Math.random()});} renderFileList();updateCount(); }
        function removeFile(id) { files=files.filter(f=>f.id!==id); renderFileList();updateCount(); }
        function renderFileList() { document.getElementById('fileList').innerHTML=files.map(f=>{const ext=f.file.name.split('.').pop().toLowerCase();const cls=ext==='pdf'?'pdf':ext==='md'?'md':ext==='docx'?'doc':'txt';const sz=f.file.size<1024*1024?(f.file.size/1024).toFixed(1)+' KB':(f.file.size/1024/1024).toFixed(1)+' MB';return`<div class="file-item"><div class="file-type-icon ${cls}">${ext}</div><div class="file-info"><div class="file-name">${f.file.name}</div><div class="file-meta">${sz}</div></div>${f.status==='uploading'?`<div><div class="progress-bar"><div class="progress-fill" style="width:${f.progress}%"></div></div></div>`:''}<span class="file-status ${f.status}">${f.status==='pending'?'Bereit':f.status==='uploading'?f.progress+'%':f.status==='success'?'✓ Fertig':'✗ Fehler'}</span>${f.status==='pending'?`<button class="file-remove" onclick="removeFile(${f.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}</div>`;}).join(''); }
        function updateCount() { const el=document.getElementById('uploadCount'); el.textContent=currentTab==='file'?(files.length?`${files.length} Datei${files.length>1?'en':''}`:''):(document.getElementById('textContent').value.length?`${document.getElementById('textContent').value.length} Zeichen`:''); }

        document.getElementById('tagInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim()){e.preventDefault();if(!tags.includes(e.target.value.trim())){tags.push(e.target.value.trim());renderTags();}e.target.value='';}});
        function removeTag(t){tags=tags.filter(x=>x!==t);renderTags();}
        function renderTags(){const c=document.getElementById('tagContainer'),inp=document.getElementById('tagInput');c.innerHTML='';tags.forEach(t=>{const s=document.createElement('span');s.className='tag';s.innerHTML=`${t} <button onclick="removeTag('${t}')">&times;</button>`;c.appendChild(s);});c.appendChild(inp);}

        async function submitUpload() {
            const btn=document.getElementById('submitBtn');
            if(currentTab==='file'){
                if(!files.length){showToast('Bitte Dateien auswählen','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Hochladen...';
                for(const f of files){if(f.status!=='pending')continue;f.status='uploading';renderFileList();
                    try{const fd=new FormData();fd.append('file',f.file);fd.append('database',selectedDB);const r=await fetch(`${API}/upload`,{method:'POST',headers:H(),body:fd});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());f.status='success';f.progress=100;}catch(e){f.status='error';showToast(`${f.file.name}: ${e.message}`,'error');}renderFileList();}
                const ok=files.filter(f=>f.status==='success').length;if(ok)showToast(`${ok} Datei${ok>1?'en':''} hochgeladen`,'success');
            } else {
                const title=document.getElementById('textTitle').value.trim(),content=document.getElementById('textContent').value.trim();
                if(!content){showToast('Bitte Text eingeben','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Speichern...';
                try{const r=await fetch(`${API}/text`,{method:'POST',headers:{...H(),'Content-Type':'application/json'},body:JSON.stringify({title:title||'Untitled',content,category:document.getElementById('textCategory').value,language:document.getElementById('textLang').value,tags,database:selectedDB})});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());showToast('Text gespeichert','success');document.getElementById('textTitle').value='';document.getElementById('textContent').value='';tags=[];renderTags();}catch(e){showToast(e.message,'error');}
            }
            btn.disabled=false;btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';loadStats();
        }

        async function loadDocuments() {
            const w=document.getElementById('docTableWrapper');
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401){doLogout();return;}const docs=await r.json();
                if(!docs.length){w.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>Noch keine Dokumente</h3><p>Lade dein erstes Dokument hoch.</p></div>`;return;}
                const db={knowledge_base:'Knowledge Base',bcm_axioms:'BCM Axiome',research:'Research'};
                w.innerHTML=`<table class="doc-table"><thead><tr><th>Dokument</th><th>Typ</th><th>Datenbank</th><th>Datum</th><th>Status</th></tr></thead><tbody>${docs.map(d=>{const date=new Date(d.created_at).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});return`<tr><td class="doc-name">${d.title}</td><td><span class="format-badge">${(d.file_type||d.source_type).toUpperCase()}</span></td><td>${db[d.database_target]||d.database_target}</td><td>${date}</td><td><span class="status-badge">${d.status}</span></td></tr>`;}).join('')}</tbody></table>`;
            }catch(e){w.innerHTML='<p style="color:var(--error)">Fehler beim Laden</p>';}
        }

        // ── Role-Based Tab Visibility ──────────────────
        // Role → Tab mapping (which tabs each role can see)
        const ROLE_TABS = {
            researcher:        [],             // standard tabs only
            sales:             ['context'],    // + Ausgangslage (CRM via crm_access)
            operations:        ['context'],    // + Ausgangslage
            senior_management: ['context'],    // + Ausgangslage (CRM auto-enabled)
            partner:           ['context'],    // + Ausgangslage (CRM auto-enabled)
            admin:             ['context']     // + everything (admin+CRM tabs handled separately)
        };

        function applyUserTabs() {
            const email = (currentUser?.email || '').toLowerCase();
            const isAdmin = currentUser?.admin || false;
            const role = currentUser?.role || 'researcher';
            const isFehrAdvice = email.endsWith('@fehradvice.com');
            const hasCrmAccess = currentUser?.crm_access || false;
            console.log('applyUserTabs - email:', email, 'admin:', isAdmin, 'role:', role, 'crm:', hasCrmAccess);

            // Admin tab (only for admins)
            const adminEl = document.getElementById('navAdmin');
            if (adminEl) adminEl.style.display = isAdmin ? 'inline' : 'none';

            // CRM tab: only for @fehradvice.com with explicit crm_access
            const crmEl = document.getElementById('navLeads');
            if (crmEl) {
                const showCrm = isFehrAdvice && hasCrmAccess;
                crmEl.style.display = showCrm ? 'inline' : 'none';
                console.log('CRM tab', showCrm ? 'SHOWN' : 'hidden', '(FA:', isFehrAdvice, 'access:', hasCrmAccess + ')');
                // Firmen tab: same visibility as CRM
                const compEl = document.getElementById('navCompanies');
                if (compEl) compEl.style.display = showCrm ? 'inline' : 'none';
            }

            // Context/Ausgangslage tab: role-based
            const ctxEl = document.getElementById('navContext');
            const visibleTabs = isAdmin ? ['context'] : (ROLE_TABS[role] || []);
            if (ctxEl) ctxEl.style.display = visibleTabs.includes('context') ? 'inline' : 'none';
        }

        // ── Kontext / Ausgangslage ──────────────────────
        let ctxData = [];

        function ctxShowAdd() {
            const f = document.getElementById('ctxAddForm');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        async function ctxLoad() {
            try {
                const r = await fetch(`${API}/contexts`, { headers: H() });
                if (!r.ok) throw new Error('Load failed');
                ctxData = await r.json();
                ctxRender();
            } catch(e) {
                console.error('Context load:', e);
                ctxData = [];
                document.getElementById('ctxTable').innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Noch keine Kontexte erfasst.</div>';
                ctxRenderKpis();
            }
        }

        function ctxRender() {
            const domainColors = { FIN:'#fbbf24', HLT:'#34d399', POL:'#f87171', ORG:'#8b9aff', EDU:'#a78bfa', ENV:'#4ade80', REL:'#fb923c', OTH:'#94a3b8' };
            const domainLabels = { FIN:'Finanzen', HLT:'Gesundheit', POL:'Politik', ORG:'Organisation', EDU:'Bildung', ENV:'Umwelt', REL:'Beziehungen', OTH:'Andere' };
            const statusColors = { aktiv:'rgba(52,211,153,0.8)', planung:'rgba(139,170,255,0.8)', abgeschlossen:'rgba(255,255,255,0.3)', pausiert:'rgba(251,191,36,0.8)' };

            document.getElementById('ctxCount').textContent = `(${ctxData.length})`;

            if (!ctxData.length) {
                document.getElementById('ctxTable').innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">Noch keine Kontexte erfasst. Klicke «+ Neuer Kontext» um zu starten.</div>';
                ctxRenderKpis();
                return;
            }

            document.getElementById('ctxTable').innerHTML = ctxData.sort((a,b) => new Date(b.updated_at||b.created_at) - new Date(a.updated_at||a.created_at)).map(c => {
                const dc = domainColors[c.domain] || '#94a3b8';
                const dl = domainLabels[c.domain] || c.domain;
                const sc = statusColors[c.status] || '#94a3b8';
                const date = new Date(c.created_at).toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: '2-digit' });
                return `
                <div style="padding:16px 18px;background:var(--navy-card);border:1px solid var(--border);border-radius:12px">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
                        <span style="font-weight:600;color:white;font-size:15px">${c.client || '–'}</span>
                        <span style="font-size:13px;color:rgba(255,255,255,0.5)">→ ${c.project || '–'}</span>
                        <span style="margin-left:auto;display:flex;gap:6px;align-items:center">
                            <span style="font-size:11px;padding:3px 10px;border-radius:12px;background:${dc}18;color:${dc};border:1px solid ${dc}44">${dl}</span>
                            <span style="font-size:11px;padding:3px 10px;border-radius:12px;background:${sc}18;color:${sc};border:1px solid ${sc}44">${c.status}</span>
                            <span style="font-size:11px;color:rgba(255,255,255,0.25)">${date}</span>
                        </span>
                    </div>
                    ${c.situation ? `<div style="margin-bottom:8px"><div style="font-size:10px;font-weight:600;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Ausgangslage</div><div style="font-size:13px;color:rgba(255,255,255,0.65);line-height:1.5">${c.situation}</div></div>` : ''}
                    ${c.goal ? `<div style="margin-bottom:8px"><div style="font-size:10px;font-weight:600;color:rgba(52,211,153,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Ziel</div><div style="font-size:13px;color:rgba(255,255,255,0.65);line-height:1.5">${c.goal}</div></div>` : ''}
                    ${c.constraints ? `<div><div style="font-size:10px;font-weight:600;color:rgba(251,191,36,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Rahmenbedingungen</div><div style="font-size:13px;color:rgba(255,255,255,0.5);line-height:1.5">${c.constraints}</div></div>` : ''}
                    <div style="display:flex;gap:8px;margin-top:10px;border-top:1px solid rgba(255,255,255,0.04);padding-top:10px">
                        <select onchange="ctxUpdateStatus('${c.id}',this.value)" style="font-size:11px;padding:3px 8px;background:transparent;color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer">
                            ${['aktiv','planung','abgeschlossen','pausiert'].map(s => `<option value="${s}" ${s===c.status?'selected':''}>${s}</option>`).join('')}
                        </select>
                        <button onclick="ctxDelete('${c.id}')" style="font-size:11px;padding:3px 8px;background:transparent;color:rgba(248,113,113,0.5);border:1px solid rgba(248,113,113,0.15);border-radius:6px;cursor:pointer">Löschen</button>
                    </div>
                </div>`;
            }).join('');

            ctxRenderKpis();
        }

        function ctxRenderKpis() {
            const active = ctxData.filter(c => c.status === 'aktiv');
            document.getElementById('ctxKpiActive').textContent = ctxData.length;
            document.getElementById('ctxKpiActive2').textContent = active.length;
            if (ctxData.length > 0) {
                const last = new Date(ctxData.sort((a,b) => new Date(b.updated_at||b.created_at) - new Date(a.updated_at||a.created_at))[0].updated_at || ctxData[0].created_at);
                document.getElementById('ctxKpiLast').textContent = last.toLocaleDateString('de-CH', { day: '2-digit', month: 'short' });
            }
        }

        async function ctxSave() {
            const ctx = {
                client: document.getElementById('ctxClient').value.trim(),
                project: document.getElementById('ctxProject').value.trim(),
                domain: document.getElementById('ctxDomain').value,
                status: document.getElementById('ctxStatus').value,
                situation: document.getElementById('ctxSituation').value.trim(),
                goal: document.getElementById('ctxGoal').value.trim(),
                constraints: document.getElementById('ctxConstraints').value.trim()
            };
            if (!ctx.client) { showToast('Bitte Kunde angeben', 'error'); return; }
            try {
                const r = await fetch(`${API}/contexts`, {
                    method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(ctx)
                });
                if (!r.ok) throw new Error('Save failed');
                showToast('Kontext gespeichert', 'success');
                document.getElementById('ctxAddForm').style.display = 'none';
                ['ctxClient','ctxProject','ctxSituation','ctxGoal','ctxConstraints'].forEach(id => document.getElementById(id).value = '');
                ctxLoad();
            } catch(e) { showToast('Fehler beim Speichern', 'error'); }
        }

        async function ctxUpdateStatus(id, status) {
            try {
                await fetch(`${API}/contexts/${id}`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                ctxLoad();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        async function ctxDelete(id) {
            if (!confirm('Kontext wirklich löschen?')) return;
            try {
                await fetch(`${API}/contexts/${id}`, { method: 'DELETE', headers: H() });
                showToast('Lead gelöscht', 'success');
                ctxLoad();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // ── CRM ──────────────────────────────────────────
        let crmDeals = [];
        let crmView = 'kanban';
        const CRM_STAGES = [
            { id: 'prospect', label: 'Prospect', color: 'rgba(139,170,255,0.8)', prob: 10, icon: '🎯' },
            { id: 'qualified', label: 'Qualified', color: 'rgba(56,189,248,0.8)', prob: 25, icon: '✅' },
            { id: 'proposal', label: 'Proposal', color: 'rgba(251,191,36,0.8)', prob: 50, icon: '📄' },
            { id: 'negotiation', label: 'Negotiation', color: 'rgba(232,163,61,0.9)', prob: 75, icon: '🤝' },
            { id: 'won', label: 'Won', color: 'rgba(52,211,153,0.8)', prob: 100, icon: '🏆' },
            { id: 'active', label: 'Active', color: 'rgba(52,211,153,0.6)', prob: 100, icon: '⚡' },
            { id: 'dormant', label: 'Dormant', color: 'rgba(148,163,184,0.5)', prob: 5, icon: '💤' },
            { id: 'churned', label: 'Churned', color: 'rgba(248,113,113,0.4)', prob: 0, icon: '📉' },
            { id: 'lost', label: 'Lost', color: 'rgba(248,113,113,0.6)', prob: 0, icon: '✗' }
        ];
        const CRM_PIPELINE = ['prospect', 'qualified', 'proposal', 'negotiation', 'won', 'active'];

        let crmLastSync = null;

        async function crmLoad() {
            try {
                const [dealsR, statsR] = await Promise.all([
                    fetch(`${API}/crm/deals`, { headers: H() }),
                    fetch(`${API}/crm/stats`, { headers: H() })
                ]);
                crmDeals = dealsR.ok ? await dealsR.json() : [];
                const stats = statsR.ok ? await statsR.json() : {};
                crmRenderKpis(stats);
                crmRenderView();
                const hint = document.getElementById('crmSyncHint');
                if (hint) hint.style.display = crmDeals.length ? 'none' : 'block';
                // Date info
                const di = document.getElementById('crmDateInfo');
                if (di) {
                    const today = new Date().toLocaleDateString('de-CH', {day:'2-digit', month:'long', year:'numeric'});
                    const syncInfo = crmLastSync ? ` · Letzter Sync: ${crmLastSync.toLocaleTimeString('de-CH', {hour:'2-digit', minute:'2-digit'})}` : '';
                    di.textContent = `Stand: ${today}${syncInfo}`;
                }
            } catch(e) { console.error('CRM load:', e); crmDeals = []; crmRenderView(); }
        }

        function crmRenderKpis(s) {
            document.getElementById('crmKpiActive').textContent = s.active_deals || 0;
            document.getElementById('crmKpiPipeline').textContent = s.pipeline_value ? new Intl.NumberFormat('de-CH', {notation:'compact'}).format(s.pipeline_value) + ' CHF' : '–';
            document.getElementById('crmKpiWon').textContent = s.won_deals || 0;
            document.getElementById('crmKpiConv').textContent = (s.conversion_rate || 0) + '%';
            document.getElementById('crmKpiCompanies').textContent = s.companies || 0;
        }

        function crmSetView(v) {
            crmView = v;
            document.getElementById('crmViewKanban').classList.toggle('active', v === 'kanban');
            document.getElementById('crmViewTable').classList.toggle('active', v === 'table');
            document.getElementById('crmKanban').style.display = v === 'kanban' ? 'flex' : 'none';
            document.getElementById('crmTable').style.display = v === 'table' ? 'block' : 'none';
            crmRenderView();
        }

        function crmRenderView() {
            // Show/hide filter banner
            const banner = document.getElementById('crmFilterBanner');
            if (banner) banner.style.display = crmCompanyFilter ? 'flex' : 'none';
            if (crmView === 'kanban') crmRenderKanban(); else crmRenderTable();
        }

        function crmGetFilteredDeals() {
            if (!crmCompanyFilter) return crmDeals;
            return crmDeals.filter(d => d.company_id === crmCompanyFilter || d.company === crmCompanyFilter);
        }

        function crmClearFilter() { crmCompanyFilter = null; crmRenderView(); }

        function crmRenderKanban() {
            const container = document.getElementById('crmKanban');
            const deals = crmGetFilteredDeals();
            container.innerHTML = CRM_PIPELINE.map(stageId => {
                const stage = CRM_STAGES.find(s => s.id === stageId);
                const stageDeals = deals.filter(d => d.stage === stageId);
                const stageValue = stageDeals.reduce((s, d) => s + (d.value || 0), 0);
                return `<div class="crm-col" data-stage="${stageId}" ondragover="event.preventDefault();this.style.background='rgba(139,170,255,0.05)'" ondragleave="this.style.background=''" ondrop="crmDrop(event,'${stageId}');this.style.background=''">
                    <div style="padding:10px 12px;border-bottom:2px solid ${stage.color};display:flex;align-items:center;gap:6px">
                        <span style="font-size:11px">${stage.icon}</span>
                        <span style="font-size:12px;font-weight:600;color:white;flex:1">${stage.label}</span>
                        <span style="font-size:11px;color:rgba(255,255,255,0.3)">${stageDeals.length}</span>
                    </div>
                    <div style="padding:6px;flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:5px;max-height:60vh">
                        ${stageDeals.length === 0 ? '<div style="text-align:center;padding:16px;font-size:11px;color:rgba(255,255,255,0.15)">–</div>' :
                        stageDeals.map(d => crmRenderCard(d, stage.color)).join('')}
                    </div>
                </div>`;
            }).join('');
            const other = crmDeals.filter(d => !CRM_PIPELINE.includes(d.stage));
            if (other.length) {
                container.innerHTML += `<div style="min-width:80px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.04)"><div style="padding:10px;text-align:center"><div style="font-size:11px;color:rgba(255,255,255,0.2)">Archiv</div><div style="font-size:16px;color:rgba(255,255,255,0.3)">${other.length}</div></div></div>`;
            }
        }

        function crmRenderCard(d, stageColor) {
            const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) : '';
            const owner = d.owner ? d.owner.replace('OWN-','') : '';
            const hot = d.notes && d.notes.includes('🔥') ? '🔥' : '';
            return `<div class="crm-card" draggable="true" ondragstart="event.dataTransfer.setData('text/plain','${d.id}')" onclick="crmOpenDeal('${d.id}')">
                <div style="font-size:12px;font-weight:600;color:white;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.title||'–'} ${hot}</div>
                <div style="font-size:10px;color:rgba(255,255,255,0.3);margin-top:1px">${d.company_name||''}</div>
                ${d.contact_name ? `<div style="font-size:10px;color:rgba(255,255,255,0.25);margin-top:3px">👤 ${d.contact_name}</div>` : ''}
                ${d.next_action ? `<div style="font-size:10px;color:rgba(251,191,36,0.8);margin-top:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">→ ${d.next_action}</div>` : ''}
                <div style="display:flex;align-items:center;gap:4px;margin-top:4px">
                    ${val ? `<span style="font-size:10px;font-weight:600;color:${stageColor}">${val} CHF</span>` : ''}
                    <span style="flex:1"></span>
                    ${owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${owner}</span>` : ''}
                </div>
            </div>`;
        }

        async function crmDrop(event, newStage) {
            event.preventDefault();
            const dealId = event.dataTransfer.getData('text/plain');
            if (!dealId) return;
            try {
                await fetch(`${API}/crm/deals/${dealId}`, { method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' }, body: JSON.stringify({ stage: newStage }) });
                crmLoad(); showToast('Stage aktualisiert', 'success');
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmRenderTable() {
            const deals = crmGetFilteredDeals();
            if (!deals.length) { document.getElementById('crmTable').innerHTML = `<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4)">${crmCompanyFilter ? 'Keine Leads für diese Firma.' : 'Keine Leads. Klicke «Synchronisieren» um Leads zu importieren.'} ${crmCompanyFilter ? '<br><a style="color:var(--accent);cursor:pointer" onclick="crmClearFilter()">Filter aufheben</a>' : ''}</div>`; return; }
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const rows = deals.map(d => {
                const s = stageMap[d.stage] || {};
                const date = d.created_at ? new Date(d.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'2-digit'}) : '';
                const val = d.value ? new Intl.NumberFormat('de-CH').format(d.value) + ' CHF' : '–';
                const owner = (d.owner||'').replace('OWN-','');
                return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer" onclick="crmOpenDeal('${d.id}')"><td style="padding:8px 10px;font-weight:500;color:white;font-size:13px">${d.title||'–'}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${d.company_name||'–'}</td><td style="padding:8px 10px"><span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}33">${s.icon||''} ${s.label||d.stage}</span></td><td style="padding:8px 10px;color:rgba(255,255,255,0.5);font-size:12px">${val}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${owner}</td><td style="padding:8px 10px;color:rgba(255,255,255,0.25);font-size:11px">${date}</td></tr>`;
            }).join('');
            document.getElementById('crmTable').innerHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)"><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Lead</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Firma</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Stage</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Wert</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Owner</th><th style="padding:6px 10px;text-align:left;font-size:10px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase">Erstellt</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        function crmShowDealForm() { const f=document.getElementById('crmDealForm'); f.style.display=f.style.display==='none'?'block':'none'; }

        async function crmSaveDeal() {
            const title = document.getElementById('crmDealTitle').value.trim();
            const company = document.getElementById('crmDealCompany').value.trim();
            if (!title && !company) { showToast('Bitte Lead-Titel oder Firma', 'error'); return; }
            try {
                await fetch(`${API}/crm/deals`, { method: 'POST', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title||company, company_name: company, contact_name: document.getElementById('crmDealContact').value.trim(), contact_email: document.getElementById('crmDealEmail').value.trim(), value: parseFloat(document.getElementById('crmDealValue').value)||0, stage: document.getElementById('crmDealStage').value, source: document.getElementById('crmDealSource').value.trim(), next_action: document.getElementById('crmDealNextAction').value.trim(), notes: document.getElementById('crmDealNotes').value.trim() })
                });
                showToast('Lead erstellt ✓', 'success');
                document.getElementById('crmDealForm').style.display = 'none';
                ['crmDealTitle','crmDealCompany','crmDealContact','crmDealEmail','crmDealValue','crmDealSource','crmDealNextAction','crmDealNotes'].forEach(id => document.getElementById(id).value = '');
                crmLoad();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        function crmOpenDeal(id) {
            const deal = crmDeals.find(d => d.id === id);
            if (!deal) return;
            document.getElementById('crmDrawerTitle').textContent = deal.title || '–';
            document.getElementById('crmDrawerCompany').textContent = deal.company_name || '–';
            const stageMap = Object.fromEntries(CRM_STAGES.map(s => [s.id, s]));
            const s = stageMap[deal.stage] || {};
            const val = deal.value ? new Intl.NumberFormat('de-CH').format(deal.value) + ' CHF' : '–';
            const created = deal.created_at ? new Date(deal.created_at).toLocaleDateString('de-CH') : '';
            const owner = (deal.owner||'').replace('OWN-','');
            document.getElementById('crmDrawerContent').innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    <span style="font-size:12px;padding:4px 12px;border-radius:12px;background:${s.color||'#94a3b8'}22;color:${s.color||'#94a3b8'};border:1px solid ${s.color||'#94a3b8'}44;font-weight:600">${s.icon||''} ${s.label||deal.stage}</span>
                    <span style="font-size:13px;font-weight:600;color:var(--accent-light)">${val}</span>
                    <span style="font-size:12px;color:rgba(255,255,255,0.3)">${deal.probability||0}%</span>
                    ${owner ? `<span style="font-size:11px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.4)">👤 ${owner}</span>` : ''}
                </div>
                <div style="display:flex;gap:3px;margin-bottom:16px;flex-wrap:wrap">
                    ${CRM_STAGES.map(st => `<button onclick="crmChangeStage('${id}','${st.id}')" style="padding:5px 6px;border-radius:6px;border:1px solid ${st.id===deal.stage?st.color:'rgba(255,255,255,0.06)'};background:${st.id===deal.stage?st.color+'22':'transparent'};color:${st.id===deal.stage?'white':'rgba(255,255,255,0.2)'};font-size:9px;cursor:pointer;font-family:inherit">${st.icon} ${st.label}</button>`).join('')}
                </div>
                <div style="border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Details</div>
                <div style="display:grid;grid-template-columns:80px 1fr;gap:6px;font-size:13px">
                    <span style="color:rgba(255,255,255,0.3)">Firma</span><span style="color:white">${deal.company_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Kontakt</span><span style="color:white">${deal.contact_name||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Quelle</span><span style="color:rgba(255,255,255,0.6)">${deal.source||'–'}</span>
                    <span style="color:rgba(255,255,255,0.3)">Owner</span><span style="color:rgba(255,255,255,0.6)">${owner}</span>
                    <span style="color:rgba(255,255,255,0.3)">Erstellt</span><span style="color:rgba(255,255,255,0.6)">${created}</span>
                </div></div>
                ${deal.next_action ? `<div style="margin-top:12px;padding:10px 12px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:8px"><div style="font-size:10px;color:rgba(251,191,36,0.7);font-weight:600">NÄCHSTE AKTION</div><div style="font-size:13px;color:white;margin-top:2px">${deal.next_action}</div>${deal.next_action_date?`<div style="font-size:11px;color:rgba(251,191,36,0.5);margin-top:2px">📅 ${deal.next_action_date}</div>`:''}</div>` : ''}
                ${deal.notes ? `<div style="margin-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:6px">Notizen</div><div style="font-size:12px;color:rgba(255,255,255,0.5);line-height:1.5;white-space:pre-wrap;max-height:200px;overflow-y:auto">${deal.notes}</div></div>` : ''}
                <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px"><div style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;margin-bottom:8px">Quick-Notiz</div>
                <div style="display:flex;gap:6px"><input class="mb-input" id="crmQuickNote" placeholder="Notiz..." style="flex:1;font-size:13px;padding:8px 12px" onkeydown="if(event.key==='Enter')crmAddNote('${id}')"><button class="mb-btn mb-btn-primary" onclick="crmAddNote('${id}')" style="font-size:12px;padding:6px 12px">+</button></div></div>
                <div style="margin-top:12px"><button class="mb-btn mb-btn-back" onclick="crmDeleteDeal('${id}')" style="font-size:11px;padding:5px 12px;color:rgba(248,113,113,0.7)">🗑 Löschen</button></div>`;
            document.getElementById('crmDrawer').style.display = 'block';
        }

        function crmCloseDrawer() { document.getElementById('crmDrawer').style.display = 'none'; }

        let crmCompaniesData = [];
        function crmShowCompanies() {
            showSection('companies', document.querySelector('[data-section=companies]'));
        }
        async function crmLoadCompanies() {
            document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Lade Firmendaten aus GitHub…</div>';
            try {
                const resp = await fetch(`${API}/crm/companies/enriched`, { headers: H() });
                crmCompaniesData = resp.ok ? await resp.json() : [];
                document.getElementById('crmCompaniesCount').textContent = `${crmCompaniesData.length} Firmen · Quelle: GitHub customer-registry.yaml + lead-database.yaml`;
                crmFilterCompanies();
            } catch(e) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:var(--error)">Fehler beim Laden</div>';
            }
        }

        function crmFilterCompanies() {
            const q = (document.getElementById('crmCompaniesSearch')?.value || '').toLowerCase();
            const filtered = q ? crmCompaniesData.filter(c =>
                (c.name || '').toLowerCase().includes(q) ||
                (c.industry || '').toLowerCase().includes(q) ||
                (c.code || '').toLowerCase().includes(q) ||
                (c.country || '').toLowerCase().includes(q) ||
                (c.notes || '').toLowerCase().includes(q)
            ) : crmCompaniesData;

            if (!filtered.length) {
                document.getElementById('crmCompaniesList').innerHTML = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,0.3)">Keine Firmen gefunden</div>';
                return;
            }

            const countryFlags = {AT:'🇦🇹',CH:'🇨🇭',DE:'🇩🇪',SE:'🇸🇪',UK:'🇬🇧',US:'🇺🇸',LI:'🇱🇮',NL:'🇳🇱',FR:'🇫🇷',IT:'🇮🇹'};
            const industryLabels = {finance:'Finanz',insurance:'Versicherung',retail:'Handel',fmcg:'FMCG',construction:'Bau',packaging:'Verpackung',public_sector:'Öffentlich',telecom:'Telekom',media:'Medien',precious_metals:'Edelmetalle',automotive:'Automobil',health:'Gesundheit',transport:'Transport',professional_services:'Services',technology:'Tech',energy:'Energie',ngo:'NGO'};

            const rows = filtered.map(c => {
                const flag = countryFlags[c.country] || '';
                const indLabel = industryLabels[c.industry] || c.industry || '';
                const ind = indLabel ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(42,127,142,0.1);color:#2A7F8E;border:1px solid rgba(42,127,142,0.2)">${indLabel}</span>` : '';
                const type = c.type === 'strategic' ? '<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:rgba(232,163,61,0.1);color:#E8A33D;border:1px solid rgba(232,163,61,0.2)">Strategic</span>' : '';
                const status = c.relationship_status ? `<span style="font-size:9px;padding:1px 6px;border-radius:6px;background:${c.relationship_status==='ACTIVE'?'rgba(52,211,153,0.1)':'rgba(255,255,255,0.04)'};color:${c.relationship_status==='ACTIVE'?'#34d399':'rgba(255,255,255,0.3)'}">${c.relationship_status}</span>` : '';
                
                // Data completeness indicators
                const hasFolder = c.has_customer_folder ? '📁' : '';
                const hasContext = c.has_context ? '🧠' : '';
                const hasVectors = c.ebf_context_vectors ? '🔬' : '';
                const hot = c.hot_lead ? '🔥' : '';
                const contactCount = c.contact_persons > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">👤${c.contact_persons}</span>` : '';
                const owner = c.fa_owner ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.3)">${c.fa_owner}</span>` : '';

                // Scores
                const fitScore = c.fit_score > 0 ? `<span style="font-size:9px;padding:1px 5px;border-radius:6px;background:rgba(139,170,255,0.08);color:rgba(139,170,255,0.6)" title="Fit Score">Fit:${c.fit_score}</span>` : '';
                const segment = c.segment ? `<span style="font-size:9px;color:rgba(255,255,255,0.2)">${c.segment}</span>` : '';
                
                // CRM stats
                const leadsBadge = c.leads > 0
                    ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(251,191,36,0.1);color:#fbbf24">${c.leads} Lead${c.leads>1?'s':''}</span>`
                    : '';
                const wonBadge = c.won > 0 ? `<span style="font-size:10px;padding:2px 8px;border-radius:8px;background:rgba(52,211,153,0.1);color:#34d399">${c.won} Won</span>` : '';
                const pipeline = c.pipeline > 0 ? `<span style="font-size:10px;color:rgba(255,255,255,0.3)">${new Intl.NumberFormat('de-CH',{notation:'compact'}).format(c.pipeline)} CHF</span>` : '';

                return `<div style="display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'" onclick="crmShowCompanyDetail('${c.code}')">
                    <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,rgba(42,127,142,0.15),rgba(27,54,93,0.3));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#2A7F8E;flex-shrink:0">${flag || (c.name||'?')[0].toUpperCase()}</div>
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:6px">
                            <span style="font-weight:600;color:white;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${c.name || '–'}</span>
                            <span style="font-size:10px;color:rgba(255,255,255,0.2)">${c.code}</span>
                            ${hot}${hasFolder}${hasContext}${hasVectors}
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;margin-top:3px;flex-wrap:wrap">${ind}${type}${status}${segment}${fitScore}${contactCount}${owner}</div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">${pipeline}${leadsBadge}${wonBadge}</div>
                </div>`;
            }).join('');
            document.getElementById('crmCompaniesList').innerHTML = rows;
        }

        function crmShowCompanyDetail(code) {
            const c = crmCompaniesData.find(x => x.code === code);
            if (!c) return;
            // Navigate to CRM and filter to this company's leads
            showSection('leads', document.querySelector('[data-section=leads]'));
            const match = crmDeals.find(d => (d.company_name||'').includes(c.short_name || c.code));
            if (match) {
                crmCompanyFilter = match.company_id || match.company;
                if (crmView !== 'table') crmSetView('table');
                crmRenderView();
                showToast(`Leads von ${c.short_name || c.name}`, 'info');
            } else {
                showToast(`${c.short_name || c.name} – keine CRM-Leads`, 'info');
            }
        }

        let crmCompanyFilter = null;

        async function crmChangeStage(dealId, ns) {
            try { await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({stage:ns}) }); crmCloseDrawer(); crmLoad(); showToast('Stage → '+ns, 'success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmAddNote(dealId) {
            const note = document.getElementById('crmQuickNote')?.value.trim();
            if (!note) return;
            try {
                await fetch(`${API}/crm/activities`, { method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({deal_id:dealId,type:'note',subject:note}) });
                const deal = crmDeals.find(d=>d.id===dealId);
                const ts = new Date().toLocaleString('de-CH');
                await fetch(`${API}/crm/deals/${dealId}`, { method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({notes:(deal?.notes||'')+`\n[${ts}] ${note}`}) });
                showToast('Notiz ✓','success'); crmLoad(); crmCloseDrawer();
            } catch(e) { showToast('Fehler','error'); }
        }

        async function crmDeleteDeal(id) {
            if (!confirm('Lead löschen?')) return;
            try { await fetch(`${API}/crm/deals/${id}`,{method:'DELETE',headers:H()}); crmCloseDrawer(); crmLoad(); showToast('Lead gelöscht','success'); } catch(e) { showToast('Fehler','error'); }
        }

        async function crmSyncGithub() {
            const btn = document.getElementById('crmSyncBtn');
            btn.disabled=true; btn.textContent='⏳ Synchronisiere...';
            try {
                const r = await fetch(`${API}/crm/sync-github`, { method:'POST', headers:H() });
                const data = await r.json();
                if (r.ok) { crmLastSync = new Date(); showToast(`Sync: ${data.stats.deals} Leads, ${data.stats.companies} Firmen ✓`, 'success'); crmLoad(); }
                else throw new Error(data.detail||'failed');
            } catch(e) { showToast('Sync fehlgeschlagen: '+e.message, 'error'); }
            btn.disabled=false; btn.textContent='🔄 Synchronisieren';
        }

        async function loadStats() {
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401)return;const d=await r.json();
                document.getElementById('statDocs').textContent=d.length;document.getElementById('statKB').textContent=d.filter(x=>x.database_target==='knowledge_base').length;document.getElementById('statAxioms').textContent=d.filter(x=>x.database_target==='bcm_axioms').length;
            }catch(e){document.getElementById('statDocs').textContent='–';}
        }

        function showToast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${{success:'✓',error:'✗',info:'ℹ'}[type]||''}</span> ${msg}`;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='0.3s';setTimeout(()=>t.remove(),300);},4000);}
        function clearAll(){files=[];tags=[];renderFileList();renderTags();document.getElementById('textTitle').value='';document.getElementById('textContent').value='';updateCount();}
        document.getElementById('textContent').addEventListener('input',updateCount);

        // ── Admin Dashboard ──────────────────────────────
        const ROLE_CONFIG = {
            researcher:        { label: 'Researcher',   color: '#8b9aff', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Profil'] },
            sales:             { label: 'Sales',        color: '#fbbf24', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            operations:        { label: 'Operations',   color: '#34d399', tabs: ['Fragen','Upload','Ausgangslage','Profil'] },
            senior_management: { label: 'Senior Mgmt',  color: '#f59e0b', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            partner:           { label: 'Partner',      color: '#ef4444', tabs: ['Fragen','Modell-Building','Upload','Dokumente','Ausgangslage','Profil'] },
            admin:             { label: 'Admin',        color: '#f87171', tabs: ['Alle Tabs'] }
        };
        // Owner codes from YAML team_registry
        const CRM_OWNER_CODES = ['','OWN-GF','OWN-EB','OWN-MdL','OWN-AJ','OWN-MR','OWN-MFA','OWN-MF'];

        async function loadAdminData() {
            if (!currentUser || !currentUser.admin) return;
            try {
                const [usersR, settingsR, docsR] = await Promise.all([
                    fetch(`${API}/admin/users`, {headers:H()}),
                    fetch(`${API}/admin/settings`, {headers:H()}),
                    fetch(`${API}/documents`, {headers:H()})
                ]);
                if (usersR.status===401) { doLogout(); return; }
                const users = usersR.ok ? await usersR.json() : [];
                const settings = settingsR.ok ? await settingsR.json() : {};
                const docs = docsR.ok ? await docsR.json() : [];

                // Stats
                document.getElementById('adminStatUsers').textContent = users.length;
                document.getElementById('adminStatDocs').textContent = docs.length;
                const regMode = settings.registration === 'open' ? 'Offen' : 'Eingeschränkt';
                document.getElementById('adminStatReg').textContent = regMode;
                const domains = settings.allowed_email_domains || [];
                document.getElementById('adminStatRegSub').textContent = domains.includes('*') ? 'Alle Domains' : domains.map(d => '@'+d).join(', ') || 'Alle Domains';
                document.getElementById('adminUserCount').textContent = users.length;

                // User table
                const tbody = users.map(u => {
                    const created = u.created_at ? new Date(u.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric'}) : '–';
                    const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Nie';
                    const userRole = u.is_admin ? 'admin' : (u.role || 'researcher');
                    const rc = ROLE_CONFIG[userRole] || ROLE_CONFIG.researcher;
                    const statusBadge = u.is_active ? '<span class="user-badge active">Aktiv</span>' : '<span class="user-badge inactive">Inaktiv</span>';
                    const verifiedBadge = u.email_verified ? '<span class="user-badge active">✓</span>' : '<span class="user-badge inactive">✗</span>';

                    // Role dropdown + admin toggle
                    const isSelf = u.email === currentUser.email;
                    const adminToggle = !isSelf
                        ? (u.is_admin
                            ? `<button onclick="adminToggleAdmin('${u.id}','${u.email}',false)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(248,113,113,0.6);border:1px solid rgba(248,113,113,0.2);border-radius:6px;cursor:pointer" title="Admin-Rechte entziehen">✕</button>`
                            : `<button onclick="adminToggleAdmin('${u.id}','${u.email}',true)" style="font-size:9px;padding:2px 6px;margin-left:4px;background:transparent;color:rgba(251,191,36,0.5);border:1px solid rgba(251,191,36,0.2);border-radius:6px;cursor:pointer" title="Zum Admin ernennen">👑</button>`)
                        : '';
                    const roleCell = u.is_admin
                        ? `<span style="font-size:11px;padding:4px 10px;border-radius:12px;background:${ROLE_CONFIG.admin.color}18;color:${ROLE_CONFIG.admin.color};border:1px solid ${ROLE_CONFIG.admin.color}44;font-weight:600">Admin</span>${adminToggle}`
                        : `<select onchange="adminSetRole('${u.id}',this.value)" style="font-size:11px;padding:4px 8px;background:${rc.color}12;color:${rc.color};border:1px solid ${rc.color}44;border-radius:8px;cursor:pointer;font-weight:600;appearance:auto">
                            ${Object.entries(ROLE_CONFIG).filter(([k]) => k !== 'admin').map(([k, v]) =>
                                `<option value="${k}" ${k === userRole ? 'selected' : ''} style="color:#000">${v.label}</option>`
                            ).join('')}
                        </select>${adminToggle}`;

                    // CRM access controls (only for @fehradvice.com)
                    const isFa = u.email.toLowerCase().endsWith('@fehradvice.com');
                    const isSenior = ['senior_management','partner'].includes(u.role);
                    const crmCell = isFa
                        ? `<div style="display:flex;flex-direction:column;gap:4px">
                            <label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="CRM-Zugang">
                                <input type="checkbox" ${u.crm_access ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{crm_access:this.checked})" style="accent-color:#2A7F8E;cursor:pointer">
                                <span style="font-size:10px;color:${u.crm_access ? '#2A7F8E' : 'rgba(255,255,255,0.25)'}">CRM</span>
                            </label>
                            ${u.crm_access ? `<label style="display:flex;align-items:center;gap:5px;cursor:pointer" title="Lead-Management (eigene Leads)">
                                <input type="checkbox" ${u.lead_management ? 'checked' : ''} onchange="adminToggleCrm('${u.id}',{lead_management:this.checked})" style="accent-color:#E8A33D;cursor:pointer">
                                <span style="font-size:10px;color:${u.lead_management ? '#E8A33D' : 'rgba(255,255,255,0.25)'}">Leads</span>
                            </label>
                            <select onchange="adminToggleCrm('${u.id}',{crm_owner_code:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${CRM_OWNER_CODES.map(c => `<option value="${c}" ${c===(u.crm_owner_code||'') ? 'selected' : ''} style="color:#000">${c || '– kein Owner –'}</option>`).join('')}
                            </select>
                            <select onchange="adminToggleCrm('${u.id}',{crm_role:this.value})" style="font-size:9px;padding:2px 4px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.5);border:1px solid rgba(255,255,255,0.08);border-radius:4px;cursor:pointer">
                                ${['none','viewer','manager','admin'].map(r => `<option value="${r}" ${r===(u.crm_role||'none') ? 'selected' : ''} style="color:#000">${r==='none'?'– keine Rolle –':r==='viewer'?'Viewer (eigene)':r==='manager'?'Manager (alle)':'Admin'}</option>`).join('')}
                            </select>` : ''}
                          </div>`
                        : '<span style="font-size:10px;color:rgba(255,255,255,0.15)">–</span>';

                    // Tab access pills (include CRM if access)
                    const tabs = u.is_admin ? ['Alle'] : [...rc.tabs.filter(t => !['Profil'].includes(t)), ...(u.crm_access && isFa ? ['CRM'] : [])];
                    const tabPills = tabs.map(t =>
                        `<span style="font-size:9px;padding:2px 6px;border-radius:8px;background:rgba(255,255,255,0.04);color:rgba(255,255,255,0.35);border:1px solid rgba(255,255,255,0.06)">${t}</span>`
                    ).join(' ');

                    const toggleBtn = u.is_active
                        ? `<button class="btn-toggle deactivate" onclick="toggleUserActive('${u.id}','${u.email}')">Deaktivieren</button>`
                        : `<button class="btn-toggle activate" onclick="toggleUserActive('${u.id}','${u.email}')">Aktivieren</button>`;
                    const verifyBtn = !u.email_verified ? ` <button class="btn-toggle activate" onclick="adminVerifyUser('${u.id}','${u.email}')">Bestätigen</button>` : '';

                    return `<tr style="border-bottom:1px solid rgba(255,255,255,0.04)">
                        <td style="padding:10px 8px"><span style="font-weight:500;color:white">${u.name || '–'}</span><br><span style="font-size:11px;color:var(--text-muted)">${u.email}</span></td>
                        <td style="padding:10px 6px">${roleCell}</td>
                        <td style="padding:10px 4px">${crmCell}</td>
                        <td style="padding:10px 4px"><div style="display:flex;flex-wrap:wrap;gap:3px">${tabPills}</div></td>
                        <td style="padding:10px 4px;text-align:center">${verifiedBadge}</td>
                        <td style="padding:10px 4px">${statusBadge}</td>
                        <td style="padding:10px 4px;font-size:11px;color:rgba(255,255,255,0.4)">${lastLogin}</td>
                        <td style="padding:10px 4px">${toggleBtn}${verifyBtn}</td>
                    </tr>`;
                }).join('');

                document.getElementById('adminUserTable').innerHTML = `<table class="user-table" style="width:100%;border-collapse:collapse">
                    <thead><tr style="border-bottom:1px solid rgba(255,255,255,0.08)">
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Benutzer</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Rolle</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">CRM</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Tab-Zugang</th>
                        <th style="text-align:center;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">E-Mail</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Status</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Letzter Login</th>
                        <th style="text-align:left;padding:8px;font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase">Aktionen</th>
                    </tr></thead>
                    <tbody>${tbody}</tbody>
                </table>`;

                // Settings
                document.getElementById('adminSettings').innerHTML = `
                    <div class="settings-row"><span class="settings-label">E-Mail-Verifizierung</span><span class="settings-value" style="color:${settings.email_verification?'var(--success)':'var(--text-muted)'}">${settings.email_verification ? '✓ Aktiv' : '✗ Deaktiviert'}</span></div>
                    <div class="settings-row"><span class="settings-label">E-Mail-Versand (Resend)</span><span class="settings-value" style="color:${settings.smtp_configured?'var(--success)':'var(--error)'}">${settings.smtp_configured ? '✓ Konfiguriert' : '✗ Nicht konfiguriert'}</span></div>
                    <div class="settings-row"><span class="settings-label">Registrierung</span><span class="settings-value">${regMode}</span></div>
                    <div class="settings-row"><span class="settings-label">Erlaubte Domains</span><span class="settings-value">${domains.includes('*') ? 'Alle (*)' : domains.map(d=>'@'+d).join(', ') || 'Alle (*)'}</span></div>
                    <div class="settings-row"><span class="settings-label">JWT Gültigkeit</span><span class="settings-value">${settings.jwt_expiry_hours || 24}h</span></div>
                `;

                // Load feedback
                try {
                    const fbR = await fetch(`${API}/feedback`, {headers:H()});
                    const feedbacks = fbR.ok ? await fbR.json() : [];
                    const openFb = feedbacks.filter(f => f.status === 'neu');
                    document.getElementById('adminStatFb').textContent = openFb.length;
                    document.getElementById('adminStatFbSub').textContent = `von ${feedbacks.length} gesamt`;
                    document.getElementById('adminFbCount').textContent = feedbacks.length;

                    if (feedbacks.length === 0) {
                        document.getElementById('adminFeedbackList').innerHTML = '<div style="text-align:center;padding:30px;color:rgba(255,255,255,0.3)">Noch kein Feedback eingegangen.</div>';
                    } else {
                        const typeIcons = { bug: '🐛', wunsch: '💡', frage: '❓' };
                        const statusColors = { neu: '#f87171', bearbeitung: '#fbbf24', erledigt: '#34d399' };
                        document.getElementById('adminFeedbackList').innerHTML = feedbacks.map(f => {
                            const sc = statusColors[f.status] || '#94a3b8';
                            const date = f.created_at ? new Date(f.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '–';
                            return `<div style="padding:14px 16px;background:var(--navy-card);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;display:flex;align-items:center;gap:12px">
                                <span style="font-size:20px">${typeIcons[f.type] || '📝'}</span>
                                <div style="flex:1;min-width:0">
                                    <div style="font-size:13px;color:white;margin-bottom:3px">${f.comment || '–'}</div>
                                    <div style="font-size:11px;color:rgba(255,255,255,0.3)">${f.created_by} · ${date} · Tab: ${f.page || '–'} · ${f.viewport || ''}</div>
                                </div>
                                <button onclick="fbShowScreenshot('${f.id}')" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(139,170,255,0.2);background:transparent;color:rgba(139,170,255,0.7);font-size:11px;cursor:pointer;white-space:nowrap">📸 Bild</button>
                                <select onchange="fbUpdateStatus('${f.id}',this.value)" style="font-size:11px;padding:4px 8px;background:transparent;color:${sc};border:1px solid ${sc}44;border-radius:6px;cursor:pointer">
                                    ${['neu','bearbeitung','erledigt'].map(s => `<option value="${s}" ${s===f.status?'selected':''}>${s}</option>`).join('')}
                                </select>
                            </div>`;
                        }).join('');
                    }
                } catch(e) { console.error('Feedback load:', e); }
            } catch(e) {
                document.getElementById('adminUserTable').innerHTML = '<p style="color:var(--error)">Fehler beim Laden der Admin-Daten.</p>';
            }
        }

        async function toggleUserActive(userId, email) {
            if (!confirm(`Benutzer ${email} wirklich umschalten?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-active`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler beim Ändern', 'error'); return; }
                const data = await r.json();
                showToast(`${email}: ${data.is_active ? 'aktiviert' : 'deaktiviert'}`, data.is_active ? 'success' : 'info');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminVerifyUser(userId, email) {
            if (!confirm(`E-Mail von ${email} manuell bestätigen?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/verify`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler', 'error'); return; }
                showToast(`${email}: E-Mail bestätigt ✓`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminSetRole(userId, role) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/role`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role })
                });
                if (!r.ok) { showToast('Fehler beim Setzen der Rolle', 'error'); return; }
                const rc = ROLE_CONFIG[role] || ROLE_CONFIG.researcher;
                showToast(`Rolle → ${rc.label} gesetzt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleAdmin(userId, email, makeAdmin) {
            const action = makeAdmin ? `${email} zum Admin ernennen?` : `Admin-Rechte von ${email} entziehen?`;
            if (!confirm(action)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-admin`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_admin: makeAdmin })
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); return; }
                showToast(makeAdmin ? `${email} ist jetzt Admin 👑` : `Admin-Rechte entfernt`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminToggleCrm(userId, data) {
            try {
                const r = await fetch(`${API}/admin/users/${userId}/crm-access`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!r.ok) { const d = await r.json().catch(()=>({})); showToast(d.detail || 'Fehler', 'error'); loadAdminData(); return; }
                const label = data.crm_access !== undefined ? (data.crm_access ? 'CRM freigeschaltet ✓' : 'CRM deaktiviert')
                    : data.lead_management !== undefined ? (data.lead_management ? 'Lead-Mgmt aktiviert ✓' : 'Lead-Mgmt deaktiviert')
                    : data.crm_owner_code !== undefined ? `Owner: ${data.crm_owner_code || '–'}`
                    : data.crm_role !== undefined ? `CRM-Rolle: ${data.crm_role}`
                    : 'Aktualisiert ✓';
                showToast(label, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function fbShowScreenshot(id) {
            try {
                const r = await fetch(`${API}/feedback/${id}/screenshot`, { headers: H() });
                if (!r.ok) { showToast('Bild nicht gefunden', 'error'); return; }
                const data = await r.json();
                // Show in modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;cursor:pointer;padding:20px';
                modal.onclick = () => modal.remove();
                const img = document.createElement('img');
                img.src = data.screenshot;
                img.style.cssText = 'max-width:95%;max-height:95%;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.5)';
                modal.appendChild(img);
                document.body.appendChild(modal);
            } catch(e) { showToast('Fehler', 'error'); }
        }

        async function fbUpdateStatus(id, status) {
            try {
                await fetch(`${API}/feedback/${id}`, {
                    method: 'PUT', headers: { ...H(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                loadAdminData();
            } catch(e) { showToast('Fehler', 'error'); }
        }

        // ── Password Change ──────────────────────────────
        function openPwModal() {
            document.getElementById('pwModal').classList.add('visible');
            document.getElementById('pwCurrent').value='';
            document.getElementById('pwNew').value='';
            document.getElementById('pwConfirm').value='';
            document.getElementById('pwMsg').className='modal-msg';
            document.getElementById('pwCurrent').focus();
        }
        function closePwModal() { document.getElementById('pwModal').classList.remove('visible'); }

        async function changePassword() {
            const cur = document.getElementById('pwCurrent').value;
            const nw = document.getElementById('pwNew').value;
            const conf = document.getElementById('pwConfirm').value;
            const msg = document.getElementById('pwMsg');
            const btn = document.getElementById('pwBtn');
            msg.className='modal-msg';
            if (!cur) { msg.className='modal-msg error'; msg.textContent='Bitte aktuelles Passwort eingeben.'; return; }
            if (nw.length < 6) { msg.className='modal-msg error'; msg.textContent='Neues Passwort muss mindestens 6 Zeichen haben.'; return; }
            if (nw !== conf) { msg.className='modal-msg error'; msg.textContent='Neue Passwörter stimmen nicht überein.'; return; }
            btn.disabled=true; btn.textContent='Wird geändert...';
            try {
                const r = await fetch(`${API}/change-password`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({current_password:cur, new_password:nw})});
                const d = await r.json();
                if (!r.ok) { msg.className='modal-msg error'; msg.textContent=d.detail||'Fehler'; btn.disabled=false; btn.textContent='Ändern'; return; }
                msg.className='modal-msg success'; msg.textContent='✓ Passwort erfolgreich geändert!';
                showToast('Passwort geändert','success');
                setTimeout(closePwModal, 1500);
            } catch(e) { msg.className='modal-msg error'; msg.textContent='Verbindungsfehler'; }
            btn.disabled=false; btn.textContent='Ändern';
        }
        document.addEventListener('keydown', e => { if(e.key==='Escape') closePwModal(); });

        // ── Profile ──────────────────────────────────────────────────────────
        let profileData = null;
        let profileExpertise = [];

        async function loadProfile() {
            try {
                const r = await fetch(`${API}/profile`, {headers:H()});
                if (!r.ok) return;
                profileData = await r.json();
                profileExpertise = profileData.expertise || [];
                // Fill form
                document.getElementById('profileName').value = profileData.name || '';
                document.getElementById('profilePosition').value = profileData.position || '';
                document.getElementById('profileCompany').value = profileData.company || '';
                document.getElementById('profilePhone').value = profileData.phone || '';
                document.getElementById('profileLinkedin').value = profileData.linkedin_url || '';
                document.getElementById('profileBio').value = profileData.bio || '';
                // Fill display card
                const name = profileData.name || profileData.email.split('@')[0];
                document.getElementById('profileDisplayName').textContent = name;
                document.getElementById('profileDisplayPosition').textContent = [profileData.position, profileData.company].filter(Boolean).join(' · ') || '–';
                document.getElementById('profileDisplayEmail').textContent = profileData.email;
                document.getElementById('profileDisplayCompany').textContent = profileData.company || '–';
                document.getElementById('profileDisplayPhone').textContent = profileData.phone || '–';
                if (profileData.created_at) {
                    document.getElementById('profileMemberSince').textContent = new Date(profileData.created_at).toLocaleDateString('de-CH', {month:'long', year:'numeric'});
                }
                // Avatar
                const avatar = document.getElementById('profileAvatar');
                if (profileData.profile_photo_url) {
                    avatar.innerHTML = `<img src="${profileData.profile_photo_url}" alt="Foto">`;
                } else {
                    const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
                    document.getElementById('profileInitials').textContent = initials;
                }
                // LinkedIn button state
                if (profileData.linkedin_connected) {
                    document.getElementById('linkedinBtn').className = 'linkedin-btn connected';
                    document.getElementById('linkedinBtnText').textContent = 'LinkedIn verbunden ✓';
                }
                // Expertise tags
                renderExpertise();
                // Load Ψ-Profile
                loadPsiProfile();
            } catch(e) { console.error('Profile load error:', e); }
        }

        async function loadPsiProfile() {
            try {
                const r = await fetch(`${API}/insight/profile`, { headers: H() });
                if (!r.ok) return;
                const psi = await r.json();
                const el = document.getElementById('psiProfileContent');

                if (!psi.has_profile || psi.total_insights === 0) {
                    el.innerHTML = `
                        <div style="text-align:center;padding:12px 0;color:rgba(255,255,255,0.4)">
                            <div style="font-size:20px;margin-bottom:8px">○</div>
                            <div>Noch kein Ψ-Profil vorhanden.</div>
                            <div style="margin-top:4px;font-size:12px">Beantworte Login-Fragen um dein Profil aufzubauen.</div>
                        </div>`;
                    return;
                }

                // Engagement bar
                const engColor = psi.engagement_score > 60 ? '#22c55e' : psi.engagement_score > 30 ? '#f59e0b' : 'var(--accent)';

                // Domain labels
                const domainLabels = { FIN: '💰 Finanzen', HLT: '🏥 Gesundheit', ORG: '🏢 Organisation', REL: '🕊️ Religion', EDU: '🎓 Bildung', ENV: '🌱 Umwelt', POL: '🏛️ Politik', OTH: '📋 Andere' };

                // Speed icon
                const speedIcon = psi.decision_speed === 'fast' ? '⚡' : psi.decision_speed === 'deliberate' ? '🧘' : '⚖️';

                // Build answer list
                let answersHtml = '';
                if (psi.answers && psi.answers.length > 0) {
                    answersHtml = '<div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px">' +
                        '<div style="font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Deine Antworten</div>' +
                        psi.answers.map(a => {
                            const domBadge = a.domain ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(139,170,255,0.1);color:var(--accent)">${a.domain}</span>` : '';
                            const styleBadge = a.style ? `<span style="font-size:10px;padding:2px 6px;border-radius:6px;background:rgba(255,255,255,0.05);color:var(--text-secondary)">${a.style.split('_')[0]}</span>` : '';
                            const latency = a.latency_ms ? `<span style="font-size:10px;color:var(--text-muted)">${(a.latency_ms/1000).toFixed(1)}s</span>` : '';
                            return `<div style="padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
                                <div style="font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:3px">${a.question}</div>
                                <div style="font-size:13px;color:rgba(255,255,255,0.85);font-weight:500">${a.choice_index ? '●' : '○'} ${a.answer}</div>
                                <div style="display:flex;gap:6px;margin-top:4px;align-items:center">${domBadge}${styleBadge}${latency}</div>
                            </div>`;
                        }).join('') + '</div>';
                }

                el.innerHTML = `
                    <div style="margin-bottom:14px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <span style="font-size:12px;color:var(--text-muted)">Engagement</span>
                            <span style="font-size:12px;font-weight:700;color:${engColor}">${psi.engagement_score}/100</span>
                        </div>
                        <div style="height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden">
                            <div style="height:100%;width:${psi.engagement_score}%;background:${engColor};border-radius:3px;transition:width 0.5s"></div>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${domainLabels[psi.primary_domain] || '📋'}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">Primary Domain</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:10px;text-align:center">
                            <div style="font-size:18px">${speedIcon}</div>
                            <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${psi.decision_speed}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
                        ${Object.entries(psi.thinking_styles || {}).map(([s, c]) =>
                            '<span style="font-size:11px;padding:3px 8px;border-radius:8px;background:rgba(139,170,255,0.1);color:var(--accent)">' + s + ' (' + c + ')</span>'
                        ).join('')}
                    </div>
                    <div style="font-size:12px;color:var(--text-muted)">
                        ${psi.total_insights} Insights · ${psi.avg_decision_latency_ms ? (psi.avg_decision_latency_ms/1000).toFixed(1)+'s ø Entscheidungszeit' : ''}
                    </div>
                    ${answersHtml}
                `;
            } catch(e) { console.error('Ψ-Profile load error:', e); }
        }

        function renderExpertise() {
            document.getElementById('profileExpertiseTags').innerHTML = profileExpertise.map((t,i) =>
                `<span class="profile-tag">${t}<span class="remove" onclick="removeExpertise(${i})">×</span></span>`
            ).join('') || '<span style="font-size:12px;color:var(--text-muted)">Noch keine Expertise hinzugefügt</span>';
        }

        function addExpertise() {
            const input = document.getElementById('expertiseInput');
            const val = input.value.trim();
            if (!val || profileExpertise.includes(val)) { input.value=''; return; }
            if (profileExpertise.length >= 20) { showToast('Max. 20 Expertise-Tags','info'); return; }
            profileExpertise.push(val);
            input.value = '';
            renderExpertise();
            saveProfile(true);
        }

        function removeExpertise(idx) {
            profileExpertise.splice(idx, 1);
            renderExpertise();
            saveProfile(true);
        }

        async function saveProfile(silent) {
            const data = {
                name: document.getElementById('profileName').value.trim(),
                position: document.getElementById('profilePosition').value.trim(),
                company: document.getElementById('profileCompany').value.trim(),
                phone: document.getElementById('profilePhone').value.trim(),
                linkedin_url: document.getElementById('profileLinkedin').value.trim(),
                bio: document.getElementById('profileBio').value.trim(),
                expertise: profileExpertise
            };
            try {
                const r = await fetch(`${API}/profile`, {method:'PUT', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(data)});
                if (!r.ok) { showToast('Fehler beim Speichern','error'); return; }
                if (!silent) showToast('Profil gespeichert ✓','success');
                // Update nav user name
                if (data.name) document.getElementById('navUser').textContent = data.name;
                loadProfile();
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        async function uploadPhoto(input) {
            if (!input.files.length) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            try {
                const r = await fetch(`${API}/profile/photo`, {method:'POST', headers:H(), body:fd});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'Fehler','error'); return; }
                showToast('Foto aktualisiert ✓','success');
                loadProfile();
            } catch(e) { showToast('Upload fehlgeschlagen','error'); }
            input.value='';
        }

        async function connectLinkedIn() {
            if (profileData?.linkedin_connected) {
                if (!confirm('LinkedIn-Verbindung trennen?')) return;
                try {
                    await fetch(`${API}/profile/linkedin/disconnect`, {method:'POST', headers:H()});
                    showToast('LinkedIn getrennt','info');
                    loadProfile();
                } catch(e) { showToast('Fehler','error'); }
                return;
            }
            try {
                const r = await fetch(`${API}/auth/linkedin`, {headers:H()});
                if (!r.ok) { const d=await r.json(); showToast(d.detail||'LinkedIn nicht konfiguriert','error'); return; }
                const {auth_url} = await r.json();
                const popup = window.open(auth_url, 'linkedin', 'width=600,height=700,left=200,top=100');
                window.addEventListener('message', async function handler(e) {
                    if (e.data?.type === 'linkedin_success') {
                        window.removeEventListener('message', handler);
                        try {
                            await fetch(`${API}/profile/linkedin`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify(e.data.data)});
                            showToast('LinkedIn verbunden ✓','success');
                            loadProfile();
                        } catch(err) { showToast('Fehler beim Speichern','error'); }
                    } else if (e.data?.type === 'linkedin_error') {
                        window.removeEventListener('message', handler);
                        showToast('LinkedIn-Verbindung fehlgeschlagen','error');
                    }
                });
            } catch(e) { showToast('Verbindungsfehler','error'); }
        }

        // ── Chat ──────────────────────────────────────────────────────────────
        let chatLoaded = false;

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function formatMessage(text) {
            // Use full markdown renderer
            return mbRenderMd(text);
        }

        function appendMessage(role, content, sources) {
            const welcome = document.getElementById('chatWelcome');
            if (welcome) welcome.style.display = 'none';
            const container = document.getElementById('chatMessages');
            const initials = role === 'user' ? (currentUser?.name || currentUser?.email || 'U').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2) : 'B';
            let html = `<div class="chat-msg ${role}">
                <div class="chat-msg-avatar">${initials}</div>
                <div class="chat-msg-body">${formatMessage(content)}`;
            if (sources && sources.length > 0) {
                html += `<div class="chat-sources">${sources.map(s => `<span class="chat-source-tag">${s.title}</span>`).join('')}</div>`;
            }
            html += `</div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping(message) {
            const container = document.getElementById('chatMessages');
            const existing = document.getElementById('typingIndicator');
            if (existing) existing.remove();
            container.insertAdjacentHTML('beforeend', `<div class="chat-msg assistant" id="typingIndicator">
                <div class="chat-msg-avatar">B</div>
                <div class="chat-msg-body">
                    <div style="display:flex;align-items:center;gap:10px;color:var(--text-muted);">
                        <div class="chat-typing"><span></span><span></span><span></span></div>
                        <span id="typingText">${message || 'BEATRIX denkt nach...'}</span>
                    </div>
                </div>
            </div>`);
            container.scrollTop = container.scrollHeight;
        }

        function updateTypingText(text) {
            const el = document.getElementById('typingText');
            if (el) el.textContent = text;
        }

        function removeTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        async function pollForAnswer(issueNumber) {
            const maxAttempts = 60; // 5 min max
            const interval = 5000; // 5 seconds
            const phases = [
                'BEATRIX liest das Evidence-Based Framework...',
                'Analysiert relevante Modelle und Axiome...',
                'Prüft Ψ-Dimensionen und Kontextfaktoren...',
                'Formuliert die Antwort...'
            ];

            for (let i = 0; i < maxAttempts; i++) {
                // Update phase message
                const phase = phases[Math.min(Math.floor(i / 5), phases.length - 1)];
                updateTypingText(phase);

                await new Promise(r => setTimeout(r, interval));
                try {
                    const r = await fetch(`${API}/chat/poll/${issueNumber}`, {headers:H()});
                    if (r.status === 401) { doLogout(); return null; }
                    const data = await r.json();
                    if (data.status === 'done') return data;
                    if (data.status === 'error') return {status:'error', answer: data.message};
                } catch(e) { /* retry */ }
            }
            return {status: 'timeout', answer: 'Die Analyse dauert länger als erwartet. Die Antwort wird in Issue #' + issueNumber + ' auf GitHub erscheinen.'};
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('chatSendBtn');
            const question = input.value.trim();
            if (!question) return;
            input.value = ''; autoResize(input);
            btn.disabled = true;
            appendMessage('user', question);
            showTyping('BEATRIX sucht in der Wissensbasis...');
            try {
                const r = await fetch(`${API}/chat`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({question})});
                if (r.status === 401) { doLogout(); return; }
                const d = await r.json();
                if (!r.ok) { removeTyping(); appendMessage('assistant', d.detail || 'Entschuldigung, es gab einen Fehler.'); return; }

                if (d.status === 'done' && d.path === 'fast') {
                    // ⚡ FAST PATH: Instant answer from Knowledge Base
                    removeTyping();
                    appendMessage('assistant', d.answer, d.sources);
                } else if (d.status === 'processing' && d.issue_number) {
                    // 🔬 DEEP PATH: Claude Code analysis
                    showTyping('Neue Frage! BEATRIX erarbeitet die Antwort mit dem EBF Framework (~3-5 Min)...');
                    const result = await pollForAnswer(d.issue_number);
                    removeTyping();
                    if (result && result.answer) {
                        appendMessage('assistant', result.answer, [{title: '🔬 EBF Deep Analysis', type: 'github', url: d.issue_url}]);
                    } else {
                        appendMessage('assistant', 'BEATRIX konnte keine Antwort generieren. Versuche es erneut.');
                    }
                } else if (d.answer) {
                    removeTyping();
                    appendMessage('assistant', d.answer, d.sources);
                }
            } catch(e) {
                removeTyping();
                appendMessage('assistant', 'Verbindungsfehler. Bitte versuche es erneut.');
            }
            btn.disabled = false;
            input.focus();
        }

        function askSuggestion(el) {
            document.getElementById('chatInput').value = el.textContent;
            sendChat();
        }

        async function loadChatHistory() {
            if (chatLoaded) return;
            try {
                const r = await fetch(`${API}/chat/history?limit=30`, {headers:H()});
                if (!r.ok) return;
                const msgs = await r.json();
                if (msgs.length > 0) {
                    const welcome = document.getElementById('chatWelcome');
                    if (welcome) welcome.style.display = 'none';
                    for (const m of msgs) {
                        appendMessage(m.role, m.content, m.sources);
                    }
                }
                chatLoaded = true;
            } catch(e) { console.error('Chat history error:', e); }
        }

        // ═══════ MODEL BUILDING WORKFLOW ═══════
        const mbState = { mode: null, step: 0, question: '', selections: {}, sessionId: null, selectedProblem: null };

        const MB_MODELS = [
            { id:'MOD-001', name:'Religious Tradition Distance Model', v:'2.0', domain:'REL', type:'distance_comparison' },
            { id:'MOD-REF-001', name:'Organic Referral Behavior Model', v:'1.0', domain:'ORG', type:'behavior' },
            { id:'MOD-PSF', name:'Papal Succession Framework', v:'2.0', domain:'REL', type:'process' },
            { id:'MOD-ESL', name:'Empirical Stability of Language Framework', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-NEAR-001', name:'Nearshoring Location Decision Model', v:'1.0', domain:'FIN', type:'decision' },
            { id:'MOD-IDV-001', name:'Interdependence Understanding Model', v:'2.0', domain:'ORG', type:'analysis' },
            { id:'MOD-PSM-001', name:'Philoro Strategy Model', v:'1.0', domain:'FIN', type:'strategy' },
            { id:'MOD-MSR-001', name:'Mission Statement Resonance Model', v:'1.0', domain:'ORG', type:'analysis' },
            { id:'MOD-ECHfP-001', name:'ECHfP Heating Replacement Behavioral Model', v:'1.0', domain:'ENV', type:'decision' },
            { id:'MOD-CPS-001', name:'Complex Problem Solving 10C Mapping', v:'1.0', domain:'EDU', type:'analysis' },
            { id:'MOD-TA-001', name:'Time-Intensive Goods Substitution Model', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-HMWM-001', name:'Holistic Migration Welfare Model', v:'3.3', domain:'POL', type:'process' },
            { id:'MOD-012', name:'Fiscal Behavior Model (FBM-CH)', v:'1.0', domain:'FIN', type:'continuous' },
            { id:'MOD-ZIN-001', name:'Kreislaufwirtschaft Behavior Dynamics ODE Model', v:'1.0', domain:'ENV', type:'process' },
            { id:'MOD-PMWT-001', name:'Pharma-MFN Welfare Transfer Model', v:'1.0', domain:'HLT', type:'analysis' },
            { id:'MOD-FIN-BUBBLE-001', name:'AI Bubble Diagnostic & Prognostic Model', v:'1.1', domain:'FIN', type:'analysis' },
            { id:'MOD-ORG-BMW-001', name:'BMW Product Compliance Behavioral Model', v:'1.0', domain:'ORG', type:'decision' },
            { id:'MOD-HLT-RES-001', name:'Health Reskilling Readiness Model', v:'1.0', domain:'HLT', type:'process' },
            { id:'MOD-EDU-LLL-001', name:'Lifelong Learning Adoption Model', v:'1.0', domain:'EDU', type:'continuous' },
            { id:'MOD-POL-TAX-001', name:'Tax Compliance Behavioral Model', v:'1.0', domain:'POL', type:'continuous' },
            { id:'MOD-ENV-MOB-001', name:'Sustainable Mobility Transition Model', v:'1.0', domain:'ENV', type:'process' }
        ];

        const DOMAIN_LABELS = { REL:'Religion', FIN:'Finance', HLT:'Health', ENV:'Environment', POL:'Policy', ORG:'Organization', EDU:'Education', OTH:'Other' };
        const DOMAIN_COLORS = { REL:'#a78bfa', FIN:'#34d399', HLT:'#f87171', ENV:'#60a5fa', POL:'#fbbf24', ORG:'#f472b6', EDU:'#38bdf8', OTH:'#94a3b8' };

        function mbSelectMode(el, mode) {
            // Double-tap = Workflow starten
            if (el.classList.contains('selected') && mbState.mode === mode) {
                mbStartWorkflow();
                return;
            }
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.mode = mode;
            document.getElementById('mbStartBtn').disabled = false;
        }

        // ── Smart Defaults Engine ──────────────────────
        let mbUserProfile = null;  // loaded on workflow start
        let mbDefaults = {};       // computed defaults per step

        async function mbLoadUserProfile() {
            try {
                const [profResp, psiResp] = await Promise.all([
                    fetch('/api/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }),
                    fetch('/api/insight/profile', { headers: { 'Authorization': 'Bearer ' + authToken } }).catch(() => null)
                ]);
                const profile = await profResp.json();
                let psi = null;
                if (psiResp && psiResp.ok) psi = await psiResp.json();

                mbUserProfile = {
                    name: profile.name || '',
                    expertise: profile.expertise || [],
                    position: profile.position || '',
                    company: profile.company || '',
                    psiInsights: psi?.total_insights || 0,
                    psiDomain: psi?.primary_domain || null,
                    psiStyle: psi?.primary_thinking_style || null,
                    psiEngagement: psi?.engagement_score || 0,
                    psiSpeed: psi?.avg_decision_speed || null,
                };
                console.log('📊 User profile loaded:', mbUserProfile);
                mbComputeDefaults();
                return profile;
            } catch(e) {
                console.warn('Profile load failed, using BEATRIX defaults');
                mbUserProfile = null;
                mbComputeDefaults();
                return null;
            }
        }

        function mbComputeDefaults() {
            const u = mbUserProfile;
            const isNew = !u || (u.psiInsights === 0 && u.expertise.length === 0);
            const isExperienced = u && (u.psiInsights >= 3 || u.expertise.length >= 2);
            const domain = mbState.selections?.domain || u?.psiDomain || null;
            const style = u?.psiStyle || null;

            // Mode
            if (isNew) {
                mbDefaults.mode = 'gefuehrt';
            } else if (isExperienced) {
                mbDefaults.mode = 'schnell';
            } else {
                mbDefaults.mode = 'gefuehrt';
            }

            // Step 1: Entry Point
            if (style?.includes('analytical') || style?.includes('systemic')) {
                mbDefaults.step1 = 'theory';
            } else if (style?.includes('intuitive') || style?.includes('empathic')) {
                mbDefaults.step1 = 'practice';
            } else if (isExperienced) {
                mbDefaults.step1 = 'hybrid';
            } else {
                mbDefaults.step1 = 'practice';
            }

            // Step 2: Scope (Behavior Type)
            if (['FIN', 'POL'].includes(domain)) {
                mbDefaults.step2 = 'decision';
            } else if (['HLT', 'ENV', 'EDU'].includes(domain)) {
                mbDefaults.step2 = 'continuous';
            } else if (['ORG'].includes(domain)) {
                mbDefaults.step2 = 'process';
            } else {
                mbDefaults.step2 = 'decision';
            }

            // Step 3: Context Ψ
            if (isNew) {
                mbDefaults.step3 = 'ggg-default';
            } else if (isExperienced) {
                mbDefaults.step3 = 'full-8psi';
            } else {
                mbDefaults.step3 = 'ggg-default';
            }

            // Step 6: Report Depth
            if (isNew) {
                mbDefaults.depth = 'standard';
            } else {
                mbDefaults.depth = 'deep';
            }

            console.log('🎯 Defaults computed:', mbDefaults, '(isNew:', isNew, 'isExperienced:', isExperienced, ')');
        }

        function mbApplyDefault(step) {
            // Recompute with latest domain info from Step 0
            mbComputeDefaults();

            if (step === 'start') {
                // Auto-select mode
                const cards = document.querySelectorAll('.mb-mode-card');
                const modeMap = ['schnell', 'gefuehrt', 'template', 'custom'];
                cards.forEach((card, i) => {
                    card.querySelector('.mb-default-badge')?.remove();
                    if (modeMap[i] === mbDefaults.mode) {
                        card.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                        // Auto-select
                        if (!mbState.mode) {
                            mbSelectMode(card, mbDefaults.mode);
                        }
                    }
                });
            }

            if (step === 1) {
                mbApplyChoiceDefault('mbStep1', mbDefaults.step1);
            }
            if (step === 2) {
                mbApplyChoiceDefault('mbStep2', mbDefaults.step2);
            }
            if (step === 3) {
                mbApplyChoiceDefault('mbStep3', mbDefaults.step3);
            }
            if (step === 6) {
                // Depth default
                const def = mbDefaults.depth || 'standard';
                setTimeout(() => {
                    // Remove old badges first
                    document.querySelectorAll('#mbDepthChoice .mb-default-badge').forEach(b => b.remove());
                    const el = def === 'deep' ? document.getElementById('mbDepthDeep') : document.getElementById('mbDepthStd');
                    if (el) {
                        el.style.position = 'relative';
                        el.insertAdjacentHTML('afterbegin', '<div class="mb-default-badge" style="position:absolute;top:10px;right:12px">empfohlen</div>');
                        mbSelectDepth(def, el);
                    }
                }, 150);
            }
        }

        function mbApplyChoiceDefault(panelId, defaultValue) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            const choices = panel.querySelectorAll('.mb-choice');
            let applied = false;

            choices.forEach(choice => {
                // Remove old badges
                choice.querySelector('.mb-default-badge')?.remove();

                // Find value from onclick
                const onclick = choice.getAttribute('onclick') || '';
                const match = onclick.match(/mbSelect\(this,'([^']+)'\)/);
                if (match && match[1] === defaultValue) {
                    choice.insertAdjacentHTML('beforeend', '<div class="mb-default-badge">empfohlen</div>');
                    // Auto-select if nothing selected yet
                    const alreadySelected = panel.querySelector('.mb-choice.selected');
                    if (!alreadySelected) {
                        mbSelect(choice, defaultValue, true);  // silent, no confirmation
                        applied = true;
                    }
                }
            });
        }

        function mbStartWorkflow() {
            if (!mbState.mode) return;
            mbState.step = 0;
            mbState.selectedProblem = null;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
            mbLoadPersonalizedQuestions();
            mbApplyDefault(0);
        }

        async function mbLoadPersonalizedQuestions() {
            const container = document.getElementById('mbStep0Choices');
            try {
                // Use already-loaded profile or load fresh
                const profile = mbUserProfile || await mbLoadUserProfile();
                const expertise = (profile?.expertise || []).join(', ') || 'Behavioral Economics';
                const userName = profile?.name || 'User';
                const position = profile?.position || '';
                const company = profile?.company || '';

                // 2. Ask BEATRIX to generate 3 personalized questions
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere genau 3 Problemstellungen für den EEE Model-Building Workflow, personalisiert für dieses Profil:
- Name: ${userName}
- Position: ${position}
- Unternehmen: ${company}
- Expertise: ${expertise}

Jede Problemstellung soll ein reales Verhaltensphänomen beschreiben, das mit dem BCM modellierbar ist.

Antworte NUR als JSON Array:
[{"icon":"emoji","title":"Kurztitel max 4 Worte","phenomenon":"Beobachtbares Verhalten, 1 Satz mit Zahlen/Fakten","paradox":"Warum ist das überraschend/problematisch, 1 Satz","question":"Konkrete Forschungsfrage, 1 Satz","domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"}]` })
                });
                const data = await resp.json();

                let questions = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\[[\s\S]*\]/);
                        if (jsonMatch) questions = JSON.parse(jsonMatch[0]);
                    } catch(e) { console.error('Parse error:', e); }
                }

                // 3. Fallback if generation failed
                if (!questions || questions.length < 3) {
                    questions = [
                        { icon: '🏢', title: 'Strategie & Verhalten', phenomenon: `Über 70% der strategischen Initiativen in Beratungsunternehmen wie ${company || 'FehrAdvice'} stoßen auf interne Verhaltenswiderstände.`, paradox: 'Selbst Mitarbeiter, die den Wandel befürworten, fallen in alte Routinen zurück.', question: 'Welche BCM-Hebel können die Umsetzungsrate strategischer Entscheidungen nachhaltig steigern?', domain: 'ORG' },
                        { icon: '🧠', title: 'Decision Architecture', phenomenon: 'Change-Prozesse in Organisationen erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Kommunikation und Incentives führen paradoxerweise zu stärkerem Widerstand.', question: 'Wie kann Choice Architecture die Akzeptanz von Veränderungsprozessen in Organisationen erhöhen?', domain: 'ORG' },
                        { icon: '💰', title: 'Finanzentscheidungen', phenomenon: 'Privatinvestoren erzielen im Schnitt 2-4% weniger Rendite als passive Markt-Benchmarks.', paradox: 'Trotz verfügbarer ETF-Strategien handeln 80% aktiv und systematisch schlechter.', question: 'Wie kann Decision Architecture die rationalen Anlageentscheidungen von Privatinvestoren korrigieren?', domain: 'FIN' }
                    ];
                }

                // 4. Render personalized choices as clean tap cards
                // Store questions globally for structured selection
                window._mbQuestions = questions.slice(0, 3);
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon || '📋'}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon || q.question || ''}</div>
                    </div>
                `).join('');

            } catch(e) {
                console.error('Load questions error:', e);
                window._mbQuestions = [
                    { icon: '🧠', title: 'Behavioral Strategy', phenomenon: 'Über 60% der strategischen Initiativen in Organisationen scheitern an Verhaltensbarrieren.', paradox: 'Selbst wenn alle Stakeholder zustimmen, blockiert Status-Quo-Bias die Umsetzung.', question: 'Wie kann Behavioral Economics die Implementierungsrate strategischer Entscheidungen verbessern?', domain: 'ORG' },
                    { icon: '🏗️', title: 'Change & Architecture', phenomenon: 'Change-Prozesse erreichen typischerweise nur 30% der geplanten Akzeptanzrate.', paradox: 'Mehr Information und Kommunikation führt paradoxerweise zu mehr Widerstand.', question: 'Wie kann Decision Architecture die Akzeptanz von Veränderungsprozessen erhöhen?', domain: 'ORG' },
                    { icon: '💰', title: 'Investment Biases', phenomenon: 'Privatanleger erzielen im Schnitt 2-4% weniger Rendite als Markt-Benchmarks.', paradox: 'Trotz verfügbarer passiver Strategien handeln 80% aktiv und verlieren.', question: 'Welche BCM-Hebel können systematische Anlage-Verzerrungen korrigieren?', domain: 'FIN' }
                ];
                container.innerHTML = window._mbQuestions.map((q, i) => `
                    <div onclick="mbSelectProblemStructured(${i})"
                         style="padding:16px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;transition:all 0.2s;background:rgba(255,255,255,0.02)"
                         onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(139,170,255,0.06)'"
                         onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.02)'">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                            <span style="font-size:18px">${q.icon}</span>
                            <span style="font-weight:600;color:white;font-size:15px">${q.title}</span>
                            <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.6">${q.domain}</span>
                        </div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.55);line-height:1.5">${q.phenomenon}</div>
                    </div>
                `).join('');
            }
        }

        // ── Universal Streaming + Progressive Reveal ──────────
        function mbRenderMd(text) {
            // v3.12 Full markdown → HTML renderer
            if (!text || typeof text !== 'string') return '';
            try {
            const lines = text.split('\n');
            let html = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;

            function flushTable() {
                if (!tableRows.length) return '';
                let t = '<table style="width:100%;border-collapse:collapse;margin:16px 0;font-size:13px">';
                tableRows.forEach((row, ri) => {
                    // Skip separator rows (|---|---|)
                    if (/^\|[\s\-:]+\|/.test(row) && row.replace(/[\s\-:|]/g, '') === '') return;
                    const cells = row.split('|').filter((c, i, a) => i > 0 && i < a.length - 1);
                    const isHeader = ri === 0;
                    t += '<tr>';
                    cells.forEach(cell => {
                        const tag = isHeader ? 'th' : 'td';
                        const style = isHeader
                            ? 'padding:8px 10px;text-align:left;font-weight:600;color:var(--accent);border-bottom:2px solid rgba(139,170,255,0.2);font-size:12px;text-transform:uppercase;letter-spacing:0.3px'
                            : 'padding:8px 10px;text-align:left;color:rgba(255,255,255,0.8);border-bottom:1px solid rgba(255,255,255,0.05);vertical-align:top;line-height:1.5';
                        const content = cell.trim().replace(/\*\*(.*?)\*\*/g, '<strong style="color:white">$1</strong>');
                        t += `<${tag} style="${style}">${content}</${tag}>`;
                    });
                    t += '</tr>';
                });
                t += '</table>';
                tableRows = [];
                inTable = false;
                return t;
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // Table detection
                if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                    if (!inTable) inTable = true;
                    tableRows.push(line);
                    continue;
                } else if (inTable) {
                    html += flushTable();
                }

                // Horizontal rule
                if (/^---+$/.test(line.trim())) {
                    html += '<hr style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:20px 0">';
                    continue;
                }

                // Headers
                if (line.startsWith('#### ')) {
                    html += `<div style="font-size:13px;font-weight:700;color:rgba(255,255,255,0.85);margin:16px 0 6px">${inlineMd(line.slice(5))}</div>`;
                    continue;
                }
                if (line.startsWith('### ')) {
                    html += `<h4 style="color:var(--accent);font-size:14px;font-weight:700;margin:20px 0 8px;letter-spacing:0.3px">${line.slice(4)}</h4>`;
                    continue;
                }
                if (line.startsWith('## ')) {
                    html += `<div style="font-size:16px;font-weight:700;color:white;margin:24px 0 10px;padding-bottom:6px;border-bottom:1px solid rgba(139,170,255,0.15)">${line.slice(3)}</div>`;
                    continue;
                }
                if (line.startsWith('# ')) {
                    html += `<div style="font-size:20px;font-weight:700;color:white;margin:8px 0 12px">${line.slice(2)}</div>`;
                    continue;
                }

                // List items
                if (/^[-*] /.test(line.trim())) {
                    const content = line.trim().replace(/^[-*] /, '');
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0">•</span><span>${inlineMd(content)}</span></div>`;
                    continue;
                }
                if (/^\d+\. /.test(line.trim())) {
                    const m = line.trim().match(/^(\d+)\. (.*)/);
                    html += `<div style="display:flex;gap:8px;padding:3px 0 3px 4px"><span style="color:var(--accent);flex-shrink:0;font-weight:600;min-width:18px">${m[1]}.</span><span>${inlineMd(m[2])}</span></div>`;
                    continue;
                }

                // Empty line = paragraph break
                if (line.trim() === '') {
                    html += '<div style="height:8px"></div>';
                    continue;
                }

                // Normal paragraph
                html += `<div style="padding:2px 0;line-height:1.7">${inlineMd(line)}</div>`;
            }

            // Flush remaining table
            if (inTable) html += flushTable();

            return html;
            } catch(e) {
                console.error('mbRenderMd error:', e);
                // Fallback: basic inline rendering
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
            }
        }

        function inlineMd(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color:rgba(255,255,255,0.95)">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color:rgba(255,255,255,0.7)">$1</em>')
                .replace(/`(.*?)`/g, '<code style="background:rgba(139,170,255,0.1);padding:1px 5px;border-radius:4px;font-size:12px;color:var(--accent)">$1</code>');
        }

        async function mbStreamChat(prompt, targetEl, opts = {}) {
            /**
             * Streams Claude response into targetEl with typewriter effect.
             * opts: { onStart, onDone, onError, showCursor }
             */
            const { onStart, onDone, onError, showCursor = true } = opts;
            let fullText = '';
            let renderBuffer = '';
            let renderTimer = null;

            // Show cursor
            if (showCursor) {
                targetEl.innerHTML = '<span class="mb-cursor" style="display:inline-block;width:2px;height:16px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle"></span>';
            }
            if (onStart) onStart();

            try {
                const resp = await fetch(`${API}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: prompt })
                });

                if (!resp.ok) {
                    throw new Error(`Stream error: ${resp.status}`);
                }

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let sseBuffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    sseBuffer += decoder.decode(value, { stream: true });

                    // Parse SSE events
                    const events = sseBuffer.split('\n\n');
                    sseBuffer = events.pop(); // Keep incomplete event

                    for (const evt of events) {
                        for (const line of evt.split('\n')) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'token' && data.text) {
                                    fullText += data.text;
                                    // Throttle rendering to every 50ms for performance
                                    if (!renderTimer) {
                                        renderTimer = setTimeout(() => {
                                            targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' +
                                                mbRenderMd(fullText) +
                                                (showCursor ? '<span class="mb-cursor" style="display:inline-block;width:2px;height:14px;background:var(--accent);animation:blink 0.8s infinite;vertical-align:middle;margin-left:2px"></span>' : '') +
                                                '</div>';
                                            targetEl.scrollTop = targetEl.scrollHeight;
                                            renderTimer = null;
                                        }, 50);
                                    }
                                } else if (data.type === 'done') {
                                    // Final render without cursor
                                    if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                                    targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                                }
                            } catch(e) {}
                        }
                    }
                }

                // Ensure final render
                if (renderTimer) { clearTimeout(renderTimer); renderTimer = null; }
                targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                if (onDone) onDone(fullText);
                return fullText;

            } catch(e) {
                console.error('Stream error:', e);
                // Fallback to non-streaming
                try {
                    const resp = await fetch(`${API}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                        body: JSON.stringify({ question: prompt })
                    });
                    const data = await resp.json();
                    if (data.answer) {
                        fullText = data.answer;
                        targetEl.innerHTML = '<div style="font-size:14px;line-height:1.8;color:rgba(255,255,255,0.85)">' + mbRenderMd(fullText) + '</div>';
                        if (onDone) onDone(fullText);
                        return fullText;
                    }
                } catch(e2) {}
                if (onError) onError(e);
                targetEl.innerHTML = '<div style="color:#ef4444;padding:12px">⚠ Fehler bei der Verbindung. Bitte erneut versuchen.</div>';
                return '';
            }
        }

        function mbShowThinking(targetEl, stages) {
            /**
             * Shows animated "thinking" stages while waiting.
             * Returns { stop() } to call when done.
             */
            let currentStage = 0;
            const startTime = Date.now();

            function render() {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
                let html = '<div style="padding:8px 0">';
                for (let i = 0; i < stages.length; i++) {
                    const isDone = i < currentStage;
                    const isActive = i === currentStage;
                    const icon = isDone ? '<span style="color:#22c55e">✓</span>' :
                                 isActive ? '<span style="display:inline-block;width:12px;height:12px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.6s linear infinite;vertical-align:middle"></span>' :
                                 '<span style="color:rgba(255,255,255,0.2)">○</span>';
                    const opacity = isDone ? '0.5' : isActive ? '1' : '0.25';
                    html += `<div style="display:flex;align-items:center;gap:10px;padding:5px 0;opacity:${opacity};transition:all 0.3s">
                        <div style="width:20px;text-align:center">${icon}</div>
                        <div style="font-size:13px;color:rgba(255,255,255,0.7)">${stages[i]}</div>
                    </div>`;
                }
                html += `<div style="font-size:11px;color:rgba(255,255,255,0.3);margin-top:8px;padding-left:30px">${elapsed}s</div>`;
                html += '</div>';
                targetEl.innerHTML = html;
            }

            render();
            const interval = setInterval(() => {
                if (currentStage < stages.length - 1) currentStage++;
                render();
            }, 2000);

            return {
                stop() { clearInterval(interval); },
                complete() {
                    clearInterval(interval);
                    currentStage = stages.length;
                    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                    let html = '<div style="padding:8px 0">';
                    for (const s of stages) {
                        html += `<div style="display:flex;align-items:center;gap:10px;padding:3px 0;opacity:0.5"><div style="width:20px;text-align:center"><span style="color:#22c55e">✓</span></div><div style="font-size:13px;color:rgba(255,255,255,0.5)">${s}</div></div>`;
                    }
                    html += `<div style="font-size:11px;color:#22c55e;margin-top:6px;padding-left:30px">✓ Abgeschlossen in ${elapsed}s</div></div>`;
                    targetEl.innerHTML = html;
                }
            };
        }

        function mbGoToStart() {
            mbState.step = 0;
            mbState.selections = {};
            mbState.question = '';
            document.getElementById('mbProgress').style.display = 'none';
            mbShowPanel('mbStart');
            document.querySelectorAll('.mb-mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('mbStartBtn').disabled = true;
        }

        function mbShowPanel(panelId) {
            document.querySelectorAll('#model-section .mb-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
        }

        function mbUpdateProgress(step) {
            document.querySelectorAll('.mb-step-dot').forEach(d => {
                const s = parseInt(d.dataset.step);
                d.classList.remove('active','completed');
                if (s < step) d.classList.add('completed');
                else if (s === step) d.classList.add('active');
            });
            document.querySelectorAll('.mb-step-line').forEach((l, i) => {
                l.classList.toggle('completed', i < step);
            });
        }

        function mbGoStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for steps with dual views
            mbResetStepViews(step);
            mbApplyDefault(step);
        }

        function mbResetStepViews(step) {
            const viewA = document.getElementById('mbStep' + step + 'ViewA');
            const viewB = document.getElementById('mbStep' + step + 'ViewB');
            if (viewA) viewA.style.display = 'block';
            if (viewB) viewB.style.display = 'none';
        }

        function mbNextStep(step) {
            mbState.step = step;
            mbUpdateProgress(step);
            mbShowPanel('mbStep' + step);
            // Reset to ViewA for the new step
            mbResetStepViews(step);
            // Step 6: reset depth choice first, THEN apply defaults
            if (step === 6) {
                mbState.reportDepth = null;
                const btn = document.getElementById('mbComputeBtn');
                if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
                document.getElementById('mbDepthChoice').style.display = 'flex';
                document.getElementById('mbComputeProgress').style.display = 'none';
                document.getElementById('mbResultContent').style.display = 'none';
                document.getElementById('mbExportBtn').style.display = 'none';
                document.getElementById('mbNewModelBtn').style.display = 'none';
                document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                    d.classList.remove('depth-active');
                    d.style.borderColor = 'rgba(255,255,255,0.08)';
                    d.style.background = 'transparent';
                });
            }
            // Apply defaults AFTER any resets
            mbApplyDefault(step);
        }

        function mbSelectDepth(depth, el) {
            // Double-tap = Report generieren
            if (el.classList.contains('depth-active') && mbState.reportDepth === depth) {
                const btn = document.getElementById('mbComputeBtn');
                if (btn && !btn.disabled) btn.click();
                return;
            }
            mbState.reportDepth = depth;
            document.querySelectorAll('#mbDepthChoice > div').forEach(d => {
                d.classList.remove('depth-active');
                d.style.borderColor = 'rgba(255,255,255,0.08)';
                d.style.background = 'transparent';
            });
            el.classList.add('depth-active');
            el.style.borderColor = 'var(--accent)';
            el.style.background = 'rgba(139,170,255,0.08)';
            const btn = document.getElementById('mbComputeBtn');
            if (btn) { btn.disabled = false; btn.style.opacity = '1'; }
        }

        // ── Choice Confirmation System ──────────────────
        let mbPendingConfirm = null; // { step, value, nextAction }

        const mbChoiceExplanations = {
            // Step 1: Entry Point
            'mbStep1': {
                'theory': {
                    icon: '📚', title: 'Theory-Driven',
                    body: 'Du startest mit einem bestehenden EBF-Konzept aus den CORE Appendices (AAA–AW). BEATRIX leitet daraus die praktische Anwendung ab.',
                    implication: 'BEATRIX wird zuerst relevante Theorien und Frameworks identifizieren, dann auf dein konkretes Problem anwenden. Ideal wenn du weisst, welches Konzept du nutzen möchtest.'
                },
                'practice': {
                    icon: '🎯', title: 'Practice-Driven',
                    body: 'Du startest mit deinem konkreten Problem oder Gestaltungsanlass. BEATRIX findet die passenden theoretischen Grundlagen automatisch.',
                    implication: 'BEATRIX analysiert dein Problem und mapped es auf die relevanten BCM-Dimensionen. Der schnellste Weg zu einem anwendbaren Modell.'
                },
                'hybrid': {
                    icon: '🔄', title: 'Hybrid (Iteration)',
                    body: 'Abwechselnde Theorie-Praxis-Zyklen. Du pendelt zwischen EBF-Konzepten und praktischer Anwendung.',
                    implication: 'BEATRIX wird iterativ vorgehen: Theorie → Praxis → Validierung → Anpassung. Braucht mehr Zeit, liefert aber das robusteste Modell.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Entry Point',
                    body: 'Du definierst den Startpunkt selbst. Maximale Flexibilität für erfahrene Modellierer.',
                    implication: 'BEATRIX gibt dir volle Kontrolle über den Entry Point. Du kannst Theorie und Praxis frei kombinieren.'
                }
            },
            // Step 2: Scope
            'mbStep2': {
                'decision': {
                    icon: '⚖️', title: 'Decision (Einmalentscheidung)',
                    body: 'Du modellierst eine diskrete Entscheidung: Ja/Nein, Option A vs. B. Typisch für Versicherungswahl, Impfentscheidung, Jobwechsel.',
                    implication: 'Mathematik: Logistic / Binary Choice Model. BEATRIX berechnet die Wahrscheinlichkeit P(B=1) dass das Zielverhalten eintritt. Ergebnis ist eine klare Ja/Nein-Prognose mit Konfidenz.'
                },
                'continuous': {
                    icon: '📈', title: 'Continuous (Wiederholtes Verhalten)',
                    body: 'Du modellierst ein Verhalten mit variabler Intensität: Sparbetrag, Energieverbrauch, Trainingsfrequenz.',
                    implication: 'Mathematik: CES Functional Form. BEATRIX berechnet den erwarteten Verhaltenslevel B* und die Elastizitäten der Einflussfaktoren.'
                },
                'process': {
                    icon: '🔄', title: 'Process (Veränderung über Zeit)',
                    body: 'Du modellierst eine Verhaltensveränderung über Zeit: Habit-Bildung, Adoption Journey, Lernprozesse.',
                    implication: 'Mathematik: Dynamic BCJ Models. BEATRIX modelliert die Trajektorie und identifiziert kritische Übergangspunkte zwischen Stages.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Scope',
                    body: 'Du kombinierst oder erweiterst die Standard-Typen frei.',
                    implication: 'Flexible Modell-Spezifikation – du definierst die funktionale Form und den Outcome-Typ selbst.'
                }
            },
            // Step 3: Context Ψ
            'mbStep3': {
                'ggg-default': {
                    icon: '📊', title: 'GGG Defaults',
                    body: 'Vorkonfigurierte Ψ-Werte aus Tabelle GGG-1 basierend auf Domain und Level. Schnell und empirisch validiert.',
                    implication: 'BEATRIX nutzt die Standard-Kalibrierung: trust, digital_adoption, autonomy, risk_aversion. Das spart ~15 Minuten und liefert robuste Baseline-Werte.'
                },
                'custom-psi': {
                    icon: '🎛️', title: 'Custom Ψ-Dimensionen',
                    body: 'Du definierst explizit welche Kontextfaktoren relevant sind – z.B. Saisonalität, Peer Effects, Availability.',
                    implication: 'BEATRIX verwendet deine spezifischen Ψ-Dimensionen statt der Defaults. Ideal wenn du den Kontext besser kennst als die Standard-Kalibrierung.'
                },
                'full-8psi': {
                    icon: '🔬', title: 'Alle 8 Ψ-Dimensionen',
                    body: 'Vollständige Analyse aller 8 Kontextdimensionen: Institutional, Social, Knowledge, Cultural, Temporal, Economic, Motivational, Framing.',
                    implication: 'Maximale Tiefe und Differenzierung. BEATRIX analysiert jeden Kontextfaktor einzeln und berechnet den gewichteten Gesamt-Ψ-Score. Dauert etwas länger, liefert aber die präziseste Kalibrierung.'
                },
                'custom': {
                    icon: '🔧', title: 'Custom Context',
                    body: 'Eigene Kontext-Konfiguration mit freier Ψ-Auswahl.',
                    implication: 'Du wählst und gewichtest die Ψ-Dimensionen selbst. Für Experten mit spezifischen Kontext-Hypothesen.'
                }
            }
        };

        function mbSelect(el, value, silent) {
            const panel = el.closest('.mb-panel');
            const stepId = panel.id;

            // Double-tap same choice = weiter (fallback)
            if (el.classList.contains('selected') && mbState.selections[stepId] === value) {
                const btn = panel.querySelector('.mb-btn-primary');
                if (btn && !btn.disabled) btn.click();
                return;
            }

            panel.querySelectorAll('.mb-choice').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            mbState.selections[stepId] = value;
            const btn = panel.querySelector('.mb-btn-primary');
            if (btn) btn.disabled = false;

            // Auto-advance: tap = select + go
            if (!silent) {
                setTimeout(() => {
                    if (btn && !btn.disabled) btn.click();
                }, 350);
            }
        }

        function mbShowConfirmation(stepLabel, icon, title, body, implication) {
            document.getElementById('mbConfirmStep').textContent = stepLabel;
            document.getElementById('mbConfirmIcon').textContent = icon;
            document.getElementById('mbConfirmTitle').textContent = title;
            document.getElementById('mbConfirmBody').textContent = body;
            document.getElementById('mbConfirmImplText').textContent = implication;

            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            overlay.style.display = 'block';
            requestAnimationFrame(() => {
                overlay.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            });
        }

        function mbHideConfirmation() {
            const overlay = document.getElementById('mbConfirmOverlay');
            const card = document.getElementById('mbConfirmCard');
            card.style.transform = 'translateY(100%)';
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 350);
        }

        function mbConfirmProceed() {
            if (!mbPendingConfirm) return;
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        function mbConfirmBack() {
            mbHideConfirmation();
            mbPendingConfirm = null;
        }

        // Steps 1-2: advance to next step
        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        function mbRenderProblemCard(data) {
            // data: { icon, title, phenomenon, paradox, question, domain, generated }
            const labels = { phenomenon: 'Phänomen', paradox: 'Paradox', question: 'Forschungsfrage' };
            const icons = { phenomenon: '🔍', paradox: '⚡', question: '🎯' };
            const colors = { phenomenon: 'rgba(255,255,255,0.7)', paradox: 'rgba(251,191,36,0.8)', question: 'rgba(139,170,255,0.9)' };

            let rows = '';
            for (const key of ['phenomenon', 'paradox', 'question']) {
                if (data[key]) {
                    rows += `
                    <div style="display:flex;gap:10px;align-items:flex-start;padding:8px 0;${key !== 'question' ? 'border-bottom:1px solid rgba(255,255,255,0.04)' : ''}">
                        <div style="flex-shrink:0;width:20px;text-align:center;font-size:13px;padding-top:1px">${icons[key]}</div>
                        <div>
                            <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.3);margin-bottom:3px">${labels[key]}</div>
                            <div style="font-size:13px;color:${colors[key]};line-height:1.55">${data[key]}</div>
                        </div>
                    </div>`;
                }
            }

            return `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                    <span style="font-size:20px">${data.icon || '📋'}</span>
                    <span style="font-weight:600;color:white;font-size:15px">${data.title || ''}</span>
                    <span style="margin-left:auto;font-size:11px;color:var(--accent);opacity:0.5">${data.domain || ''}</span>
                </div>
                ${rows}
                ${data.generated ? '<div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,0.25)">🤖 Von BEATRIX generiert</div>' : ''}
            `;
        }

        // Parse a flat question string into structured components
        function mbParseQuestion(text) {
            // Try to split by sentence-ending patterns (? or .)
            const sentences = text.match(/[^.?!]+[.?!]+/g) || [text];
            if (sentences.length >= 3) {
                return { phenomenon: sentences[0].trim(), paradox: sentences[1].trim(), question: sentences.slice(2).join(' ').trim() };
            } else if (sentences.length === 2) {
                return { phenomenon: sentences[0].trim(), question: sentences[1].trim() };
            }
            return { question: text };
        }

        function mbSelectProblemStructured(idx) {
            const q = (typeof idx === 'number') ? window._mbQuestions[idx] : idx;
            if (!q) return;
            const fullQ = [q.phenomenon, q.paradox, q.question].filter(Boolean).join(' ');
            mbState.selectedProblem = fullQ;

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(q);
            mbProcessStep0();
        }

        function mbSelectProblem(el, question) {
            mbState.selectedProblem = question;
            // Get structured data from the card if available
            const titleEl = el.querySelector('[style*="font-weight:600"]');
            const icon = el.querySelector('[style*="font-size:18px"]');
            const domainEl = el.querySelector('[style*="opacity:0.6"]');

            const parsed = mbParseQuestion(question);
            parsed.icon = icon ? icon.textContent : '📋';
            parsed.title = titleEl ? titleEl.textContent : '';
            parsed.domain = domainEl ? domainEl.textContent : '';

            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            mbProcessStep0();
        }

        function mbStep0Back() {
            document.getElementById('mbStep0ViewB').style.display = 'none';
            document.getElementById('mbStep0ViewA').style.display = 'block';
            document.getElementById('mbStep0Result').style.display = 'none';
            mbState.selectedProblem = null;
        }

        function mbShowCustomInput() {
            mbState.selectedProblem = null;
            const ci = document.getElementById('mbCustomInput');
            ci.style.display = 'block';
            ci.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => document.getElementById('mbQuestion').focus(), 200);
        }

        async function mbLetBeatrixDefine() {
            // Switch to a generation view
            document.getElementById('mbStep0ViewA').style.display = 'none';
            document.getElementById('mbStep0ViewB').style.display = 'block';
            document.getElementById('mbStep0SelectedQ').innerHTML = `
                <div style="display:flex;align-items:center;gap:10px">
                    <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0"></div>
                    <span style="color:rgba(255,255,255,0.5)">BEATRIX generiert eine Problemstellung...</span>
                </div>`;
            document.getElementById('mbStep0Result').style.display = 'none';
            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'Wird generiert...';

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Generiere eine Problemstellung für den EEE Model-Building Workflow.
Antworte NUR als JSON:
{
  "icon": "passendes emoji",
  "title": "Kurztitel 3-4 Worte",
  "phenomenon": "Das beobachtbare Verhalten in 1 Satz (was passiert konkret, mit Zahlen/Fakten)",
  "paradox": "Die Spannung/das Paradox in 1 Satz (warum ist es überraschend oder problematisch)",
  "question": "Die konkrete Forschungsfrage in 1 Satz (was wollen wir herausfinden)",
  "domain": "REL/FIN/HLT/ENV/POL/ORG/EDU/OTH"
}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }
                if (!parsed) parsed = { icon: '🔬', title: 'Behavioral Analysis', phenomenon: data.answer || '', paradox: '', question: '', domain: 'OTH' };

                // Compose full question for state
                const fullQ = [parsed.phenomenon, parsed.paradox, parsed.question].filter(Boolean).join(' ');
                mbState.selectedProblem = fullQ;

                // Show as structured card
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);

                // Auto-trigger analysis
                mbProcessStep0();

            } catch(e) {
                console.error('Generate error:', e);
                document.getElementById('mbStep0SelectedQ').innerHTML = '<div style="color:#ef4444">⚠ Fehler bei der Generierung. Bitte erneut versuchen.</div>';
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
            }
        }

        // ── Universal Inline Progress ──────────────────────────
        const MB_STEP_STAGES = {
            0: [
                { label: 'Frage parsen', pct: 15 },
                { label: 'Domain erkennen', pct: 35 },
                { label: 'Verhaltensziel identifizieren', pct: 55 },
                { label: 'Scope definieren', pct: 75 },
                { label: 'Session erstellen', pct: 92 },
            ],
            3: [
                { label: 'Kontext-Variablen laden', pct: 12 },
                { label: 'Ψ-Dimensionen berechnen', pct: 30 },
                { label: '10C CORE Mapping', pct: 50 },
                { label: 'Domain-Konfiguration', pct: 68 },
                { label: 'Sensitivität prüfen', pct: 82 },
                { label: 'Modell-Match suchen', pct: 95 },
            ],
        };

        function mbStartProgress(stepNum) {
            const el = document.getElementById('mbProgress' + stepNum);
            if (!el) return null;
            const stages = MB_STEP_STAGES[stepNum] || [];
            el.style.display = 'block';
            el.innerHTML = `
                <div class="mb-prog-header">
                    <div class="mb-prog-spinner"></div>
                    <div>
                        <div style="font-size:14px;font-weight:600;color:rgba(255,255,255,0.9)" id="mbProgLabel${stepNum}">BEATRIX arbeitet...</div>
                        <div style="font-size:11px;color:rgba(255,255,255,0.4);margin-top:2px" id="mbProgDetail${stepNum}"></div>
                    </div>
                </div>
                <div class="mb-prog-bar-bg"><div class="mb-prog-bar" id="mbProgBar${stepNum}"></div></div>
                <div class="mb-prog-meta">
                    <span id="mbProgPct${stepNum}">0%</span>
                    <span id="mbProgTime${stepNum}">Geschätzt: ~${Math.round(stages.length * 2)}s</span>
                </div>
                <div class="mb-prog-stages">
                    ${stages.map((s, i) => `
                        <div class="mb-prog-stage" id="mbProgS${stepNum}_${i}">
                            <div class="mb-prog-dot" id="mbProgD${stepNum}_${i}">○</div>
                            <span>${s.label}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const startTime = Date.now();
            let idx = 0;
            const interval = setInterval(() => {
                if (idx >= stages.length) { clearInterval(interval); return; }
                const s = stages[idx];

                // Update bar
                const bar = document.getElementById('mbProgBar' + stepNum);
                const pct = document.getElementById('mbProgPct' + stepNum);
                const label = document.getElementById('mbProgLabel' + stepNum);
                const time = document.getElementById('mbProgTime' + stepNum);
                if (bar) bar.style.width = s.pct + '%';
                if (pct) pct.textContent = s.pct + '%';
                if (label) label.textContent = s.label + '...';

                // Elapsed
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                const remaining = Math.max(1, Math.round((stages.length - idx) * 2));
                if (time) time.textContent = `${elapsed}s · ~${remaining}s verbleibend`;

                // Mark active
                const row = document.getElementById('mbProgS' + stepNum + '_' + idx);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + idx);
                if (row) row.className = 'mb-prog-stage active';
                if (dot) dot.innerHTML = '●';

                // Mark previous done
                if (idx > 0) {
                    const prevRow = document.getElementById('mbProgS' + stepNum + '_' + (idx - 1));
                    const prevDot = document.getElementById('mbProgD' + stepNum + '_' + (idx - 1));
                    if (prevRow) prevRow.className = 'mb-prog-stage done';
                    if (prevDot) prevDot.innerHTML = '✓';
                }

                idx++;
            }, 2000);

            return { interval, startTime, stepNum };
        }

        function mbStopProgress(handle) {
            if (!handle) return;
            clearInterval(handle.interval);
            const stepNum = handle.stepNum;
            const el = document.getElementById('mbProgress' + stepNum);
            const stages = MB_STEP_STAGES[stepNum] || [];
            const totalTime = ((Date.now() - handle.startTime) / 1000).toFixed(1);

            // Mark all done
            stages.forEach((s, i) => {
                const row = document.getElementById('mbProgS' + stepNum + '_' + i);
                const dot = document.getElementById('mbProgD' + stepNum + '_' + i);
                if (row) row.className = 'mb-prog-stage done';
                if (dot) dot.innerHTML = '✓';
            });

            // Complete bar
            const bar = document.getElementById('mbProgBar' + stepNum);
            const pct = document.getElementById('mbProgPct' + stepNum);
            const label = document.getElementById('mbProgLabel' + stepNum);
            const time = document.getElementById('mbProgTime' + stepNum);
            if (bar) bar.style.width = '100%';
            if (pct) pct.textContent = '100%';
            if (label) label.textContent = '✓ Abgeschlossen';
            if (time) time.textContent = `Fertig in ${totalTime}s`;

            // Hide after delay
            setTimeout(() => { if (el) el.style.display = 'none'; }, 1200);
        }

        async function mbProcessStep0() {
            const q = document.getElementById('mbQuestion') ? document.getElementById('mbQuestion').value.trim() : '';
            const selectedQ = mbState.selectedProblem || q;
            if (!selectedQ) return;
            mbState.question = selectedQ;

            // Switch to View B if not already there (custom input case)
            if (document.getElementById('mbStep0ViewA').style.display !== 'none') {
                document.getElementById('mbStep0ViewA').style.display = 'none';
                document.getElementById('mbStep0ViewB').style.display = 'block';
                const parsed = mbParseQuestion(selectedQ);
                parsed.icon = '✏️';
                parsed.title = 'Eigene Problemstellung';
                document.getElementById('mbStep0SelectedQ').innerHTML = mbRenderProblemCard(parsed);
            }

            const btn = document.getElementById('mbStep0Btn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(0);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Analysiere diese Frage für den EEE Model-Building Workflow. Antworte NUR als JSON: {"domain":"REL/FIN/HLT/ENV/POL/ORG/EDU/OTH","domain_signals":["..."],"question_type":"analysis/decision/behavior_change/comparison","has_behavior_goal":true/false,"behavior_goal":"...oder null","scope_in":["..."],"scope_out":["..."],"suggested_mode":"schnell/gefuehrt/template/custom","session_id":"EBF-S-2026-02-08-XXX-001"}\n\nFrage: ${q}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try {
                        const jsonMatch = data.answer.match(/\{[\s\S]*\}/);
                        if (jsonMatch) parsed = JSON.parse(jsonMatch[0]);
                    } catch(e) {}
                }

                if (!parsed) {
                    parsed = {
                        domain: 'OTH', domain_signals: [q.split(' ').slice(0,3).join(' ')],
                        question_type: 'analysis', has_behavior_goal: false, behavior_goal: null,
                        scope_in: ['Modell-Analyse'], scope_out: ['Interventionen'],
                        suggested_mode: mbState.mode, session_id: `EBF-S-2026-02-08-OTH-001`
                    };
                }

                mbState.sessionId = parsed.session_id;
                mbState.selections.domain = parsed.domain;
                mbState.selections.questionType = parsed.question_type;

                const summaryEl = document.getElementById('mbSessionSummary');
                const domainColor = DOMAIN_COLORS[parsed.domain] || '#94a3b8';
                const domainLabel = DOMAIN_LABELS[parsed.domain] || parsed.domain;
                const typeLabels = { analysis: 'Analyse', decision: 'Entscheidung', behavior_change: 'Behavior Change', comparison: 'Vergleich', strategy: 'Strategie' };
                const typeLabel = typeLabels[parsed.question_type] || parsed.question_type;

                const signalTags = (parsed.domain_signals || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(139,170,255,0.08);border:1px solid rgba(139,170,255,0.12);color:rgba(255,255,255,0.7);margin:2px 4px 2px 0">${s}</span>`
                ).join('');

                const scopeInTags = (parsed.scope_in || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15);color:rgba(34,197,94,0.8);margin:2px 4px 2px 0">✓ ${s}</span>`
                ).join('');

                const scopeOutTags = (parsed.scope_out || []).map(s =>
                    `<span style="display:inline-block;font-size:11px;padding:3px 10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.35);margin:2px 4px 2px 0">✗ ${s}</span>`
                ).join('');

                summaryEl.innerHTML = `
                    <!-- Header: Domain + Type + ID -->
                    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px">
                        <span style="display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;background:${domainColor}18;border:1px solid ${domainColor}40;font-size:13px;font-weight:600;color:${domainColor}">
                            <span style="width:8px;height:8px;border-radius:50%;background:${domainColor}"></span>
                            ${domainLabel}
                        </span>
                        <span style="display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);font-size:12px;color:rgba(255,255,255,0.6)">
                            ${typeLabel}
                        </span>
                        <span style="margin-left:auto;font-size:11px;font-family:monospace;color:rgba(255,255,255,0.25);letter-spacing:0.3px">${parsed.session_id}</span>
                    </div>

                    ${parsed.has_behavior_goal ? `
                    <!-- Behavior Goal: Prominent -->
                    <div style="padding:14px 16px;border-radius:10px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.7);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Verhaltensziel</div>
                        <div style="font-size:14px;color:rgba(255,255,255,0.9);line-height:1.5">${parsed.behavior_goal || 'Definiert'}</div>
                    </div>` : `
                    <div style="padding:12px 16px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);margin-bottom:16px;font-size:13px;color:rgba(255,255,255,0.4)">
                        ⚠ Kein explizites Verhaltensziel erkannt — BEATRIX leitet eines ab.
                    </div>`}

                    <!-- Signals -->
                    <div style="margin-bottom:16px">
                        <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.35);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Erkannte Signale</div>
                        <div style="display:flex;flex-wrap:wrap">${signalTags}</div>
                    </div>

                    <!-- Scope: In / Out -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(34,197,94,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">In Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeInTags}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;font-weight:600;color:rgba(255,255,255,0.25);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Out of Scope</div>
                            <div style="display:flex;flex-wrap:wrap">${scopeOutTags}</div>
                        </div>
                    </div>
                `;
                document.getElementById('mbStep0Result').style.display = 'block';

                mbStopProgress(progHandle);
                btn.textContent = 'Weiter zu Schritt 1 →';
                btn.disabled = false;
                btn.onclick = () => mbNextStep(1);

            } catch(e) {
                mbStopProgress(progHandle);
                btn.textContent = 'Analysieren →';
                btn.disabled = false;
                console.error('Step 0 error:', e);
            }
        }

        async function mbProcessStep3() {
            const psiChoice = mbState.selections.mbStep3 || 'ggg-default';
            const psiLabels = { 'ggg-default': '📊 GGG Defaults', 'custom-psi': '🎛️ Custom Ψ', 'full-8psi': '🔬 Alle 8 Ψ-Dimensionen', 'custom': '🔧 Custom' };

            // Switch to ViewB
            document.getElementById('mbStep3ViewA').style.display = 'none';
            document.getElementById('mbStep3ViewB').style.display = 'block';
            document.getElementById('mbStep3Selection').textContent = psiLabels[psiChoice] || psiChoice;

            const btn = document.getElementById('mbStep3NextBtn');
            btn.disabled = true;
            btn.textContent = 'BEATRIX analysiert...';
            const progHandle = mbStartProgress(3);

            try {
                const resp = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
                    body: JSON.stringify({ question: `Für den EEE Model-Building Workflow Step 3 (Kontext Ψ). Frage: "${mbState.question}". Domain: ${mbState.selections.domain}. Modus: ${psiChoice}. Entry: ${mbState.selections.mbStep1||'practice'}. Scope: ${mbState.selections.mbStep2||'decision'}. Erstelle eine Kontext-Analyse mit den Ψ-Dimensionen. Antworte NUR als JSON: {"psi_dimensions":[{"id":"Ψ_I","name":"Institutional","value":0.7,"rationale":"..."},...],"domain_config":"...","level":"Individual/Household/Organization","10c_mapping":{"WHO":"...","WHAT":"...","HOW":"...","WHEN":"...","WHERE":"...","AWARE":"...","READY":"...","STAGE":"...","HIERARCHY":"...","EIT":"..."}}` })
                });
                const data = await resp.json();
                let parsed = null;
                if (data.answer) {
                    try { const m = data.answer.match(/\{[\s\S]*\}/); if(m) parsed = JSON.parse(m[0]); } catch(e){}
                }

                if (parsed && parsed.psi_dimensions) {
                    mbState.selections.psi = parsed;
                    // Store for use in Step 4+5 prompts
                    mbState.selections.psiSummary = parsed.psi_dimensions.map(p => `${p.id}=${p.value}`).join(', ');
                }

                mbStopProgress(progHandle);
                mbNextStep(4);

            } catch(e) {
                mbStopProgress(progHandle);
                console.error('Step 3 error:', e);
                btn.textContent = 'Erneut versuchen →';
                btn.disabled = false;
                btn.onclick = () => mbProcessStep3();
            }
        }

        function mbStep3Back() {
            document.getElementById('mbStep3ViewB').style.display = 'none';
            document.getElementById('mbStep3ViewA').style.display = 'block';
            document.getElementById('mbStep3Result').innerHTML = '';
        }

        function mbConfirmAndAdvance(fromStep, toStep) {
            mbNextStep(toStep);
        }

        async function mbRunStep4() {
            const btn = document.getElementById('mbStep4Btn');
            const resultEl = document.getElementById('mbModelResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX erstellt Modell...';

            const prompt = `Erstelle die 10C Modell-Spezifikation für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Entry: ${mbState.selections.mbStep1 || 'practice'}. Scope: ${mbState.selections.mbStep2 || 'decision'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.

Strukturiere mit Markdown:
### Modell-Typ & ID
Identifiziere den passenden Modell-Typ (Decision/Continuous/Process) und vergib eine BCM-Modell-ID.

### 10C Complementarity Mapping
Tabelle mit | Dimension | Spezifikation | Relevanz (Hoch/Mittel/Niedrig) |
für alle 10 Dimensionen: WHO, WHAT, HOW, WHEN, WHERE, AWARE, READY, STAGE, HIERARCHY, EIT.

### Funktionale Form
Welche mathematische Spezifikation: Logistic, CES, Dynamic BCJ?

Schreibe kompakt und präzise.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep4Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep4Meta">Modell wird erstellt...</div>
            </div><div id="mbStep4Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep4Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep4Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep4Meta');
                    if (meta) meta.textContent = `✓ Modell erstellt in ${t}s`;
                    mbState.selections.step4Result = text;
                    btn.textContent = 'Weiter zu Parameter →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(5);
                }
            });
        }

        async function mbRunStep5() {
            const btn = document.getElementById('mbStep5Btn');
            const resultEl = document.getElementById('mbParamResult');
            btn.disabled = true;
            btn.textContent = 'BEATRIX schätzt Parameter...';

            const prompt = `Schätze die BCM-Parameter für: "${mbState.question}".
Session: ${mbState.sessionId}. Domain: ${mbState.selections.domain || 'OTH'}.
Ψ-Config: ${mbState.selections.mbStep3 || 'ggg-default'}.
Modell-Kontext aus Step 4: ${(mbState.selections.step4Result || '').slice(0, 500)}

Strukturiere mit Markdown:
### Willingness (W)
- **Aktueller Wert:** [0.0–1.0]
- **Gate Condition:** W ≥ θ_W? Ja/Nein
- Begründung (2–3 Sätze) basierend auf motivationalen Faktoren

### Ability (A_mod)
- **Aktueller Wert:** [0.0–1.0]
- Subkomponenten: Skills, Knowledge, Resources
- Begründung

### Capacity (C)
- **Aktueller Wert:** [0.0–1.0]
- Externe Constraints, Facilitating Conditions
- Begründung

### BCM Gesamtschätzung
Tabelle: | Parameter | Wert | Gate | Interpretation |
| W | ... | ... | ... |
| A_mod | ... | ... | ... |
| C | ... | ... | ... |
| **P(B)** | ... | — | Verhaltenswahrscheinlichkeit |

Berechne P(B) nach BCM-Formel. Schreibe wissenschaftlich fundiert.`;

            resultEl.innerHTML = `<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbStep5Spinner"></div>
                <div style="font-size:13px;color:var(--text-secondary)" id="mbStep5Meta">Parameter werden geschätzt...</div>
            </div><div id="mbStep5Stream" style="max-height:50vh;overflow-y:auto"></div>`;

            const startTime = Date.now();
            await mbStreamChat(prompt, document.getElementById('mbStep5Stream'), {
                onDone: (text) => {
                    const t = ((Date.now() - startTime) / 1000).toFixed(1);
                    const sp = document.getElementById('mbStep5Spinner');
                    if (sp) { sp.style.animation = 'none'; sp.style.borderColor = '#22c55e'; sp.style.borderTopColor = '#22c55e'; }
                    const meta = document.getElementById('mbStep5Meta');
                    if (meta) meta.textContent = `✓ Parameter geschätzt in ${t}s`;
                    mbState.selections.step5Result = text;
                    btn.textContent = 'Weiter zum Ergebnis →';
                    btn.disabled = false;
                    btn.onclick = () => mbNextStep(6);
                }
            });
        }

        function mbShowRegistry() {
            mbShowPanel('mbRegistry');
            document.getElementById('mbProgress').style.display = 'none';

            const list = document.getElementById('mbRegistryList');
            list.innerHTML = MB_MODELS.map(m => {
                const color = DOMAIN_COLORS[m.domain] || '#94a3b8';
                return `<div class="mb-model-card" onclick="mbUseTemplate('${m.id}')">
                    <span class="mb-model-id" style="background:${color}22;color:${color}">${m.id}</span>
                    <div class="mb-model-info">
                        <div class="mb-model-name">${m.name}</div>
                        <div class="mb-model-meta">${DOMAIN_LABELS[m.domain]||m.domain} · ${m.type}</div>
                    </div>
                    <span class="mb-model-version">v${m.v}</span>
                </div>`;
            }).join('');
        }

        function mbUseTemplate(modelId) {
            const model = MB_MODELS.find(m => m.id === modelId);
            if (!model) return;
            mbState.mode = 'template';
            mbState.selections.templateModel = model;
            document.getElementById('mbQuestion').value = `Basierend auf ${model.name} (${model.id})`;
            mbShowPanel('mbStep0');
            document.getElementById('mbProgress').style.display = 'flex';
            mbUpdateProgress(0);
        }

        const MB_COMPUTE_STAGES = [
            { label: 'Modell initialisieren', detail: 'Session-Daten laden und validieren', pct: 5 },
            { label: 'Frage analysieren', detail: 'Problemstellung und Kontext parsen', pct: 12 },
            { label: '10C Mapping', detail: 'Complementarity-Dimensionen zuordnen', pct: 22 },
            { label: 'Ψ-Kontext laden', detail: 'Psychologische Kontextvariablen integrieren', pct: 35 },
            { label: 'Modellparameter setzen', detail: 'Willingness · Ability · Capacity kalibrieren', pct: 48 },
            { label: 'BCM Berechnung', detail: 'Behavioral Compliance Model anwenden', pct: 62 },
            { label: 'Sensitivitätsanalyse', detail: 'Parameter-Robustheit über ±20% Range testen', pct: 78 },
            { label: 'Report generieren', detail: 'Ergebnis, Empfehlungen und Visualisierungen erstellen', pct: 90 },
            { label: 'Finalisieren', detail: 'Qualitätsprüfung und Formatierung', pct: 97 },
        ];

        async function mbComputeResult() {
            const depth = mbState.reportDepth || 'standard';
            const isDeep = depth === 'deep';

            // Hide choice, show progress
            document.getElementById('mbDepthChoice').style.display = 'none';
            document.getElementById('mbComputeBtn').style.display = 'none';

            const progressEl = document.getElementById('mbComputeProgress');
            const resultEl = document.getElementById('mbResultContent');
            const stageEl = document.getElementById('mbComputeStage');
            const detailEl = document.getElementById('mbComputeDetail');
            const timeEl = document.getElementById('mbComputeTime');

            progressEl.style.display = 'block';
            resultEl.style.display = 'none';
            stageEl.textContent = isDeep ? 'Tiefenanalyse wird vorbereitet...' : 'Report wird vorbereitet...';
            detailEl.textContent = isDeep ? 'Standard++ · 4–6 Seiten' : 'Standard · 1–2 Seiten';
            timeEl.textContent = '';

            const startTime = Date.now();
            const s4 = mbState.selections.step4Result ? `\n\nModell-Spezifikation aus Step 4:\n${mbState.selections.step4Result.slice(0, 800)}` : '';
            const s5 = mbState.selections.step5Result ? `\n\nParameter-Schätzung aus Step 5:\n${mbState.selections.step5Result.slice(0, 800)}` : '';

            const promptStandard = `Erstelle einen kompakten BCM Modell-Report für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain
Kurze Einordnung (3–4 Sätze).
### 2. 10C Mapping
Nenne die 3–4 relevantesten Complementarity-Dimensionen als Aufzählung mit je 1 Satz.
### 3. BCM Parameter
Tabelle mit | Parameter | Wert | Interpretation |
für Willingness (W), Ability (A), Capacity (C). Nutze die Werte aus Step 5 falls vorhanden.
### 4. Ergebnis
Klare Verhaltensvorhersage in 2–3 Sätzen.
### 5. Handlungsempfehlungen
3–5 konkrete Massnahmen als nummerierte Liste.

Schreibe präzise und professionell. Maximal 500 Wörter.`;

            const promptDeep = `Erstelle einen umfassenden BCM Modell-Report (Standard++) für: "${mbState.question}".
Session: ${mbState.sessionId}. Mode: ${mbState.mode}.${s4}${s5}

Struktur (nutze exakt diese Markdown-Überschriften):
## Modell-Report: [Kurztitel]
### 1. Problemstellung & Domain-Analyse
Detaillierte Einordnung der Fragestellung, Zielgruppe, Verhaltensänderungsziel.
### 2. 10C Complementarity Mapping
Vollständige Tabelle | Dimension | Spezifikation | BCM Relevanz | für alle 10 Dimensionen. Nutze die Spezifikation aus Step 4 falls vorhanden.
### 3. Ψ-Kontextdimensionen
Tabelle | Ψ-Dimension | Wert (0–1) | Impact | Rationale | für die 8 Ψ-Dimensionen.
### 4. BCM Parameter (Willingness · Ability · Capacity)
Detaillierte Tabelle mit Subkomponenten, Werten und Interpretation. Nutze die Schätzungen aus Step 5 falls vorhanden.
#### Key Insight
Zusammenfassende Erkenntnis.
### 5. Ergebnis & Verhaltensvorhersage
Klare Vorhersage mit Konfidenzintervall und Begründung. Berechne P(B) nach BCM-Formel.
### 6. Sensitivitätsanalyse
Welche Parameter haben den grössten Einfluss? ±20% Variation analysieren.
### 7. Handlungsempfehlungen
#### Strategische Intervention Roadmap
Phasenplan mit 3–4 Phasen, jeweils mit Zeitrahmen, Ziel, Taktiken und Interventionen.

Schreibe detailliert, wissenschaftlich fundiert und praxisorientiert. Nutze Tabellen wo sinnvoll.`;

            const prompt = isDeep ? promptDeep : promptStandard;

            try {
                await new Promise(r => setTimeout(r, 500));
                progressEl.style.display = 'none';
                resultEl.style.display = 'block';
                const depthLabel = isDeep ? '🔬 Standard++' : '📋 Standard';
                resultEl.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)">
                        <div style="width:16px;height:16px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0" id="mbReportSpinner"></div>
                        <div>
                            <div style="font-size:14px;font-weight:600;color:white">📊 Modell-Report <span style="font-size:12px;color:var(--accent);font-weight:400">${depthLabel}</span></div>
                            <div style="font-size:11px;color:var(--text-secondary)" id="mbReportMeta">Session ${mbState.sessionId || 'N/A'} · Streaming...</div>
                        </div>
                    </div>
                    <div id="mbStreamTarget" style="max-height:65vh;overflow-y:auto;padding-right:8px"></div>
                `;

                const targetEl = document.getElementById('mbStreamTarget');
                await mbStreamChat(prompt, targetEl, {
                    onDone: (text) => {
                        const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                        const spinner = document.getElementById('mbReportSpinner');
                        if (spinner) { spinner.style.animation = 'none'; spinner.style.borderColor = '#22c55e'; spinner.style.borderTopColor = '#22c55e'; }
                        const meta = document.getElementById('mbReportMeta');
                        if (meta) meta.textContent = `Session ${mbState.sessionId || 'N/A'} · Generiert in ${totalTime}s`;
                        document.getElementById('mbExportBtn').style.display = '';
                        document.getElementById('mbNewModelBtn').style.display = '';
                    }
                });

            } catch(e) {
                console.error('Compute error:', e);
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="color:#ef4444;padding:20px;text-align:center">⚠ Fehler. Bitte erneut versuchen.</div>';
                document.getElementById('mbExportBtn').style.display = '';
                document.getElementById('mbNewModelBtn').style.display = '';
            }
        }

        async function mbExportModel() {
            // Re-run computation or copy to clipboard
            const content = document.getElementById('mbResultContent').innerText;
            if (content) {
                try {
                    await navigator.clipboard.writeText(content);
                    showToast('Modell-Report in Zwischenablage kopiert ✓', 'success');
                } catch(e) {
                    // Fallback: download as text
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `BEATRIX-Report-${mbState.sessionId || 'export'}.txt`;
                    a.click(); URL.revokeObjectURL(url);
                    showToast('Report heruntergeladen ✓', 'success');
                }
            }
        }

        checkAuth();
    </script>

    <!-- ═══ Feedback Widget v3.17 – Single Screen ═══ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #fbBtn { position:fixed; bottom:24px; right:24px; z-index:9999; width:48px; height:48px; border-radius:50%; background:linear-gradient(135deg,#8b9aff,#6366f1); border:none; cursor:pointer; box-shadow:0 4px 20px rgba(99,102,241,0.4); display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
        #fbBtn:hover { transform:scale(1.1); box-shadow:0 6px 28px rgba(99,102,241,0.6); }
        #fbBtn svg { width:22px; height:22px; fill:white; }
        #fbOverlay { display:none; position:fixed; inset:0; z-index:10000; background:rgba(6,8,20,0.97); flex-direction:column; }
        #fbOverlay.active { display:flex; }
        #fbToolbar { display:flex; align-items:center; gap:6px; padding:8px 12px; background:rgba(20,20,40,0.95); border-bottom:1px solid rgba(255,255,255,0.08); flex-shrink:0; flex-wrap:wrap; }
        .fb-tool { padding:5px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.6); font-size:12px; cursor:pointer; transition:all 0.15s; }
        .fb-tool:hover, .fb-tool.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        /* CRM Kanban */
        .crm-col { min-width:180px; flex:1; background:rgba(255,255,255,0.02); border-radius:10px; border:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; }
        .crm-card { padding:10px; background:var(--navy-card); border:1px solid rgba(255,255,255,0.06); border-radius:8px; cursor:pointer; transition:all 0.15s; }
        .crm-card:hover { border-color:rgba(139,170,255,0.3); background:rgba(139,170,255,0.04); transform:translateY(-1px); }
        .crm-card[draggable=true] { cursor:grab; }
        .crm-card[draggable=true]:active { cursor:grabbing; opacity:0.7; }
        .fb-color { width:22px; height:22px; border-radius:50%; border:2px solid transparent; cursor:pointer; transition:transform 0.15s; }
        .fb-color:hover, .fb-color.active { transform:scale(1.2); border-color:white; }
        #fbCanvas { flex:1; cursor:crosshair; }
        #fbBottom { display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(20,20,40,0.95); border-top:1px solid rgba(255,255,255,0.08); flex-shrink:0; }
        #fbComment { flex:1; padding:8px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:10px; color:white; font-size:13px; outline:none; font-family:inherit; }
        #fbComment::placeholder { color:rgba(255,255,255,0.25); }
        #fbComment:focus { border-color:rgba(139,170,255,0.4); }
        .fb-type { padding:4px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.1); background:transparent; color:rgba(255,255,255,0.5); font-size:12px; cursor:pointer; }
        .fb-type.active { background:rgba(139,170,255,0.15); color:white; border-color:rgba(139,170,255,0.4); }
        #fbSend { padding:8px 18px; border-radius:10px; border:none; background:linear-gradient(135deg,#8b9aff,#6366f1); color:white; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; }
        #fbSend:hover { filter:brightness(1.1); }
        #fbSend:disabled { opacity:0.5; cursor:not-allowed; }
        /* AI circles on screenshot */
        .fb-ai-circle { position:absolute; z-index:3; pointer-events:auto; cursor:pointer; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; color:white; box-shadow:0 2px 10px rgba(0,0,0,0.5); animation:fbPop 0.4s ease-out; border:2px solid rgba(255,255,255,0.4); }
        .fb-ai-circle:hover { transform:scale(1.15); }
        .fb-ai-area { position:absolute; z-index:2; border:2px dashed; border-radius:6px; pointer-events:none; animation:fbPop 0.5s ease-out; }
        @keyframes fbPop { from { transform:scale(0.5); opacity:0; } to { transform:scale(1); opacity:1; } }
        /* Suggestion list items */
        .fb-sug-item { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; margin-bottom:4px; }
        .fb-sug-item:hover { background:rgba(139,170,255,0.06); border-color:rgba(139,170,255,0.2); }
        .fb-sug-num { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:white; flex-shrink:0; }
        .fb-sug-text { flex:1; min-width:0; }
        .fb-sug-title { font-size:12px; font-weight:600; color:rgba(255,255,255,0.85); }
        .fb-sug-desc { font-size:11px; color:rgba(255,255,255,0.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #fbAiLoading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:4; display:flex; align-items:center; gap:10px; padding:12px 22px; background:rgba(20,20,40,0.9); border-radius:12px; border:1px solid rgba(255,255,255,0.08); }
    </style>

    <button id="fbBtn" onclick="fbCapture()" title="Feedback geben" style="display:none">
        <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM11 5h2v4h-2zm0 6h2v2h-2z"/></svg>
    </button>

    <div id="fbOverlay">
        <div id="fbToolbar">
            <span id="fbHeaderMsg" style="font-size:12px;color:rgba(255,255,255,0.5);margin-right:4px">🙏 Danke! Markiere oder tippe auf einen Vorschlag.</span>
            <div style="flex:1"></div>
            <button class="fb-tool active" onclick="fbSetTool('draw')" id="fbToolDraw">✏️</button>
            <button class="fb-tool" onclick="fbSetTool('arrow')" id="fbToolArrow">➡️</button>
            <button class="fb-tool" onclick="fbSetTool('rect')" id="fbToolRect">▢</button>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <div class="fb-color active" style="background:#f87171" onclick="fbSetColor('#f87171')" data-color="#f87171"></div>
            <div class="fb-color" style="background:#fbbf24" onclick="fbSetColor('#fbbf24')" data-color="#fbbf24"></div>
            <div class="fb-color" style="background:#34d399" onclick="fbSetColor('#34d399')" data-color="#34d399"></div>
            <div style="width:1px;height:18px;background:rgba(255,255,255,0.1)"></div>
            <button class="fb-tool" onclick="fbUndo()">↩</button>
            <button class="fb-tool" onclick="fbClose()" style="color:rgba(248,113,113,0.8)">✕</button>
        </div>
        <div style="flex:1;position:relative;overflow:hidden" id="fbCanvasWrap">
            <canvas id="fbCanvas"></canvas>
            <div id="fbAnnotations" style="position:absolute;inset:0;pointer-events:none"></div>
            <div id="fbAiLoading" style="display:none">
                <div style="width:14px;height:14px;border:2px solid rgba(139,170,255,0.2);border-top:2px solid #8b9aff;border-radius:50%;animation:spin 0.8s linear infinite"></div>
                <span style="font-size:12px;color:rgba(255,255,255,0.5)">BEATRIX analysiert...</span>
            </div>
        </div>
        <!-- AI Suggestion List (appears after analysis) -->
        <div id="fbSugList" style="display:none;padding:8px 12px;background:rgba(20,20,40,0.95);border-top:1px solid rgba(255,255,255,0.08);flex-shrink:0">
            <div style="display:flex;align-items:center;margin-bottom:6px">
                <span style="font-size:11px;color:rgba(255,255,255,0.3);text-transform:uppercase;letter-spacing:0.5px;flex:1">BEATRIX Vorschläge</span>
                <button onclick="fbDismissAll()" style="border:none;background:none;color:rgba(255,255,255,0.25);font-size:11px;cursor:pointer;padding:2px 6px">alle ausblenden</button>
            </div>
            <div id="fbSugItems"></div>
        </div>
        <div id="fbBottom">
            <button class="fb-type active" onclick="fbSetType('bug')" id="fbTypeBug">🐛</button>
            <button class="fb-type" onclick="fbSetType('wunsch')" id="fbTypeWunsch">💡</button>
            <button class="fb-type" onclick="fbSetType('frage')" id="fbTypeFrage">❓</button>
            <input id="fbComment" placeholder="Was fällt dir auf?" maxlength="500" onkeydown="if(event.key==='Enter')fbSend()">
            <button id="fbSend" onclick="fbSend()">Senden ➤</button>
        </div>
    </div>

    <script>
    // ═══ Feedback Widget v3.17 ═══
    const fbState = { tool:'draw', color:'#f87171', type:'bug', drawing:false, history:[], baseImage:null, startX:0, startY:0, suggestions:[] };

    async function fbCapture() {
        document.getElementById('fbBtn').style.display = 'none';
        try {
            const canvas = await html2canvas(document.body, { scale: window.devicePixelRatio > 1 ? 1.5 : 1, useCORS:true, logging:false, backgroundColor:'#0a0f1c' });
            fbState.baseImage = new Image();
            fbState.baseImage.onload = () => {
                const fbC = document.getElementById('fbCanvas');
                const wrap = document.getElementById('fbCanvasWrap');
                fbC.width = wrap.clientWidth;
                fbC.height = wrap.clientHeight;
                fbState.history = [];
                fbRedraw();
            };
            fbState.baseImage.src = canvas.toDataURL('image/jpeg', 0.85);

            document.getElementById('fbOverlay').classList.add('active');
            document.getElementById('fbComment').value = '';
            document.getElementById('fbAnnotations').innerHTML = '';
            document.getElementById('fbAiLoading').style.display = 'flex';
            document.getElementById('fbSugList').style.display = 'none';
            document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! BEATRIX analysiert...';

            fbAnalyzeScreen();
        } catch(e) {
            console.error('Screenshot failed:', e);
            showToast('Screenshot fehlgeschlagen', 'error');
        }
        document.getElementById('fbBtn').style.display = 'flex';
    }

    async function fbAnalyzeScreen() {
        const colors = ['#f87171', '#fbbf24', '#34d399'];
        try {
            const section = document.querySelector('.nav-link.active')?.dataset?.section || 'unknown';
            const r = await fetch(`${API}/feedback/analyze`, {
                method: 'POST',
                headers: { ...H(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ screenshot: fbState.baseImage.src, page: section, viewport: `${window.innerWidth}x${window.innerHeight}` })
            });
            if (!r.ok) throw new Error('Analyze failed');
            const data = await r.json();
            fbState.suggestions = data.suggestions || [];

            document.getElementById('fbAiLoading').style.display = 'none';

            if (fbState.suggestions.length > 0) {
                document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! Tippe auf einen Vorschlag oder zeichne eigenes Feedback.';
                const wrap = document.getElementById('fbCanvasWrap');
                const cW = wrap.clientWidth, cH = wrap.clientHeight;
                const annotEl = document.getElementById('fbAnnotations');
                annotEl.style.pointerEvents = 'auto';

                // Small numbered circles on screenshot + dashed areas
                annotEl.innerHTML = fbState.suggestions.map((s, i) => {
                    const color = colors[i % 3];
                    const x = (s.x || 50) / 100 * cW;
                    const y = (s.y || 30 + i * 25) / 100 * cH;
                    const aW = (s.w || 20) / 100 * cW;
                    const aH = (s.h || 8) / 100 * cH;
                    return `<div class="fb-ai-area" id="fbArea${i}" style="left:${x - aW/2}px;top:${y - aH/2}px;width:${aW}px;height:${aH}px;border-color:${color}50;background:${color}08;animation-delay:${i*0.15}s"></div>
                    <div class="fb-ai-circle" id="fbCircle${i}" style="left:${x - aW/2 - 10}px;top:${y - aH/2 - 10}px;background:${color};animation-delay:${i*0.15}s" onclick="fbUseSuggestion(${i})">${i+1}</div>`;
                }).join('');

                // Suggestion list panel
                const typeIcons = { bug:'🐛', wunsch:'💡', ux:'✨', performance:'⚡', frage:'❓' };
                document.getElementById('fbSugItems').innerHTML = fbState.suggestions.map((s, i) => {
                    const color = colors[i % 3];
                    return `<div class="fb-sug-item" onclick="fbUseSuggestion(${i})" id="fbSugItem${i}">
                        <div class="fb-sug-num" style="background:${color}">${i+1}</div>
                        <div class="fb-sug-text">
                            <div class="fb-sug-title">${typeIcons[s.type] || '💡'} ${s.title}</div>
                            <div class="fb-sug-desc">${s.description}</div>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('fbSugList').style.display = 'block';
            } else {
                document.getElementById('fbHeaderMsg').textContent = '🙏 Danke! Zeichne und beschreibe dein Feedback.';
            }
        } catch(e) {
            console.error('AI analyze:', e);
            document.getElementById('fbAiLoading').style.display = 'none';
            document.getElementById('fbHeaderMsg').textContent = '🙏 Zeichne und beschreibe dein Feedback.';
        }
    }

    function fbUseSuggestion(i) {
        const s = fbState.suggestions[i];
        if (!s) return;
        const typeMap = { bug:'bug', wunsch:'wunsch', ux:'wunsch', performance:'bug', frage:'frage' };
        fbSetType(typeMap[s.type] || 'wunsch');
        const input = document.getElementById('fbComment');
        input.value = s.title + ': ' + s.description;
        input.focus();
    }

    function fbDismissBadge(i) {
        ['fbCircle','fbArea','fbSugItem'].forEach(prefix => {
            const el = document.getElementById(prefix + i);
            if (el) { el.style.transition = 'opacity 0.3s'; el.style.opacity = '0'; setTimeout(() => el?.remove(), 300); }
        });
    }

    function fbDismissAll() {
        document.getElementById('fbAnnotations').innerHTML = '';
        document.getElementById('fbSugList').style.display = 'none';
        document.getElementById('fbHeaderMsg').textContent = '🙏 Zeichne und beschreibe dein Feedback.';
    }

    function fbRedraw() {
        const c = document.getElementById('fbCanvas');
        const ctx = c.getContext('2d');
        if (!fbState.baseImage || !fbState.baseImage.complete) return;
        const scale = Math.min(c.width / fbState.baseImage.width, c.height / fbState.baseImage.height);
        const w = fbState.baseImage.width * scale, h = fbState.baseImage.height * scale;
        const ox = (c.width - w) / 2, oy = (c.height - h) / 2;
        ctx.fillStyle = '#0a0f1c'; ctx.fillRect(0, 0, c.width, c.height);
        ctx.drawImage(fbState.baseImage, ox, oy, w, h);
        for (const item of fbState.history) {
            ctx.strokeStyle = item.color; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            if (item.type === 'draw' && item.points.length > 1) {
                ctx.beginPath(); ctx.moveTo(item.points[0].x, item.points[0].y);
                for (let p = 1; p < item.points.length; p++) ctx.lineTo(item.points[p].x, item.points[p].y);
                ctx.stroke();
            } else if (item.type === 'rect') { ctx.strokeRect(item.x, item.y, item.w, item.h); }
            else if (item.type === 'arrow') { fbDrawArrow(ctx, item.x1, item.y1, item.x2, item.y2, item.color); }
        }
    }

    function fbDrawArrow(ctx, x1, y1, x2, y2, color) {
        const hl = 14, a = Math.atan2(y2-y1, x2-x1);
        ctx.strokeStyle = color; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x2,y2); ctx.lineTo(x2-hl*Math.cos(a-Math.PI/6), y2-hl*Math.sin(a-Math.PI/6));
        ctx.moveTo(x2,y2); ctx.lineTo(x2-hl*Math.cos(a+Math.PI/6), y2-hl*Math.sin(a+Math.PI/6)); ctx.stroke();
    }

    // Canvas drawing events
    const fbCanvas = document.getElementById('fbCanvas');
    function fbXY(e) {
        const r = fbCanvas.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
        return { x:(t.clientX-r.left)*(fbCanvas.width/r.width), y:(t.clientY-r.top)*(fbCanvas.height/r.height) };
    }
    fbCanvas.addEventListener('pointerdown', e => {
        e.preventDefault(); fbState.drawing = true; const p = fbXY(e);
        fbState.startX = p.x; fbState.startY = p.y;
        if (fbState.tool === 'draw') fbState.history.push({ type:'draw', color:fbState.color, points:[p] });
    });
    fbCanvas.addEventListener('pointermove', e => {
        if (!fbState.drawing) return; e.preventDefault(); const p = fbXY(e);
        if (fbState.tool === 'draw') { const last = fbState.history[fbState.history.length-1]; if (last?.type==='draw') { last.points.push(p); fbRedraw(); } }
        else if (fbState.tool === 'rect' || fbState.tool === 'arrow') {
            fbRedraw(); const ctx = fbCanvas.getContext('2d'); ctx.strokeStyle = fbState.color; ctx.lineWidth = 3;
            if (fbState.tool === 'rect') ctx.strokeRect(fbState.startX, fbState.startY, p.x-fbState.startX, p.y-fbState.startY);
            else fbDrawArrow(ctx, fbState.startX, fbState.startY, p.x, p.y, fbState.color);
        }
    });
    fbCanvas.addEventListener('pointerup', e => {
        if (!fbState.drawing) return; fbState.drawing = false; const p = fbXY(e);
        if (fbState.tool === 'rect') fbState.history.push({ type:'rect', color:fbState.color, x:fbState.startX, y:fbState.startY, w:p.x-fbState.startX, h:p.y-fbState.startY });
        else if (fbState.tool === 'arrow') fbState.history.push({ type:'arrow', color:fbState.color, x1:fbState.startX, y1:fbState.startY, x2:p.x, y2:p.y });
        fbRedraw();
    });
    fbCanvas.addEventListener('pointerleave', () => { fbState.drawing = false; });

    function fbSetTool(t) { fbState.tool = t; document.querySelectorAll('.fb-tool').forEach(el => el.classList.remove('active')); document.getElementById('fbTool'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.add('active'); }
    function fbSetColor(c) { fbState.color = c; document.querySelectorAll('.fb-color').forEach(el => el.classList.toggle('active', el.dataset.color===c)); }
    function fbSetType(t) { fbState.type = t; document.querySelectorAll('.fb-type').forEach(el => el.classList.remove('active')); document.getElementById('fbType'+t.charAt(0).toUpperCase()+t.slice(1))?.classList.add('active'); }
    function fbUndo() { if (fbState.history.length) { fbState.history.pop(); fbRedraw(); } }
    function fbClose() { document.getElementById('fbOverlay').classList.remove('active'); }

    async function fbSend() {
        const comment = document.getElementById('fbComment').value.trim();
        if (!comment) { const inp = document.getElementById('fbComment'); inp.focus(); inp.style.borderColor='#f87171'; setTimeout(()=>inp.style.borderColor='',1500); return; }
        const btn = document.getElementById('fbSend'); btn.disabled = true; btn.textContent = '...';
        try {
            const imgData = document.getElementById('fbCanvas').toDataURL('image/jpeg', 0.7);
            const section = document.querySelector('.nav-link.active')?.dataset?.section || 'unknown';
            const r = await fetch(`${API}/feedback`, { method:'POST', headers:{...H(),'Content-Type':'application/json'},
                body: JSON.stringify({ type:fbState.type, comment, screenshot:imgData, page:section, url:window.location.href, viewport:`${window.innerWidth}x${window.innerHeight}`, userAgent:navigator.userAgent.substring(0,200) })
            });
            if (!r.ok) throw new Error('Send failed');
            fbClose(); showToast('Feedback gesendet – danke! 🙏', 'success');
        } catch(e) { showToast('Senden fehlgeschlagen', 'error'); console.error(e); }
        btn.disabled = false; btn.textContent = 'Senden ➤';
    }
    </script>
</body>
</html>

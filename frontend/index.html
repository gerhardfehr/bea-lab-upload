<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEA Lab · Document Upload</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0b0f;
            --bg-secondary: #12131a;
            --bg-card: #181a24;
            --bg-card-hover: #1e2030;
            --border: #2a2d3e;
            --border-active: #4f6ef7;
            --text-primary: #e8eaf0;
            --text-secondary: #8b8fa3;
            --text-muted: #5a5e73;
            --accent: #4f6ef7;
            --accent-light: #6b85fa;
            --accent-glow: rgba(79, 110, 247, 0.15);
            --success: #34d399;
            --success-bg: rgba(52, 211, 153, 0.1);
            --warning: #fbbf24;
            --warning-bg: rgba(251, 191, 36, 0.1);
            --error: #f87171;
            --error-bg: rgba(248, 113, 113, 0.1);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Subtle grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(79, 110, 247, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(79, 110, 247, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        /* Top nav */
        .nav {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 40px;
            background: rgba(10, 11, 15, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            letter-spacing: -0.5px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .nav-title span {
            color: var(--text-muted);
            font-weight: 400;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .nav-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main layout */
        .container {
            position: relative;
            z-index: 1;
            max-width: 960px;
            margin: 0 auto;
            padding: 48px 24px 80px;
        }

        .page-header {
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .page-header p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 560px;
        }

        /* Tab navigation */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            width: fit-content;
        }

        .tab {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            border: none;
            background: none;
            font-family: inherit;
        }

        .tab:hover { color: var(--text-primary); }

        .tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 56px 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, var(--accent-glow), transparent 70%);
            opacity: 0;
            transition: var(--transition);
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .upload-zone:hover::before,
        .upload-zone.dragover::before {
            opacity: 1;
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .upload-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent);
        }

        .upload-zone h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            position: relative;
            z-index: 1;
        }

        .upload-zone h3 span {
            color: var(--accent-light);
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        .upload-zone p {
            font-size: 13px;
            color: var(--text-muted);
            position: relative;
            z-index: 1;
        }

        .upload-formats {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 16px;
            position: relative;
            z-index: 1;
        }

        .format-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Text input section */
        .text-section {
            display: none;
        }

        .text-section.active {
            display: block;
        }

        .file-section.active {
            display: block;
        }

        .file-section {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: var(--transition);
            outline: none;
        }

        .input-field:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        textarea.input-field {
            min-height: 200px;
            resize: vertical;
            line-height: 1.7;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        select.input-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%238b8fa3' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M3 5l3 3 3-3'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }

        /* Tag input */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            min-height: 44px;
            align-items: center;
            cursor: text;
            transition: var(--transition);
        }

        .tag-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px 3px 10px;
            background: var(--accent-glow);
            border: 1px solid rgba(79, 110, 247, 0.3);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-light);
        }

        .tag button {
            background: none;
            border: none;
            color: var(--accent-light);
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            padding: 0 2px;
            opacity: 0.6;
        }

        .tag button:hover { opacity: 1; }

        .tag-input {
            border: none;
            outline: none;
            background: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            flex: 1;
            min-width: 100px;
        }

        /* File list */
        .file-list {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .file-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .file-type-icon.pdf {
            background: rgba(239, 68, 68, 0.12);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .file-type-icon.txt {
            background: rgba(96, 165, 250, 0.12);
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .file-type-icon.md {
            background: rgba(52, 211, 153, 0.12);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .file-type-icon.doc {
            background: rgba(96, 165, 250, 0.12);
            color: #60a5fa;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .file-progress {
            flex: 1;
            max-width: 200px;
        }

        .progress-bar {
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .file-status {
            font-size: 12px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .file-status.pending {
            color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .file-status.uploading {
            color: var(--accent-light);
            background: var(--accent-glow);
        }

        .file-status.success {
            color: var(--success);
            background: var(--success-bg);
        }

        .file-status.error {
            color: var(--error);
            background: var(--error-bg);
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            transition: var(--transition);
            border-radius: 4px;
        }

        .file-remove:hover {
            color: var(--error);
            background: var(--error-bg);
        }

        /* Submit button */
        .actions {
            margin-top: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn {
            padding: 12px 28px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 12px rgba(79, 110, 247, 0.3);
        }

        .btn-primary:hover {
            background: var(--accent-light);
            box-shadow: 0 4px 20px rgba(79, 110, 247, 0.4);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .upload-count {
            font-size: 13px;
            color: var(--text-muted);
        }

        .upload-count strong {
            color: var(--text-secondary);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastIn 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--accent); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Database selector */
        .db-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
        }

        .db-option {
            flex: 1;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .db-option:hover {
            background: var(--bg-card);
            border-color: var(--border-active);
        }

        .db-option.selected {
            background: var(--bg-card);
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .db-option-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .db-option-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .db-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .nav { padding: 12px 20px; }
            .container { padding: 24px 16px 60px; }
            .page-header h1 { font-size: 24px; }
            .upload-zone { padding: 36px 20px; }
            .input-row { grid-template-columns: 1fr; }
            .db-selector { flex-direction: column; }
            .actions { flex-direction: column; gap: 12px; }
        }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Recent uploads table */
        .recent-section {
            margin-top: 48px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .recent-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .recent-section > p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .recent-table {
            width: 100%;
            border-collapse: collapse;
        }

        .recent-table th {
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
        }

        .recent-table td {
            padding: 12px 14px;
            font-size: 13px;
            border-bottom: 1px solid rgba(42, 45, 62, 0.5);
            color: var(--text-secondary);
        }

        .recent-table tr:hover td {
            background: var(--bg-secondary);
        }

        .recent-table .doc-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-dot {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="nav">
        <a href="#" class="nav-brand">
            <div class="nav-logo">BEA</div>
            <div class="nav-title">BEA Lab <span>· Upload</span></div>
        </a>
        <div class="nav-status">
            <div class="dot"></div>
            Datenbank verbunden
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1>Dokumente hochladen</h1>
            <p>Lade PDFs, Textdateien oder Markdown-Dokumente hoch, um sie in die BEATRIX Knowledge Base einzufügen. Texte können auch direkt eingegeben werden.</p>
        </div>

        <!-- Target Database -->
        <div class="db-selector">
            <div class="db-option selected" data-db="knowledge_base" onclick="selectDB(this)">
                <div class="db-option-title">
                    <span class="db-dot" style="background: var(--accent)"></span>
                    Knowledge Base
                </div>
                <div class="db-option-desc">Allgemeine Dokumente & Literatur</div>
            </div>
            <div class="db-option" data-db="bcm_axioms" onclick="selectDB(this)">
                <div class="db-option-title">
                    <span class="db-dot" style="background: var(--success)"></span>
                    BCM Axiome
                </div>
                <div class="db-option-desc">Axiom-Definitionen & Parameter</div>
            </div>
            <div class="db-option" data-db="research" onclick="selectDB(this)">
                <div class="db-option-title">
                    <span class="db-dot" style="background: var(--warning)"></span>
                    Research Papers
                </div>
                <div class="db-option-desc">Akademische Publikationen</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('file', this)">Datei-Upload</button>
            <button class="tab" onclick="switchTab('text', this)">Text eingeben</button>
        </div>

        <!-- File Upload Section -->
        <div class="file-section active" id="file-section">
            <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <h3>Dateien hierher ziehen oder <span>durchsuchen</span></h3>
                <p>Maximal 50 MB pro Datei</p>
                <div class="upload-formats">
                    <span class="format-badge">PDF</span>
                    <span class="format-badge">TXT</span>
                    <span class="format-badge">MD</span>
                    <span class="format-badge">DOCX</span>
                    <span class="format-badge">CSV</span>
                </div>
            </div>
            <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md,.docx,.csv,.json" style="display:none">

            <div class="file-list" id="fileList"></div>
        </div>

        <!-- Text Input Section -->
        <div class="text-section" id="text-section">
            <div class="input-group">
                <label>Titel</label>
                <input type="text" class="input-field" id="textTitle" placeholder="z.B. Axiom INU-3200 Definition">
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label>Kategorie</label>
                    <select class="input-field" id="textCategory">
                        <option value="general">Allgemein</option>
                        <option value="axiom">Axiom-Definition</option>
                        <option value="paper">Research Paper</option>
                        <option value="note">Notiz / Memo</option>
                        <option value="persona">Persona-Profil</option>
                        <option value="parameter">Parameter-Set</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Sprache</label>
                    <select class="input-field" id="textLang">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                        <option value="auto">Auto-detect</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <label>Tags</label>
                <div class="tag-container" id="tagContainer" onclick="document.getElementById('tagInput').focus()">
                    <input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter">
                </div>
            </div>
            <div class="input-group">
                <label>Inhalt</label>
                <textarea class="input-field" id="textContent" placeholder="Text, JSON, Axiom-Definition oder Markdown hier einfügen..."></textarea>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <div class="upload-count" id="uploadCount"></div>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-secondary" onclick="clearAll()">Zurücksetzen</button>
                <button class="btn btn-primary" id="submitBtn" onclick="submitUpload()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    In Datenbank laden
                </button>
            </div>
        </div>

        <!-- Recent uploads -->
        <div class="recent-section">
            <h2>Letzte Uploads</h2>
            <p>Die zuletzt hinzugefügten Dokumente</p>
            <table class="recent-table">
                <thead>
                    <tr>
                        <th>Dokument</th>
                        <th>Typ</th>
                        <th>Datenbank</th>
                        <th>Datum</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="recentTableBody">
                    <!-- Populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ── Configuration ──────────────────────────────────────────
        const API_BASE = '/api'; // Change to your actual API endpoint
        // e.g., 'https://bea-lab.io/api' or 'http://localhost:8000/api'

        // ── State ──────────────────────────────────────────────────
        let files = [];
        let tags = [];
        let selectedDB = 'knowledge_base';
        let currentTab = 'file';

        // ── Tab switching ──────────────────────────────────────────
        function switchTab(tab, el) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('file-section').classList.toggle('active', tab === 'file');
            document.getElementById('text-section').classList.toggle('active', tab === 'text');
            updateCount();
        }

        // ── Database selector ──────────────────────────────────────
        function selectDB(el) {
            document.querySelectorAll('.db-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedDB = el.dataset.db;
        }

        // ── Drag & Drop ────────────────────────────────────────────
        const dropZone = document.getElementById('dropZone');

        ['dragenter', 'dragover'].forEach(evt => {
            dropZone.addEventListener(evt, e => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(evt => {
            dropZone.addEventListener(evt, e => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
        });

        dropZone.addEventListener('drop', e => {
            const droppedFiles = [...e.dataTransfer.files];
            addFiles(droppedFiles);
        });

        document.getElementById('fileInput').addEventListener('change', e => {
            addFiles([...e.target.files]);
            e.target.value = '';
        });

        // ── File management ────────────────────────────────────────
        function addFiles(newFiles) {
            const allowed = ['application/pdf', 'text/plain', 'text/markdown', 'text/csv',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                            'application/json'];
            const allowedExt = ['.pdf', '.txt', '.md', '.docx', '.csv', '.json'];

            for (const f of newFiles) {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                if (!allowedExt.includes(ext)) {
                    showToast(`${f.name}: Dateityp nicht unterstützt`, 'error');
                    continue;
                }
                if (f.size > 50 * 1024 * 1024) {
                    showToast(`${f.name}: Datei zu groß (max 50 MB)`, 'error');
                    continue;
                }
                files.push({ file: f, status: 'pending', progress: 0, id: Date.now() + Math.random() });
            }
            renderFileList();
            updateCount();
        }

        function removeFile(id) {
            files = files.filter(f => f.id !== id);
            renderFileList();
            updateCount();
        }

        function getFileExt(name) {
            return name.split('.').pop().toLowerCase();
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function renderFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = files.map(f => {
                const ext = getFileExt(f.file.name);
                const iconClass = ext === 'pdf' ? 'pdf' : ext === 'md' ? 'md' :
                                 ext === 'docx' ? 'doc' : 'txt';
                return `
                    <div class="file-item" data-id="${f.id}">
                        <div class="file-type-icon ${iconClass}">${ext}</div>
                        <div class="file-info">
                            <div class="file-name">${f.file.name}</div>
                            <div class="file-meta">${formatSize(f.file.size)}</div>
                        </div>
                        ${f.status === 'uploading' ? `
                            <div class="file-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${f.progress}%"></div>
                                </div>
                            </div>
                        ` : ''}
                        <span class="file-status ${f.status}">
                            ${f.status === 'pending' ? 'Bereit' :
                              f.status === 'uploading' ? `${f.progress}%` :
                              f.status === 'success' ? '✓ Fertig' : '✗ Fehler'}
                        </span>
                        ${f.status === 'pending' ? `
                            <button class="file-remove" onclick="removeFile(${f.id})" title="Entfernen">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateCount() {
            const el = document.getElementById('uploadCount');
            if (currentTab === 'file') {
                el.textContent = files.length > 0
                    ? `${files.length} Datei${files.length > 1 ? 'en' : ''} ausgewählt`
                    : '';
            } else {
                const content = document.getElementById('textContent').value;
                el.textContent = content.length > 0
                    ? `${content.length} Zeichen`
                    : '';
            }
        }

        // ── Tags ───────────────────────────────────────────────────
        document.getElementById('tagInput').addEventListener('keydown', e => {
            if (e.key === 'Enter' && e.target.value.trim()) {
                e.preventDefault();
                const val = e.target.value.trim();
                if (!tags.includes(val)) {
                    tags.push(val);
                    renderTags();
                }
                e.target.value = '';
            }
        });

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tagContainer');
            const input = document.getElementById('tagInput');
            container.innerHTML = '';
            tags.forEach(t => {
                const el = document.createElement('span');
                el.className = 'tag';
                el.innerHTML = `${t} <button onclick="removeTag('${t}')">&times;</button>`;
                container.appendChild(el);
            });
            container.appendChild(input);
        }

        // ── Upload / Submit ────────────────────────────────────────
        async function submitUpload() {
            const btn = document.getElementById('submitBtn');

            if (currentTab === 'file') {
                if (files.length === 0) {
                    showToast('Bitte wähle mindestens eine Datei aus', 'error');
                    return;
                }
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> Wird hochgeladen...';

                for (let i = 0; i < files.length; i++) {
                    if (files[i].status !== 'pending') continue;
                    files[i].status = 'uploading';
                    renderFileList();

                    try {
                        await uploadFile(files[i]);
                        files[i].status = 'success';
                        files[i].progress = 100;
                        addToRecentTable(files[i].file.name, getFileExt(files[i].file.name), selectedDB);
                    } catch (err) {
                        files[i].status = 'error';
                        showToast(`Fehler bei ${files[i].file.name}: ${err.message}`, 'error');
                    }
                    renderFileList();
                }

                const successCount = files.filter(f => f.status === 'success').length;
                if (successCount > 0) {
                    showToast(`${successCount} Datei${successCount > 1 ? 'en' : ''} erfolgreich hochgeladen`, 'success');
                }
            } else {
                // Text upload
                const title = document.getElementById('textTitle').value.trim();
                const content = document.getElementById('textContent').value.trim();

                if (!content) {
                    showToast('Bitte gib einen Text ein', 'error');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> Wird gespeichert...';

                try {
                    await uploadText({
                        title: title || 'Untitled',
                        content,
                        category: document.getElementById('textCategory').value,
                        language: document.getElementById('textLang').value,
                        tags,
                        database: selectedDB
                    });
                    showToast('Text erfolgreich in die Datenbank eingefügt', 'success');
                    addToRecentTable(title || 'Texteingabe', 'text', selectedDB);
                    document.getElementById('textTitle').value = '';
                    document.getElementById('textContent').value = '';
                    tags = [];
                    renderTags();
                } catch (err) {
                    showToast(`Fehler: ${err.message}`, 'error');
                }
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                In Datenbank laden
            `;
        }

        // ── API Calls ──────────────────────────────────────────────
        async function uploadFile(fileObj) {
            const formData = new FormData();
            formData.append('file', fileObj.file);
            formData.append('database', selectedDB);

            // Simulated upload with progress
            // Replace with actual fetch when backend is ready:
            /*
            const response = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) throw new Error(await response.text());
            return await response.json();
            */

            // Simulation for demo:
            return new Promise((resolve, reject) => {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 25 + 10;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        fileObj.progress = 100;
                        renderFileList();
                        setTimeout(resolve, 200);
                    } else {
                        fileObj.progress = Math.round(progress);
                        renderFileList();
                    }
                }, 300);
            });
        }

        async function uploadText(data) {
            // Replace with actual fetch when backend is ready:
            /*
            const response = await fetch(`${API_BASE}/text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(await response.text());
            return await response.json();
            */

            // Simulation for demo:
            return new Promise(resolve => setTimeout(resolve, 1000));
        }

        // ── Recent table ───────────────────────────────────────────
        function addToRecentTable(name, type, db) {
            const tbody = document.getElementById('recentTableBody');
            const dbLabels = {
                knowledge_base: 'Knowledge Base',
                bcm_axioms: 'BCM Axiome',
                research: 'Research Papers'
            };
            const now = new Date();
            const dateStr = now.toLocaleDateString('de-CH', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="doc-name">${name}</td>
                <td><span class="format-badge">${type.toUpperCase()}</span></td>
                <td>${dbLabels[db] || db}</td>
                <td>${dateStr}</td>
                <td><span class="status-dot">Indexiert</span></td>
            `;
            tbody.insertBefore(row, tbody.firstChild);
        }

        // ── Toast notifications ────────────────────────────────────
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = {
                success: '✓',
                error: '✗',
                info: 'ℹ'
            };
            toast.innerHTML = `<span>${icons[type] || ''}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                toast.style.transition = '0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ── Clear all ──────────────────────────────────────────────
        function clearAll() {
            files = [];
            tags = [];
            renderFileList();
            renderTags();
            document.getElementById('textTitle').value = '';
            document.getElementById('textContent').value = '';
            updateCount();
        }

        // ── Text content counter ───────────────────────────────────
        document.getElementById('textContent').addEventListener('input', updateCount);

        // ── Init ───────────────────────────────────────────────────
        updateCount();
    </script>
</body>
</html>

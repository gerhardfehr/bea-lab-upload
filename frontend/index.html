<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEATRIX â€“ The Strategic Intelligence Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0a1628; --navy-light: #111d35; --navy-mid: #162244; --navy-card: #1a2847; --navy-hover: #1f3055;
            --border: #253556; --border-light: #2d4070;
            --accent: #5b8af5; --accent-light: #7ba3ff; --accent-glow: rgba(91,138,245,0.12); --accent-glow-strong: rgba(91,138,245,0.25);
            --text: #e4e9f2; --text-secondary: #8899b8; --text-muted: #586a8e; --white: #ffffff;
            --success: #34d399; --success-bg: rgba(52,211,153,0.1); --warning: #fbbf24;
            --error: #f87171; --error-bg: rgba(248,113,113,0.08);
            --radius: 14px; --radius-sm: 8px; --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Plus Jakarta Sans',-apple-system,sans-serif; background:var(--navy); color:var(--text); min-height:100vh; overflow-x:hidden; -webkit-font-smoothing:antialiased; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(91,138,245,0.06),transparent),radial-gradient(ellipse 60% 50% at 80% 100%,rgba(91,138,245,0.04),transparent); pointer-events:none; z-index:0; }

        /* â”€â”€ Login/Register Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .auth-overlay { position:fixed; inset:0; z-index:10000; background:var(--navy); display:flex; align-items:center; justify-content:center; transition:opacity 0.5s ease, visibility 0.5s ease; }
        .auth-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }
        .auth-card { width:100%; max-width:420px; padding:48px 40px; text-align:center; }
        .auth-logo { width:80px; height:80px; border-radius:20px; margin:0 auto 28px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.2); }
        .auth-title { font-size:28px; font-weight:800; color:var(--white); margin-bottom:6px; letter-spacing:-0.3px; }
        .auth-title span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .auth-subtitle { font-size:14px; color:var(--text-secondary); margin-bottom:32px; line-height:1.6; }
        .auth-form { display:flex; flex-direction:column; gap:14px; }
        .auth-input-wrapper { position:relative; }
        .auth-input-wrapper svg { position:absolute; left:16px; top:50%; transform:translateY(-50%); width:18px; height:18px; stroke:var(--text-muted); transition:var(--transition); pointer-events:none; }
        .auth-input { width:100%; padding:14px 16px 14px 46px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:inherit; font-size:15px; outline:none; transition:var(--transition); }
        .auth-input::placeholder { color:var(--text-muted); }
        .auth-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); background:var(--navy-card); }
        .auth-btn { width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:var(--radius); font-size:15px; font-weight:700; font-family:inherit; cursor:pointer; transition:var(--transition); box-shadow:0 4px 20px rgba(91,138,245,0.3); display:flex; align-items:center; justify-content:center; gap:10px; }
        .auth-btn:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 6px 28px rgba(91,138,245,0.4); }
        .auth-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
        .auth-error { font-size:13px; color:var(--error); padding:10px 14px; background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); border-radius:var(--radius-sm); display:none; animation:shake 0.4s ease; text-align:left; }
        .auth-error.visible { display:block; }
        .auth-success { font-size:13px; color:var(--success); padding:10px 14px; background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); border-radius:var(--radius-sm); display:none; text-align:left; }
        .auth-success.visible { display:block; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 50%{transform:translateX(6px)} 75%{transform:translateX(-4px)} }
        .auth-switch { margin-top:24px; font-size:13px; color:var(--text-muted); }
        .auth-switch a { color:var(--accent); text-decoration:none; font-weight:600; cursor:pointer; }
        .auth-switch a:hover { color:var(--accent-light); text-decoration:underline; }
        .auth-footer { margin-top:28px; font-size:11px; color:var(--text-muted); }
        .auth-footer a { color:var(--accent); text-decoration:none; }
        .auth-panel { display:none; }
        .auth-panel.active { display:block; }
        .auth-divider { display:flex; align-items:center; gap:12px; margin:4px 0; font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }
        .auth-divider::before, .auth-divider::after { content:''; flex:1; height:1px; background:var(--border); }

        /* â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:0 40px; height:64px; background:rgba(10,22,40,0.9); backdrop-filter:blur(24px); border-bottom:1px solid var(--border); }
        .nav-brand { display:flex; align-items:center; gap:14px; text-decoration:none; }
        .nav-logo-img { height:34px; width:auto; border-radius:6px; }
        .nav-title { font-size:16px; font-weight:700; color:var(--white); letter-spacing:1.5px; text-transform:uppercase; }
        .nav-links { display:flex; align-items:center; gap:8px; }
        .nav-link { padding:8px 16px; font-size:13px; font-weight:500; color:var(--text-secondary); text-decoration:none; border-radius:var(--radius-sm); transition:var(--transition); }
        .nav-link:hover, .nav-link.active { color:var(--white); background:var(--navy-mid); }
        .nav-right { display:flex; align-items:center; gap:12px; }
        .nav-status { display:flex; align-items:center; gap:7px; font-size:12px; font-weight:500; color:var(--success); padding:5px 12px; background:var(--success-bg); border-radius:20px; }
        .nav-status .dot { width:6px; height:6px; border-radius:50%; background:var(--success); animation:pulse 2s infinite; }
        .nav-user { font-size:12px; color:var(--text-secondary); padding:5px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:20px; }
        .nav-logout { padding:5px 12px; font-size:12px; font-weight:500; color:var(--text-muted); background:var(--navy-light); border:1px solid var(--border); border-radius:20px; cursor:pointer; transition:var(--transition); font-family:inherit; display:flex; align-items:center; gap:5px; }
        .nav-logout:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .hero { position:relative; z-index:1; text-align:center; padding:80px 24px 60px; border-bottom:1px solid var(--border); }
        .hero-logo { width:120px; height:120px; border-radius:24px; margin:0 auto 32px; object-fit:cover; box-shadow:0 8px 40px rgba(91,138,245,0.15); }
        .hero h1 { font-size:42px; font-weight:800; letter-spacing:-0.5px; color:var(--white); margin-bottom:12px; }
        .hero h1 span { background:linear-gradient(135deg,var(--accent),var(--accent-light)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .hero .subtitle { font-size:17px; color:var(--text-secondary); max-width:520px; margin:0 auto 36px; line-height:1.7; }
        .hero-stats { display:flex; justify-content:center; gap:40px; }
        .hero-stat { text-align:center; }
        .hero-stat .num { font-size:28px; font-weight:800; color:var(--white); }
        .hero-stat .label { font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-top:2px; }

        /* â”€â”€ Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section { display:none; position:relative; z-index:1; }
        .section.active { display:block; }
        .container { max-width:960px; margin:0 auto; padding:40px 24px 80px; }
        .section-header { margin-bottom:32px; }
        .section-header h2 { font-size:24px; font-weight:700; color:var(--white); margin-bottom:6px; }
        .section-header p { font-size:14px; color:var(--text-secondary); line-height:1.6; }
        .db-selector { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:28px; }
        .db-option { padding:16px 18px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius); cursor:pointer; transition:var(--transition); }
        .db-option:hover { background:var(--navy-card); border-color:var(--border-light); }
        .db-option.selected { background:var(--navy-card); border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .db-option-title { font-size:14px; font-weight:600; color:var(--white); margin-bottom:3px; display:flex; align-items:center; gap:8px; }
        .db-dot { width:8px; height:8px; border-radius:50%; }
        .db-option-desc { font-size:12px; color:var(--text-muted); }
        .tabs { display:flex; gap:4px; margin-bottom:28px; background:var(--navy-light); padding:4px; border-radius:var(--radius); border:1px solid var(--border); width:fit-content; }
        .tab { padding:10px 22px; border-radius:10px; font-size:13px; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:var(--transition); border:none; background:none; font-family:inherit; }
        .tab:hover { color:var(--text); }
        .tab.active { background:var(--navy-card); color:var(--white); box-shadow:0 2px 8px rgba(0,0,0,0.2); }
        .upload-zone { border:2px dashed var(--border); border-radius:var(--radius); padding:52px 40px; text-align:center; cursor:pointer; transition:var(--transition); background:var(--navy-light); position:relative; overflow:hidden; }
        .upload-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,var(--accent-glow),transparent 70%); opacity:0; transition:var(--transition); }
        .upload-zone:hover,.upload-zone.dragover { border-color:var(--accent); background:var(--navy-card); }
        .upload-zone:hover::before,.upload-zone.dragover::before { opacity:1; }
        .upload-icon { position:relative; z-index:1; margin-bottom:16px; }
        .upload-icon svg { width:36px; height:36px; stroke:var(--accent); }
        .upload-zone h3 { position:relative; z-index:1; font-size:16px; font-weight:600; margin-bottom:6px; color:var(--white); }
        .upload-zone h3 span { color:var(--accent-light); text-decoration:underline; text-underline-offset:2px; }
        .upload-zone p { position:relative; z-index:1; font-size:13px; color:var(--text-muted); margin-bottom:12px; }
        .upload-formats { position:relative; z-index:1; display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
        .format-badge { padding:3px 9px; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; background:var(--navy-card); border:1px solid var(--border); border-radius:5px; color:var(--text-secondary); }
        .file-section,.text-section { display:none; }
        .file-section.active,.text-section.active { display:block; }
        .input-group { margin-bottom:16px; }
        .input-group label { display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; }
        .input-field,.textarea-field { width:100%; padding:10px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:13px; outline:none; transition:var(--transition); }
        .input-field:focus,.textarea-field:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .textarea-field { min-height:200px; resize:vertical; line-height:1.7; }
        .input-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
        .tag-container { display:flex; flex-wrap:wrap; gap:6px; padding:8px 12px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); min-height:40px; align-items:center; cursor:text; transition:var(--transition); }
        .tag-container:focus-within { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .tag { display:flex; align-items:center; gap:4px; padding:3px 8px 3px 10px; background:var(--accent-glow); border:1px solid rgba(91,138,245,0.3); border-radius:6px; font-size:12px; font-weight:500; color:var(--accent-light); }
        .tag button { background:none; border:none; color:var(--accent-light); cursor:pointer; font-size:14px; padding:0 2px; opacity:0.6; }
        .tag button:hover { opacity:1; }
        .tag-input { border:none; outline:none; background:none; color:var(--text); font-family:inherit; font-size:13px; flex:1; min-width:80px; }
        .file-list { margin-top:20px; display:flex; flex-direction:column; gap:8px; }
        .file-item { display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); animation:slideIn 0.3s ease; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-6px)} to{opacity:1;transform:translateY(0)} }
        .file-type-icon { width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:700; font-family:'JetBrains Mono',monospace; text-transform:uppercase; flex-shrink:0; }
        .file-type-icon.pdf { background:rgba(239,68,68,0.12); color:#f87171; border:1px solid rgba(239,68,68,0.2); }
        .file-type-icon.txt { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-type-icon.md { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.2); }
        .file-type-icon.doc { background:rgba(96,165,250,0.12); color:#60a5fa; border:1px solid rgba(96,165,250,0.2); }
        .file-info { flex:1; min-width:0; }
        .file-name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .file-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }
        .progress-bar { height:3px; background:var(--navy); border-radius:2px; overflow:hidden; max-width:180px; }
        .progress-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.3s; }
        .file-status { font-size:11px; font-weight:600; padding:3px 9px; border-radius:5px; white-space:nowrap; }
        .file-status.pending { color:var(--text-muted); background:var(--navy-light); }
        .file-status.uploading { color:var(--accent-light); background:var(--accent-glow); }
        .file-status.success { color:var(--success); background:var(--success-bg); }
        .file-status.error { color:var(--error); background:var(--error-bg); }
        .file-remove { background:none; border:none; color:var(--text-muted); cursor:pointer; padding:4px; transition:var(--transition); border-radius:4px; }
        .file-remove:hover { color:var(--error); background:var(--error-bg); }
        .actions { margin-top:28px; display:flex; align-items:center; justify-content:space-between; }
        .btn { padding:11px 24px; border-radius:var(--radius-sm); font-size:13px; font-weight:600; font-family:inherit; cursor:pointer; transition:var(--transition); border:none; display:flex; align-items:center; gap:8px; }
        .btn-primary { background:var(--accent); color:white; box-shadow:0 2px 12px rgba(91,138,245,0.3); }
        .btn-primary:hover { background:var(--accent-light); transform:translateY(-1px); box-shadow:0 4px 20px rgba(91,138,245,0.4); }
        .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; box-shadow:none; }
        .btn-secondary { background:var(--navy-card); color:var(--text-secondary); border:1px solid var(--border); }
        .btn-secondary:hover { background:var(--navy-hover); color:var(--text); }
        .upload-count { font-size:13px; color:var(--text-muted); }
        .doc-table { width:100%; border-collapse:collapse; }
        .doc-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .doc-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .doc-table tr:hover td { background:var(--navy-light); }
        .doc-table .doc-name { color:var(--white); font-weight:500; }
        .status-badge { display:inline-flex; align-items:center; gap:5px; font-size:11px; font-weight:600; }
        .status-badge::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--success); }
        .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
        .empty-state svg { width:48px; height:48px; stroke:var(--border-light); margin-bottom:16px; }
        .empty-state h3 { font-size:16px; color:var(--text-secondary); margin-bottom:6px; }
        .toast-container { position:fixed; bottom:24px; right:24px; z-index:1000; display:flex; flex-direction:column; gap:8px; }
        .toast { padding:12px 18px; border-radius:var(--radius-sm); font-size:13px; font-weight:500; display:flex; align-items:center; gap:8px; animation:toastIn 0.3s ease; box-shadow:0 8px 32px rgba(0,0,0,0.3); border:1px solid var(--border); background:var(--navy-card); }
        .toast.success { border-left:3px solid var(--success); } .toast.error { border-left:3px solid var(--error); } .toast.info { border-left:3px solid var(--accent); }
        @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:translateX(0)} }
        .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .footer { position:relative; z-index:1; text-align:center; padding:32px 24px; border-top:1px solid var(--border); font-size:12px; color:var(--text-muted); }
        .footer a { color:var(--accent); text-decoration:none; }

        /* â”€â”€ Admin Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .admin-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:32px; }
        .admin-card { padding:24px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); }
        .admin-card-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:8px; }
        .admin-card-value { font-size:28px; font-weight:800; color:var(--white); }
        .admin-card-sub { font-size:12px; color:var(--text-secondary); margin-top:4px; }
        .admin-section-title { font-size:16px; font-weight:700; color:var(--white); margin-bottom:16px; display:flex; align-items:center; gap:10px; }
        .admin-section-title .badge { font-size:11px; font-weight:600; padding:3px 10px; border-radius:20px; background:var(--accent-glow); color:var(--accent-light); border:1px solid rgba(91,138,245,0.2); }
        .user-table { width:100%; border-collapse:collapse; margin-bottom:32px; }
        .user-table th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); padding:10px 14px; border-bottom:1px solid var(--border); }
        .user-table td { padding:12px 14px; font-size:13px; border-bottom:1px solid rgba(37,53,86,0.5); color:var(--text-secondary); }
        .user-table tr:hover td { background:var(--navy-light); }
        .user-email { color:var(--white); font-weight:500; }
        .user-badge { display:inline-flex; align-items:center; gap:4px; font-size:10px; font-weight:700; padding:3px 8px; border-radius:4px; text-transform:uppercase; letter-spacing:0.3px; }
        .user-badge.admin { background:rgba(251,191,36,0.12); color:var(--warning); border:1px solid rgba(251,191,36,0.2); }
        .user-badge.user { background:var(--navy-light); color:var(--text-muted); border:1px solid var(--border); }
        .user-badge.active { background:var(--success-bg); color:var(--success); border:1px solid rgba(52,211,153,0.2); }
        .user-badge.inactive { background:var(--error-bg); color:var(--error); border:1px solid rgba(248,113,113,0.2); }
        .btn-toggle { padding:5px 12px; font-size:11px; font-weight:600; font-family:inherit; cursor:pointer; border-radius:6px; transition:var(--transition); border:1px solid var(--border); background:var(--navy-light); color:var(--text-secondary); }
        .btn-toggle:hover { background:var(--navy-hover); color:var(--white); border-color:var(--border-light); }
        .btn-toggle.deactivate:hover { color:var(--error); border-color:rgba(248,113,113,0.3); background:var(--error-bg); }
        .btn-toggle.activate:hover { color:var(--success); border-color:rgba(52,211,153,0.3); background:var(--success-bg); }
        .settings-row { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:10px; }
        .settings-label { font-size:13px; color:var(--text); font-weight:500; }
        .settings-value { font-size:13px; color:var(--accent-light); font-weight:600; font-family:'JetBrains Mono',monospace; }
        .nav-link.admin-link { color:var(--warning); }
        .nav-link.admin-link:hover,.nav-link.admin-link.active { color:var(--warning); background:rgba(251,191,36,0.08); }

        /* â”€â”€ Password Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay { position:fixed; inset:0; z-index:9999; background:rgba(10,22,40,0.85); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:all 0.3s ease; }
        .modal-overlay.visible { opacity:1; visibility:visible; }
        .modal { background:var(--navy-card); border:1px solid var(--border); border-radius:var(--radius); padding:36px; width:100%; max-width:400px; }
        .modal h3 { font-size:18px; font-weight:700; color:var(--white); margin-bottom:20px; }
        .modal-input { width:100%; padding:12px 14px; background:var(--navy-light); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-family:inherit; font-size:14px; outline:none; transition:var(--transition); margin-bottom:12px; }
        .modal-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
        .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:8px; }
        .modal-msg { font-size:13px; padding:10px 14px; border-radius:var(--radius-sm); margin-bottom:12px; display:none; }
        .modal-msg.error { display:block; color:var(--error); background:var(--error-bg); border:1px solid rgba(248,113,113,0.15); }
        .modal-msg.success { display:block; color:var(--success); background:var(--success-bg); border:1px solid rgba(52,211,153,0.15); }
        .nav-user { cursor:pointer; transition:var(--transition); }
        .nav-user:hover { border-color:var(--accent); color:var(--text); }
        @media (max-width:640px) {
            .nav { padding:0 16px; } .nav-links { display:none; } .hero { padding:48px 16px 40px; } .hero h1 { font-size:28px; }
            .hero-stats { gap:20px; } .container { padding:24px 16px 60px; } .db-selector { grid-template-columns:1fr; }
            .input-row { grid-template-columns:1fr; } .upload-zone { padding:36px 20px; } .actions { flex-direction:column; gap:12px; }
            .auth-card { padding:36px 24px; } .auth-title { font-size:24px; }
        }
    </style>
</head>
<body>

    <!-- â•â•â•â•â•â•â• AUTH OVERLAY â•â•â•â•â•â•â• -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-card">
            <div class="auth-logo" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#111d33,#1a2a47);border:1px solid rgba(91,138,245,0.3)">
                <svg width="44" height="44" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M50 10L15 30V70L50 90L85 70V30L50 10Z" stroke="#5b8af5" stroke-width="3" fill="none"/>
                    <path d="M50 20L25 35V65L50 80L75 65V35L50 20Z" stroke="#5b8af5" stroke-width="2" fill="rgba(91,138,245,0.08)"/>
                    <path d="M50 32L33 42V58L50 68L67 58V42L50 32Z" fill="rgba(91,138,245,0.15)" stroke="#5b8af5" stroke-width="1.5"/>
                    <text x="50" y="55" text-anchor="middle" fill="#5b8af5" font-family="system-ui" font-size="14" font-weight="800">B</text>
                </svg>
            </div>
            <h1 class="auth-title">BEATRIX <span>Lab</span></h1>
            <p class="auth-subtitle">Strategic Intelligence Suite</p>

            <!-- LOGIN PANEL -->
            <div class="auth-panel active" id="loginPanel">
                <div class="auth-form">
                    <div class="auth-error" id="loginError"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="loginEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="loginPassword" placeholder="Passwort" autocomplete="current-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="loginBtn" onclick="doLogin()">Anmelden</button>
                    <div style="text-align:center;margin-top:10px"><a onclick="showAuthPanel('forgot')" style="font-size:13px;color:var(--accent);cursor:pointer">Passwort vergessen?</a></div>
                </div>
                <div class="auth-switch">Noch kein Konto? <a onclick="showAuthPanel('register')">Jetzt registrieren</a></div>
            </div>

            <!-- REGISTER PANEL -->
            <div class="auth-panel" id="registerPanel">
                <div class="auth-form">
                    <div class="auth-error" id="registerError"></div>
                    <div class="auth-success" id="registerSuccess"></div>
                    <div class="auth-input-wrapper">
                        <input type="text" class="auth-input" id="regName" placeholder="Name (optional)" autocomplete="name">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="regEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <div class="auth-input-wrapper">
                        <input type="password" class="auth-input" id="regPassword" placeholder="Passwort (mind. 6 Zeichen)" autocomplete="new-password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <button class="auth-btn" id="registerBtn" onclick="doRegister()">Registrieren</button>
                    <div id="resendArea" style="display:none;margin-top:12px;text-align:center;font-size:13px;color:var(--text-muted)">
                        Keine E-Mail erhalten? <a onclick="resendVerification()" style="color:var(--accent);cursor:pointer;font-weight:600">Erneut senden</a>
                    </div>
                </div>
                <div class="auth-switch">Bereits registriert? <a onclick="showAuthPanel('login')">Anmelden</a></div>
            </div>

            <!-- FORGOT PASSWORD PANEL -->
            <div class="auth-panel" id="forgotPanel">
                <div class="auth-form">
                    <p style="font-size:14px;color:var(--text-muted);margin-bottom:16px;text-align:center">Gib deine E-Mail-Adresse ein und wir senden dir einen Link zum ZurÃ¼cksetzen deines Passworts.</p>
                    <div class="auth-error" id="forgotError"></div>
                    <div class="auth-success" id="forgotSuccess" style="display:none;padding:12px;background:var(--success-bg);border:1px solid rgba(52,211,153,0.15);border-radius:var(--radius-sm);color:var(--success);font-size:13px;margin-bottom:12px"></div>
                    <div class="auth-input-wrapper">
                        <input type="email" class="auth-input" id="forgotEmail" placeholder="E-Mail-Adresse" autocomplete="email">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                    </div>
                    <button class="auth-btn" id="forgotBtn" onclick="doForgotPassword()">Reset-Link senden</button>
                </div>
                <div class="auth-switch">ZurÃ¼ck zur <a onclick="showAuthPanel('login')">Anmeldung</a></div>
            </div>

            <div class="auth-footer"><a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> Â· ZÃ¼rich</div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â• -->
    <nav class="nav">
        <a href="#" class="nav-brand" onclick="showSection('hero')"><svg width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="border-radius:6px"><rect width="100" height="100" rx="16" fill="#111d33"/><path d="M50 15L20 32V68L50 85L80 68V32L50 15Z" stroke="#5b8af5" stroke-width="3" fill="none"/><path d="M50 28L30 40V60L50 72L70 60V40L50 28Z" fill="rgba(91,138,245,0.12)" stroke="#5b8af5" stroke-width="2"/><text x="50" y="56" text-anchor="middle" fill="#5b8af5" font-family="system-ui" font-size="18" font-weight="800">B</text></svg><span class="nav-title">BEATRIX</span></a>
        <div class="nav-links">
            <a href="#" class="nav-link active" data-section="upload" onclick="showSection('upload',this)">Upload</a>
            <a href="#" class="nav-link" data-section="documents" onclick="showSection('documents',this)">Dokumente</a>
            <a href="#" class="nav-link admin-link" data-section="admin" id="navAdmin" onclick="showSection('admin',this)" style="display:none">âš™ Admin</a>
        </div>
        <div class="nav-right">
            <div class="nav-status"><span class="dot"></span> Online</div>
            <span class="nav-user" id="navUser" onclick="openPwModal()" title="Passwort Ã¤ndern"></span>
            <button class="nav-logout" onclick="doLogout()">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Abmelden
            </button>
        </div>
    </nav>

    <section class="hero" id="hero-section">
        <div class="hero-logo" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#111d33,#1a2a47);border:1px solid rgba(91,138,245,0.2)">
            <svg width="64" height="64" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 10L15 30V70L50 90L85 70V30L50 10Z" stroke="#5b8af5" stroke-width="3" fill="none"/>
                <path d="M50 20L25 35V65L50 80L75 65V35L50 20Z" stroke="#5b8af5" stroke-width="2" fill="rgba(91,138,245,0.08)"/>
                <path d="M50 32L33 42V58L50 68L67 58V42L50 32Z" fill="rgba(91,138,245,0.15)" stroke="#5b8af5" stroke-width="1.5"/>
                <text x="50" y="55" text-anchor="middle" fill="#5b8af5" font-family="system-ui" font-size="14" font-weight="800">B</text>
            </svg>
        </div>
        <h1>BEATRIX <span>Intelligence Suite</span></h1>
        <p class="subtitle">Knowledge Base fÃ¼r Behavioral Economics. Lade Dokumente, Axiome und Research Papers in die BEATRIX-Datenbank.</p>
        <div class="hero-stats">
            <div class="hero-stat"><div class="num" id="statDocs">â€“</div><div class="label">Dokumente</div></div>
            <div class="hero-stat"><div class="num" id="statKB">â€“</div><div class="label">Knowledge Base</div></div>
            <div class="hero-stat"><div class="num" id="statAxioms">â€“</div><div class="label">BCM Axiome</div></div>
        </div>
    </section>

    <section class="section active" id="upload-section">
        <div class="container">
            <div class="section-header"><h2>Dokument hochladen</h2><p>PDFs, Texte und Axiom-Definitionen in die BEATRIX Knowledge Base einfÃ¼gen.</p></div>
            <div class="db-selector">
                <div class="db-option selected" data-db="knowledge_base" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--accent)"></span> Knowledge Base</div><div class="db-option-desc">Dokumente & Literatur</div></div>
                <div class="db-option" data-db="bcm_axioms" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--success)"></span> BCM Axiome</div><div class="db-option-desc">Axiom-Definitionen</div></div>
                <div class="db-option" data-db="research" onclick="selectDB(this)"><div class="db-option-title"><span class="db-dot" style="background:var(--warning)"></span> Research Papers</div><div class="db-option-desc">Akademische Publikationen</div></div>
            </div>
            <div class="tabs"><button class="tab active" onclick="switchTab('file',this)">Datei-Upload</button><button class="tab" onclick="switchTab('text',this)">Text eingeben</button></div>
            <div class="file-section active" id="file-section">
                <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    <h3>Dateien hierher ziehen oder <span>durchsuchen</span></h3>
                    <p>Maximal 50 MB pro Datei</p>
                    <div class="upload-formats"><span class="format-badge">PDF</span><span class="format-badge">TXT</span><span class="format-badge">MD</span><span class="format-badge">DOCX</span><span class="format-badge">CSV</span><span class="format-badge">JSON</span></div>
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.txt,.md,.docx,.csv,.json" style="display:none">
                <div class="file-list" id="fileList"></div>
            </div>
            <div class="text-section" id="text-section">
                <div class="input-group"><label>Titel</label><input type="text" class="input-field" id="textTitle" placeholder="z.B. Axiom INU-3200 Definition"></div>
                <div class="input-row">
                    <div class="input-group"><label>Kategorie</label><select class="input-field" id="textCategory"><option value="general">Allgemein</option><option value="axiom">Axiom</option><option value="paper">Paper</option><option value="note">Notiz</option></select></div>
                    <div class="input-group"><label>Sprache</label><select class="input-field" id="textLang"><option value="de">Deutsch</option><option value="en">English</option></select></div>
                </div>
                <div class="input-group"><label>Tags</label><div class="tag-container" onclick="this.querySelector('.tag-input').focus()"><input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter"></div></div>
                <div class="input-group"><label>Inhalt</label><textarea class="textarea-field" id="textContent" placeholder="Text oder Axiom-Definition hier einfÃ¼gen..."></textarea></div>
            </div>
            <div class="actions">
                <span class="upload-count" id="uploadCount"></span>
                <div style="display:flex;gap:10px;align-items:center">
                    <button class="btn btn-secondary" onclick="clearAll()">ZurÃ¼cksetzen</button>
                    <button class="btn btn-primary" id="submitBtn" onclick="submitUpload()">
                        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        In Datenbank laden
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="documents-section">
        <div class="container"><div class="section-header"><h2>Dokumente</h2><p>Ãœbersicht aller indexierten Dokumente in der BEATRIX Knowledge Base.</p></div><div id="docTableWrapper"></div></div>
    </section>

    <section class="section" id="admin-section">
        <div class="container">
            <div class="section-header"><h2>âš™ Administration</h2><p>Benutzer verwalten und Systemeinstellungen konfigurieren.</p></div>
            <div class="admin-cards" id="adminCards">
                <div class="admin-card"><div class="admin-card-label">Benutzer</div><div class="admin-card-value" id="adminStatUsers">â€“</div><div class="admin-card-sub">Registriert</div></div>
                <div class="admin-card"><div class="admin-card-label">Registrierung</div><div class="admin-card-value" id="adminStatReg" style="font-size:18px">â€“</div><div class="admin-card-sub" id="adminStatRegSub"></div></div>
                <div class="admin-card"><div class="admin-card-label">Dokumente</div><div class="admin-card-value" id="adminStatDocs">â€“</div><div class="admin-card-sub">In Datenbank</div></div>
            </div>
            <div class="admin-section-title">Benutzer <span class="badge" id="adminUserCount">0</span></div>
            <div id="adminUserTable"></div>
            <div class="admin-section-title" style="margin-top:32px">Einstellungen</div>
            <div id="adminSettings"></div>
        </div>
    </section>

    <footer class="footer">BEATRIX â€“ The Strategic Intelligence Suite Â· <a href="https://fehradvice.com" target="_blank">FehrAdvice & Partners AG</a> Â· ZÃ¼rich</footer>
    <div class="toast-container" id="toastContainer"></div>

    <!-- â•â•â•â•â•â•â• PASSWORD MODAL â•â•â•â•â•â•â• -->
    <div class="modal-overlay" id="pwModal" onclick="if(event.target===this)closePwModal()">
        <div class="modal">
            <h3>ðŸ”‘ Passwort Ã¤ndern</h3>
            <div class="modal-msg" id="pwMsg"></div>
            <input type="password" class="modal-input" id="pwCurrent" placeholder="Aktuelles Passwort">
            <input type="password" class="modal-input" id="pwNew" placeholder="Neues Passwort (mind. 6 Zeichen)">
            <input type="password" class="modal-input" id="pwConfirm" placeholder="Neues Passwort bestÃ¤tigen">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closePwModal()">Abbrechen</button>
                <button class="btn btn-primary" id="pwBtn" onclick="changePassword()">Ã„ndern</button>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.hostname.includes('railway.app') ? '/api' : 'https://bea-lab-upload-production.up.railway.app/api';
        let files=[], tags=[], selectedDB='knowledge_base', currentTab='file', authToken=null, currentUser=null;

        function H() { return authToken ? {'Authorization':`Bearer ${authToken}`} : {}; }

        // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showAuthPanel(panel) {
            document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(panel+'Panel').classList.add('active');
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
        }

        async function checkAuth() {
            const saved = sessionStorage.getItem('bea_token');
            const user = sessionStorage.getItem('bea_user');
            if (saved) {
                try {
                    const r = await fetch(`${API}/auth/check`, {headers:{'Authorization':`Bearer ${saved}`}});
                    if (r.ok) {
                        authToken = saved;
                        currentUser = user ? JSON.parse(user) : (await r.json());
                        document.getElementById('authOverlay').classList.add('hidden');
                        document.getElementById('navUser').textContent = currentUser.name || currentUser.email;
                        if (currentUser.admin) document.getElementById('navAdmin').style.display = '';
                        loadStats();
                        return;
                    }
                } catch(e) {}
                sessionStorage.removeItem('bea_token');
                sessionStorage.removeItem('bea_user');
            }
            document.getElementById('authOverlay').classList.remove('hidden');
        }

        function onAuthSuccess(data) {
            authToken = data.token;
            currentUser = data.user;
            // Decode JWT to get admin status
            try { const p = JSON.parse(atob(data.token.split('.')[1])); currentUser.admin = p.admin || false; } catch(e) { currentUser.admin = false; }
            sessionStorage.setItem('bea_token', authToken);
            sessionStorage.setItem('bea_user', JSON.stringify(currentUser));
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('navUser').textContent = data.user.name || data.user.email;
            if (currentUser.admin) document.getElementById('navAdmin').style.display = '';
            loadStats();
            showToast(`Willkommen, ${data.user.name || data.user.email}!`, 'success');
        }

        async function doLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Anmelden...'; err.classList.remove('visible');
            try {
                const r = await fetch(`${API}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                if (!r.ok) {
                    const d=await r.json().catch(()=>({}));
                    const msg = d.detail||'Anmeldung fehlgeschlagen.';
                    if (r.status === 403 && msg.includes('nicht bestÃ¤tigt')) {
                        err.innerHTML = msg + ' <a style="color:var(--accent);cursor:pointer;font-weight:600" onclick="resendFromLogin()">Erneut senden</a>';
                    } else { err.textContent = msg; }
                    err.classList.add('visible'); btn.disabled=false; btn.textContent='Anmelden'; return;
                }
                onAuthSuccess(await r.json());
            } catch(e) { err.textContent='Verbindungsfehler.'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Anmelden';
        }

        async function resendFromLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const pw = document.getElementById('loginPassword').value;
            if (!email || !pw) return;
            const err = document.getElementById('loginError');
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { err.innerHTML='âœ“ Neuer BestÃ¤tigungslink gesendet!'; err.style.color='var(--success)'; }
                else { err.textContent = d.detail || 'Fehler'; }
            } catch(e) { err.textContent='Verbindungsfehler'; }
        }

        async function doForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const btn = document.getElementById('forgotBtn');
            const err = document.getElementById('forgotError');
            const suc = document.getElementById('forgotSuccess');
            err.classList.remove('visible'); suc.style.display='none';
            if (!email) { err.textContent='Bitte E-Mail-Adresse eingeben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Wird gesendet...';
            try {
                const r = await fetch(`${API}/forgot-password`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})});
                const d = await r.json();
                if (r.ok) { suc.textContent='âœ“ ' + d.message; suc.style.display='block'; }
                else { err.textContent=d.detail||'Fehler'; err.classList.add('visible'); }
            } catch(e) { err.textContent='Verbindungsfehler'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Reset-Link senden';
        }

        async function doRegister() {
            const name = document.getElementById('regName').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const pw = document.getElementById('regPassword').value;
            const btn = document.getElementById('registerBtn');
            const err = document.getElementById('registerError');
            const suc = document.getElementById('registerSuccess');
            err.classList.remove('visible'); if(suc) suc.classList.remove('visible');
            if (!email || !pw) { err.textContent='Bitte E-Mail und Passwort eingeben.'; err.classList.add('visible'); return; }
            if (pw.length < 6) { err.textContent='Passwort muss mindestens 6 Zeichen haben.'; err.classList.add('visible'); return; }
            btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Registrieren...';
            try {
                const r = await fetch(`${API}/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw, name:name||null})});
                const d = await r.json();
                if (!r.ok) { err.textContent=d.detail||'Registrierung fehlgeschlagen.'; err.classList.add('visible'); btn.disabled=false; btn.textContent='Registrieren'; return; }
                if (d.status === 'verification_required') {
                    // Show verification message
                    if(suc) { suc.textContent = d.message; suc.classList.add('visible'); }
                    else { err.style.color='var(--success)'; err.style.background='var(--success-bg)'; err.style.borderColor='rgba(52,211,153,0.15)'; err.textContent = d.message; err.classList.add('visible'); }
                    btn.disabled=false; btn.textContent='Registrieren';
                    // Show resend link
                    setTimeout(() => {
                        const resendEl = document.getElementById('resendArea');
                        if (resendEl) { resendEl.style.display='block'; resendEl.dataset.email=email; resendEl.dataset.pw=pw; }
                    }, 500);
                    return;
                }
                onAuthSuccess(d);
            } catch(e) { err.textContent='Verbindungsfehler.'; err.classList.add('visible'); }
            btn.disabled=false; btn.textContent='Registrieren';
        }

        async function resendVerification() {
            const resendEl = document.getElementById('resendArea');
            const email = resendEl?.dataset.email;
            const pw = resendEl?.dataset.pw;
            if (!email || !pw) return;
            const btn = resendEl.querySelector('a');
            const origText = btn.textContent;
            btn.textContent = 'Wird gesendet...'; btn.style.pointerEvents='none';
            try {
                const r = await fetch(`${API}/resend-verification`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pw})});
                const d = await r.json();
                if (r.ok) { btn.textContent='âœ“ Gesendet!'; btn.style.color='var(--success)'; }
                else { btn.textContent = d.detail || 'Fehler'; btn.style.color='var(--error)'; }
            } catch(e) { btn.textContent='Fehler'; btn.style.color='var(--error)'; }
            setTimeout(() => { btn.textContent=origText; btn.style.color=''; btn.style.pointerEvents=''; }, 4000);
        }

        function doLogout() {
            authToken=null; currentUser=null;
            sessionStorage.removeItem('bea_token'); sessionStorage.removeItem('bea_user');
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('loginEmail').value=''; document.getElementById('loginPassword').value='';
            document.querySelectorAll('.auth-error,.auth-success').forEach(e => e.classList.remove('visible'));
            showAuthPanel('login');
        }

        document.getElementById('loginPassword').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('loginEmail').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
        document.getElementById('regPassword').addEventListener('keydown', e => { if(e.key==='Enter') doRegister(); });

        // â”€â”€ App Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showSection(name,el) {
            if(el){document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));el.classList.add('active');}
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const sec=document.getElementById(name+'-section'); if(sec) sec.classList.add('active');
            if(name==='documents') loadDocuments();
            if(name==='admin') loadAdminData();
        }
        function switchTab(tab,el) { currentTab=tab; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); document.getElementById('file-section').classList.toggle('active',tab==='file'); document.getElementById('text-section').classList.toggle('active',tab==='text'); updateCount(); }
        function selectDB(el) { document.querySelectorAll('.db-option').forEach(o=>o.classList.remove('selected')); el.classList.add('selected'); selectedDB=el.dataset.db; }

        const dropZone=document.getElementById('dropZone');
        ['dragenter','dragover'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.add('dragover');}));
        ['dragleave','drop'].forEach(e=>dropZone.addEventListener(e,ev=>{ev.preventDefault();dropZone.classList.remove('dragover');}));
        dropZone.addEventListener('drop',e=>addFiles([...e.dataTransfer.files]));
        document.getElementById('fileInput').addEventListener('change',e=>{addFiles([...e.target.files]);e.target.value='';});

        function addFiles(nf) { const ok=['.pdf','.txt','.md','.docx','.csv','.json']; for(const f of nf){const ext='.'+f.name.split('.').pop().toLowerCase(); if(!ok.includes(ext)){showToast(`${f.name}: nicht unterstÃ¼tzt`,'error');continue;} if(f.size>50*1024*1024){showToast(`${f.name}: zu groÃŸ`,'error');continue;} files.push({file:f,status:'pending',progress:0,id:Date.now()+Math.random()});} renderFileList();updateCount(); }
        function removeFile(id) { files=files.filter(f=>f.id!==id); renderFileList();updateCount(); }
        function renderFileList() { document.getElementById('fileList').innerHTML=files.map(f=>{const ext=f.file.name.split('.').pop().toLowerCase();const cls=ext==='pdf'?'pdf':ext==='md'?'md':ext==='docx'?'doc':'txt';const sz=f.file.size<1024*1024?(f.file.size/1024).toFixed(1)+' KB':(f.file.size/1024/1024).toFixed(1)+' MB';return`<div class="file-item"><div class="file-type-icon ${cls}">${ext}</div><div class="file-info"><div class="file-name">${f.file.name}</div><div class="file-meta">${sz}</div></div>${f.status==='uploading'?`<div><div class="progress-bar"><div class="progress-fill" style="width:${f.progress}%"></div></div></div>`:''}<span class="file-status ${f.status}">${f.status==='pending'?'Bereit':f.status==='uploading'?f.progress+'%':f.status==='success'?'âœ“ Fertig':'âœ— Fehler'}</span>${f.status==='pending'?`<button class="file-remove" onclick="removeFile(${f.id})"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`:''}</div>`;}).join(''); }
        function updateCount() { const el=document.getElementById('uploadCount'); el.textContent=currentTab==='file'?(files.length?`${files.length} Datei${files.length>1?'en':''}`:''):(document.getElementById('textContent').value.length?`${document.getElementById('textContent').value.length} Zeichen`:''); }

        document.getElementById('tagInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&e.target.value.trim()){e.preventDefault();if(!tags.includes(e.target.value.trim())){tags.push(e.target.value.trim());renderTags();}e.target.value='';}});
        function removeTag(t){tags=tags.filter(x=>x!==t);renderTags();}
        function renderTags(){const c=document.getElementById('tagContainer'),inp=document.getElementById('tagInput');c.innerHTML='';tags.forEach(t=>{const s=document.createElement('span');s.className='tag';s.innerHTML=`${t} <button onclick="removeTag('${t}')">&times;</button>`;c.appendChild(s);});c.appendChild(inp);}

        async function submitUpload() {
            const btn=document.getElementById('submitBtn');
            if(currentTab==='file'){
                if(!files.length){showToast('Bitte Dateien auswÃ¤hlen','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Hochladen...';
                for(const f of files){if(f.status!=='pending')continue;f.status='uploading';renderFileList();
                    try{const fd=new FormData();fd.append('file',f.file);fd.append('database',selectedDB);const r=await fetch(`${API}/upload`,{method:'POST',headers:H(),body:fd});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());f.status='success';f.progress=100;}catch(e){f.status='error';showToast(`${f.file.name}: ${e.message}`,'error');}renderFileList();}
                const ok=files.filter(f=>f.status==='success').length;if(ok)showToast(`${ok} Datei${ok>1?'en':''} hochgeladen`,'success');
            } else {
                const title=document.getElementById('textTitle').value.trim(),content=document.getElementById('textContent').value.trim();
                if(!content){showToast('Bitte Text eingeben','error');return;}
                btn.disabled=true;btn.innerHTML='<div class="spinner"></div> Speichern...';
                try{const r=await fetch(`${API}/text`,{method:'POST',headers:{...H(),'Content-Type':'application/json'},body:JSON.stringify({title:title||'Untitled',content,category:document.getElementById('textCategory').value,language:document.getElementById('textLang').value,tags,database:selectedDB})});if(r.status===401){doLogout();showToast('Sitzung abgelaufen','error');return;}if(!r.ok)throw new Error(await r.text());showToast('Text gespeichert','success');document.getElementById('textTitle').value='';document.getElementById('textContent').value='';tags=[];renderTags();}catch(e){showToast(e.message,'error');}
            }
            btn.disabled=false;btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> In Datenbank laden';loadStats();
        }

        async function loadDocuments() {
            const w=document.getElementById('docTableWrapper');
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401){doLogout();return;}const docs=await r.json();
                if(!docs.length){w.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>Noch keine Dokumente</h3><p>Lade dein erstes Dokument hoch.</p></div>`;return;}
                const db={knowledge_base:'Knowledge Base',bcm_axioms:'BCM Axiome',research:'Research'};
                w.innerHTML=`<table class="doc-table"><thead><tr><th>Dokument</th><th>Typ</th><th>Datenbank</th><th>Datum</th><th>Status</th></tr></thead><tbody>${docs.map(d=>{const date=new Date(d.created_at).toLocaleDateString('de-CH',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});return`<tr><td class="doc-name">${d.title}</td><td><span class="format-badge">${(d.file_type||d.source_type).toUpperCase()}</span></td><td>${db[d.database_target]||d.database_target}</td><td>${date}</td><td><span class="status-badge">${d.status}</span></td></tr>`;}).join('')}</tbody></table>`;
            }catch(e){w.innerHTML='<p style="color:var(--error)">Fehler beim Laden</p>';}
        }

        async function loadStats() {
            try{const r=await fetch(`${API}/documents`,{headers:H()});if(r.status===401)return;const d=await r.json();
                document.getElementById('statDocs').textContent=d.length;document.getElementById('statKB').textContent=d.filter(x=>x.database_target==='knowledge_base').length;document.getElementById('statAxioms').textContent=d.filter(x=>x.database_target==='bcm_axioms').length;
            }catch(e){document.getElementById('statDocs').textContent='â€“';}
        }

        function showToast(msg,type='info'){const c=document.getElementById('toastContainer'),t=document.createElement('div');t.className=`toast ${type}`;t.innerHTML=`<span>${{success:'âœ“',error:'âœ—',info:'â„¹'}[type]||''}</span> ${msg}`;c.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(20px)';t.style.transition='0.3s';setTimeout(()=>t.remove(),300);},4000);}
        function clearAll(){files=[];tags=[];renderFileList();renderTags();document.getElementById('textTitle').value='';document.getElementById('textContent').value='';updateCount();}
        document.getElementById('textContent').addEventListener('input',updateCount);

        // â”€â”€ Admin Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadAdminData() {
            if (!currentUser || !currentUser.admin) return;
            try {
                const [usersR, settingsR, docsR] = await Promise.all([
                    fetch(`${API}/admin/users`, {headers:H()}),
                    fetch(`${API}/admin/settings`, {headers:H()}),
                    fetch(`${API}/documents`, {headers:H()})
                ]);
                if (usersR.status===401) { doLogout(); return; }
                const users = usersR.ok ? await usersR.json() : [];
                const settings = settingsR.ok ? await settingsR.json() : {};
                const docs = docsR.ok ? await docsR.json() : [];

                // Stats
                document.getElementById('adminStatUsers').textContent = users.length;
                document.getElementById('adminStatDocs').textContent = docs.length;
                const regMode = settings.registration === 'open' ? 'Offen' : 'EingeschrÃ¤nkt';
                document.getElementById('adminStatReg').textContent = regMode;
                const domains = settings.allowed_email_domains || [];
                document.getElementById('adminStatRegSub').textContent = domains.includes('*') ? 'Alle Domains' : domains.map(d => '@'+d).join(', ') || 'Alle Domains';

                // User count badge
                document.getElementById('adminUserCount').textContent = users.length;

                // User table
                const tbody = users.map(u => {
                    const created = u.created_at ? new Date(u.created_at).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric'}) : 'â€“';
                    const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString('de-CH', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : 'Nie';
                    const roleBadge = u.is_admin ? '<span class="user-badge admin">Admin</span>' : '<span class="user-badge user">User</span>';
                    const statusBadge = u.is_active ? '<span class="user-badge active">Aktiv</span>' : '<span class="user-badge inactive">Inaktiv</span>';
                    const verifiedBadge = u.email_verified ? '<span class="user-badge active">âœ“ Verifiziert</span>' : '<span class="user-badge inactive">Ausstehend</span>';
                    const toggleBtn = u.is_active
                        ? `<button class="btn-toggle deactivate" onclick="toggleUserActive('${u.id}','${u.email}')">Deaktivieren</button>`
                        : `<button class="btn-toggle activate" onclick="toggleUserActive('${u.id}','${u.email}')">Aktivieren</button>`;
                    const verifyBtn = !u.email_verified ? ` <button class="btn-toggle activate" onclick="adminVerifyUser('${u.id}','${u.email}')">BestÃ¤tigen</button>` : '';
                    return `<tr>
                        <td><span class="user-email">${u.name || 'â€“'}</span><br><span style="font-size:11px;color:var(--text-muted)">${u.email}</span></td>
                        <td>${roleBadge}</td>
                        <td>${verifiedBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${created}</td>
                        <td>${lastLogin}</td>
                        <td>${toggleBtn}${verifyBtn}</td>
                    </tr>`;
                }).join('');

                document.getElementById('adminUserTable').innerHTML = `<table class="user-table">
                    <thead><tr><th>Benutzer</th><th>Rolle</th><th>E-Mail</th><th>Status</th><th>Registriert</th><th>Letzter Login</th><th>Aktionen</th></tr></thead>
                    <tbody>${tbody}</tbody>
                </table>`;

                // Settings
                document.getElementById('adminSettings').innerHTML = `
                    <div class="settings-row"><span class="settings-label">E-Mail-Verifizierung</span><span class="settings-value" style="color:${settings.email_verification?'var(--success)':'var(--text-muted)'}">${settings.email_verification ? 'âœ“ Aktiv' : 'âœ— Deaktiviert'}</span></div>
                    <div class="settings-row"><span class="settings-label">E-Mail-Versand (Resend)</span><span class="settings-value" style="color:${settings.smtp_configured?'var(--success)':'var(--error)'}">${settings.smtp_configured ? 'âœ“ Konfiguriert' : 'âœ— Nicht konfiguriert'}</span></div>
                    <div class="settings-row"><span class="settings-label">Registrierung</span><span class="settings-value">${regMode}</span></div>
                    <div class="settings-row"><span class="settings-label">Erlaubte Domains</span><span class="settings-value">${domains.includes('*') ? 'Alle (*)' : domains.map(d=>'@'+d).join(', ') || 'Alle (*)'}</span></div>
                    <div class="settings-row"><span class="settings-label">JWT GÃ¼ltigkeit</span><span class="settings-value">${settings.jwt_expiry_hours || 24}h</span></div>
                `;
            } catch(e) {
                document.getElementById('adminUserTable').innerHTML = '<p style="color:var(--error)">Fehler beim Laden der Admin-Daten.</p>';
            }
        }

        async function toggleUserActive(userId, email) {
            if (!confirm(`Benutzer ${email} wirklich umschalten?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/toggle-active`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler beim Ã„ndern', 'error'); return; }
                const data = await r.json();
                showToast(`${email}: ${data.is_active ? 'aktiviert' : 'deaktiviert'}`, data.is_active ? 'success' : 'info');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        async function adminVerifyUser(userId, email) {
            if (!confirm(`E-Mail von ${email} manuell bestÃ¤tigen?`)) return;
            try {
                const r = await fetch(`${API}/admin/users/${userId}/verify`, {method:'PUT', headers:H()});
                if (!r.ok) { showToast('Fehler', 'error'); return; }
                showToast(`${email}: E-Mail bestÃ¤tigt âœ“`, 'success');
                loadAdminData();
            } catch(e) { showToast('Verbindungsfehler', 'error'); }
        }

        // â”€â”€ Password Change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openPwModal() {
            document.getElementById('pwModal').classList.add('visible');
            document.getElementById('pwCurrent').value='';
            document.getElementById('pwNew').value='';
            document.getElementById('pwConfirm').value='';
            document.getElementById('pwMsg').className='modal-msg';
            document.getElementById('pwCurrent').focus();
        }
        function closePwModal() { document.getElementById('pwModal').classList.remove('visible'); }

        async function changePassword() {
            const cur = document.getElementById('pwCurrent').value;
            const nw = document.getElementById('pwNew').value;
            const conf = document.getElementById('pwConfirm').value;
            const msg = document.getElementById('pwMsg');
            const btn = document.getElementById('pwBtn');
            msg.className='modal-msg';
            if (!cur) { msg.className='modal-msg error'; msg.textContent='Bitte aktuelles Passwort eingeben.'; return; }
            if (nw.length < 6) { msg.className='modal-msg error'; msg.textContent='Neues Passwort muss mindestens 6 Zeichen haben.'; return; }
            if (nw !== conf) { msg.className='modal-msg error'; msg.textContent='Neue PasswÃ¶rter stimmen nicht Ã¼berein.'; return; }
            btn.disabled=true; btn.textContent='Wird geÃ¤ndert...';
            try {
                const r = await fetch(`${API}/change-password`, {method:'POST', headers:{...H(),'Content-Type':'application/json'}, body:JSON.stringify({current_password:cur, new_password:nw})});
                const d = await r.json();
                if (!r.ok) { msg.className='modal-msg error'; msg.textContent=d.detail||'Fehler'; btn.disabled=false; btn.textContent='Ã„ndern'; return; }
                msg.className='modal-msg success'; msg.textContent='âœ“ Passwort erfolgreich geÃ¤ndert!';
                showToast('Passwort geÃ¤ndert','success');
                setTimeout(closePwModal, 1500);
            } catch(e) { msg.className='modal-msg error'; msg.textContent='Verbindungsfehler'; }
            btn.disabled=false; btn.textContent='Ã„ndern';
        }
        document.addEventListener('keydown', e => { if(e.key==='Escape') closePwModal(); });

        checkAuth();
    </script>
</body>
</html>
